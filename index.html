<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>题境 | 本地题库系统</title>
  <!-- Tailwind CSS -->
  <link href="https://cdn.staticfile.org/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link href="https://cdn.staticfile.org/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <!-- Noto Serif SC & Noto Sans SC -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;500;600;700&family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
  <!-- SheetJS for xlsx parsing -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- 本地 SheetJS 备份，避免网络问题 -->
  <script>
    // 检查 XLSX 是否已加载，如果没有则加载本地版本
    window.addEventListener('DOMContentLoaded', function() {
      if (typeof XLSX === 'undefined') {
        console.log('CDN加载失败，使用本地XLSX库');
        const script = document.createElement('script');
        script.src = './xlsx.full.min.js'; // 本地备份
        document.head.appendChild(script);
      } else {
        console.log('CDN加载成功');
      }
    });
  </script>
  <!-- Marked.js for Markdown rendering -->
  <!-- 优先CDN，失败自动降级为本地 -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    if (typeof marked === 'undefined' || typeof marked.parse !== 'function') {
      var script = document.createElement('script');
      script.src = './src/marked.min.js';
      document.head.appendChild(script);
    }
  </script>
  <!-- Chart.js for statistics -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <!-- 光影书架艺术级视觉升级CSS（自动生成，2024） -->
  <style>
    body {
      background: radial-gradient(ellipse at 60% 20%, #e0e7ff 0%, #f8fafc 60%, #f1f5f9 100%);
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
      font-family: 'Noto Serif SC', serif;
    }
    /* 三栏空间分隔与柔和光影 */
    aside, #main-section {
      box-shadow: 0 8px 32px 0 rgba(99,102,241,0.10), 0 1.5px 4px 0 rgba(0,0,0,0.04);
      border-radius: 1.5rem;
      background: rgba(255,255,255,0.85);
      backdrop-filter: blur(2.5px);
      margin: 1.5rem 0.5rem;
      border: 1.5px solid #e0e7ff;
      transition: box-shadow 0.3s, background 0.3s;
    }
    aside {
      background: linear-gradient(120deg, #f8fafc 80%, #e0e7ff 100%);
    }
    #main-section {
      background: linear-gradient(120deg, #f8fafc 60%, #e0e7ff 100%);
      box-shadow: 0 12px 48px 0 rgba(99,102,241,0.13), 0 2px 8px 0 rgba(0,0,0,0.04);
    }
    /* 卡片升级 */
    .draggable-cat, .draggable-lib, .group.bg-white, .group.bg-gray-900 {
      box-shadow: 0 4px 16px 0 rgba(99,102,241,0.08), 0 1px 2px 0 rgba(0,0,0,0.03);
      border-radius: 1.1rem;
      border: 1.5px solid #e0e7ff;
      background: rgba(255,255,255,0.97);
      transition: box-shadow 0.2s, background 0.2s;
    }
    .draggable-cat:hover, .draggable-lib:hover {
      box-shadow: 0 8px 32px 0 rgba(99,102,241,0.13), 0 2px 8px 0 rgba(0,0,0,0.04);
      background: #f1f5fa;
    }
    /* 解析区艺术化 */
    .markdown-body, #explanation-md {
      background: linear-gradient(90deg, #f8f9ff 0%, #e8ecff 100%);
      border-left: 6px solid #6366f1;
      border-radius: 1.1rem;
      padding: 1.3em 1.6em;
      font-style: normal;
      line-height: 1.85;
      letter-spacing: 0.02em;
      box-shadow: 0 2px 8px 0 rgba(99,102,241,0.08);
      margin-top: 0.5em;
      position: relative;
      word-break: break-word;
      white-space: pre-line;
    }
    /* Xiaohongshu 风格列表符号 */
    .markdown-body ul, #explanation-md ul {list-style:none; padding-left:0; margin-left:0;}
    .markdown-body ul li, #explanation-md ul li {position:relative; padding-left:1.4em; margin:0.4em 0;}
    .markdown-body ul li::before, #explanation-md ul li::before {
      content:'📝';
      position:absolute; left:0; top:0.1em;
    }
    /* 段落间距 */
    .markdown-body p, #explanation-md p {margin:0.6em 0;}
    /* 夜间解析区文本提亮 */
    .dark .markdown-body, .dark #explanation-md {color:#e5e7eb;}
    /* 解析区引号装饰 */
    .markdown-body:before, #explanation-md:before {
      content: '"';
      font-size: 2.5em;
      color: #fbbf24;
      position: absolute;
      left: 1.1em; top: 0.2em;
      opacity: 0.18;
      font-family: serif;
      pointer-events: none;
    }
    /* 按钮与进度条升级 */
    button, .practice-btn, #fav-btn {
      box-shadow: 0 2px 8px 0 rgba(99,102,241,0.08);
      border-radius: 1.1rem;
      transition: box-shadow 0.2s, background 0.2s, transform 0.15s;
    }
    button:hover, .practice-btn:hover, #fav-btn:hover {
      box-shadow: 0 4px 16px 0 rgba(99,102,241,0.13);
      transform: translateY(-2px) scale(1.04);
    }
    .w-56 .grid button {
      border: 2px solid #e0e7ff;
      background: linear-gradient(120deg, #f8fafc 80%, #e0e7ff 100%);
    }
    /* 进度条升级 */
    .w-56.h-2.bg-gray-200 {
      background: linear-gradient(90deg, #e0e7ff 0%, #f8fafc 100%);
    }
    .h-2.bg-gradient-to-r {
      box-shadow: 0 1px 4px 0 rgba(99,102,241,0.13);
    }
    /* 错题本/收藏夹区块材质感 */
    #tab-wrong, #tab-fav {
      background: linear-gradient(120deg, #fff7f7 80%, #ffeaea 100%);
      border-radius: 1.2rem;
      box-shadow: 0 4px 16px 0 rgba(239,68,68,0.07);
    }
    #tab-fav {
      background: linear-gradient(120deg, #fffbe6 80%, #fff3c4 100%);
      box-shadow: 0 4px 16px 0 rgba(251,191,36,0.07);
    }
    /* 主题LOGO升级为原创SVG图标 */
    .logo-tijing {
      display:inline-block;
    }
    .logo-tijing svg {
      width:40px;
      height:40px;
      filter: drop-shadow(0 2px 8px #a5b4fc88);
      border-radius: 1.2rem;
      background: linear-gradient(120deg, #e0e7ff 60%, #f8fafc 100%);
    }
    /* 主功能区图标升级为原创SVG */
    .fa-folder-open:before, .fa-times-circle:before, .fa-star:before {
      content: '' !important;
      display: none !important;
    }
    .tab-btn[data-tab="library"] i::before {
      content: '';
      display: inline-block;
      width: 1.5em; height: 1.5em;
      background: url('data:image/svg+xml;utf8,<svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="4" y="8" width="24" height="16" rx="4" fill="%236366f1" fill-opacity="0.13"/><rect x="4" y="8" width="24" height="16" rx="4" stroke="%236366f1" stroke-width="2"/><path d="M8 12 Q16 20 24 12" stroke="%236366f1" stroke-width="2" fill="none"/><ellipse cx="16" cy="10.5" rx="2.5" ry="1.2" fill="%236366f1" fill-opacity="0.5"/></svg>') center/contain no-repeat;
      vertical-align: middle;
    }
    .tab-btn[data-tab="wrong"] i::before {
      content: '';
      display: inline-block;
      width: 1.5em; height: 1.5em;
      background: url('data:image/svg+xml;utf8,<svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="16" cy="16" r="13" fill="%23ef4444" fill-opacity="0.13"/><circle cx="16" cy="16" r="13" stroke="%23ef4444" stroke-width="2"/><path d="M12 12 L20 20 M20 12 L12 20" stroke="%23ef4444" stroke-width="2.5" stroke-linecap="round"/></svg>') center/contain no-repeat;
      vertical-align: middle;
    }
    .tab-btn[data-tab="fav"] i::before {
      content: '';
      display: inline-block;
      width: 1.5em; height: 1.5em;
      background: url('data:image/svg+xml;utf8,<svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg"><polygon points="16,6 19.09,13.26 27,14.27 21,19.14 22.18,27 16,23.27 9.82,27 11,19.14 5,14.27 12.91,13.26" fill="%23fbbf24" fill-opacity="0.13"/><polygon points="16,6 19.09,13.26 27,14.27 21,19.14 22.18,27 16,23.27 9.82,27 11,19.14 5,14.27 12.91,13.26" stroke="%23fbbf24" stroke-width="2"/><polygon points="16,8.5 18.18,13.26 23,13.97 19.5,17.14 20.36,22 16,19.27 11.64,22 12.5,17.14 9,13.97 13.82,13.26" fill="%23fbbf24"/></svg>') center/contain no-repeat;
      vertical-align: middle;
    }
    /* 响应式优化 */
    @media (max-width: 900px) {
      aside, #main-section {
        margin: 0.7rem 0.2rem;
        border-radius: 1.1rem;
      }
    }
    @media (max-width: 700px) {
      aside, #main-section {
        margin: 0.2rem 0;
        border-radius: 0.7rem;
        box-shadow: 0 2px 8px 0 rgba(99,102,241,0.08);
      }
      .logo-tijing svg {
        width: 28px; height: 28px;
      }
    }
    aside.w-56 button i, aside.w-56 button::before, aside.w-56 button::after {
      display: none !important;
    }
    /* 夜间主题整体配色覆盖 */
    .dark body {
      background: radial-gradient(ellipse at 60% 20%, #1e293b 0%, #0f172a 60%, #0a101b 100%);
    }
    /* 隐藏分类播放按钮，减少视觉干扰 */
    .practice-cat-btn{display:none!important;}
    /* 顶部 Header 在夜间采用同系深色渐变，保持整体一致 */
    .dark header {
      background: linear-gradient(120deg, #1f2937 0%, #111827 100%);
      border-bottom-color:#334155;
      box-shadow: 0 2px 6px rgba(0,0,0,0.6);
    }
    .dark .logo-tijing svg {
      background: linear-gradient(120deg, #334155 60%, #1e293b 100%);
    }
    .dark header span.text-base {
      color:#94a3b8; /* slate-400 */
    }
    .dark aside, .dark #main-section {
      background: linear-gradient(120deg, #1f2937 60%, #111827 100%);
      border-color: #334155;
      box-shadow: 0 10px 40px rgba(0,0,0,0.45), 0 2px 6px rgba(0,0,0,0.3);
    }
    .dark .draggable-cat, .dark .draggable-lib, .dark .group.bg-white, .dark .group.bg-gray-900 {
      background: rgba(31,41,55,0.9);
      border-color: #334155;
      box-shadow: 0 6px 24px rgba(0,0,0,0.4);
    }
    .dark button, .dark .practice-btn, .dark #fav-btn {
      box-shadow: 0 2px 6px rgba(0,0,0,0.4);
    }
    .dark .markdown-body, .dark #explanation-md {
      background: linear-gradient(90deg,#1e293b 0%, #334155 100%);
      border-left-color:#fbbf24;
    }
    .dark .w-56 .grid button {
      background: linear-gradient(120deg, #1e293b 80%, #334155 100%);
      border-color:#334155;
    }
    /* 夜间滚动条 */
    .dark ::-webkit-scrollbar-thumb {background:#334155;}
    .dark ::-webkit-scrollbar-track {background:#111827;}
    /* 夜间下练习卡片强制深色 */
    .dark .practice-card {
      background:#1f2937 !important;
      border-color:#334155 !important;
      color:#e5e7eb;
    }
    .dark .practice-card .text-gray-900,
    .dark .practice-card .text-base,
    .dark .practice-card .text-xl {
      color:#e5e7eb !important;
    }
    .dark .practice-card .text-gray-500 {color:#9ca3af !important;}
    /* 夜间侧栏文字提亮 */
    .dark aside {
      color:#e5e7eb;
    }
    .dark aside .text-gray-600,
    .dark aside .text-gray-700,
    .dark aside .text-gray-800,
    .dark aside .text-gray-900 {
      color:#e5e7eb !important;
    }
    .dark aside .text-gray-500 {color:#9ca3af !important;}
    /* 夜间选项卡片统一深色 */
    .dark .practice-card label.custom-radio {
      background:#1e2638 !important;
      border-color:#3b475c !important;
      color:#e2e8f0 !important;
    }
    .dark .practice-card label.custom-radio:hover {
      background:#27324a !important;
      border-color:#56607a !important;
    }
    .dark .practice-card label.custom-radio.locked {
      background:#2b374d !important;
      border-color:#4b5563 !important;
    }
    /* 解析区（卡片）日间主色调 */
    .explain-card {
      background:linear-gradient(90deg,#f0f4ff 0%, #e8ecff 100%);
      border-color:#c7d2fe;
    }
    /* 夜间解析区保持深色 */
    .dark .explain-card {
      background:linear-gradient(90deg,#182235 0%, #25324a 100%) !important;
      border-color:#475569 !important;
      color:#e5e7eb !important;
    }
    /* 夜间Header文案提亮 */
    .dark header .font-extrabold {color:#e5e7eb !important;}
    .dark header span.text-base {color:#cbd5e1 !important;}

    /* 隐藏一键备份按钮 */
    #dev-backup-btn {display:none !important;}

    /* 夜间主题切换按钮柔和化 */
    .dark #theme-toggle {background:#334155 !important; box-shadow:0 1px 4px rgba(0,0,0,0.4);}
    .dark #theme-toggle:hover {background:#475569 !important;}
    .dark #theme-toggle i {color:#fbbf24 !important; opacity:0.8;}
    /* 夜间主题每日一言字体颜色修正 */
    .dark #daily-quote {
      color: #a5b4fc !important;
    }
    /* 题库文件名自动换行 */
    .group.bg-white .font-semibold,
    .group.bg-gray-900 .font-semibold {
      word-break: break-all;
      white-space: normal;
      display: block;
    }
    .group.bg-white, .group.bg-gray-900 {
      min-height: 56px;
    }
    /* 答题卡题号按钮圆形统一风格 */
    .answer-sheet-btn {
      width: 2.5rem;
      height: 2.5rem;
      min-width: 2.5rem;
      min-height: 2.5rem;
      max-width: 2.5rem;
      max-height: 2.5rem;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s;
      word-break: keep-all;
      padding: 0;
      overflow: hidden;
    }
    .answer-sheet-btn.long {
      font-size: 0.95rem;
    }
    .answer-sheet-btn.xlong {
      font-size: 0.8rem;
    }
    /* 答题卡高亮外圈用box-shadow实现，避免被遮挡 */
    .answer-sheet-btn.ring-indigo-500 {
      box-shadow: 0 0 0 3px #6366f1;
      border-color: #6366f1 !important;
      z-index: 2;
    }
    .answer-sheet-btn.scale-110 {
      transform: scale(1.10);
    }
    /* 夜间模式下禁用按钮样式优化 */
    .dark #prev-answer-page[disabled],
    .dark #next-answer-page[disabled] {
      opacity: 0.5;
      background-color: #4b5563 !important; /* gray-600 */
      cursor: not-allowed;
    }
    /* 题库卡片样式优化 */
    .draggable-lib {
      display: flex;
      flex-direction: column;
      min-height: 96px;
      position: relative;
    }
    .draggable-lib .flex.items-center.mb-1 {
      flex: 1;
      margin-bottom: 8px;
    }
    .draggable-lib .flex.items-center.justify-between {
      margin-top: 8px;
      width: 100%;
      flex-shrink: 0; /* 不允许行被压缩到0高度 */
    }
    .draggable-lib .font-semibold {
      max-height: none;
      overflow: visible;
      display: block;
      line-clamp: unset;
      -webkit-line-clamp: unset;
      box-orient: unset;
      -webkit-box-orient: unset;
      line-height: 1.3;
      word-break: break-word;
    }
    /* 清空按钮样式 */
    .clear-btn {
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }

    /* 白天模式 */
    body:not(.dark-mode) .clear-btn {
      background: #f0f0f0;
      color: #666;
      border: 1px solid #ccc;
    }

    body:not(.dark-mode) .clear-btn:hover {
      background: #e0e0e0;
      color: #333;
    }

    /* 夜晚模式 */
    body.dark-mode .clear-btn {
      background: rgba(30, 41, 59, 0.5);
      color: #94a3b8;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    body.dark-mode .clear-btn:hover {
      background: rgba(30, 41, 59, 0.8);
      color: #e2e8f0;
    }

    /* 修复列表内容溢出圆角问题 */
    #wrongbook-list, #favbook-list {
      overflow: hidden;
      border-radius: inherit;
    }

    .question-item {
      margin-bottom: 8px;
      overflow: hidden;
    }

    /* 错题本和收藏夹容器样式 */
    .tab-container {
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
    }

    /* 白天模式 */
    body:not(.dark-mode) .tab-container {
      background: #fff;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    /* 夜晚模式 */
    body.dark-mode .tab-container {
      background: rgba(13, 18, 30, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    /* 标题栏样式 */
    .tab-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    /* 错题本标题样式 */
    .wrong-title {
      font-size: 18px;
      font-weight: bold;
      display: flex;
      align-items: center;
    }

    body:not(.dark-mode) .wrong-title {
      color: #ff4d4f;
    }

    body.dark-mode .wrong-title {
      color: #ff7875;
    }

    /* 收藏夹标题样式 */
    .fav-title {
      font-size: 18px;
      font-weight: bold;
      display: flex;
      align-items: center;
    }

    body:not(.dark-mode) .fav-title {
      color: #faad14;
    }

    body.dark-mode .fav-title {
      color: #ffd666;
    }

    /* 移除按钮样式 */
    body.dark-mode .remove-btn {
      background: rgba(30, 41, 59, 0.5);
      color: #94a3b8;
      border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 2px 8px;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }

    body.dark-mode .remove-btn:hover {
      background: rgba(30, 41, 59, 0.8);
      color: #e2e8f0;
    }

    /* 错题本和收藏夹容器基础样式 */
    .tab-container {
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
    }

    /* 白天模式 */
    body:not(.dark-mode) #tab-wrong {
      background: #fff1f0;
    }

    body:not(.dark-mode) #tab-fav {
      background: #fffbe6;
    }

    /* 夜晚模式 */
    body.dark-mode #tab-wrong {
      background: rgba(71, 27, 27, 0.3);
    }

    body.dark-mode #tab-fav {
      background: rgba(82, 72, 21, 0.3);
    }

    /* 列表容器样式 */
    #wrongbook-list, #favbook-list {
      overflow: hidden;
      border-radius: 8px;
    }

    /* 列表项样式 */
    .question-item {
      padding: 12px;
      margin-bottom: 8px;
      border-radius: 8px;
    }

    /* 白天模式列表项 */
    body:not(.dark-mode) .question-item {
      background: rgba(255, 255, 255, 0.8);
      border: 1px solid rgba(0, 0, 0, 0.1);
    }

    /* 夜晚模式列表项 */
    body.dark-mode .question-item {
      background: rgba(30, 41, 59, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: #94a3b8;
    }

    /* 清空按钮基础样式 */
    .clear-btn {
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }

    /* 白天模式按钮 */
    body:not(.dark-mode) .clear-btn {
      background: rgba(255, 255, 255, 0.8);
      border: 1px solid rgba(0, 0, 0, 0.1);
      color: #666;
    }

    body:not(.dark-mode) .clear-btn:hover {
      background: rgba(255, 255, 255, 0.9);
      color: #333;
    }

    /* 夜晚模式按钮 */
    body.dark-mode .clear-btn {
      background: rgba(30, 41, 59, 0.4);
      color: #94a3b8;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    body.dark-mode .clear-btn:hover {
      background: rgba(30, 41, 59, 0.6);
      color: #e2e8f0;
    }

    /* 移除按钮样式 */
    .remove-btn {
      padding: 2px 8px;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }

    /* 白天模式移除按钮 */
    body:not(.dark-mode) .remove-btn {
      background: rgba(255, 255, 255, 0.8);
      border: 1px solid rgba(0, 0, 0, 0.1);
      color: #666;
    }

    /* 夜晚模式移除按钮 */
    body.dark-mode .remove-btn {
      background: rgba(30, 41, 59, 0.4);
      color: #94a3b8;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    body.dark-mode .remove-btn:hover {
      background: rgba(30, 41, 59, 0.6);
      color: #e2e8f0;
    }

    /* 新增覆盖样式，确保夜间模式背景更深且与整体协调 */
    body.dark-mode #tab-wrong {
      background: rgba(255, 77, 79, 0.08) !important; /* 深红轻透明 */
    }
    body.dark-mode #tab-fav {
      background: rgba(250, 173, 20, 0.08) !important; /* 深黄轻透明 */
    }
    body.dark-mode #tab-wrong .question-item,
    body.dark-mode #tab-fav .question-item {
      background: rgba(255, 255, 255, 0.05) !important; /* 比容器更深一点 */
      color: #cbd5e1 !important;
    }
    body.dark-mode .clear-btn,
    body.dark-mode .remove-btn {
      background: rgba(255, 255, 255, 0.05) !important;
      border-color: rgba(255, 255, 255, 0.15) !important;
      color: #cbd5e1 !important;
    }
    /* 夜间模式-深色背景替换 */
    .dark #tab-wrong {
      background: linear-gradient(120deg, #2b2a30 0%, #1d1e24 100%) !important; /* 深灰带微红滤色 */
    }
    .dark #tab-fav {
      background: linear-gradient(120deg, #2b2a25 0%, #1d1c18 100%) !important; /* 深灰带微黄滤色 */
    }
    .dark #tab-wrong .question-item,
    .dark #tab-fav .question-item {
      background: rgba(255,255,255,0.04) !important;
      color:#d1d5db !important;
    }
    .dark #tab-wrong .clear-btn,
    .dark #tab-wrong .remove-btn,
    .dark #tab-fav .clear-btn,
    .dark #tab-fav .remove-btn {
      background: rgba(255,255,255,0.06) !important;
      color:#d1d5db !important;
      border-color: rgba(255,255,255,0.12) !important;
    }
    /* 夜间修正错题本/收藏夹列表项过亮问题 */
    .dark #tab-wrong .bg-red-50,
    .dark #tab-wrong .bg-red-100 {background: rgba(55, 27, 27, 0.35) !important;}
    .dark #tab-fav .bg-yellow-50,
    .dark #tab-fav .bg-yellow-100 {background: rgba(55, 48, 21, 0.35) !important;}
    .dark #tab-wrong .text-red-700 {color:#fca5a5 !important;}
    .dark #tab-fav .text-yellow-700 {color:#fde68a !important;}
    /* 夜间下移除按钮对比度增强 */
    .dark #tab-wrong .remove-btn {
      background: rgba(220, 38, 38, 0.25) !important; /* 深红半透明 */
      color: #fca5a5 !important;
      border-color: rgba(248, 113, 113, 0.4) !important;
    }
    .dark #tab-fav .remove-btn {
      background: rgba(202, 138, 4, 0.25) !important; /* 深黄半透明 */
      color: #fde68a !important;
      border-color: rgba(253, 224, 71, 0.4) !important;
    }
    /* 夜间下移除按钮对比度再提升 */
    .dark #tab-wrong .remove-btn {
      background: rgba(239, 68, 68, 0.25) !important; /* 更亮的红背景 */
      color: #fda4af !important; /* 浅红文字 */
      border-color: rgba(248, 113, 113, 0.7) !important;
      font-weight: 600 !important;
    }
    .dark #tab-wrong .remove-btn:hover {
      background: rgba(239, 68, 68, 0.4) !important;
    }
    .dark #tab-fav .remove-btn {
      background: rgba(253, 224, 71, 0.22) !important; /* 更亮的黄背景 */
      color: #fde68a !important; /* 浅黄文字 */
      border-color: rgba(253, 224, 71, 0.7) !important;
      font-weight: 600 !important;
    }
    .dark #tab-fav .remove-btn:hover {
      background: rgba(253, 224, 71, 0.38) !important;
    }
    /* 白天模式下容器背景与整体一致 */
    :not(.dark) #tab-wrong,
    :not(.dark) #tab-fav {
      background:#ffffff !important;
      box-shadow:0 1px 4px rgba(0,0,0,0.05) !important;
    }
    /* 白天模式下列表项背景改为纯白，添加左侧彩色标条区分 */
    :not(.dark) #tab-wrong .bg-red-50,
    :not(.dark) #tab-wrong .bg-red-100 {
      background:#ffffff !important;
      border-left:4px solid #f87171 !important;
    }
    :not(.dark) #tab-fav .bg-yellow-50,
    :not(.dark) #tab-fav .bg-yellow-100 {
      background:#ffffff !important;
      border-left:4px solid #fbbf24 !important;
    }
    :not(.dark) #tab-wrong .text-red-700 {color:#ef4444 !important;}
    :not(.dark) #tab-fav .text-yellow-700 {color:#f59e0b !important;}

    /* ===== Light mode accurate selectors ===== */
    html:not(.dark) #tab-wrong,
    body:not(.dark) #tab-wrong,
    html:not(.dark) #tab-fav,
    body:not(.dark) #tab-fav {
      background:#ffffff !important;
      box-shadow:0 1px 4px rgba(0,0,0,0.05) !important;
    }
    html:not(.dark) #tab-wrong .question-item,
    body:not(.dark) #tab-wrong .question-item {
      background:#ffffff !important;
      border-left:4px solid #ef4444 !important;
      color:#ef4444 !important;
    }
    html:not(.dark) #tab-fav .question-item,
    body:not(.dark) #tab-fav .question-item {
      background:#ffffff !important;
      border-left:4px solid #fbbf24 !important;
      color:#f59e0b !important;
    }
    html:not(.dark) #tab-wrong .remove-btn,
    body:not(.dark) #tab-wrong .remove-btn {
      background:rgba(239,68,68,0.15) !important;
      color:#ef4444 !important;
      border-color:rgba(248,113,113,0.4) !important;
    }
    html:not(.dark) #tab-fav .remove-btn,
    body:not(.dark) #tab-fav .remove-btn {
      background:rgba(253,224,71,0.15) !important;
      color:#f59e0b !important;
      border-color:rgba(253,224,71,0.4) !important;
    }

    /* ==== Dark theme containers harmonize with overall bg ==== */
    .dark #tab-wrong,
    .dark #tab-fav {
      background: rgba(38, 45, 60, 0.8) !important; /* 深蓝灰半透明，与主体一致 */
      border: 1px solid rgba(255,255,255,0.08) !important;
      box-shadow: 0 2px 8px rgba(0,0,0,0.4);
    }
    .dark #tab-wrong {border-left-color:#ef4444 !important;}
    .dark #tab-fav {border-left-color:#fbbf24 !important;}
    /* 列表项 */
    .dark #tab-wrong .question-item,
    .dark #tab-fav .question-item {
      background: rgba(255, 255, 255, 0.03) !important;
      border: 1px solid rgba(255,255,255,0.05) !important;
      border-radius: 8px;
    }
    .dark #tab-wrong .question-item::before,
    .dark #tab-fav .question-item::before {
      content:'';
      display:block;
      position:absolute;
      left:0;top:0;bottom:0;width:3px;
      border-radius:3px 0 0 3px;
    }
    .dark #tab-wrong .question-item::before {background:#ef4444;}
    .dark #tab-fav .question-item::before {background:#fbbf24;}
    /* 调整文本颜色 */
    .dark #tab-wrong .question-item {color:#fca5a5 !important;}
    .dark #tab-fav .question-item {color:#fde68a !important;}
    /* 移除按钮可见性 */
    .dark #tab-wrong .remove-btn {background:rgba(239,68,68,0.25) !important; color:#fda4af !important;}
    .dark #tab-fav .remove-btn {background:rgba(253,224,71,0.25) !important; color:#fde68a !important;}

    /* FINAL dark override */
    .dark #tab-wrong,
    .dark #tab-fav{
      background:rgba(31,41,55,0.9) !important; /* 深灰蓝 */
      backdrop-filter:blur(2px);
    }
    .dark #tab-wrong .question-item,
    .dark #tab-fav .question-item{background:rgba(255,255,255,0.04)!important;}

    /* Ultimate dark container rule */
    .dark #tab-wrong,
    .dark #tab-fav{
      background-color:#1e273b !important; /* 统一深色 */
      background-image:none !important;    /* 取消渐变 */
      border:1px solid rgba(255,255,255,0.06) !important;
    }
    /* 夜间清空按钮颜色恢复 */
    .dark .clear-btn{
      background:rgba(255,255,255,0.08) !important;
      color:#cbd5e1 !important;
      border-color:rgba(255,255,255,0.15) !important;
    }

    /* 强制夜间卡片背景与题库管理一致 */
    .dark #tab-wrong.draggable-cat,
    .dark #tab-fav.draggable-cat {
      background: rgba(31,41,55,0.92) !important;
      border: 1.5px solid #334155 !important;
      box-shadow: 0 6px 24px rgba(0,0,0,0.4);
      background-image: none !important;
    }

    /* 作者署名样式 */
    .author-signature {
      position: absolute;
      left: 16px;
      top: 10px;
      font-family: 'Noto Sans SC', sans-serif;
      font-size: 14.5px;
      color: #666;
      opacity: 0.92;
      pointer-events: none;
      letter-spacing: 0.03em;
      font-weight: 400;
      transition: all 0.3s ease;
      padding: 4px 8px;
      border-radius: 4px;
      background: linear-gradient(120deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 100%);
      display: flex;
      align-items: center;
      gap: 2px;
    }
    .author-signature::before {
      content: 'By：';
      font-family: 'Noto Serif SC', serif;
      font-weight: 600;
      font-style: normal;
      letter-spacing: 0;
    }
    .author-signature span {
      font-family: 'Noto Serif SC', serif;
      font-weight: 500;
      background: linear-gradient(120deg, #666 0%, #888 100%);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      position: relative;
      top: 0.5px;
    }
    /* 夜间模式署名样式 */
    .dark .author-signature {
      color: #94a3b8;
      background: linear-gradient(120deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0) 100%);
    }
    .dark .author-signature span {
      background: linear-gradient(120deg, #94a3b8 0%, #cbd5e1 100%);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    /* 深色模式下学习统计占位文字颜色 */
    .dark #stats-placeholder h3 {
      color: #ffffff !important;
    }
    .dark #stats-placeholder p {
      color: #cccccc !important;
    }
    /* 可见性增强：答题选项圆点（白天/夜晚 & 锁定状态） */
    .custom-radio { position: relative; }
    .custom-radio input[type="radio"],
    .custom-radio input[type="checkbox"] {
      position: absolute;
      inset: 0;
      margin: 0;
      opacity: 0;
      pointer-events: none;
    }
    .custom-radio .radio-dot {
      width: 1rem;
      height: 1rem;
      border-radius: 9999px;
      border: 2px solid #cbd5e1; /* slate-300 */
      flex-shrink: 0;
      transition: background-color .2s, border-color .2s, box-shadow .2s;
    }
    /* 选中时颜色 */
    .custom-radio input:checked + .radio-dot {
      background-color: #6366f1; /* indigo-500 */
      border-color: #6366f1;
    }
    /* 锁定后仍保持高亮，增加外圈阴影以提升可见性 */
    .custom-radio.locked input:checked + .radio-dot {
      background-color: #6366f1;
      border-color: #6366f1;
      box-shadow: 0 0 0 2px #c7d2fe;
    }
    /* 夜间主题颜色调整 */
    .dark .custom-radio .radio-dot {
      border-color: #475569; /* slate-600 */
    }
    .dark .custom-radio input:checked + .radio-dot {
      background-color: #a5b4fc; /* indigo-300 */
      border-color: #a5b4fc;
    }
    .dark .custom-radio.locked input:checked + .radio-dot {
      background-color: #a5b4fc;
      border-color: #a5b4fc;
      box-shadow: 0 0 0 2px #3730a3;
    }
    /* 题号更醒目 */
    .question-number {
      color: #4338ca !important; /* 深靛蓝，日间 */
      font-weight: bold;
      font-size: 1.1em;
      letter-spacing: 0.02em;
      text-shadow: 0 1px 2px #e0e7ff88;
      transition: color 0.2s;
    }
    .dark .question-number {
      color: #a5b4fc !important; /* 夜间亮紫蓝 */
      text-shadow: 0 1px 4px #1e293b88;
    }
    /* === 错题本 & 收藏夹 夜间配色优化 === */
    .dark .wrong-cat, .dark .wrong-lib {
      background: #1e293b !important; /* slate-800 */
      border-color: #b91c1c !important; /* red-700 accent */
    }
    .dark .wrong-lib {
      background: #27324a !important; /* slightly lighter for depth */
    }
    .dark .wrong-cat .text-red-400, .dark .wrong-lib .text-red-600,
    .dark .wrong-cat .text-red-600, .dark .wrong-lib .text-red-400 {
      color: #f87171 !important; /* red-400 */
    }
    .dark .fav-cat, .dark .fav-lib {
      background: #1e293b !important; /* slate-800 */
      border-color: #b45309 !important; /* amber-700 accent */
    }
    .dark .fav-lib {
      background: #27324a !important;
    }
    .dark .fav-cat .text-yellow-400, .dark .fav-lib .text-yellow-600,
    .dark .fav-cat .text-yellow-600, .dark .fav-lib .text-yellow-400 {
      color: #fbbf24 !important; /* amber-400 */
    }
    /* 调整删除/播放等按钮hover颜色在夜间不过亮 */
    .dark .wrong-cat button:hover, .dark .wrong-lib button:hover {
      background: #7f1d1d33 !important;
    }
    .dark .fav-cat button:hover, .dark .fav-lib button:hover {
      background: #b4530933 !important;
    }
    /* 进一步覆盖可能残留的浅色背景类 */
    .dark .wrong-cat .bg-red-50, .dark .wrong-cat .bg-red-50\/50,
    .dark .wrong-lib .bg-red-50, .dark .wrong-lib .bg-red-50\/50 {
      background: #27324a !important;
    }
    .dark .fav-cat .bg-yellow-50, .dark .fav-cat .bg-yellow-50\/50,
    .dark .fav-lib .bg-yellow-50, .dark .fav-lib .bg-yellow-50\/50 {
      background: #27324a !important;
    }
    /* 强制覆盖残留浅色背景（Wrong/Fav 卡片）*/
    .dark .wrong-cat,
    .dark .wrong-cat *[class*='bg-'],
    .dark .wrong-lib,
    .dark .wrong-lib *[class*='bg-']{
      background-color:#1f2937 !important;
    }
    .dark .fav-cat,
    .dark .fav-cat *[class*='bg-'],
    .dark .fav-lib,
    .dark .fav-lib *[class*='bg-']{
      background-color:#1f2937 !important;
    }
    /* 笔记按钮样式 */
    #note-btn {
      cursor:pointer;
    }
    .dark #note-btn svg {fill:#a5b4fc;}
    
    /* 夜间模式笔记窗口样式 */
    html.dark #note-modal .note-draggable {
      background: #1f2937 !important;
      border-color: #475569 !important;
    }
    html.dark #note-editor {
      background: #111827;
      color: #e5e7eb; /* 默认文字色，可被Quill inline样式覆盖 */
      border-color: #475569;
    }
    html.dark #note-toolbar {
      background: #374151 !important;
    }
    html.dark .note-tool {
      background: #1f2937 !important;
      color: #a5b4fc !important;
      border-color: #475569 !important;
    }
    html.dark #note-preview-toggle {
      background: #4f46e5 !important;
    }
    html.dark #note-save {
      background: #4f46e5 !important;
    }
    html.dark #note-delete {
      background: #1f2937 !important;
      color: #f87171 !important;
      border-color: #7f1d1d !important;
    }

      /* 弹窗背景样式 */
  .modal-bg {
    background-color: rgba(0, 0, 0, 0.3);
    backdrop-filter: blur(2px);
  }
  .dark .modal-bg {
    background-color: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(3px);
  }
  
  /* 分类选择弹窗增强样式 */
  #category-modal .bg-white.dark\:bg-gray-800 {
    box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.1);
  }
  
  .dark #category-modal .bg-white.dark\:bg-gray-800 {
    background: #1b2838 !important; /* 精准匹配截图中的深蓝色背景 */
    box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5) !important;
    border: none !important;
    color: white !important;
  }
  
  /* 确保标题文字显示正确 */
  .dark #category-modal .text-black {
    color: white !important;
  }
  
  #category-modal .text-black {
    color: black;
  }
  
  .dark #category-modal .fas {
    font-size: 1.1rem;
  }
  
  /* 夜间模式下的表单控件增强 */
  .dark #category-select,
  .dark #category-input {
    background-color: #2a3b52 !important; /* 稍微亮一点的深蓝色 */
    border: none !important;
    color: #ffffff !important;
    box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.15) !important;
    font-size: 1rem !important;
  }
  
  .dark #category-select:focus,
  .dark #category-input:focus {
    border: none !important;
    box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.15), 0 0 0 2px rgba(99, 102, 241, 0.25) !important;
  }
  
  /* 夜间模式下占位符文本颜色 */
  .dark #category-input::placeholder {
    color: #a0aec0 !important;
  }
  
  /* 夜间模式下的按钮样式精确匹配 */
  .dark #category-cancel {
    background-color: #ffffff !important;
    color: #1e293b !important;
    font-weight: 500 !important;
    border: none !important;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1) !important;
  }
  
  .dark #category-confirm {
    background-color: #6366f1 !important;
    border: none !important;
    font-weight: 500 !important;
    box-shadow: 0 2px 5px rgba(99, 102, 241, 0.3) !important;
  }
  
  /* 夜间模式下的标签文字颜色 */
  .dark #category-modal label {
    color: #94a3b8 !important;
  }

    /* 可拖动弹窗样式 */
    .note-draggable {
      position: absolute;
      transform: translate(-50%, -50%);
      left: 50%;
      top: 50%;
      transition: none;
    }

    .drag-handle {
      cursor: move;
      user-select: none;
      position: relative;
    }

    .drag-handle::before {
      content: '';
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 100%;
      height: 10px;
      background: linear-gradient(to right, #e0e7ff 5%, transparent 5%, transparent 95%, #e0e7ff 95%);
      background-size: 14px 2px;
      background-repeat: repeat-x;
      opacity: 0.5;
      pointer-events: none;
    }

    .dark .drag-handle::before {
      background: linear-gradient(to right, #4b5563 5%, transparent 5%, transparent 95%, #4b5563 95%);
      background-size: 14px 2px;
      background-repeat: repeat-x;
    }

    /* 笔记窗口的普通模式 */
    .note-panel {
      background-color: #ffffff; /* 白天模式背景 */
      color: #333333; /* 白天模式文字颜色 */
    }

    /* 笔记窗口的夜间模式 */
    .dark .note-panel {
      background-color: rgba(30, 30, 30, 0.95); /* 深色背景 */
      color: #e0e0e0; /* 深色模式文字颜色 */
    }

    /* 其他元素的样式 */
    .dark .note-panel button {
      background-color: #4a90e2; /* 深色模式按钮背景 */
      color: white; /* 深色模式按钮文字颜色 */
    }

    .dark .note-panel button:hover {
      background-color: #357abd; /* 深色模式按钮悬停效果 */
    }

    /* 添加夜间模式样式 */
    /* 笔记窗口夜间模式样式 */
    html.dark #note-modal .note-draggable {
      background: #1f2937 !important;
      border-color: #475569 !important;
    }
    
    html.dark #note-editor {
      background: #111827;
      color: #e5e7eb;
      border-color: #475569;
    }
    
    html.dark #note-toolbar {
      background: #374151 !important;
    }
    
    html.dark .note-tool {
      background: #1f2937 !important;
      color: #a5b4fc !important;
      border-color: #475569 !important;
    }
    
    html.dark #note-preview-toggle {
      background: #4f46e5 !important;
    }
    
    html.dark #note-save {
      background: #4f46e5 !important;
    }
    
    html.dark #note-delete {
      background: #1f2937 !important;
      color: #f87171 !important;
      border-color: #7f1d1d !important;
    }
    
    html.dark #note-close {
      color: #9ca3af;
    }
    
    html.dark #note-close:hover {
      background-color: #374151;
    }
    
    html.dark #note-toolbar {
      background-color: #1f2937;
    }
    
    html.dark .note-tool {
      background-color: #374151;
      border-color: #4b5563;
      color: #e5e7eb;
    }
    
    html.dark .note-tool:hover {
      background-color: #4b5563;
    }
    
    html.dark #note-preview-toggle {
      background-color: #4f46e5;
    }
    
    html.dark #note-preview-toggle:hover {
      background-color: #4338ca;
    }
    
    html.dark #note-editor {
      background-color: #1f2937;
      border-color: #4b5563;
      color: #e5e7eb;
    }
    
    html.dark #note-preview {
      background-color: #111827;
      border-color: #4b5563;
      color: #e5e7eb;
    }
    
    html.dark #note-save {
      background-color: #4f46e5;
    }
    
    html.dark #note-save:hover {
      background-color: #4338ca;
    }
    
    html.dark #note-delete {
      background-color: #1f2937;
      border-color: #7f1d1d;
      color: #ef4444;
    }
    
    html.dark #note-delete:hover {
      background-color: #7f1d1d;
      color: #fca5a5;
    }

    /* 夜间模式下笔记窗口字体颜色优化 - 移除 !important 以允许 Quill 行内颜色生效 */
    html.dark #note-modal .note-draggable {
      color:#e5e7eb;
    }
    html.dark #note-modal .note-draggable .note-tool {
      color: #a5b4fc !important;
    }
    html.dark #note-modal .note-draggable .text-indigo-700 {
      color: #a5b4fc !important;
    }
    html.dark #note-modal .note-draggable .text-gray-500 {
      color: #cbd5e1 !important;
    }
    html.dark #note-modal .note-draggable .text-indigo-500 {
      color: #818cf8 !important;
    }
    html.dark #note-modal .note-draggable .text-indigo-600 {
      color: #818cf8 !important;
    }
    html.dark #note-modal .note-draggable .text-indigo-400 {
      color: #a5b4fc !important;
    }
    /* 夜间模式下笔记窗口顶部虚线分割线颜色优化 */
    html.dark #note-modal .note-draggable .border-b {
      border-bottom-color: #334155 !important;
      border-bottom-style: dashed !important;
    }
    html.dark #note-modal .note-draggable .drag-handle::before {
      background: linear-gradient(to right, #334155 5%, transparent 5%, transparent 95%, #334155 95%) !important;
    }
    /* 隐藏笔记窗口顶部虚线分割线 */
    #note-modal .note-draggable .drag-handle::before {
      display: none !important;
    }

    /* 优化夜间模式下笔记窗口字体颜色覆盖，避免影响按钮和编辑器内容 */
    html.dark #note-modal .note-draggable {
      color: #e5e7eb !important;
    }
    /* 恢复按钮原有颜色 */
    html.dark #note-modal .note-draggable .note-tool {
      color: #a5b4fc !important;
      background-color: #1f2937 !important;
      border-color: #475569 !important;
    }
    html.dark #note-modal .note-draggable .note-tool:hover {
      background-color: #374151 !important;
    }
    /* 恢复编辑器内容的列表样式和颜色 */
    html.dark #note-editor ol,
    html.dark #note-editor ul {
      color: #e5e7eb !important;
      list-style-position: inside !important;
    }
    html.dark #note-editor li {
      color: #e5e7eb !important;
    }

    /* 隐藏旧的自定义笔记工具栏（已被Quill替代） */
    #note-toolbar{display:none!important;}

    /* Quill 编辑器自定义样式 - 亮色模式 */
    body:not(.dark) .ql-toolbar.ql-snow{
      background:#f9fafb;
      border:1px solid #e5e7eb;
      border-radius:0.75rem;
      padding:4px 8px;
      margin-bottom:8px;
    }
    body:not(.dark) .ql-container.ql-snow{
      border:1px solid #e5e7eb;
      border-radius:0.75rem;
    }
    /* Quill 编辑器自定义样式 - 暗色模式 */
    html.dark .ql-toolbar.ql-snow{
      background:#374151;
      border:1px solid #475569;
      border-radius:0.75rem;
      padding:4px 8px;
      margin-bottom:8px;
    }
    html.dark .ql-container.ql-snow{
      border:1px solid #475569;
      border-radius:0.75rem;
    }
    html.dark .ql-toolbar .ql-stroke{stroke:#e5e7eb;}
    html.dark .ql-toolbar .ql-fill{fill:#e5e7eb;}
    html.dark .ql-toolbar .ql-picker{color:#e5e7eb;}
    /* 设置编辑区域最小高度 */
    #note-editor .ql-editor{
      max-height:70vh !important;
      min-height:40vh !important;
    }
    #md-editor,#md-preview{max-height:50vh;overflow-y:auto;}
    #note-modal .note-draggable{max-height:90vh;display:flex;flex-direction:column;}
    #note-modal .note-draggable>div.flex-1{flex:1;overflow:hidden;}
    #md-wrapper{height:auto !important;min-height:45vh !important;}
    /* Quill 工具栏额外控件（模式选择 & 预览）样式 */
    .ql-toolbar .toolbar-extras{
      margin-left:auto; /* 推到最右 */
      display:flex;
      align-items:center;
      gap:8px;
    }
    /* 统一按钮/选择框样式 - 亮色 */
    body:not(.dark) #note-mode-select,
    body:not(.dark) #md-preview-toggle{
      background:#f9fafb;
      border:1px solid #e5e7eb;
      color:#374151;
      border-radius:0.375rem;
      padding:4px 8px;
      height:32px;
      transition:background-color .2s, color .2s;
    }
    body:not(.dark) #note-mode-select:hover,
    body:not(.dark) #md-preview-toggle:hover{
      background:#f3f4f6;
    }
    /* 统一按钮/选择框样式 - 暗色 */
    html.dark #note-mode-select,
    html.dark #md-preview-toggle{
      background:#374151;
      border:1px solid #475569;
      color:#e5e7eb;
    }
    html.dark #note-mode-select:hover,
    html.dark #md-preview-toggle:hover{
      background:#4b5563;
    }
    /* 移除 select 默认箭头，使用统一样式 */
    #note-mode-select{
      appearance:none;
      -moz-appearance:none;
      -webkit-appearance:none;
      padding-right:1.75rem; /* 留出空间显示箭头 */
      position:relative;
    }
    /* 自定义下拉箭头 */
    #note-mode-select::after{
      content:'\25BC';
      position:absolute;
      right:0.6rem;
      top:50%;
      transform:translateY(-50%);
      pointer-events:none;
      font-size:0.6rem;
    }
    /* 确保按钮内图标垂直居中 */
    #md-preview-toggle i{pointer-events:none;}

    /* 调整眼睛按钮尺寸并强制居中 */
    #md-preview-toggle{
      width:32px;
      height:32px;
      padding:0;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    #md-preview-toggle i{font-size:16px;}

    /* 调整下拉框内文字水平垂直居中 */
    #note-mode-select{
      padding:0 12px;
      height:32px;
      line-height:32px;
      text-align:center;
      border:none !important;
      outline:none !important;
      box-shadow:none !important;
      background:#374151 !important;
      color:#e5e7eb !important;
    }

    /* 深色模式 Markdown 编辑框背景保持一致 */
    html.dark #md-editor:not(.hidden){
      background:#374151 !important;
      color:#e5e7eb !important;
    }
    html.dark #md-preview:not(.hidden){
      background:#374151 !important;
      color:#e5e7eb !important;
    }
    /* 统一 extras 按钮在暗色下的背景及无边框 */
    html.dark #md-preview-toggle,
    html.dark #note-mode-select{
      background:#475569 !important;
      border:none !important;
    }
    body:not(.dark) #md-preview-toggle,
    body:not(.dark) #note-mode-select{
      background:#e5e7eb !important;
      border:none !important;
      color:#374151 !important;
    }
    /* 重设工具栏额外控件背景 - 明/暗主题匹配 Quill */
    .ql-toolbar .toolbar-extras>*{margin-left:8px;}
    .ql-toolbar .toolbar-extras>*:first-child{margin-left:0;}

    body:not(.dark) #md-preview-toggle,
    body:not(.dark) #note-mode-select{
      background:#f9fafb !important;
      color:#374151 !important;
      border:none !important;
    }
    html.dark #md-preview-toggle,
    html.dark #note-mode-select{
      background:#374151 !important;
      color:#e5e7eb !important;
      border:none !important;
    }

    /* —— 模式切换按钮 —— */
    .mode-btn{
      border:none;
      border-radius:0.375rem;
      height:32px;
      padding:0 14px;
      font-size:14px;
      line-height:32px;
      cursor:pointer;
      transition:background-color .2s,color .2s;
    }
    body:not(.dark) .mode-btn{background:#f9fafb;color:#374151;}
    body:not(.dark) .mode-btn:hover{background:#e5e7eb;}
    html.dark .mode-btn{background:#374151;color:#e5e7eb;}
    html.dark .mode-btn:hover{background:#4b5563;}
    .mode-btn.active{background:#6366f1!important;color:#ffffff!important;}

    /* 分段控件外框 */
    .mode-group{
      display:flex;
      border:1px solid rgba(255,255,255,0.08);
      border-radius:0.5rem;
      overflow:hidden;
    }
    body:not(.dark) .mode-group{border-color:#d1d5db;}
    html.dark .mode-group{border-color:#475569;}

    .mode-group .mode-btn{
      border-radius:0; /* 由外框控制圆角 */
      min-width:72px;
    }
    .mode-group .mode-btn:first-child{border-top-left-radius:0.5rem;border-bottom-left-radius:0.5rem;}
    .mode-group .mode-btn:last-child{border-top-right-radius:0.5rem;border-bottom-right-radius:0.5rem;}
    /* 取消左右间隙 */
    .toolbar-extras>*{margin-left:12px;}
    .toolbar-extras .mode-group{margin-left:0;}

    /* 单一模式切换按钮 (Text⇄MD) */
    .mode-toggle{
      height:32px;min-width:72px;
      padding:0 16px;
      border-radius:0.5rem;
      border:none;
      cursor:pointer;
      font-size:15px;
      font-weight:500;
      transition:background-color .2s,color .2s;
    }
    body:not(.dark) .mode-toggle{background:#f9fafb;color:#374151;}
    body:not(.dark) .mode-toggle:hover{background:#e5e7eb;}
    html.dark .mode-toggle{background:#374151;color:#e5e7eb;}
    html.dark .mode-toggle:hover{background:#4b5563;}
    .mode-toggle.active{background:#6366f1!important;color:#ffffff!important;}

    /* ----- Typora-aligned Markdown 预览排版 ----- */
    #md-preview.markdown-body{
      background:#374151; /* 深色背景与编辑一致 */
      border:1px solid #475569;
      border-radius:.75rem;
      padding:.75rem;
      white-space:pre-line; /* 保留原文硬/软换行 */
    }
    #md-preview.markdown-body:before{content:none!important;} /* 取消黄色装饰条 */
    #md-preview.markdown-body p{margin:.7em 0;}
    #md-preview.markdown-body ul,#md-preview.markdown-body ol{margin:.5em 0 .5em 1.4em;}
    #md-preview.markdown-body li{margin:.3em 0;}
  </style>
  <!-- Typora-aligned override for Markdown preview -->
  <style id="md-preview-fix">
    #md-preview.markdown-body{
      background:#374151;
      border:1px solid #475569;
      border-radius:.75rem;
      padding:.75rem;
      white-space:pre-line;
    }
    #md-preview.markdown-body:before{content:none!important;}
    #md-preview.markdown-body p{margin:.7em 0;}
    #md-preview.markdown-body ul,
    #md-preview.markdown-body ol{margin:.5em 0 .5em 1.4em;}
    #md-preview.markdown-body li{margin:.3em 0;}
  </style>
  <style id="md-preview-li-fix">
    /* 恢复列表项内部段距，确保 Markdown 段内空行可见 */
    #md-preview.markdown-body li p { margin: .6em 0 !important; }
    /* 调整列表项自身的上下间距 */
    #md-preview.markdown-body li     { margin: .4em 0 !important; }
  </style>
  <!-- 解决 Markdown 预览额外空行：覆盖 white-space 设置 -->
  <style id="md-preview-overrides">
    /* 遵循 Markdown 默认段落处理，取消 pre-line 造成的软回车换行 */
    #md-preview.markdown-body {
      white-space: normal !important;
    }
  </style>
  
  <style id="scroll-list-styles">/* 滚动容器定制窄滚动条，滚动条覆盖在内容之上且不压缩内容 */ .scroll-list { position: relative; box-sizing: border-box; scrollbar-width: thin; /* 使用overlay模式让滚动条覆盖在内容上方，不占用内容空间 */ overflow-y: overlay; } .scroll-list::-webkit-scrollbar { width: 8px; } .scroll-list::-webkit-scrollbar-thumb { background: #c7d2fe; border-radius: 4px; } /* 确保卡片在滚动区域内保持完整宽度 */ .scroll-list .draggable-lib { width: calc(100% - 8px); /* 减去滚动条宽度 */ min-width: 0; /* 允许收缩到父容器宽度 */ } /* 给滚动区域右侧添加渐变阴影，提示可滚动 */ .scroll-list::after { content: ''; position: absolute; top: 0; right: 0; width: 8px; height: 100%; background: linear-gradient(to left, rgba(255,255,255,.7), rgba(255,255,255,0)); pointer-events: none; } .dark .scroll-list::after { background: linear-gradient(to left, rgba(30,41,59,.7), rgba(30,41,59,0)); }</style>
  <!-- 笔记编辑区尺寸覆盖，提高可见高度 -->
  <style id="note-size-override">
    #note-editor .ql-editor{
      max-height:70vh !important;
    }
    #md-editor,
    #md-preview,
    #md-wrapper{
      max-height:70vh !important;
    }
    /* 调大 Markdown 包装初始高度 */
    #md-wrapper{
      height:auto !important;
      min-height:45vh !important;
    }
    /* Quill 容器也需要最小高度 */
    #note-editor{
      min-height:45vh !important;
    }
  </style>
  <!-- Note modal fixed size & internal scrolling -->
  <style id="note-modal-fixed-size">
    #note-modal .note-draggable{
      height:80vh !important; /* 固定整体高度 */
      max-height:80vh !important;
      display:flex;
      flex-direction:column;
    }
    /* 工具栏、按钮区维持固有高度；编辑区占满剩余空间 */
    #note-editor,
    #md-wrapper{
      flex:1 1 0%;
      min-height:0 !important; /* 允许收缩 */
      max-height:none !important;
      overflow:auto !important; /* 超出滚动 */
    }
  </style>
  <!-- Quill 富文本编辑器 -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

  <!-- 统一颜色 / 高亮按钮外观 -->
  <style id="quill-pickers-unified">
    /* 统一外观 */
    #note-modal .ql-toolbar .ql-picker.ql-color > .ql-picker-label,
    #note-modal .ql-toolbar .ql-picker.ql-background > .ql-picker-label {
      width:32px;height:32px;border-radius:50%;
      display:flex;align-items:center;justify-content:center;
      margin-right:4px;background:#f3f4f6!important;border:none;cursor:pointer;position:relative;
    }
    html.dark #note-modal .ql-toolbar .ql-picker.ql-color > .ql-picker-label,
    html.dark #note-modal .ql-toolbar .ql-picker.ql-background > .ql-picker-label {
      background:#374151!important;
    }
    /* 去掉Quill注入 SVG */
    #note-modal .ql-toolbar .ql-picker.ql-color svg,
    #note-modal .ql-toolbar .ql-picker.ql-background svg {display:none!important;}
    /* FontAwesome icon */
    #note-modal .ql-toolbar .ql-picker.ql-color   > .ql-picker-label::before {
      content:"\f031";
    }
    #note-modal .ql-toolbar .ql-picker.ql-background > .ql-picker-label::before {
      content:"\f591";
    }
    #note-modal .ql-toolbar .ql-picker.ql-color > .ql-picker-label::before,
    #note-modal .ql-toolbar .ql-picker.ql-background > .ql-picker-label::before {
      font-family:"Font Awesome 6 Free";font-weight:900;font-size:15px;
      color:#374151;position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
    }
    html.dark #note-modal .ql-toolbar .ql-picker.ql-color > .ql-picker-label::before,
    html.dark #note-modal .ql-toolbar .ql-picker.ql-background > .ql-picker-label::before {color:#e5e7eb;}
    /* hover */
    #note-modal .ql-toolbar .ql-picker.ql-color > .ql-picker-label:hover,
    #note-modal .ql-toolbar .ql-picker.ql-background > .ql-picker-label:hover {background:#e5e7eb!important;}
    html.dark #note-modal .ql-toolbar .ql-picker.ql-color > .ql-picker-label:hover,
    html.dark #note-modal .ql-toolbar .ql-picker.ql-background > .ql-picker-label:hover {background:#4b5563!important;}
    /* active */
    #note-modal .ql-toolbar .ql-picker.ql-color.ql-expanded   > .ql-picker-label,
    #note-modal .ql-toolbar .ql-picker.ql-background.ql-expanded > .ql-picker-label,
    #note-modal .ql-toolbar .ql-picker.ql-color .ql-picker-label.ql-active,
    #note-modal .ql-toolbar .ql-picker.ql-background .ql-picker-label.ql-active {background:#6366f1!important;}
    #note-modal .ql-toolbar .ql-picker.ql-color.ql-expanded   > .ql-picker-label::before,
    #note-modal .ql-toolbar .ql-picker.ql-background.ql-expanded > .ql-picker-label::before,
    #note-modal .ql-toolbar .ql-picker.ql-color .ql-picker-label.ql-active::before,
    #note-modal .ql-toolbar .ql-picker.ql-background .ql-picker-label.ql-active::before {color:#fff;}
    /* highlight left spacing */
    #note-modal .ql-toolbar .ql-picker.ql-background {margin-left:4px;}
    /* 高亮按钮与颜色按钮间隔 4px */
    #note-modal .ql-toolbar .ql-picker.ql-background{margin-left:4px;}

    /* === 对齐 & 边框修正 === */
    #note-modal .ql-toolbar .ql-picker.ql-color,
    #note-modal .ql-toolbar .ql-picker.ql-background{
      display:inline-flex !important;      /* 让整体在 flex 容器中垂直居中 */
      align-items:center;                  /* label 居中 */
      vertical-align:middle;               /* 避免基线偏差导致上下不齐 */
      box-sizing:border-box;
      border:1px solid #d1d5db;            /* 日间边框 */
    }
    html.dark #note-modal .ql-toolbar .ql-picker.ql-color,
    html.dark #note-modal .ql-toolbar .ql-picker.ql-background{
      border:1px solid #4b5563;            /* 夜间边框 */
    }
    /* —— wrapper单圆形化，去掉多余方框 —— */
    #note-modal .ql-toolbar .ql-picker.ql-color,
    #note-modal .ql-toolbar .ql-picker.ql-background{
      width:32px!important;height:32px!important;border-radius:50%!important;
      padding:0!important;background:transparent!important;border:none!important;
      display:inline-flex!important;align-items:center!important;justify-content:center!important;
    }
    /* === final uniform picker override === */
    /* 外层恢复默认尺寸，保留左右 8px 间隔 */
    #note-modal .ql-toolbar .ql-picker.ql-color,
    #note-modal .ql-toolbar .ql-picker.ql-background {
      padding:0 8px;               /* Quill 默认 */
      width:auto!important;
      height:auto!important;
      background:transparent!important;
      border:none!important;
      display:inline-flex!important;
      align-items:center!important;
    }
    /* 内层 label 32px 圆形（始终可见） */
    #note-modal .ql-toolbar .ql-picker.ql-color   > .ql-picker-label,
    #note-modal .ql-toolbar .ql-picker.ql-background > .ql-picker-label {
      width:32px;height:32px;border-radius:50%;
      display:flex;align-items:center;justify-content:center;
      background:#ffffff!important;border:1px solid #d1d5db!important;
    }
    html.dark #note-modal .ql-toolbar .ql-picker.ql-color   > .ql-picker-label,
    html.dark #note-modal .ql-toolbar .ql-picker.ql-background > .ql-picker-label {
      background:#374151!important;border:1px solid #4b5563!important;
    }
    /* hover / active */
    #note-modal .ql-toolbar .ql-picker.ql-color   > .ql-picker-label:hover,
    #note-modal .ql-toolbar .ql-picker.ql-background > .ql-picker-label:hover {
      background:#e5e7eb!important;
    }
    html.dark #note-modal .ql-toolbar .ql-picker.ql-color   > .ql-picker-label:hover,
    html.dark #note-modal .ql-toolbar .ql-picker.ql-background > .ql-picker-label:hover {
      background:#4b5563!important;
    }
    #note-modal .ql-toolbar .ql-picker.ql-color.ql-expanded   > .ql-picker-label,
    #note-modal .ql-toolbar .ql-picker.ql-background.ql-expanded > .ql-picker-label,
    #note-modal .ql-toolbar .ql-picker.ql-color   .ql-picker-label.ql-active,
    #note-modal .ql-toolbar .ql-picker.ql-background .ql-picker-label.ql-active {
      background:#6366f1!important;color:#fff!important;
    }
    /*  图标颜色在 active 状态下已由 Quill 自动设定为白色，这里不再额外处理 */
  </style>
  <style id="quill-picker-shade">
  /* --- match default Quill button shading --- */
  /* 亮色：稍深灰底 + subtle inner shadow */
  body:not(.dark) #note-modal .ql-toolbar .ql-picker.ql-color > .ql-picker-label,
  body:not(.dark) #note-modal .ql-toolbar .ql-picker.ql-background > .ql-picker-label{
    background:#e5e7eb!important;/* 与其它按钮一致 */
    box-shadow: inset 0 0 0 1px rgba(0,0,0,0.05);
    border:1px solid #d1d5db!important;
  }
  /* 暗色：与其它按钮一致的稍亮灰圆 & 内阴影 */
  html.dark #note-modal .ql-toolbar .ql-picker.ql-color   > .ql-picker-label,
  html.dark #note-modal .ql-toolbar .ql-picker.ql-background > .ql-picker-label{
    background:#4b5563!important; /* 比工具栏深一阶 */
    box-shadow: inset 0 0 0 1px rgba(255,255,255,0.05);
    border:1px solid #4b5563!important;
  }
  /* 悬停时仅边框 & 阴影提亮，保持与其他按钮一致 */
  body:not(.dark) #note-modal .ql-toolbar .ql-picker.ql-color > .ql-picker-label:hover,
  body:not(.dark) #note-modal .ql-toolbar .ql-picker.ql-background > .ql-picker-label:hover{
    background:#d1d5db!important;
  }
  html.dark #note-modal .ql-toolbar .ql-picker.ql-color   > .ql-picker-label:hover,
  html.dark #note-modal .ql-toolbar .ql-picker.ql-background > .ql-picker-label:hover{
    background:#6b7280!important; /* slate-500 */
  }
  </style>
  <style id="quill-picker-final-override">
    /* Light-mode default background & hover (sync with other buttons) */
    body:not(.dark) #note-modal .ql-toolbar .ql-picker.ql-color > .ql-picker-label,
    body:not(.dark) #note-modal .ql-toolbar .ql-picker.ql-background > .ql-picker-label{
      background:#ffffff !important;
      border:1px solid #e5e7eb !important; /* subtle outline */
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.03);
    }
    body:not(.dark) #note-modal .ql-toolbar .ql-picker.ql-color > .ql-picker-label:hover,
    body:not(.dark) #note-modal .ql-toolbar .ql-picker.ql-background > .ql-picker-label:hover{
      background:#f3f4f6 !important;
    }
    /* Dark-mode default & hover */
    html.dark #note-modal .ql-toolbar .ql-picker.ql-color > .ql-picker-label,
    html.dark #note-modal .ql-toolbar .ql-picker.ql-background > .ql-picker-label{
      background:#374151 !important;
      border:1px solid #4b5563 !important;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.05);
    }
    html.dark #note-modal .ql-toolbar .ql-picker.ql-color > .ql-picker-label:hover,
    html.dark #note-modal .ql-toolbar .ql-picker.ql-background > .ql-picker-label:hover{
      background:#4b5563 !important;
    }
  </style>
  <style id="quill-picker-size-fix">
    /* shrink pickers to match other buttons */
    #note-modal .ql-toolbar .ql-picker.ql-color,
    #note-modal .ql-toolbar .ql-picker.ql-background{
      padding:0 !important;              /* remove extra horizontal paddings */
    }
    #note-modal .ql-toolbar .ql-picker.ql-color > .ql-picker-label,
    #note-modal .ql-toolbar .ql-picker.ql-background > .ql-picker-label{
      width:28px !important;
      height:28px !important;
    }
  </style>
  <!-- 取消紧凑模式样式，始终保持统一卡片尺寸 -->
  <style id="card-size-lock">
    /* 题库卡片保持统一尺寸与上下留白 */
    .draggable-lib {
      min-height: 96px;
      padding: 16px 20px;
      display: flex;
      flex-direction: column;
      width: 100%;
      box-sizing: border-box;
      flex-shrink: 0;
    }
    
    /* 重要：修复滚动区域卡片被压缩的问题 */
    .scroll-list > .draggable-lib,
    .scroll-list > div {
      width: calc(100% - 12px) !important;
      margin-right: 4px;
    }
    
    /* 确保标题内容不被压缩，标题和操作栏间距固定 */
    .draggable-lib .flex.items-center.mb-1 {
      flex: 1;
    }
    
    /* 操作栏固定高度，不被压缩 */
    .draggable-lib .flex.items-center.justify-between {
      margin-top: 12px;
      flex-shrink: 0;
      flex-wrap: nowrap;
    }
    
    /* 滚动容器设置 */
    .scroll-list {
      position: relative;
      box-sizing: border-box;
      scrollbar-width: none; /* 隐藏Firefox滚动条 */
      -ms-overflow-style: none; /* 隐藏IE滚动条 */
      /* 使用auto而不是overlay，确保兼容性 */
      overflow-y: auto;
      padding-right: 4px; /* 给滚动条预留空间 */
      margin-right: -4px; /* 抵消padding-right */
    }
    
    /* 隐藏滚动条但保留功能 */
    .scroll-list::-webkit-scrollbar { 
      width: 8px;
      background: transparent;
    }
    
    .scroll-list::-webkit-scrollbar-thumb { 
      background: rgba(199, 210, 254, 0.5); /* 半透明滚动条 */
      border-radius: 4px;
    }

    /* 当前练习题库高亮样式 */
    .active-practice-library {
      position: relative;
      border: 2px solid #6366f1 !important;
      box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2), 0 4px 12px rgba(99, 102, 241, 0.15) !important;
    }

    .active-practice-library::before {
      content: '当前练习';
      position: absolute;
      top: 4px;
      right: 8px;
      background: #6366f1;
      color: white;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 600;
      z-index: 10;
    }

    .dark .active-practice-library::before {
      background: #818cf8;
    }

    .active-practice-library .draggable-lib {
      border-color: #6366f1 !important;
      background: rgba(99, 102, 241, 0.05) !important;
    }

    .dark .active-practice-library .draggable-lib {
      background: rgba(99, 102, 241, 0.1) !important;
    }
  </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen transition-colors duration-300">
  <!-- 顶部LOGO+系统名 -->
  <header class="flex items-center gap-3 px-6 py-4 border-b border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 shadow-sm select-none sticky top-0 z-50" style="backdrop-filter: blur(6px);">
    <!-- 删除署名元素 -->
    <!-- <div class="author-signature"><span>Leosu</span></div> -->
    <span class="logo-tijing">
      <svg viewBox="0 0 48 48" fill="none">
        <rect x="6" y="12" width="36" height="24" rx="6" fill="url(#bookGradient)"/>
        <path d="M12 18 Q24 30 36 18" stroke="#6366f1" stroke-width="2.5" fill="none"/>
        <ellipse cx="24" cy="16" rx="3.5" ry="2" fill="#6366f1" opacity=".7"/>
        <circle cx="24" cy="10" r="3" fill="#fbbf24" stroke="#6366f1" stroke-width="1.5"/>
        <path d="M24 13 v2" stroke="#fbbf24" stroke-width="1.5"/>
        <defs>
          <linearGradient id="bookGradient" x1="6" y1="12" x2="42" y2="36" gradientUnits="userSpaceOnUse">
            <stop stop-color="#a5b4fc"/>
            <stop offset="1" stop-color="#c4b5fd"/>
          </linearGradient>
        </defs>
      </svg>
    </span>
    <span class="text-2xl font-extrabold tracking-tight" style="font-family: 'Noto Serif SC', serif; letter-spacing: 0.05em;">题境</span>
    <span class="ml-4 text-base text-gray-500 dark:text-gray-400 font-medium">本地题库系统</span>
    <!-- 每日一言：保持 flex 顺序 (ml-auto 实现推右)，超长句子通过 transform 向左位移 -->
    <span id="daily-quote" class="ml-auto mr-4 text-base italic text-indigo-600 dark:text-indigo-300 whitespace-nowrap" style="max-width:none;" title="每日一言"></span>
    <!-- 主题切换按钮 -->
    <button id="theme-toggle" class="p-2 rounded-full bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 shadow transition-transform hover:scale-110" title="切换主题">
      <i id="theme-icon" class="fas fa-moon text-gray-700 dark:text-yellow-300"></i>
    </button>
  </header>

  <!-- 三栏主布局 -->
  <main class="flex flex-row w-full max-w-[1600px] mx-auto min-h-[calc(100vh-64px)]">
    <!-- 左侧：分类与题库管理 -->
    <aside class="w-72 min-w-[240px] max-w-xs bg-white dark:bg-gray-900 border-r border-gray-200 dark:border-gray-800 p-4 flex flex-col gap-4 overflow-y-auto scrollbar-hide">
      <div class="flex items-center gap-2 mb-4">
        <button class="tab-btn flex-1 flex flex-col items-center gap-1 py-2 rounded-lg font-semibold text-indigo-600 dark:text-indigo-300 bg-indigo-50 dark:bg-indigo-900 hover:bg-indigo-100 dark:hover:bg-indigo-800 transition" data-tab="library"><i class="fas fa-folder-open text-lg"></i><span class="text-xs">题库</span></button>
        <button class="tab-btn flex-1 flex flex-col items-center gap-1 py-2 rounded-lg font-semibold text-red-500 dark:text-red-300 bg-red-50 dark:bg-red-900 hover:bg-red-100 dark:hover:bg-red-800 transition" data-tab="wrong"><i class="fas fa-times-circle text-lg"></i><span class="text-xs">错题本</span></button>
        <button class="tab-btn flex-1 flex flex-col items-center gap-1 py-2 rounded-lg font-semibold text-yellow-500 dark:text-yellow-300 bg-yellow-50 dark:bg-yellow-900 hover:bg-yellow-100 dark:hover:bg-yellow-800 transition" data-tab="fav"><i class="fas fa-star text-lg"></i><span class="text-xs">收藏夹</span></button>
      </div>
      <!-- 操作按钮行 + 搜索栏 -->
      <div id="action-row" class="flex flex-col gap-2 mb-4">
        <!-- 按钮行 -->
        <div class="flex gap-1 w-full flex-nowrap">
          <button id="download-template-btn" title="下载模板"
                  class="px-2 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-semibold shadow text-xs inline-flex items-center justify-center gap-1 whitespace-nowrap flex-1">
            <i class="fas fa-download text-xs"></i><span>下载模板</span>
          </button>
          <button id="upload-btn" title="上传题库"
                  class="px-2 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-semibold shadow text-xs inline-flex items-center justify-center gap-1 whitespace-nowrap flex-1">
            <i class="fas fa-upload text-xs"></i><span>上传题库</span>
          </button>
          <button id="stats-btn" title="学习统计"
                  class="px-2 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-semibold shadow text-xs inline-flex items-center justify-center gap-1 whitespace-nowrap flex-1">
            <i class="fas fa-chart-column text-xs"></i><span>学习统计</span>
          </button>
        </div>
        <!-- 搜索栏 -->
        <input id="lib-search" type="text" placeholder="搜索题库…"
               class="w-full h-8 px-3 text-sm rounded-lg border border-indigo-200 focus:ring-2 focus:ring-indigo-300 outline-none transition" />
      </div>
      <div id="tab-library">
        <div class="flex items-center justify-between mb-2">
          <span class="text-lg font-bold"><i class="fas fa-folder-open text-indigo-500 mr-2"></i>题库管理</span>
        </div>
        <div id="category-list" class="flex flex-col gap-2"></div>
      </div>
      <!-- 错题本部分 -->
      <div id="tab-wrong" class="hidden tab-container draggable-cat">
        <div class="tab-header">
          <span class="wrong-title"><i class="fas fa-times-circle mr-2"></i>错题本</span>
          <button id="clear-wrongbook" class="clear-btn">清空</button>
        </div>
        <div id="wrongbook-list" class="flex flex-col gap-2"></div>
        <button id='wrongbook-practice' class='mt-3 px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg font-semibold shadow hidden'>
          <i class='fas fa-play mr-1'></i>刷错题
        </button>
      </div>
      <!-- 收藏夹部分 -->
      <div id="tab-fav" class="hidden tab-container draggable-cat">
        <div class="tab-header">
          <span class="fav-title"><i class="fas fa-star mr-2"></i>收藏夹</span>
          <button id="clear-favbook" class="clear-btn">清空</button>
        </div>
        <div id="favbook-list" class="flex flex-col gap-2"></div>
        <button id='favbook-practice' class='mt-3 px-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg font-semibold shadow hidden'>
          <i class='fas fa-play mr-1'></i>刷收藏
        </button>
      </div>
    </aside>

    <!-- 中间：练习主区域（预留） -->
    <section id="main-section" class="flex-1 flex flex-col items-center justify-center w-full h-full p-0 m-0">
      <div class="text-gray-400 text-xl">请选择左侧题库开始练习</div>
    </section>

    <section id="search-result" class="flex-1 hidden overflow-y-auto p-6"></section>
    <!-- 学习统计页 -->
    <section id="stats-section" class="flex-1 hidden overflow-y-auto p-6 flex flex-col justify-between items-center">
      <!-- 待开发占位 -->
      <div id="stats-placeholder" class="flex flex-col items-center justify-center w-full max-w-3xl h-96 bg-white/90 dark:bg-gray-700/60 backdrop-blur-md rounded-2xl shadow-2xl border border-gray-100 dark:border-gray-700/60">
        <i class="fas fa-tools text-4xl text-indigo-400 mb-4"></i>
        <h3 class="dark:text-white text-gray-700 text-xl font-semibold mb-2">学习统计功能开发中…</h3>
        <p class="dark:text-gray-300 text-gray-500">敬请期待后续更新</p>
      </div>
    </section>

    <!-- 右侧：答题卡（预留） -->
    <aside class="w-56 min-w-[180px] max-w-sm bg-white dark:bg-gray-900 border-l border-gray-200 dark:border-gray-800 p-4 flex flex-col gap-4 overflow-y-auto scrollbar-hide">
      <div class="text-lg font-bold text-gray-500 dark:text-gray-400"><i class="fas fa-list-ol mr-2"></i>答题卡</div>
      <div class="text-gray-400 text-sm">练习时显示题号跳转</div>
    </aside>
  </main>

  <!-- 上传题库文件input（隐藏） -->
  <input id="file-upload" type="file" accept=".xlsx,.xls" class="hidden" />

  <!-- 分类选择/新建弹窗 -->
  <div id="category-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-bg hidden">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl p-7 w-full max-w-md flex flex-col gap-4 border border-gray-100 dark:border-gray-700">
      <div class="text-xl font-bold mb-5 flex items-center">
        <div class="w-10 h-10 bg-indigo-100 dark:bg-white rounded-full flex items-center justify-center mr-3 shadow-sm">
          <i class="fas fa-layer-group text-indigo-600 dark:text-indigo-600"></i>
        </div>
        <span class="text-black dark:text-white">选择或新建分类</span>
      </div>
      <label class="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-100">已有分类</label>
      <select id="category-select" class="w-full p-2.5 rounded-md border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-800 dark:text-white mb-4 focus:outline-none dark:focus:outline-none">
        <option value="">-- 请选择 --</option>
      </select>
      <label class="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-100">新建分类</label>
      <input id="category-input" type="text" class="w-full p-2.5 rounded-md border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-800 dark:text-white dark:placeholder-gray-300 focus:outline-none dark:focus:outline-none" placeholder="输入新分类名称" />
      <div class="flex gap-3 mt-7 justify-end">
        <button id="category-cancel" class="px-5 py-2 bg-gray-200 hover:bg-gray-300 dark:bg-white dark:hover:bg-gray-200 text-gray-700 dark:text-gray-800 rounded-md font-medium transition">取消</button>
        <button id="category-confirm" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 dark:bg-indigo-500 dark:hover:bg-indigo-600 text-white rounded-md font-medium transition">确定</button>
      </div>
    </div>
  </div>

  <!-- 开发专用：一键备份按钮，发布时可删除 -->
  <div id="dev-backup-btn" style="position:fixed;top:16px;right:120px;z-index:1000;">
    <button id="backup-btn" class="px-3 py-1 bg-yellow-400 hover:bg-yellow-500 text-white rounded shadow font-bold text-sm" title="开发专用：一键备份当前代码">一键备份</button>
  </div>

  <!-- 笔记弹窗 -->
  <div id="note-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
    <div class="modal-bg absolute inset-0" id="note-modal-bg"></div>
    <div class="bg-white rounded-2xl shadow-xl p-6 w-10/12 max-w-3xl flex flex-col gap-4 border-2 border-indigo-100 bg-gradient-to-br from-white to-indigo-50 note-draggable z-10">
      <div class="text-lg font-bold mb-3 flex items-center justify-between pb-2 border-b border-indigo-100 cursor-move drag-handle" id="note-drag-handle">
        <div class="flex items-center gap-2">
          <div class="w-7 h-7 rounded-full bg-indigo-100 flex items-center justify-center">
            <i class="fas fa-sticky-note text-indigo-500"></i>
          </div>
          <span class="text-indigo-700">题目笔记</span>
        </div>
        <button id="note-close" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-200 text-gray-500" title="关闭"><i class="fas fa-times"></i></button>
      </div>
      <!-- 工具栏 -->
      <div id="note-toolbar" class="flex flex-wrap gap-1.5 mb-2 p-1.5 bg-indigo-50 rounded-lg">
        <button class="note-tool px-2 py-0.5 text-xs bg-white hover:bg-indigo-100 rounded-md text-indigo-700 shadow-sm border border-indigo-100" data-cmd="bold" title="加粗">
          <i class="fas fa-bold mr-1"></i>加粗
        </button>
        <button class="note-tool px-2 py-0.5 text-xs bg-white hover:bg-indigo-100 rounded-md text-indigo-700 shadow-sm border border-indigo-100" data-cmd="italic" title="斜体">
          <i class="fas fa-italic mr-1"></i>斜体
        </button>
        <button class="note-tool px-2 py-0.5 text-xs bg-white hover:bg-indigo-100 rounded-md text-indigo-700 shadow-sm border border-indigo-100" data-cmd="ul" title="无序列表">
          <i class="fas fa-list-ul mr-1"></i>无序
        </button>
        <button class="note-tool px-2 py-0.5 text-xs bg-white hover:bg-indigo-100 rounded-md text-indigo-700 shadow-sm border border-indigo-100" data-cmd="ol" title="有序列表">
          <i class="fas fa-list-ol mr-1"></i>有序
        </button>
        <button id="note-preview-toggle" class="ml-auto text-xs px-2 py-0.5 rounded-md bg-indigo-500 hover:bg-indigo-600 text-white shadow-sm" title="切换预览">
          <i class="fas fa-eye mr-1"></i>预览
        </button>
      </div>
      <!-- 富文本编辑器容器（Quill 注入） -->
      <div id="note-editor" class="quill-container w-full"></div>
      <!-- Markdown 编辑器 -->
      <div id="md-wrapper" class="w-full hidden flex flex-col">
        <!-- Markdown 编辑器 -->
        <textarea id="md-editor" class="flex-1 min-h-[260px] p-3 text-sm font-mono resize-none overflow-y-auto" placeholder="在此输入 Markdown..."></textarea>
        <!-- Markdown 预览区 -->
        <div id="md-preview" class="flex-1 min-h-[260px] p-3 markdown-body overflow-y-auto hidden"></div>
      </div>
      <div class="flex gap-2 mt-3 justify-end pt-2 border-t border-indigo-100">
        <button id="note-delete" class="px-3 py-1 bg-white hover:bg-red-50 text-red-500 rounded-lg font-medium mr-auto border border-red-200 hover:border-red-300 shadow-sm flex items-center text-sm">
          <i class="fas fa-trash mr-1"></i>删除
        </button>
        <button id="note-save" class="px-3 py-1 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-medium shadow-sm flex items-center text-sm">
          <i class="fas fa-save mr-1"></i>保存
        </button>
      </div>
    </div>
  </div>
  <!-- 结束笔记弹窗 -->

  <div class="note-panel">
    <!-- 笔记窗口内容 -->
  </div>

  <script>
    // 解析题库文件内容的函数 - 全局定义，确保在Electron和非Electron环境都可访问
      async function parseQuestionBankFromContent(fileContent, filePath) {
        try {
          // 确保XLSX已经加载
          if (typeof XLSX === 'undefined') {
            throw new Error('XLSX库未加载，请刷新页面重试');
          }
          
          console.log('开始解析文件...');
          
          // 将文件内容转换为 ArrayBuffer
          const arrayBuffer = new Uint8Array(fileContent).buffer;
          
          // 使用 SheetJS 解析 Excel 文件，使用raw:false确保保留文本格式
          const workbook = XLSX.read(arrayBuffer, { 
            type: 'array', 
            raw: false, 
            cellText: true, 
            cellFormula: false,
            cellNF: false,  // 禁用数字格式化，强制文本保留
            dateNF: 'yyyy-mm-dd' // 日期格式保持原始文本
          });
          
          if (!workbook || !workbook.SheetNames || workbook.SheetNames.length === 0) {
            throw new Error('无法读取Excel工作表');
          }
          
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          if (!sheet) {
            throw new Error('工作表为空');
          }
          
          console.log('成功读取工作表');
          
          const rows = XLSX.utils.sheet_to_json(sheet, { 
            header: 1, 
            blankrows: false, 
            defval: '',
            raw: false,  // 确保文本格式保留
            cellText: true  // 强制使用文本格式
          });
          if (!rows || rows.length === 0) {
            throw new Error('工作表中没有数据');
          }
          
          console.log(`读取到${rows.length}行数据`);
          
          // 调试：验证标点符号是否被正确保留
          console.log('=== 标点符号调试信息 ===');
          rows.slice(0, 3).forEach((row, idx) => {
            if (row && row.length > 0) {
              const firstCell = String(row[0] || '');
              console.log(`第${idx+1}行第一列内容: "${firstCell}"`);
              console.log(`包含逗号: ${firstCell.includes(',')}`);
              console.log(`逗号位置: ${[...firstCell].map((c, i) => c === ',' ? i : -1).filter(i => i !== -1)}`);
            }
          });
          console.log('=== 调试信息结束 ===');
          
        // 直接使用所有行，不跳过第一行
          const questions = rows.map((row, idx) => {
            // 检查行数据是否有效
            if (!row || !Array.isArray(row) || row.length < 2) {
              console.warn(`第${idx+1}行数据无效，已跳过`);
              return null;
            }
            
            // 确保所有值都转换为字符串以保留原始格式（包括数字中的逗号）
            const [stem, answer, optA, optB, optC, optD, optE, explanation] = row.map(cell => {
              const strValue = cell != null ? String(cell) : '';
              // 调试：检测原始值类型和内容
              console.log(`第${idx+1}行单元格值:`, {
                original: cell,
                type: typeof cell,
                string: strValue,
                hasComma: strValue.includes(','),
                length: strValue.length
              });
              return strValue;
            });
            
            // 调试：打印完整行数据以验证标点符号
            console.log(`第${idx+1}行完整数据:`, {
              stem: stem,
              answer: answer,
              optA: optA,
              optB: optB,
              optC: optC,
              optD: optD,
              optE: optE,
              explanation: explanation,
              rowLength: row.length,
              rawRow: row
            });
            
            // 检查题干和答案是否存在
            if (!stem || !answer) {
              console.warn(`第${idx+1}行缺少题干或答案，已跳过`);
              return null;
            }
            
            const options = [optA, optB, optC, optD, optE]
              .map((opt, i) => opt ? { label: String.fromCharCode(65 + i), text: opt } : null)
              .filter(Boolean);
            
            // 检查选项是否存在
            if (options.length === 0) {
              console.warn(`第${idx+1}行没有有效选项，已跳过`);
              return null;
            }
            
            const type = (typeof answer === 'string' && answer.length > 1) ? '多选' : '单选';
            return {
              id: idx + 1,
              stem: stem || '',
              answer: answer || '',
              options,
              explanation: explanation || '',
              type
            };
          }).filter(Boolean); // 过滤掉null值
          
          if (!questions.length) {
            throw new Error('题库文件解析失败，未找到有效题目，请检查格式！');
          }
          
          console.log(`成功解析${questions.length}道题目`);
          
          // 显示分类选择弹窗
          showCategoryModal(questions, filePath);
          
        } catch (error) {
          console.error('文件解析错误:', error);
          alert('文件解析失败: ' + (error.message || '未知错误'));
          throw error;
        }
      }
      
    // 显示导入成功信息 - 全局定义
      function showImportSuccess(filePath) {
        const fileName = filePath.split(/[\\/]/).pop(); // 获取文件名
        console.log(`题库导入成功: ${fileName}`);
        // 可以在这里添加更友好的成功提示
      }
      
    // 显示分类选择弹窗 - 全局定义
      function showCategoryModal(questions, filePath) {
      const fileName = typeof filePath === 'string' ? filePath.split(/[\\/]/).pop().replace(/\.[^.]+$/, '') : '未命名题库';
        
        // 填充已有分类
        const categorySelect = document.getElementById('category-select');
        categorySelect.innerHTML = '<option value="">-- 请选择 --</option>' + categories.map(cat => `<option value="${cat.name}">${cat.name}</option>`).join('');
        
        // 清空输入框
        document.getElementById('category-input').value = '';
        
        // 显示弹窗
        document.getElementById('category-modal').classList.remove('hidden');
        
        // 修改确认按钮的处理逻辑
        const categoryConfirm = document.getElementById('category-confirm');
        
      categoryConfirm.onclick = () => {
          let catName = categorySelect.value || document.getElementById('category-input').value.trim();
          if (!catName) {
            alert('请选择或输入分类名称');
            return;
          }
          
          // 题库名自动生成
          const name = fileName;
          
          // 分类处理
          let catIdx = categories.findIndex(cat => cat.name === catName);
          if (catIdx === -1) {
            categories.unshift({ name: catName, libraries: [] });
            catIdx = 0;
          }
          
          // 检查是否已存在同名题库
          const existingLibIndex = categories[catIdx].libraries.findIndex(lib => lib.name === name);
          if (existingLibIndex !== -1) {
            // 提示用户是否替换
            if (confirm(`分类"${catName}"中已存在名为"${name}"的题库，是否替换？`)) {
              // 替换现有题库
              categories[catIdx].libraries[existingLibIndex] = {
                id: Date.now(),
                name,
                questions,
                created: new Date().toISOString(),
                lastUsed: new Date().toISOString()
              };
            } else {
              // 用户取消替换，可以提供重命名选项
              const newName = prompt('请输入新的题库名称:', name + ' (复制)');
              if (!newName || !newName.trim()) return; // 用户取消
              
              // 添加新题库
              categories[catIdx].libraries.push({
                id: Date.now(),
                name: newName.trim(),
                questions,
                created: new Date().toISOString(),
                lastUsed: new Date().toISOString()
              });
            }
          } else {
            // 新题库加到分类最后
            categories[catIdx].libraries.push({
              id: Date.now(),
              name,
              questions,
              created: new Date().toISOString(),
              lastUsed: new Date().toISOString()
            });
          }
          
          saveCategories();
          renderCategories(catIdx); // 展开当前分类
          document.getElementById('category-modal').classList.add('hidden');
      };
    }
    
    // Electron 环境检测和增强导入功能
    if (typeof window.electronAPI !== 'undefined') {
      // 增强的题库导入功能
      async function enhancedImportQuestionBank() {
        try {
          console.log('开始导入题库...');
          
          // 检查XLSX库是否已加载
          if (typeof XLSX === 'undefined') {
            alert('XLSX库未加载，请刷新页面重试');
            return;
          }
          
          // 使用 Electron API 打开文件对话框
          const filePath = await window.electronAPI.openFileDialog();
          
          if (!filePath) {
            console.log('用户取消了文件选择');
            return;
          }
          
          console.log('用户选择了文件:', filePath);
          
          // 使用 Electron API 读取文件内容
          const fileContent = await window.electronAPI.readFile(filePath);
          
          if (!fileContent || !fileContent.length) {
            throw new Error('文件内容为空');
          }
          
          console.log('成功读取文件内容，大小:', fileContent.length, '字节');
          
          // 解析文件内容
          await parseQuestionBankFromContent(fileContent, filePath);
          
          // 显示导入成功信息
          showImportSuccess(filePath);
        } catch (error) {
          console.error('导入失败:', error);
          alert('导入失败: ' + (error.message || '未知错误'));
        }
      }
      
      // 替换原有的上传按钮事件
      const uploadBtn = document.getElementById('upload-btn');
      uploadBtn.onclick = enhancedImportQuestionBank;
    }

    // 主题切换按钮事件
    document.getElementById('theme-toggle').onclick = function() {
      const isDark = document.documentElement.classList.toggle('dark');
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
      const themeIcon = document.getElementById('theme-icon');
      themeIcon.className = isDark ? 'fas fa-sun text-yellow-300' : 'fas fa-moon text-gray-700';
      
      // 更新答题卡按钮样式
      updateAnswerCardButtonStyles();
    };
    
    // 初始化主题设置
    if (localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
      document.documentElement.classList.add('dark');
      document.getElementById('theme-icon').className = 'fas fa-sun text-yellow-300';
    }
    
    // 更新答题卡按钮样式的函数
    function updateAnswerCardButtonStyles() {
      const prevBtn = document.getElementById('prev-answer-page');
      const nextBtn = document.getElementById('next-answer-page');
      const isDark = document.documentElement.classList.contains('dark');
      
      if (prevBtn && nextBtn) {
        if (isDark) {
          prevBtn.style.backgroundColor = '#4f46e5';
          prevBtn.style.color = 'white';
          nextBtn.style.backgroundColor = '#4f46e5';
          nextBtn.style.color = 'white';
          
          if (prevBtn.hasAttribute('disabled')) {
            prevBtn.style.backgroundColor = '#4b5563';
            prevBtn.style.opacity = '0.5';
          }
          if (nextBtn.hasAttribute('disabled')) {
            nextBtn.style.backgroundColor = '#4b5563';
            nextBtn.style.opacity = '0.5';
          }
        } else {
          // 添加日间模式样式
          prevBtn.style.backgroundColor = '#6366f1';
          prevBtn.style.color = 'white';
          nextBtn.style.backgroundColor = '#6366f1';
          nextBtn.style.color = 'white';
          
          if (prevBtn.hasAttribute('disabled')) {
            prevBtn.style.backgroundColor = '#d1d5db';
            prevBtn.style.opacity = '0.5';
          }
          if (nextBtn.hasAttribute('disabled')) {
            nextBtn.style.backgroundColor = '#d1d5db';
            nextBtn.style.opacity = '0.5';
          }
        }
      }
    }

    /* ---- 每日一言 ---- */
    // 在线随机每日一言（Hitokoto API）+ 离线本地后备
    (async function(){
      const useStore = !!window.electronAPI;
      let storeQuoteObj = null;
      if (useStore) {
        try {
          storeQuoteObj = await window.electronAPI.getDailyQuote();
        } catch(e){console.warn('读取 dailyQuote store 失败',e);}  
      }
      const fallbackQuotes = [
        '读万卷书，行万里路。',
        '学如逆水行舟，不进则退。',
        '宝剑锋从磨砺出，梅花香自苦寒来。',
        '黑发不知勤学早，白首方悔读书迟。',
        '书山有路勤为径，学海无涯苦作舟。',
        '业精于勤荒于嬉，行成于思毁于随。',
        '敏而好学，不耻下问。',
        '少壮不努力，老大徒伤悲。',
        '好学而不贰，耻下问者也。',
        '知识改变命运，学习成就未来。'
      ];

      const KEY   = 'tijing-daily-quote';
      const today = new Date().toISOString().slice(0,10);
      // 先尝试 localStorage，再尝试文件存储
      const cacheLocal = JSON.parse(localStorage.getItem(KEY) || '{}');
      const cache = storeQuoteObj || cacheLocal;

      // 如果今天已有缓存（无论来源），直接显示并结束，不再请求网络
      if (cache.date === today && cache.quote) {
        setQuote(cache.quote);
        return;
      }

      // 若无缓存，再尝试在线获取
      fetch('https://v1.hitokoto.cn?encode=text', { cache: 'no-store' })
        .then(res => res.ok ? res.text() : Promise.reject())
        .then(txt => {
          const quoteOnline = txt.trim();
          if(isPositive(quoteOnline)){
            saveAndShow(quoteOnline, true); // online 且通过筛选
          }else{
            throw new Error('not positive');
          }
        })
        .catch(() => {
          // 若今日尚无缓存，则使用本地后备
          if (!(cache.date === today && cache.quote)) {
            // 从本地正能量池随机取
            const local = fallbackQuotes[Math.floor(Math.random()*fallbackQuotes.length)];
            saveAndShow(local, false);
          }
        });

      function saveAndShow(q, isOnline){
        const obj = { date: today, quote: q, online: !!isOnline };
        localStorage.setItem(KEY, JSON.stringify(obj));
        if (useStore) {
          window.electronAPI.setDailyQuote(obj);
        }
        setQuote(q);
      }

      function setQuote(q){
        const span = document.getElementById('daily-quote');
        if(span){
          const maxLen = 40; // 最多显示 40 个字符，超出加省略号
          span.textContent = q.length > maxLen ? q.slice(0, maxLen) + '…' : q;
          span.setAttribute('title', q); // hover 时显示完整句子
        }
      }
    })();

    // 关键词筛选：包含积极学习相关词且不含屏蔽词
    const positiveKeywords = ['学', '习', '读', '书', '勤', '思', '问', '知', '进', '悟', '成长', '奋斗', '未来', '梦想', '努力', '坚持'];
    const bannedKeywords   = ['胸', '贫乳', '色色', '暗黑', '暴力'];

    function isPositive(q){
      const hasPositive = positiveKeywords.some(k => q.includes(k));
      const hasBanned   = bannedKeywords.some(k => q.includes(k));
      return hasPositive && !hasBanned;
    }

    // 分类与题库本地存储结构
    let categories = [];
    
    // 初始化数据存储
    async function initializeStorage() {
      try {
        console.log('初始化数据存储...');
        
        // 优先从文件存储加载数据
        if (window.electronAPI) {
          const result = await window.electronAPI.loadData('categories');
          if (result.success && result.data) {
            categories = result.data;
            console.log('从文件存储加载了', categories.length, '个分类');
            renderCategories(); // 立即渲染分类列表
            return;
          }
        }
        
        // 如果文件存储没有数据，尝试从localStorage读取
        categories = JSON.parse(localStorage.getItem('tijing-categories') || '[]');
        console.log('从localStorage加载了', categories.length, '个分类');
        
        // 如果从localStorage读取到数据，立即保存到文件存储
        if (categories.length > 0 && window.electronAPI) {
          await window.electronAPI.saveData('categories', categories);
          console.log('已将localStorage数据迁移到文件存储');
        }
      } catch (error) {
        console.error('读取题库数据失败:', error);
        categories = [];
      }
      
      // 渲染分类
      renderCategories();
    }
    
    // 页面加载完成后调用初始化
    document.addEventListener('DOMContentLoaded', () => {
      initializeStorage();
    });
    
    async function saveCategories() {
      try {
        // 同时保存到localStorage和文件存储
        localStorage.setItem('tijing-categories', JSON.stringify(categories));
        
        if (window.electronAPI) {
          await window.electronAPI.saveData('categories', categories);
          console.log('保存了', categories.length, '个分类到文件存储');
        } else {
          console.log('保存了', categories.length, '个分类到localStorage');
        }
      } catch (error) {
        console.error('保存题库数据失败:', error);
        alert('保存题库数据失败: ' + (error.message || '未知错误'));
      }
    }

    // 分类折叠状态记忆 - 使用分类名称作为稳定ID
    let categoryFoldState = JSON.parse(localStorage.getItem('tijing-category-fold') || '{}');
    function saveCategoryFoldState() {
      localStorage.setItem('tijing-category-fold', JSON.stringify(categoryFoldState));
    }

    // 答题卡分页变量
    let answerSheetPage = 0;
    const ANSWER_SHEET_PAGE_SIZE = 100;

    // 题库功能
    
    // 确保DOM完全渲染后再绑定事件
    function bindEvents() {
      // 绑定分类删除事件
      document.querySelectorAll('.delete-cat-btn').forEach(btn => {
        btn.onclick = (e) => {
          e.stopPropagation();
          const cidx = btn.getAttribute('data-cidx');
          if (confirm('确定要删除该分类及其下所有题库吗？')) {
            const catName = categories[cidx].name;
            delete categoryFoldState[catName];
            saveCategoryFoldState();
            categories.splice(cidx, 1);
            saveCategories();
            renderCategories();
          }
        };
      });

      // 绑定分类标题点击事件
      document.querySelectorAll('.cat-header').forEach(header => {
        header.onclick = function(e) {
          const cidx = header.closest('.draggable-cat').getAttribute('data-cidx');
          const bodyElement = document.getElementById(`cat-body-${cidx}`);
          bodyElement.classList.toggle('hidden');
        };
      });

      // 绑定题库删除事件
      document.querySelectorAll('.delete-lib-btn').forEach(btn => {
        btn.onclick = (e) => {
          e.stopPropagation();
          const cidx = btn.getAttribute('data-cidx');
          const lidx = btn.getAttribute('data-lidx');
          if (confirm('确定要删除该题库吗？')) {
            categories[cidx].libraries.splice(lidx, 1);
            saveCategories();
            renderCategories(cidx);
          }
        };
      });

      // 绑定题库练习事件
      document.querySelectorAll('.practice-btn').forEach(btn => {
        btn.onclick = (e) => {
          e.stopPropagation();
          const cidx = btn.getAttribute('data-cidx');
          const lidx = btn.getAttribute('data-lidx');
          const cat = categories[cidx];
          const libOrig = cat.libraries[lidx];
          // 克隆库对象并附加所属分类信息
          const lib = { ...libOrig, _categoryName: cat.name };
          startPractice(lib);
        };
      });

      // 绑定拖拽事件
      initializeDragAndDrop();
    }

    function renderCategories(expandIdx = null) {
      const list = document.getElementById('category-list');
      list.innerHTML = '';
      if (!categories.length) {
        list.innerHTML = '<div class="text-gray-400 text-sm">暂无分类，请上传题库</div>';
        return;
      }
      
      categories.forEach((cat, cidx) => {
        // 判断是否应该展开此分类 - 只在明确指定expandIdx时展开
        const shouldExpand = expandIdx !== null ? cidx === expandIdx : false;
        
        list.innerHTML += `
          <div class="border rounded-xl mb-2 bg-gray-50 dark:bg-gray-800 draggable-cat" draggable="true" data-cidx="${cidx}">
            <div class="flex items-center justify-between px-3 py-2 cursor-pointer select-none cat-header" data-cat-name="${cat.name}">
              <div class="flex items-center gap-2">
                <i class="fas fa-folder text-indigo-500"></i>
                <span class="font-bold">${cat.name}</span>
              </div>
              <button class="delete-cat-btn text-red-400 hover:text-red-600" data-cidx="${cidx}"><i class="fas fa-trash"></i></button>
            </div>
            <div id="cat-body-${cidx}" class="px-2 pb-2 ${shouldExpand ? '' : 'hidden'}">
              <div class="flex flex-col gap-2 scroll-list" data-cidx="${cidx}" id="lib-list-${cidx}" style="max-height: 320px;">
                ${cat.libraries.map((lib, lidx) => `
                  <div class="group bg-white dark:bg-gray-900 rounded-lg px-4 py-3 shadow-sm border border-gray-100 dark:border-gray-800 cursor-move draggable-lib" draggable="true" data-lidx="${lidx}">
                    <div class="flex items-center mb-1">
                      <i class="fas fa-book text-indigo-400 mr-2"></i>
                      <span class="font-semibold text-base filename whitespace-normal overflow-auto">${lib.name}</span>
                    </div>
                    <div class="flex items-center justify-between mt-1">
                      <span class="px-2 py-0.5 text-xs rounded bg-indigo-100 dark:bg-indigo-700 text-indigo-600 dark:text-indigo-200">${lib.questions.length}题</span>
                      <div class="flex gap-1 flex-shrink-0">
                        <button class="practice-btn w-7 h-7 flex items-center justify-center rounded hover:bg-indigo-100 dark:hover:bg-indigo-700 text-indigo-600 dark:text-indigo-200" data-cidx="${cidx}" data-lidx="${lidx}" title="练习"><i class="fas fa-play"></i></button>
                        <button class="delete-lib-btn w-7 h-7 flex items-center justify-center rounded hover:bg-red-100 dark:hover:bg-red-700 text-red-600 dark:text-red-200" data-cidx="${cidx}" data-lidx="${lidx}" title="删除"><i class="fas fa-trash"></i></button>
                      </div>
                    </div>
                  </div>
                `).join('')}
              </div>
              ${cat.libraries.length ? '<div class="text-xs text-gray-400 mt-1">可拖动题库卡片调整顺序</div>' : '<div class="text-gray-400 text-xs px-2 py-2">暂无题库</div>'}
            </div>
          </div>
        `;
      });

      // 确保DOM完全渲染后再绑定事件
      setTimeout(() => {
        bindEvents();
      }, 100);
    }

    // 初始化拖拽功能
    function initializeDragAndDrop() {
      // 分类拖拽
      document.querySelectorAll('.draggable-cat').forEach(catDiv => {
        catDiv.ondragstart = function(e) {
          e.dataTransfer.setData('cat-idx', catDiv.getAttribute('data-cidx'));
          catDiv.classList.add('opacity-50');
        };
        catDiv.ondragend = function() {
          catDiv.classList.remove('opacity-50');
        };
        catDiv.ondragover = function(e) {
          e.preventDefault();
          catDiv.classList.add('ring', 'ring-indigo-300');
        };
        catDiv.ondragleave = function() {
          catDiv.classList.remove('ring', 'ring-indigo-300');
        };
        catDiv.ondrop = function(e) {
          e.preventDefault();
          catDiv.classList.remove('ring', 'ring-indigo-300');
          const from = parseInt(e.dataTransfer.getData('cat-idx'));
          const to = parseInt(catDiv.getAttribute('data-cidx'));
          if (from !== to) {
            const moved = categories.splice(from, 1)[0];
            categories.splice(to, 0, moved);
            saveCategories();
            renderCategories();
          }
        };
      });

      // 题库拖拽
      document.querySelectorAll('.draggable-lib').forEach(libDiv => {
        libDiv.ondragstart = function(e) {
          e.dataTransfer.setData('lib-lidx', libDiv.getAttribute('data-lidx'));
          e.dataTransfer.setData('lib-cidx', libDiv.parentElement.getAttribute('data-cidx'));
          libDiv.classList.add('opacity-50');
        };
        libDiv.ondragend = function() {
          libDiv.classList.remove('opacity-50');
        };
        libDiv.ondragover = function(e) {
          e.preventDefault();
          libDiv.classList.add('ring', 'ring-indigo-300');
        };
        libDiv.ondragleave = function() {
          libDiv.classList.remove('ring', 'ring-indigo-300');
        };
        libDiv.ondrop = function(e) {
          e.preventDefault();
          libDiv.classList.remove('ring', 'ring-indigo-300');
          const fromLidx = parseInt(e.dataTransfer.getData('lib-lidx'));
          const fromCidx = parseInt(e.dataTransfer.getData('lib-cidx'));
          const toLidx = parseInt(libDiv.getAttribute('data-lidx'));
          const cidx = parseInt(libDiv.parentElement.getAttribute('data-cidx'));
          if (fromCidx === cidx && fromLidx !== toLidx) {
            const moved = categories[cidx].libraries.splice(fromLidx, 1)[0];
            categories[cidx].libraries.splice(toLidx, 0, moved);
            saveCategories();
            renderCategories(cidx);
          }
        };
      });
    }

    // 错题本本地存储
    function getWrongBook() {
      return JSON.parse(localStorage.getItem('tijing-wrongbook') || '[]');
    }
    function setWrongBook(arr) {
      localStorage.setItem('tijing-wrongbook', JSON.stringify(arr));
    }
    // 练习区答错题自动归入错题本
    function addToWrongBook(q) {
      const wrongBook = getWrongBook();
      if (!wrongBook.find(item => item.stem === q.stem && item.answer === q.answer)) {
        wrongBook.push(q);
        setWrongBook(wrongBook);
      }
    }
    // 收藏夹本地存储
    function getFavBook() {
      return JSON.parse(localStorage.getItem('tijing-favbook') || '[]');
    }
    function setFavBook(arr) {
      localStorage.setItem('tijing-favbook', JSON.stringify(arr));
    }
    function isFav(q) {
      return getFavBook().find(item => item.stem === q.stem && item.answer === q.answer);
    }
    function toggleFav(q) {
      let favBook = getFavBook();
      if (isFav(q)) {
        favBook = favBook.filter(item => !(item.stem === q.stem && item.answer === q.answer));
      } else {
        favBook.push({ ...q });
      }
      setFavBook(favBook);
    }
    // 上传题库弹窗逻辑（非 Electron 环境使用）
    const fileInput = document.getElementById('file-upload');
    const categoryModal = document.getElementById('category-modal');
    const categorySelect = document.getElementById('category-select');
    const categoryInput = document.getElementById('category-input');
    const categoryCancel = document.getElementById('category-cancel');
    const categoryConfirm = document.getElementById('category-confirm');
    let pendingFile = null;

    // 只在非 Electron 环境中设置原有的上传逻辑
    if (typeof window.electronAPI === 'undefined') {
      const uploadBtn = document.getElementById('upload-btn');
      uploadBtn.onclick = () => fileInput.click();
    }
    // 只在非 Electron 环境中设置文件输入处理
    if (typeof window.electronAPI === 'undefined') {
      fileInput.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const data = new Uint8Array(e.target.result);
            // 确保调用全局作用域中的函数
            parseQuestionBankFromContent(data, file.name)
              .catch(err => {
                console.error('处理文件失败:', err);
                alert('处理文件失败: ' + (err.message || '未知错误'));
              });
          } catch (err) {
            console.error('处理文件失败:', err);
            alert('处理文件失败: ' + (err.message || '未知错误'));
          }
        };
        reader.readAsArrayBuffer(file);
      };
    }
    // 取消按钮处理（适用于所有环境）
    categoryCancel.onclick = () => {
      categoryModal.classList.add('hidden');
      pendingFile = null;
      fileInput.value = '';
    };
    // 只在非 Electron 环境中设置确认按钮处理
    if (typeof window.electronAPI === 'undefined') {
      categoryConfirm.onclick = async () => {
        let catName = categorySelect.value || categoryInput.value.trim();
        if (!catName) {
          alert('请选择或输入分类名称');
          return;
        }
        // 解析文件
        const data = await pendingFile.arrayBuffer();
        const workbook = XLSX.read(data, { 
          type: 'array', 
          raw: false, 
          cellText: true, 
          cellFormula: false,
          cellNF: false,  // 禁用数字格式化，强制文本保留
          dateNF: 'yyyy-mm-dd' // 日期格式保持原始文本
        });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet, { 
          header: 1, 
          blankrows: false, 
          defval: '',
          raw: false,  // 确保文本格式保留
          cellText: true  // 强制使用文本格式
        });
        // 调试：验证标点符号是否被正确保留
        console.log('=== 文件上传标点符号调试信息 ===');
        rows.slice(0, 3).forEach((row, idx) => {
          if (row && row.length > 0) {
            const firstCell = String(row[0] || '');
            console.log(`第${idx+1}行第一列内容: "${firstCell}"`);
            console.log(`包含逗号: ${firstCell.includes(',')}`);
            console.log(`逗号位置: ${[...firstCell].map((c, i) => c === ',' ? i : -1).filter(i => i !== -1)}`);
          }
        });
        console.log('=== 调试信息结束 ===');
        
        const questions = rows.map((row, idx) => {
          // 强制转换为字符串并保留所有标点符号
          const [stem, answer, optA, optB, optC, optD, optE, explanation] = row.map(cell => {
            if (cell == null) return '';
            const strValue = String(cell);
            // 调试：显示原始值和转换后的值
            if (idx < 3 && strValue.includes(',')) {
              console.log(`文件上传 - 第${idx+1}行单元格调试: 原始值="${cell}" -> 字符串="${strValue}"`);
            }
            return strValue;
          });
          const options = [optA, optB, optC, optD, optE].map((opt, i) => opt ? { label: String.fromCharCode(65 + i), text: opt } : null).filter(Boolean);
          const type = (typeof answer === 'string' && answer.length > 1) ? '多选' : '单选';
          return {
            id: idx + 1,
            stem: stem || '',
            answer: answer || '',
            options,
            explanation: explanation || '',
            type
          };
        }).filter(q => q.stem && q.answer && q.options.length > 0);
        if (!questions.length) {
          alert('题库文件解析失败，请检查格式！');
          return;
        }
        // 题库名自动生成
        const name = pendingFile.name.replace(/\.[^.]+$/, '');
        // 分类处理
        let catIdx = categories.findIndex(cat => cat.name === catName);
        if (catIdx === -1) {
          categories.unshift({ name: catName, libraries: [] });
          catIdx = 0;
        }
        // 新题库加到分类最后
        categories[catIdx].libraries.push({
          id: Date.now(),
          name,
          questions,
          created: new Date().toISOString(),
          lastUsed: new Date().toISOString()
        });
        saveCategories();
        renderCategories(catIdx); // 保持当前分类展开
        categoryModal.classList.add('hidden');
        pendingFile = null;
        fileInput.value = '';
      };
    }

    // 练习区主流程
    let practiceState = null;
    const PRACTICE_MODES = [
      { key: 'practice', label: '练习模式' },
      { key: 'recite', label: '背题模式' }
    ];
    function startPractice(library, mode = 'practice') {
      // 若搜索结果页显示，关闭它
      const resDiv=document.getElementById('search-result');
      if(resDiv) resDiv.classList.add('hidden');
      document.getElementById('main-section')?.classList.remove('hidden');
      // 若统计页开启，则关闭它
      document.getElementById('stats-section')?.classList.add('hidden');
      let saved = loadPracticeProgress(library);
      if (saved && Array.isArray(saved.userAnswers) && Array.isArray(saved.submitted)) {
        practiceState = {
          library,
          questions: library.questions,
          current: typeof saved.currentIndex === 'number' ? saved.currentIndex : 0,
          userAnswers: JSON.parse(JSON.stringify(saved.userAnswers)),
          submitted: JSON.parse(JSON.stringify(saved.submitted)),
          mode,
          startTime: Date.now(),
          finished: !!saved.finished,
          score: 0,
          duration: 0,
          orderMode: 'ordered',
          originalQuestions: library.questions.slice()
        };
        if (saved.finished) {
          practiceState.finished = true;
          practiceState.current = practiceState.questions.length - 1;
        }
      } else {
        practiceState = {
          library,
          questions: library.questions,
          current: 0,
          userAnswers: Array(library.questions.length).fill(null),
          submitted: Array(library.questions.length).fill(false),
          mode,
          startTime: Date.now(),
          finished: false,
          score: 0,
          duration: 0,
          orderMode: 'ordered',
          originalQuestions: [] // 先设置为空数组，后面再填充
        };
      }
      // 先为所有题目添加元数据
      practiceState.questions.forEach(q => {
        if (!q._libraryName) q._libraryName = library.name;
        if (!q._categoryName) q._categoryName = library._categoryName || '';
      });
      // 保存带有元数据的题目到 originalQuestions
      practiceState.originalQuestions = practiceState.questions.slice();
      highlightActiveLibrary(library);
      renderPractice();
      renderAnswerSheet();
    }
    function renderPractice() {
      const main = document.getElementById('main-section');
      const { questions, current, userAnswers, submitted, mode, finished } = practiceState;
      const q = questions[current];
      const favActive = isFav(q);
      // 模式切换按钮
      const modeBtns = PRACTICE_MODES.map(m => `<button class="mode-btn px-2 py-1 rounded text-xs font-semibold border ${mode===m.key?'bg-indigo-500 text-white border-indigo-500':'bg-white dark:bg-gray-800 text-gray-500 dark:text-gray-300 border-gray-300 dark:border-gray-600'} mr-2" data-mode="${m.key}">${m.label}</button>`).join('');
      const orderBtn = `<button id=\"toggle-order-btn\" class=\"px-2 py-1 rounded text-xs font-semibold border ${practiceState.orderMode==='ordered'?'bg-purple-500 text-white border-purple-500':'bg-white dark:bg-gray-800 text-gray-500 dark:text-gray-300 border-gray-300 dark:border-gray-600'} hover:ring-2 hover:ring-purple-300 transition mr-2\">${practiceState.orderMode==='ordered'?'顺序':'乱序'}<i class=\"fas fa-exchange-alt ml-1 text-[10px]\"></i></button>`;
      // 题目区
      const fixedStem = fixChinesePunctuationNoLineStart(q.stem);
      const stemHtml = convertImageLinks(fixedStem);
      main.innerHTML = `
        <div class="practice-card w-full h-full bg-white dark:bg-gray-900 rounded-2xl shadow-2xl border border-gray-100 dark:border-gray-700 p-6 sm:p-8 flex flex-col" style="min-height: 100%;">
          <div class="flex items-center justify-between mb-2 w-full">
            <div class="flex items-center gap-2 flex-wrap">
              <span class="px-2 py-0.5 text-xs rounded bg-indigo-500 text-white font-bold">${q.type}</span>
              <span class="text-gray-500 dark:text-gray-400 text-xs question-number">第 ${current + 1} / ${questions.length} 题</span>
              <span class="ml-4">${modeBtns}${orderBtn}</span>
            </div>
            <div class="flex items-center gap-3">
              <div class="w-32 h-2 bg-gray-200 dark:bg-gray-700 rounded relative flex items-center">
                <div class="h-2 bg-gradient-to-r from-indigo-500 to-purple-500 rounded" style="width:${((current+1)/questions.length)*100}%"></div>
          </div>
              <button id="fav-btn" class="p-0 m-0 bg-transparent border-none focus:outline-none transform hover:scale-110 transition-transform" title="收藏/取消收藏" style="cursor:pointer;">
                ${favActive
                  ? '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="32" height="32" fill="#fbbf24" stroke="#f59e0b" stroke-width="1.2" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.2 21.02 12 17.77 5.8 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>'
                  : '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="32" height="32" fill="none" stroke="#94a3b8" stroke-width="1.8" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.2 21.02 12 17.77 5.8 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>'
                }
              </button>
              <button id="note-btn" class="p-0 m-0 bg-transparent border-none focus:outline-none transform hover:scale-110 transition-transform" title="题目笔记" style="cursor:pointer;">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="32" height="32" fill="#6366f1" class="dark:fill-current"><path d="M4 3h14a1 1 0 011 1v12l-4-4H5a1 1 0 01-1-1V4a1 1 0 011-1z"/><path d="M3 7v11a1 1 0 001 1h11" stroke="#6366f1" stroke-width="2" fill="none"/></svg>
              </button>
            </div>
          </div>
          <div class="font-semibold text-xl mb-4 w-full">${stemHtml}</div>
          ${mode==='recite' ? renderReciteMode(q) : ''}
          ${mode!=='recite' ? `<form id="answer-form" class="flex flex-col gap-0 mb-4 w-full">
            ${q.options.map(opt => {
              const isChecked = userAnswers[current] && (Array.isArray(userAnswers[current]) ? userAnswers[current].includes(opt.label) : userAnswers[current] === opt.label);
              const isLocked = submitted[current] && isChecked;
              return `
                <label class="custom-radio flex items-center gap-2 cursor-pointer rounded px-3 py-3 transition border-2 mb-2 ${isChecked ? (submitted[current] ? 'bg-gray-100 dark:bg-gray-800 border-gray-400 dark:border-gray-600 locked' : 'bg-indigo-50 dark:bg-indigo-800 border-indigo-600 dark:border-indigo-400 ring-2 ring-indigo-400') : 'bg-gray-50 dark:bg-gray-800 border-gray-200 dark:border-gray-700 hover:border-indigo-300 dark:hover:border-indigo-600'}">
                  <input type="${q.type==='多选'?'checkbox':'radio'}" name="option" value="${opt.label}" ${submitted[current] ? 'disabled' : ''} ${isChecked ? 'checked' : ''} />
                  <span class="radio-dot"></span>
                  <span class="w-7 h-7 flex items-center justify-center rounded bg-indigo-100 dark:bg-gray-700 text-indigo-600 dark:text-indigo-200 font-bold text-lg">${opt.label}</span>
                  <span class="text-base">${opt.text}</span>
                </label>
              `;
            }).join('')}
          </form>
          <div class="flex gap-4 mt-2 w-full">
            <button id="prev-question" class="px-5 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg font-semibold shadow transition" ${current === 0 ? 'disabled' : ''}>上一题</button>
            ${!submitted[current] && mode!=='recite' ? `<button id="submit-answer" class="px-7 py-2 bg-gradient-to-r from-indigo-500 to-purple-500 text-white font-semibold rounded-lg shadow hover:scale-105 transition-transform">提交</button>` : ''}
            <button id="next-question" class="px-5 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-semibold shadow transition" ${current === questions.length-1 ? 'disabled' : ''}>下一题</button>
          </div>
          ` : ''}
          <!-- 移除重复的答案注释 -->
          <div class="w-full">
          ${submitted[current] ? renderPracticeResult(q, userAnswers[current]) : ''}
            </div>
          ${finished ? renderFinalScore() : ''}
        </div>
      `;
      // 模式切换交互
      document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.onclick = () => {
          if(practiceState.mode!==btn.dataset.mode){
            practiceState.mode=btn.dataset.mode;
            renderPractice();
            renderAnswerSheet();
          }
        };
      });
      // 顺序/乱序按钮
      const toggleBtn=document.getElementById('toggle-order-btn');
      if(toggleBtn){
        toggleBtn.onclick=()=>{
          practiceState.orderMode = practiceState.orderMode==='ordered'?'shuffle':'ordered';
          practiceState.questions = practiceState.orderMode==='shuffle' ? shuffleArray(practiceState.originalQuestions.slice()) : practiceState.originalQuestions.slice();
          practiceState.current=0;
          practiceState.userAnswers = Array(practiceState.questions.length).fill(null);
          practiceState.submitted = Array(practiceState.questions.length).fill(false);
          renderPractice();
          renderAnswerSheet();
        };
      }
      setTimeout(() => {
        const favBtn = document.getElementById('fav-btn');
        if(favBtn) favBtn.onclick = () => {
          toggleFav(q);
          renderPractice();
          renderAnswerSheet();
        };
        const noteBtn = document.getElementById('note-btn');
        if(noteBtn){
          // 检查当前题目是否已有笔记，异步获取后高亮
          getNotes().then(ns=>{
            if(ns[getQuestionKey(q)]){
              noteBtn.querySelector('svg').style.fill='#fbbf24'; // 有笔记时高亮
            }
          });
          noteBtn.onclick=()=>{
            openNoteModal(q);
          };
        }
      }, 0);
      // 选项交互
      if(mode!=='recite'){
      const form = document.getElementById('answer-form');
      if (form) {
        form.onchange = () => {
            let selected;
            const opts = form.elements['option'];
            if(q.type==='多选'){
              // 多选题，opts 一定是 NodeList
              selected = (Array.isArray(opts) || opts instanceof NodeList)
                ? Array.from(opts).filter(input => input.checked).map(input => input.value).sort()
                : (opts && opts.checked ? [opts.value] : []);
            }else{
              // 单选题，opts 可能是 NodeList 或单个元素
              if (Array.isArray(opts) || opts instanceof NodeList) {
                const checked = Array.from(opts).find(input => input.checked);
                selected = checked ? checked.value : null;
              } else {
                selected = opts && opts.checked ? opts.value : null;
              }
            }
            practiceState.userAnswers[current] = selected;
          renderPractice();
          renderAnswerSheet();
        };
        }
      }
      // 按钮交互
      document.getElementById('prev-question').onclick = (e) => {
        e.preventDefault();
        if (practiceState.current > 0) {
          practiceState.current--;
          savePracticeProgress(practiceState.library, practiceState.current, practiceState.userAnswers, practiceState.submitted, practiceState.finished);
          renderPractice();
          renderAnswerSheet();
        }
      };
      document.getElementById('next-question').onclick = (e) => {
        e.preventDefault();
        if (practiceState.current < practiceState.questions.length-1) {
          practiceState.current++;
          savePracticeProgress(practiceState.library, practiceState.current, practiceState.userAnswers, practiceState.submitted, practiceState.finished);
          renderPractice();
          renderAnswerSheet();
        }
      };
      const submitBtn = document.getElementById('submit-answer');
      if (submitBtn) {
        submitBtn.onclick = (e) => {
          e.preventDefault();
          let hasAnswer = false;
          const q = practiceState.questions[practiceState.current];
          if(q.type==='多选'){
            hasAnswer = Array.isArray(practiceState.userAnswers[practiceState.current]) && practiceState.userAnswers[practiceState.current].length>0;
          }else{
            hasAnswer = !!practiceState.userAnswers[practiceState.current];
          }
          if (!hasAnswer) {
            alert('请选择答案');
            return;
          }
          practiceState.submitted[practiceState.current] = true;
          if(practiceState.current===practiceState.questions.length-1){
            practiceState.finished=true;
            practiceState.duration = Math.floor((Date.now()-practiceState.startTime)/1000);
            practiceState.score = calcTotalScore(practiceState);
          }
          savePracticeProgress(practiceState.library, practiceState.current, practiceState.userAnswers, practiceState.submitted, practiceState.finished);
          renderPractice();
          renderAnswerSheet();
        };
      }
      // Markdown渲染
      if (submitted[current]) {
        try {
          const mdDiv = document.getElementById('explanation-md');
          if (mdDiv) {
            mdDiv.innerHTML = q.explanation ? marked.parse(convertImageLinks(q.explanation)) : '<span class="text-gray-400">无解析内容</span>';
          }
        } catch (e) {
          const mdDiv = document.getElementById('explanation-md');
          if (mdDiv) mdDiv.innerHTML = '<span class="text-red-400">解析内容渲染出错</span>';
        }
      }
    }
    function renderReciteMode(q){
      // 背题模式：只显示选项、答案、解析（不重复题干）
      return `<div class="my-0 w-full">
        <ul class="mb-4">
          ${q.options.map(opt=>`<li class="flex items-center gap-2 mb-2"><span class="w-7 h-7 flex items-center justify-center rounded bg-indigo-100 dark:bg-gray-700 text-indigo-600 dark:text-indigo-200 font-bold text-lg">${opt.label}</span><span class="text-base">${opt.text}</span></li>`).join('')}
        </ul>
        <div class="mb-4 text-base text-green-600 dark:text-green-300 font-semibold">答案：${q.answer}</div>
        <div class="text-base text-gray-700 dark:text-gray-200 markdown-body">${q.explanation ? marked.parse(convertImageLinks(q.explanation)) : '<span class="text-gray-400">无解析内容</span>'}</div>
        <div class="flex gap-4 mt-4 w-full">
          <button id="prev-question" class="px-5 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg font-semibold shadow transition" ${practiceState.current === 0 ? 'disabled' : ''}>上一题</button>
          <button id="next-question" class="px-5 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-semibold shadow transition" ${practiceState.current === practiceState.questions.length-1 ? 'disabled' : ''}>下一题</button>
        </div>
      </div>`;
    }
    function renderFinalScore(){
      const {score, questions, duration, library} = practiceState;
      const min = Math.floor(duration/60), sec = duration%60;
      return `<div class="mt-8 p-6 rounded-2xl bg-gradient-to-r from-indigo-50 to-pink-50 dark:from-gray-800 dark:to-gray-700 border border-indigo-200 dark:border-pink-600 shadow flex flex-col gap-2 items-center">
        <div class="text-2xl font-bold text-indigo-600 dark:text-pink-300">总成绩：${score} 分 / ${questions.length+questions.filter(q=>q.type==='多选').length} 分</div>
        <div class="text-lg text-gray-500 dark:text-gray-300">用时：${min}分${sec}秒</div>
        <div class="flex gap-4 mt-4">
          <button id="restart-practice" class="px-6 py-2 bg-indigo-500 hover:bg-indigo-600 text-white rounded-lg font-semibold shadow">重新练习</button>
          <button id="end-practice" class="px-6 py-2 bg-gray-400 hover:bg-gray-500 text-white rounded-lg font-semibold shadow">结束</button>
        </div>
      </div>`;
    }
    function calcTotalScore(state){
      let total = 0;
      state.questions.forEach((q,idx)=>{
        const user = state.userAnswers[idx];
        const ansArr = typeof q.answer==='string' ? q.answer.split('').sort() : [];
        if(q.type==='单选'){
          if(user && user===ansArr[0]) total+=1;
        }else if(q.type==='多选'){
          if(Array.isArray(user)){
            const userSet = new Set(user);
            const ansSet = new Set(ansArr);
            const wrong = user.find(x=>!ansSet.has(x));
            if(wrong){
              // 错选，不得分
            }else if(user.length<ansArr.length){
              // 少选，0.5分/项
              let rightCount = user.filter(x=>ansSet.has(x)).length;
              total += 0.5*rightCount;
            }else if(user.length===ansArr.length && user.every(x=>ansSet.has(x))){
              total += 2;
            }
          }
        }
      });
      return Math.round(total*100)/100;
    }
    // 答题卡功能
    function renderAnswerSheet() {
      const aside = document.querySelector('aside.w-56');
      if (!practiceState) {
        aside.innerHTML = `<div class="text-lg font-bold text-gray-500 dark:text-gray-400"><i class="fas fa-list-ol mr-2"></i>答题卡</div><div class="text-gray-400 text-sm">练习时显示题号跳转</div>`;
        return;
      }
      const { questions, current, userAnswers, submitted } = practiceState;
      const totalPages = Math.ceil(questions.length / ANSWER_SHEET_PAGE_SIZE);
      if (answerSheetPage >= totalPages) answerSheetPage = totalPages - 1;
      if (answerSheetPage < 0) answerSheetPage = 0;
      const startIdx = answerSheetPage * ANSWER_SHEET_PAGE_SIZE;
      const endIdx = Math.min(startIdx + ANSWER_SHEET_PAGE_SIZE, questions.length);
      aside.innerHTML = `
        <div class="flex justify-between items-center mb-2">
          <div class="text-lg font-bold text-gray-500 dark:text-gray-400"><i class="fas fa-list-ol mr-2"></i>答题卡</div>
          <div class="flex items-center gap-1">
            <button id="prev-answer-page" class="px-1 py-0.5 text-xs rounded bg-gray-200 hover:bg-gray-300" ${answerSheetPage === 0 ? 'disabled' : ''}>←</button>
            <span class="text-xs">${answerSheetPage+1}/${totalPages}</span>
            <button id="next-answer-page" class="px-1 py-0.5 text-xs rounded bg-gray-200 hover:bg-gray-300" ${answerSheetPage === totalPages-1 ? 'disabled' : ''}>→</button>
          </div>
        </div>
        <div class="grid grid-cols-5 gap-2 mb-4">
          ${questions.slice(startIdx, endIdx).map((q, idx) => {
            let btnClass = '';
            let colorStyle = '';
            let bgStyle = '';
            let user = Array.isArray(userAnswers[startIdx+idx]) ? userAnswers[startIdx+idx].sort().join('') : (userAnswers[startIdx+idx] || '');
            let correct = q.answer.split('').sort().join('');
            if (submitted[startIdx+idx]) {
              if (user === correct) {
                btnClass = 'bg-green-500 border-green-500';
                colorStyle = 'color:#fff;';
                bgStyle = 'background:#10B981;';
              } else {
                btnClass = 'bg-red-500 border-red-500';
                colorStyle = 'color:#fff;';
                bgStyle = 'background:#EF4444;';
              }
            } else if (userAnswers[startIdx+idx]) {
              btnClass = 'bg-indigo-100 border-indigo-200';
              colorStyle = 'color:#3730a3;';
              bgStyle = 'background:#E0E7FF;';
            } else {
              btnClass = 'bg-gray-200 border-gray-200';
              colorStyle = 'color:#334155;';
              bgStyle = 'background:#E5E7EB;';
            }
            // 数字长度判断
            const numStr = (startIdx+idx+1).toString();
            let extraClass = '';
            if (numStr.length === 3) extraClass = 'long';
            if (numStr.length >= 4) extraClass = 'xlong';
            // 高亮外圈用box-shadow实现
            if (current === startIdx+idx) btnClass += ' ring-indigo-500 scale-110';
            return `<button class="answer-sheet-btn font-bold flex items-center justify-center border transition ${btnClass} ${extraClass}" data-idx="${startIdx+idx}" title="第${startIdx+idx+1}题" style="line-height:1;${colorStyle}${bgStyle}">${numStr}</button>`;
          }).join('')}
        </div>
      `;
      aside.querySelectorAll('button[data-idx]').forEach(btn => {
        btn.onclick = () => {
          practiceState.current = parseInt(btn.getAttribute('data-idx'));
          savePracticeProgress(practiceState.library, practiceState.current, practiceState.userAnswers, practiceState.submitted, practiceState.finished);
          renderPractice();
          renderAnswerSheet();
        };
      });
      // 分页按钮事件
      const prevBtn = document.getElementById('prev-answer-page');
      const nextBtn = document.getElementById('next-answer-page');
      if (prevBtn) prevBtn.onclick = () => { answerSheetPage--; renderAnswerSheet(); };
      if (nextBtn) nextBtn.onclick = () => { answerSheetPage++; renderAnswerSheet(); };
      
      // 更新按钮样式
      updateAnswerCardButtonStyles();
    }
    function renderPracticeResult(q, selected) {
      const correct = q.answer.split('').sort().join('');
      const user = Array.isArray(selected) ? selected.sort().join('') : (selected || '');
      const isCorrect = user === correct;
      if (!isCorrect) addToWrongBook(q);
      let explanationHtml = '';
      try {
        // 日志与健壮性处理
        const explanationStr = typeof q.explanation === 'string' ? q.explanation : (q.explanation ? JSON.stringify(q.explanation) : '');
        const converted = typeof convertImageLinks === 'function' ? convertImageLinks(explanationStr) : explanationStr;
        console.log('explanation原始：', q.explanation);
        console.log('explanation字符串：', explanationStr);
        console.log('convertImageLinks结果：', converted);
        if (typeof marked !== 'undefined' && typeof marked.parse === 'function') {
          explanationHtml = explanationStr ? marked.parse(converted) : '<span class="text-gray-400">无解析内容</span>';
        } else {
          console.error('marked.js 未正确加载');
          explanationHtml = '<span class="text-red-400">解析内容渲染出错(marked未加载)</span>';
        }
      } catch (e) {
        console.error('解析内容渲染出错', e, q.explanation);
        explanationHtml = '<span class="text-red-400">解析内容渲染出错</span>';
      }
      return `
        <div class="explain-card mt-6 p-5 rounded-2xl bg-gradient-to-r from-pink-50 to-indigo-50 dark:from-gray-800 dark:to-gray-700 border border-pink-200 dark:border-pink-600 shadow flex flex-col gap-2">
          <div class="flex items-center gap-2 mb-1">
            <i class="fas ${isCorrect ? 'fa-check-circle text-green-500' : 'fa-times-circle text-red-500'} text-xl"></i>
            <span class="font-bold text-lg">${isCorrect ? '回答正确！' : '回答错误'}</span>
            <span class="ml-2 text-base text-gray-500">正确答案：<span class="font-bold text-green-600 dark:text-green-400">${q.answer}</span></span>
          </div>
          <div class="flex items-center gap-2 mt-2 mb-1">
            <i class="fas fa-book-open text-pink-400"></i>
            <span class="font-bold text-pink-600 dark:text-pink-300 text-base">解析</span>
            <div class="flex-1 border-t border-dashed border-pink-200 dark:border-pink-500 ml-2"></div>
          </div>
          <div class="text-base text-gray-700 dark:text-gray-200 markdown-body" id="explanation-md">${explanationHtml}</div>
        </div>
      `;
    }

    // Tab切换事件
    function setupTabSwitch() {
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.onclick = () => {
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('ring-2', 'ring-indigo-400', 'bg-white', 'dark:bg-gray-800'));
          btn.classList.add('ring-2', 'ring-indigo-400', 'bg-white', 'dark:bg-gray-800');
          const tab = btn.getAttribute('data-tab');
          document.getElementById('tab-library').classList.toggle('hidden', tab !== 'library');
          document.getElementById('tab-wrong').classList.toggle('hidden', tab !== 'wrong');
          document.getElementById('tab-fav').classList.toggle('hidden', tab !== 'fav');
          if (tab === 'wrong') renderWrongBookList();
          if (tab === 'fav') renderFavBookList();
        };
      });
    }
    // 错题本/收藏夹列表渲染
    function renderWrongBookList() {
      const container = document.getElementById('wrongbook-list');
      const wrongBook = getWrongBook();
      const practiceBtn = document.getElementById('wrongbook-practice');

      if (!wrongBook.length) {
        container.innerHTML = '<div class="text-red-400 text-sm">暂无错题</div>';
        practiceBtn.classList.add('hidden');
        return;
      }

      const grouped = groupByCatLib(wrongBook);
      let html = '';
      Object.keys(grouped).forEach(cat => {
        const libMap = grouped[cat];
        const total = Object.values(libMap).reduce((sum, l) => sum + l.length, 0);
        html += `<div class='wrong-cat border border-red-600 rounded-xl mb-2 bg-gray-50 dark:bg-gray-800'>
          <div class='flex items-center px-3 py-2 cursor-pointer cat-header'>
            <div class='flex items-center gap-2 flex-1'>
              <i class='fas fa-folder text-red-400'></i>
              <span class='font-bold'>${cat}</span>
              <span class='text-xs ml-1 text-red-400'>(${total})</span>
            </div>
            <button class='remove-cat-btn w-7 h-7 flex items-center justify-center rounded hover:bg-red-100 text-red-600 mr-2' data-cat='${cat}' title='删除本分类全部错题'>
              <i class='fas fa-trash'></i>
            </button>
          </div>
          <div class='cat-body px-2 pb-2 hidden'>
            ${Object.keys(libMap).map(lib => {
              const list = libMap[lib];
              return `
              <div class='wrong-lib bg-white dark:bg-gray-900 rounded-lg ml-2 mb-3 overflow-hidden'>
                <div class='pl-2 pr-1 py-1 cursor-pointer lib-header flex items-center gap-2'>
                  <i class='fas fa-book text-red-300'></i>
                  <span class='font-medium'>${lib}</span>
                </div>
                <div class='flex items-center justify-between pl-4 pr-2 py-1 lib-controls'>
                  <span class='text-xs bg-red-100 dark:bg-red-700 text-red-600 dark:text-red-200 px-2 py-0.5 rounded'>${list.length}题</span>
                  <div class='flex items-center gap-2'>
                    <button class='practice-lib-btn w-7 h-7 flex items-center justify-center rounded hover:bg-red-100 dark:hover:bg-red-700 text-red-600 dark:text-red-200 mr-1' data-cat='${cat}' data-lib='${lib}' title='刷本库'>
                      <i class='fas fa-play'></i>
                    </button>
                    <button class='remove-lib-btn w-7 h-7 flex items-center justify-center rounded hover:bg-red-100 dark:hover:bg-red-700 text-red-600 dark:text-red-200' data-cat='${cat}' data-lib='${lib}' title='删除本库错题'>
                      <i class='fas fa-trash'></i>
                    </button>
                  </div>
                </div>
                <div class='lib-body pl-4 hidden'>
                  ${list.map(({ q, idx }) => `
                    <div class='flex items-center gap-2 p-1 rounded wrong-item' data-idx='${idx}'>
                      <span class='flex-1 truncate text-sm'>${q.stem}</span>
                      <button class='px-2 py-0.5 text-xs rounded bg-red-100 hover:bg-red-200 text-red-600 remove-wrong-btn' data-idx='${idx}'>移除</button>
                    </div>
                  `).join('')}
                </div>
              </div>`;
            }).join('')}
          </div>
        </div>`;
      });
      container.innerHTML = html;

      // 折叠交互：分类
      container.querySelectorAll('.cat-header').forEach(h => {
        h.onclick = e => {
          // 如果点击的是按钮则交由按钮处理
          if (e.target.closest('button')) return;
          const body = h.nextElementSibling;
          body.classList.toggle('hidden');
          // 已移除箭头图标，无需切换类
        };
      });

      // 折叠交互：题库
      container.querySelectorAll('.lib-header').forEach(lh => {
        lh.onclick = e => {
          if (e.target.closest('button')) return;
          const body = lh.nextElementSibling;
          body.classList.toggle('hidden');
          // 已移除箭头图标，无需切换类
        };
      });

      // 分类删除按钮
      container.querySelectorAll('.remove-cat-btn').forEach(btn => {
        btn.onclick = () => {
          const cat = btn.getAttribute('data-cat');
          if(!confirm(`确认删除分类 "${cat}" 的所有错题？`)) return;
          const wb = getWrongBook().filter(q => (q._categoryName || '未分类') !== cat);
          setWrongBook(wb);
          renderWrongBookList();
        };
      });

      container.querySelectorAll('.practice-lib-btn').forEach(btn => {
        btn.onclick = () => {
          const cat = btn.getAttribute('data-cat');
          const lib = btn.getAttribute('data-lib');
          const subset = wrongBook.filter(q => (q._categoryName || '未分类') === cat && (q._libraryName || '未知题库') === lib);
          if (subset.length) startPractice({ name: `${cat}/${lib} - 错题本`, questions: subset });
        };
      });

      // 题库删除按钮
      container.querySelectorAll('.remove-lib-btn').forEach(btn => {
        btn.onclick = () => {
          const cat = btn.getAttribute('data-cat');
          const lib = btn.getAttribute('data-lib');
          if(!confirm(`确认删除 ${cat}/${lib} 的错题？`)) return;
          const wb = getWrongBook().filter(q => !((q._categoryName || '未分类')===cat && (q._libraryName || '未知题库')===lib));
          setWrongBook(wb);
          renderWrongBookList();
        };
      });

      practiceBtn.classList.remove('hidden');
      practiceBtn.onclick = () => { if (wrongBook.length) startPractice({ name: '错题本', questions: wrongBook }); };
      document.getElementById('clear-wrongbook').onclick = () => { if (confirm('确定要清空错题本吗？')) { setWrongBook([]); renderWrongBookList(); } };
    }
    function renderFavBookList() {
      const container = document.getElementById('favbook-list');
      const favBook = getFavBook();
      const practiceBtn = document.getElementById('favbook-practice');

      if (!favBook.length) {
        container.innerHTML = '<div class="text-yellow-400 text-sm">暂无收藏</div>';
        practiceBtn.classList.add('hidden');
        return;
      }

      const grouped = groupByCatLib(favBook);
      let html = '';
      Object.keys(grouped).forEach(cat => {
        const libMap = grouped[cat];
        const total = Object.values(libMap).reduce((sum, l) => sum + l.length, 0);
        html += `<div class='fav-cat border border-amber-600 rounded-xl mb-2 bg-gray-50 dark:bg-gray-800'>
          <div class='flex items-center px-3 py-2 cursor-pointer cat-header'>
            <div class='flex items-center gap-2 flex-1'>
              <i class='fas fa-folder text-yellow-500'></i>
              <span class='font-bold'>${cat}</span>
              <span class='text-xs ml-1 text-yellow-500'>(${total})</span>
            </div>
            <button class='remove-fav-cat-btn w-7 h-7 flex items-center justify-center rounded hover:bg-yellow-100 text-yellow-600 mr-2' data-cat='${cat}' title='删除本分类'>
              <i class='fas fa-trash'></i>
            </button>
          </div>
          <div class='cat-body px-2 pb-2 hidden'>
            ${Object.keys(libMap).map(lib => {
              const list = libMap[lib];
              return `
              <div class='fav-lib bg-white dark:bg-gray-900 rounded-lg ml-2 mb-3 overflow-hidden'>
                <div class='pl-2 pr-1 py-1 cursor-pointer lib-header flex items-center gap-2'>
                  <i class='fas fa-book text-yellow-400'></i>
                  <span class='font-medium'>${lib}</span>
                </div>
                <div class='flex items-center justify-between pl-4 pr-2 py-1 lib-controls'>
                  <span class='text-xs bg-yellow-100 dark:bg-yellow-700 text-yellow-600 dark:text-yellow-200 px-2 py-0.5 rounded'>${list.length}题</span>
                  <div class='flex items-center gap-2'>
                    <button class='practice-fav-lib-btn w-7 h-7 flex items-center justify-center rounded hover:bg-yellow-100 dark:hover:bg-yellow-700 text-yellow-600 dark:text-yellow-200 mr-1' data-cat='${cat}' data-lib='${lib}' title='练习'>
                      <i class='fas fa-play'></i>
                    </button>
                    <button class='remove-fav-lib-btn w-7 h-7 flex items-center justify-center rounded hover:bg-yellow-100 dark:hover:bg-yellow-700 text-yellow-600 dark:text-yellow-200' data-cat='${cat}' data-lib='${lib}' title='删除'>
                      <i class='fas fa-trash'></i>
                    </button>
                  </div>
                </div>
              </div>`;
            }).join('')}
          </div>
        </div>`;
      });
      container.innerHTML = html;

      container.querySelectorAll('.cat-header').forEach(h => {
        h.onclick = e => {
          if (e.target.closest('button')) return;
          const body = h.nextElementSibling;
          body.classList.toggle('hidden');
          // 已移除箭头图标，无需切换类
        };
      });

      container.querySelectorAll('.lib-header').forEach(lh => {
        lh.onclick = e => {
          const body = lh.nextElementSibling;
          body.classList.toggle('hidden');
          // 已移除箭头图标，无需切换类
        };
      });

      // 分类删除
      container.querySelectorAll('.remove-fav-cat-btn').forEach(btn=>{
        btn.onclick=()=>{
          const cat=btn.getAttribute('data-cat');
          if(!confirm(`确认删除收藏分类 ${cat} ?`))return;
          const fb=getFavBook().filter(q=>(q._categoryName||'未分类')!==cat);
          setFavBook(fb);renderFavBookList();
        }
      });

      // 题库练习
      container.querySelectorAll('.practice-fav-lib-btn').forEach(btn=>{
        btn.onclick=()=>{
          const cat=btn.getAttribute('data-cat');
          const lib=btn.getAttribute('data-lib');
          const subset=getFavBook().filter(q=> (q._categoryName||'未分类')===cat && (q._libraryName||'未知题库')===lib);
          if(subset.length) startPractice({name:`${cat}/${lib} - 收藏`,questions:subset});
        }
      });

      // 题库删除
      container.querySelectorAll('.remove-fav-lib-btn').forEach(btn=>{
        btn.onclick=()=>{
          const cat=btn.getAttribute('data-cat');
          const lib=btn.getAttribute('data-lib');
          if(!confirm(`确认删除 ${cat}/${lib} 收藏?`))return;
          const fb=getFavBook().filter(q=> !((q._categoryName||'未分类')===cat && (q._libraryName||'未知题库')===lib));
          setFavBook(fb);renderFavBookList();
        }
      });

      practiceBtn.classList.remove('hidden');
      practiceBtn.onclick = () => { if (favBook.length) startPractice({ name: '收藏夹', questions: favBook }); };
      document.getElementById('clear-favbook').onclick = () => { if (confirm('确定要清空收藏夹吗？')) { setFavBook([]); renderFavBookList(); } };
    }
    // 页面初次加载时只激活一次"题库"Tab
    setTimeout(() => {
      setupTabSwitch();
      document.querySelector('.tab-btn[data-tab="library"]').click();
    }, 0);

    // 开发专用：一键备份按钮逻辑，发布时可删除
    document.getElementById('backup-btn').onclick = function() {
      const text = '<!DOCTYPE html>\n' + document.documentElement.outerHTML;
      const blob = new Blob([text], {type: 'text/html'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      const ts = new Date().toISOString().replace(/[-:T.]/g, '').slice(0, 14);
      a.download = `index_backup_${ts}.html`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    };

    // 题干标点换行美化，防止括号等标点单独出现在每行开头（除首行外）
    function fixChinesePunctuationNoLineStart(text) {
      // 在标点前插入 word joiner (\u2060)，防止换行到行首
      // 常见中文标点：，。、！？；：）】」』》）
      return text.replace(/([\u4e00-\u9fa5A-Za-z0-9])([，。、！？；：）\]\}】」』》〉])/g, '$1\u2060$2');
    }

    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', function() {
      initCategoryFoldState();
    });

    // 下载模板按钮事件
    document.getElementById('download-template-btn').onclick = function() {
      // 检查是否在Electron环境中
      if (window.electronAPI) {
        // 使用Electron API下载模板
        window.electronAPI.downloadTemplate().then(result => {
          if (result && result.success) {
            console.log('模板下载成功:', result.path);
          } else if (result && result.message === '用户取消下载') {
            console.log('用户取消下载模板');
            // 不提示错误，静默返回
          } else {
            console.error('模板下载失败:', result ? result.message : '未知错误');
            alert('模板下载失败，请重试');
          }
        }).catch(err => {
          console.error('模板下载出错:', err);
          alert('下载出错，请重试');
        });
      } else {
        // 普通网页环境，直接从templates文件夹下载
        try {
          const a = document.createElement('a');
          a.href = '../templates/题境-题库模板.xlsx';  // 指向templates文件夹
          a.download = '题境-题库模板.xlsx';
          a.target = '_blank';  // 在新窗口中打开，避免当前页面被替换
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          
          console.log('模板下载成功');
        } catch (error) {
          console.error('下载模板出错:', error);
          alert('下载出错，请重试');
        }
      }
    };

    // 添加暗黑模式切换处理
    function updateDarkModeStyles() {
      const isDarkMode = document.body.classList.contains('dark-mode');
      const wrongTab = document.getElementById('tab-wrong');
      const favTab = document.getElementById('tab-fav');
      
      if (isDarkMode) {
        wrongTab.style.backgroundColor = 'rgba(71, 27, 27, 0.3)';
        favTab.style.backgroundColor = 'rgba(82, 72, 21, 0.3)';
        
        // 设置列表项样式
        document.querySelectorAll('.question-item').forEach(item => {
          item.style.backgroundColor = 'rgba(30, 41, 59, 0.4)';
          item.style.borderColor = 'rgba(255, 255, 255, 0.1)';
          item.style.color = '#94a3b8';
        });
        
        // 设置按钮样式
        document.querySelectorAll('.clear-btn, .remove-btn').forEach(btn => {
          btn.style.backgroundColor = 'rgba(30, 41, 59, 0.4)';
          btn.style.borderColor = 'rgba(255, 255, 255, 0.1)';
          btn.style.color = '#94a3b8';
        });
      } else {
        wrongTab.style.backgroundColor = '#fff1f0';
        favTab.style.backgroundColor = '#fffbe6';
        
        // 重置列表项样式
        document.querySelectorAll('.question-item').forEach(item => {
          item.style.backgroundColor = 'rgba(255, 255, 255, 0.8)';
          item.style.borderColor = 'rgba(0, 0, 0, 0.1)';
          item.style.color = '';
        });
        
        // 重置按钮样式
        document.querySelectorAll('.clear-btn, .remove-btn').forEach(btn => {
          btn.style.backgroundColor = 'rgba(255, 255, 255, 0.8)';
          btn.style.borderColor = 'rgba(0, 0, 0, 0.1)';
          btn.style.color = '#666';
        });
      }
    }

    // 监听暗黑模式变化
    const darkModeObserver = new MutationObserver(mutations => {
      mutations.forEach(mutation => {
        if (mutation.attributeName === 'class') {
          updateDarkModeStyles();
        }
      });
    });

    // 页面加载后初始化
    document.addEventListener('DOMContentLoaded', () => {
      updateDarkModeStyles();
      darkModeObserver.observe(document.body, { attributes: true });
    });

    // 在文档加载完成后执行
    document.addEventListener('DOMContentLoaded', function() {
      // 获取主题模式
      const isDarkMode = document.body.classList.contains('dark-mode');
      
      // 获取错题本和收藏夹元素
      const wrongTab = document.getElementById('tab-wrong');
      const favTab = document.getElementById('tab-fav');
      
      // 设置初始样式
      updateThemeStyles(isDarkMode);
      
      // 监听主题切换
      const themeToggle = document.querySelector('.theme-toggle'); // 假设有这样一个切换按钮
      if (themeToggle) {
        themeToggle.addEventListener('click', function() {
          const newDarkMode = document.body.classList.toggle('dark-mode');
          updateThemeStyles(newDarkMode);
        });
      }
      
      // 更新主题样式
      function updateThemeStyles(isDark) {
        if (isDark) {
          // 夜晚模式
          wrongTab.style.background = 'rgba(71, 27, 27, 0.3)';
          favTab.style.background = 'rgba(82, 72, 21, 0.3)';
          
          // 为列表项添加深色样式
          document.querySelectorAll('.question-item').forEach(item => {
            item.style.background = 'rgba(30, 41, 59, 0.4)';
            item.style.border = '1px solid rgba(255, 255, 255, 0.1)';
            item.style.color = '#94a3b8';
          });
          
          // 为按钮添加深色样式
          document.querySelectorAll('.clear-btn, .remove-btn').forEach(btn => {
            btn.style.background = 'rgba(30, 41, 59, 0.4)';
            btn.style.color = '#94a3b8';
            btn.style.border = '1px solid rgba(255, 255, 255, 0.1)';
          });
        } else {
          // 白天模式
          wrongTab.style.background = '#fff1f0';
          favTab.style.background = '#fffbe6';
          
          // 恢复列表项默认样式
          document.querySelectorAll('.question-item').forEach(item => {
            item.style.background = 'rgba(255, 255, 255, 0.8)';
            item.style.border = '1px solid rgba(0, 0, 0, 0.1)';
            item.style.color = '';
          });
          
          // 恢复按钮默认样式
          document.querySelectorAll('.clear-btn, .remove-btn').forEach(btn => {
            btn.style.background = 'rgba(255, 255, 255, 0.8)';
            btn.style.color = '#666';
            btn.style.border = '1px solid rgba(0, 0, 0, 0.1)';
          });
        }
      }
      
      // 创建列表项时应用样式
      function createQuestionItem(question, type) {
        const item = document.createElement('div');
        item.className = 'question-item';
        
        // 根据当前主题设置样式
        if (document.body.classList.contains('dark-mode')) {
          item.style.background = 'rgba(30, 41, 59, 0.4)';
          item.style.border = '1px solid rgba(255, 255, 255, 0.1)';
          item.style.color = '#94a3b8';
        } else {
          item.style.background = 'rgba(255, 255, 255, 0.8)';
          item.style.border = '1px solid rgba(0, 0, 0, 0.1)';
        }
        
        // 其他设置...
        return item;
      }
    });

    // 初始化题库界面
    if (window.electronAPI) {
      // Electron环境
      document.addEventListener('DOMContentLoaded', () => {
        // 设置上传按钮事件
        const uploadBtn = document.getElementById('upload-btn');
        uploadBtn.onclick = enhancedImportQuestionBank;
        
        // 监听来自主进程的导入请求
        window.electronAPI.onImportQuestion = () => {
          enhancedImportQuestionBank();
        };
      });
    } else {
      // 非Electron环境
      // 上传题库弹窗逻辑（非 Electron 环境使用）
      const fileInput = document.getElementById('file-upload');
      fileInput.onchange = function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            try {
            const data = new Uint8Array(e.target.result);
              // 现在这个函数应该能找到了，因为我们把它定义在了全局作用域
            parseQuestionBankFromContent(data, file.name);
            } catch (err) {
              console.error('处理文件失败:', err);
              alert('处理文件失败: ' + (err.message || '未知错误'));
            }
          };
          reader.readAsArrayBuffer(file);
        }
      };
      const uploadBtn = document.getElementById('upload-btn');
      uploadBtn.onclick = () => fileInput.click();
      
      // 初始化渲染
      renderCategories();
    }

    /* ========= 搜索栏逻辑 ========= */
    const searchInput = document.getElementById('lib-search');
    if (searchInput) {
      // 根据关键字和当前标签筛选对应列表
      const performFilter = () => {
        const kw = searchInput.value.trim().toLowerCase();
        const activeTab = document.querySelector('.tab-btn.ring-2')?.dataset.tab || 'library';

        // 如果搜索框已清空，直接还原所有显示并恢复此前自动展开的分类
        if (kw === '') {
          if (activeTab === 'library') {
            document.querySelectorAll('#category-list .draggable-cat').forEach(catDiv => {
              catDiv.style.display = '';
              const catBody = catDiv.querySelector('[id^="cat-body-"]');
              // 一律折叠分类体，无论是否由搜索展开
              if (catBody) {
                catBody.classList.add('hidden');
                delete catBody.dataset.openedBySearch;
              }
              // 恢复内部题库可见
              catDiv.querySelectorAll('.draggable-lib').forEach(libDiv => libDiv.style.display='');
            });
          } else {
            // 错题本/收藏夹：恢复全部可见并折叠分类
            const isWrongTab = activeTab === 'wrong';
            const catSelector = isWrongTab ? '#wrongbook-list .wrong-cat' : '#favbook-list .fav-cat';
            document.querySelectorAll(catSelector).forEach(catDiv => {
              catDiv.style.display='';
              const body = catDiv.querySelector('.cat-body');
              body?.classList.add('hidden');
            });
          }
          return;
        }

        // ---- 图书/分类搜索 ----
        if (activeTab === 'library') {
          // 遍历分类
          document.querySelectorAll('#category-list .draggable-cat').forEach(catDiv => {
            const cidx = parseInt(catDiv.getAttribute('data-cidx'));
            const catBody = catDiv.querySelector(`#cat-body-${cidx}`);
            let catMatch = kw !== '' && catDiv.querySelector('.cat-header').innerText.toLowerCase().includes(kw);

            // 遍历题库
            let visibleLibCount = 0;
            catDiv.querySelectorAll('.draggable-lib').forEach(libDiv => {
              const lidx = parseInt(libDiv.getAttribute('data-lidx'));
              const lib = (window.categories || [])[cidx]?.libraries[lidx];
              let libMatch = false;
              if (kw === '') {
                libMatch = true;
              } else {
                // 名称匹配
                libMatch = libDiv.innerText.toLowerCase().includes(kw);
                // 题干匹配
                if (!libMatch && lib && Array.isArray(lib.questions)) {
                  libMatch = lib.questions.some(q => (q.stem || '').toLowerCase().includes(kw));
                }
              }
              libDiv.style.display = libMatch ? '' : 'none';
              if (libMatch) visibleLibCount++;
            });

            // 分类可见性与展开
            const catVisible = catMatch || visibleLibCount > 0;
            catDiv.style.display = catVisible ? '' : 'none';
            if (catVisible) {
              // 展开显示匹配结果
              catBody.classList.remove('hidden');
            }
          });
          return;
        }

        // ---- 错题本 / 收藏夹列表搜索 ----
        const isWrong = activeTab === 'wrong';
        const catSelector = isWrong ? '#wrongbook-list .wrong-cat' : '#favbook-list .fav-cat';
        const libSelector = isWrong ? '.wrong-lib' : '.fav-lib';

        document.querySelectorAll(catSelector).forEach(catDiv => {
          const catHeaderText = catDiv.querySelector('.cat-header')?.innerText.toLowerCase() || '';
          let catMatch = kw!=='' && catHeaderText.includes(kw);

          let visibleLibCount = 0;
          catDiv.querySelectorAll(libSelector).forEach(libDiv => {
            const libText = libDiv.querySelector('.lib-header')?.innerText.toLowerCase() || '';
            const match = kw==='' || libText.includes(kw) || libDiv.innerText.toLowerCase().includes(kw);
            libDiv.style.display = match ? '' : 'none';
            if (match) visibleLibCount++;
          });

          const catVisible = kw==='' ? true : (catMatch || visibleLibCount>0);
          catDiv.style.display = catVisible ? '' : 'none';

          const catBody = catDiv.querySelector('.cat-body');
          if (catVisible && kw!=='') {
            catBody?.classList.remove('hidden'); // 展开匹配分类
          } else if (kw==='') {
            // 清空搜索后折叠全部
            catBody?.classList.add('hidden');
          }
        });
      };

      searchInput.addEventListener('input', performFilter);

      // 切换标签时重置输入及占位符
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const tab = btn.dataset.tab;
          searchInput.placeholder = tab === 'library' ? '搜索题库…' : (tab === 'wrong' ? '搜索错题…' : '搜索收藏…');
          searchInput.value = '';
          performFilter();
        });
      });
    }

    // 注意：下载模板功能已在上方实现，无需重复添加事件监听器

    /* ---------- 通用：按 分类 > 题库 分组 ---------- */
    function groupByCatLib(arr) {
      const map = {};
      arr.forEach((q, idx) => {
        const cat = q._categoryName || '未分类';
        const lib = q._libraryName || '未知题库';
        if (!map[cat]) map[cat] = {};
        if (!map[cat][lib]) map[cat][lib] = [];
        map[cat][lib].push({ q, idx });
      });
      return map;
    }

    // Fisher-Yates shuffle
    function shuffleArray(arr){
      for(let i=arr.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]]=[arr[j],arr[i]];
      }
      return arr;
    }

    /* ========= 学习统计功能 ========= */
    const STATS_KEY = 'tj_stats';

    function loadStats(){
      try{
        const raw = localStorage.getItem(STATS_KEY);
        return raw ? JSON.parse(raw) : { totalCorrect:0, totalIncorrect:0, categories:{} };
      }catch(e){
        console.warn('Stats parse failed',e);
        return { totalCorrect:0, totalIncorrect:0, categories:{} };
      }
    }

    function saveStats(stats){
      localStorage.setItem(STATS_KEY, JSON.stringify(stats));
    }

    // 调用此函数以更新统计，后续做答题功能时可复用
    function updateStats(category, isCorrect){
      const stats = loadStats();
      if(isCorrect) stats.totalCorrect++; else stats.totalIncorrect++;
      if(!stats.categories[category]) stats.categories[category] = { correct:0, incorrect:0 };
      if(isCorrect) stats.categories[category].correct++; else stats.categories[category].incorrect++;
      saveStats(stats);
    }

    let overallChart;

    function renderStats(){
      const stats = loadStats();

      // 总体图表
      const overallCtx = document.getElementById('overall-chart').getContext('2d');
      if(overallChart) overallChart.destroy();
      const total = stats.totalCorrect + stats.totalIncorrect;
      let doughnutData;
      if(total===0){
        doughnutData=[1];
      }else{
        doughnutData=[stats.totalCorrect,stats.totalIncorrect];
      }
      overallChart = new Chart(overallCtx, {
        type:'doughnut',
        data:{
          labels: total===0?['暂无数据']:['正确','错误'],
          datasets:[{
            data:doughnutData,
            backgroundColor: total===0? ['#e5e7eb']:['#4ade80','#f87171'],
            borderWidth:0,
            cutout:'70%'
          }]
        },
        options:{responsive:true, plugins:{ legend:{ display:false }}}
      });

      /* 题型条形图 */
      const typeCtx=document.getElementById('type-chart').getContext('2d');
      const types=['单选','多选'];
      const typeData=types.map(t=>stats.byType?.[t]?.correct||0);
      const totalType=typeData.reduce((a,b)=>a+b,0);
      if(window.typeChart) window.typeChart.destroy();
      window.typeChart=new Chart(typeCtx,{
        type:'bar',
        data:{
          labels:types,
          datasets:[{
            data: totalType===0? [0,0]:typeData,
            backgroundColor: totalType===0? '#e5e7eb':['#6366f1','#a78bfa']
          }]
        },
        options:{
          responsive:true,
          plugins:{legend:{display:false}},
          scales:{y:{beginAtZero:true}}
        }
      });

      // 更新数字摘要
      document.getElementById('total-count').textContent = total;
      document.getElementById('correct-count').textContent = stats.totalCorrect;
      document.getElementById('incorrect-count').textContent = stats.totalIncorrect;

      // 生成分类表现 TOP3
      const categoryContainer = document.getElementById('top-categories');
      categoryContainer.innerHTML = '';
      const sortedCats = Object.entries(stats.categories).sort((a,b)=>{
        const ta=a[1].correct+a[1].incorrect, tb=b[1].correct+b[1].incorrect; return tb-ta;});
      sortedCats.slice(0,3).forEach(([name,data])=>{
        const total=data.correct+data.incorrect;
        const percent=total?Math.round(data.correct/total*100):0;
        const bar=`<div class='flex items-center gap-2'>
          <span class='w-20 truncate'>${name}</span>
          <div class='flex-1 h-2 bg-gray-200 rounded overflow-hidden'>
            <div class='h-2 bg-green-400' style='width:${percent}%'></div>
          </div>
          <span class='w-12 text-right'>${percent}%</span>
        </div>`;
        categoryContainer.insertAdjacentHTML('beforeend',bar);
      });

      /* centerText 插件：在圆环图中心绘制百分比 */
      if(!Chart.registry.plugins.get('centerText')){
        Chart.register({
          id:'centerText',
          afterDraw(chart){
            if(chart.config.type!=='doughnut') return;
            const {ctx,width,height} = chart;
            const data = chart.data.datasets[0].data;
            const totalVal = data.reduce((a,b)=>a+b,0);
            const percent = totalVal?Math.round(data[0]/totalVal*100):0;
            ctx.save();
            ctx.font = 'bold 32px "Noto Sans SC", sans-serif';
            ctx.fillStyle = '#4ade80';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(percent + '%', width/2, height/2);
            ctx.restore();
          }
        });
      }
    }

    // 按钮监听与页面切换
    document.getElementById('stats-btn')?.addEventListener('click', ()=>{
      document.getElementById('main-section')?.classList.add('hidden');
      document.getElementById('search-result')?.classList.add('hidden');
      document.getElementById('stats-section')?.classList.remove('hidden');
      renderStats();
    });

    // === 笔记功能 ===
    let quill = null; // Quill实例
    async function getNotes(){
      if(typeof window.electronAPI!=='undefined' && window.electronAPI.loadNotes){
        const res=await window.electronAPI.loadNotes();
        if(res.success && res.data) return res.data;
      }
      return JSON.parse(localStorage.getItem('tijing-notes')||'{}');
    }
    async function setNotes(obj){
      if(typeof window.electronAPI!=='undefined' && window.electronAPI.saveNotes){
        await window.electronAPI.saveNotes(obj);
      }
      localStorage.setItem('tijing-notes',JSON.stringify(obj));
    }
    // 根据题库名、分类名、题干生成稳定且唯一的 key；避免题干文本小改导致无法匹配。
    function getQuestionKey(q){
      // 若缺少元数据则回退为空串，保持格式一致
      const lib = (q._libraryName || '').trim();
      const cat = (q._categoryName || '').trim();
      const stem = (q.stem || '').replace(/\s+/g,' ').trim();
      // 组合后做简单长度限制，足够唯一
      return `${lib}::${cat}::${stem}`.slice(0,150);
    }

    // 打开笔记弹窗函数（集成Quill）
    async function openNoteModal(q) {
      const modal = document.getElementById('note-modal');
      const modalBg = document.getElementById('note-modal-bg');
      const saveBtn = document.getElementById('note-save');
      const closeBtn = document.getElementById('note-close');
      const deleteBtn = document.getElementById('note-delete');
      const previewBtn = document.getElementById('note-preview-toggle');
      const dragElement = document.querySelector('.note-draggable');
      const dragHandle = document.getElementById('note-drag-handle');
      // 为笔记生成唯一的键
      const key = getQuestionKey(q);
      const notes = await getNotes();
      const rawNote = notes[key] || '';
      const existing = (typeof rawNote==='object' && rawNote!==null) ? rawNote : {mode:'rich',content:String(rawNote)};
      // 初始化Quill（只初始化一次）
      if (!quill) {
        const COLORS = [false, '#000000', '#e60000', '#ff9900', '#ffff00', '#008a00', '#0066cc', '#9933ff'];
        quill = new Quill('#note-editor', {
          theme: 'snow',
          modules: {
            toolbar: [
              ['bold', 'italic'],
              [{ 'color': COLORS }, { 'background': COLORS }],
              [{ 'list': 'ordered'}, { 'list': 'bullet' }],
              ['code-block', 'image']
            ]
          }
        });
      }
      // 设置内容
      quill.root.innerHTML = existing.mode==='md' ? '' : (existing.content||'');
      // 显示模态框
      modal.classList.remove('hidden');
      // 重置弹窗位置
      dragElement.style.transform = 'translate(-50%, -50%)';
      // 阻止点击事件冒泡到背景
      dragElement.addEventListener('click', (e) => {
        e.stopPropagation();
      });
      // 背景点击关闭
      modalBg.onclick = () => {
        modal.classList.add('hidden');
      };
      // 关闭按钮
      closeBtn.onclick = (e) => {
        e.stopPropagation();
        modal.classList.add('hidden');
      };
      // 保存按钮
      saveBtn.onclick = async (e) => {
        e.stopPropagation();
        const content = quill.root.innerHTML;
        notes[key] = {mode:currentMode, content};
        await setNotes(notes);
        modal.classList.add('hidden');
      };
      // 删除笔记按钮
      deleteBtn.onclick = async (e) => {
        e.stopPropagation();
        if (confirm('确定要删除此笔记吗？')) {
          delete notes[key];
          await setNotes(notes);
          modal.classList.add('hidden');
        }
      };
      // 预览按钮隐藏（Quill已自带所见即所得）
      if (previewBtn) previewBtn.style.display = 'none';
      // 初始化拖动功能
      initDraggable(dragElement, dragHandle);
      // 为工具栏按钮和颜色选项添加提示
      addQuillTooltips();
      // 确保工具栏扩展控件存在（模式切换+预览）
      ensureToolbarExtras();
    }

    // 初始化拖动功能
    function initDraggable(element, handle) {
      if (!element || !handle) return;
      
      let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
      
      handle.onmousedown = dragMouseDown;
      
      function dragMouseDown(e) {
        e = e || window.event;
        e.preventDefault();
        e.stopPropagation(); // 阻止事件冒泡到背景
        
        // 获取鼠标初始位置
        pos3 = e.clientX;
        pos4 = e.clientY;
        document.onmouseup = closeDragElement;
        // 鼠标移动时调用elementDrag
        document.onmousemove = elementDrag;
      }
      
      function elementDrag(e) {
        e = e || window.event;
        e.preventDefault();
        e.stopPropagation(); // 阻止事件冒泡到背景
        
        // 计算新位置
        pos1 = pos3 - e.clientX;
        pos2 = pos4 - e.clientY;
        pos3 = e.clientX;
        pos4 = e.clientY;
        
        // 更新元素位置
        const currentTransform = window.getComputedStyle(element).getPropertyValue('transform');
        const matrix = new DOMMatrix(currentTransform);
        const currentX = matrix.m41;
        const currentY = matrix.m42;
        
        element.style.transform = `translate(${currentX - pos1}px, ${currentY - pos2}px)`;
      }
      
      function closeDragElement() {
        document.onmouseup = null;
        document.onmousemove = null;
      }
    }

    // 高亮当前练习的题库
    function highlightActiveLibrary(library) {
      // 首先清除所有之前的高亮
      document.querySelectorAll('.active-practice-library').forEach(el => {
        el.classList.remove('active-practice-library');
      });
      
      // 查找对应的题库元素并添加高亮
      const libraryElements = document.querySelectorAll('.draggable-lib');
      libraryElements.forEach(libElement => {
        const libName = libElement.querySelector('.filename')?.textContent?.trim();
        if (libName === library.name) {
          // 添加高亮类到题库元素
          libElement.classList.add('active-practice-library');
          
          // 确保包含该题库的分类是展开的
          const categoryElement = libElement.closest('.draggable-cat');
          if (categoryElement) {
            const cidx = categoryElement.getAttribute('data-cidx');
            const catBody = document.getElementById(`cat-body-${cidx}`);
            if (catBody && catBody.classList.contains('hidden')) {
              catBody.classList.remove('hidden');
            }
          }
          
          // 滚动到高亮的题库元素
          libElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
      });
    }

  
    // 笔记编辑工具栏功能
    document.addEventListener('DOMContentLoaded', () => {
      // 添加笔记工具栏按钮事件
      document.querySelectorAll('.note-tool').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          const command = btn.getAttribute('data-cmd');
          
          if (command === 'bold') {
            toggleBold();
          } else if (command === 'italic') {
            toggleItalic();
          } else if (command === 'ul') {
            toggleList('ul');
          } else if (command === 'ol') {
            toggleList('ol');
          }
          
          // 确保编辑器获得焦点
          document.getElementById('note-editor').focus();
        });
      });
    });

    // 初始化分类折叠状态
    function initCategoryFoldState() {
      categoryFoldState = JSON.parse(localStorage.getItem('tijing-category-fold') || '{}');
      console.log('分类折叠状态初始化完成');
    }

    // ====== 新增：原生JS实现富文本功能 ======
    // 加粗功能
    function toggleBold() {
      const editor = document.getElementById('note-editor');
      const selection = window.getSelection();
      if (!selection.rangeCount) return;
      const range = selection.getRangeAt(0);
      // 检查是否在<b>或<strong>标签内
      let node = selection.anchorNode;
      while (node && node !== editor) {
        if (node.nodeName === 'B' || node.nodeName === 'STRONG') {
          // 移除加粗：用父节点替换当前节点
          const parent = node.parentNode;
          while (node.firstChild) parent.insertBefore(node.firstChild, node);
          parent.removeChild(node);
          return;
        }
        node = node.parentNode;
      }
      // 否则加粗选区
      const bold = document.createElement('b');
      bold.appendChild(range.extractContents());
      range.insertNode(bold);
      // 重新聚焦
      editor.focus();
    }
    // 斜体功能
    function toggleItalic() {
      const editor = document.getElementById('note-editor');
      const selection = window.getSelection();
      if (!selection.rangeCount) return;
      const range = selection.getRangeAt(0);
      // 检查是否在<i>或<em>标签内
      let node = selection.anchorNode;
      while (node && node !== editor) {
        if (node.nodeName === 'I' || node.nodeName === 'EM') {
          const parent = node.parentNode;
          while (node.firstChild) parent.insertBefore(node.firstChild, node);
          parent.removeChild(node);
          return;
        }
        node = node.parentNode;
      }
      // 否则斜体选区
      const italic = document.createElement('i');
      italic.appendChild(range.extractContents());
      range.insertNode(italic);
      editor.focus();
    }
    // 有序/无序列表功能
    function toggleList(type) {
      const editor = document.getElementById('note-editor');
      const selection = window.getSelection();
      if (!selection.rangeCount) return;
      const range = selection.getRangeAt(0);
      // 检查是否已在列表中
      let node = selection.anchorNode;
      while (node && node !== editor) {
        if (node.nodeName === 'UL' || node.nodeName === 'OL') {
          // 已在列表中，移除列表
          const parent = node.parentNode;
          while (node.firstChild) parent.insertBefore(node.firstChild, node);
          parent.removeChild(node);
          return;
        }
        node = node.parentNode;
      }
      // 否则插入新列表
      const list = document.createElement(type);
      const li = document.createElement('li');
      li.textContent = selection.toString() || '新列表项';
      list.appendChild(li);
      // 替换选区内容为列表
      range.deleteContents();
      range.insertNode(list);
      // 移动光标到新列表项
      selection.removeAllRanges();
      const newRange = document.createRange();
      newRange.selectNodeContents(li);
      newRange.collapse(false);
      selection.addRange(newRange);
      editor.focus();
    }

    /* 为 Quill 工具栏按钮和颜色选项添加 title 提示 */
    function addQuillTooltips(){
      const toolbar = document.querySelector('.ql-toolbar');
      if(!toolbar) return;
      // 基本按钮
      const btnMap = {
        '.ql-bold':'加粗',
        '.ql-italic':'斜体',
        'button.ql-list[value="ordered"]':'有序列表',
        'button.ql-list[value="bullet"]':'无序列表',
        '.ql-code-block':'代码块',
        '.ql-image':'插入图片'
      };
      Object.entries(btnMap).forEach(([sel,text])=>{
        const el=toolbar.querySelector(sel);
        if(el){
          el.setAttribute('title',text);
          // 阻止按钮获取焦点导致选区丢失
          el.addEventListener('mousedown',e=>e.preventDefault());
        }
      });
      // 颜色名称映射
      const colorName={
        '':'默认',
        '#000000':'黑色','#e60000':'红色','#ff9900':'橙色',
        '#ffff00':'黄色','#008a00':'绿色','#0066cc':'蓝色','#9933ff':'紫色'
      };
      toolbar.querySelectorAll('.ql-color .ql-picker-item').forEach(item=>{
        const val=item.getAttribute('data-value')||'';
        const name=colorName[val]||'默认';
        item.setAttribute('title',name);
        item.addEventListener('mousedown',e=>e.preventDefault());
      });
      toolbar.querySelectorAll('.ql-background .ql-picker-item').forEach(item=>{
        const val=item.getAttribute('data-value')||'';
        const name=colorName[val]||'默认';
        item.setAttribute('title',`高亮-${name}`);
        item.addEventListener('mousedown',e=>e.preventDefault());
      });
    }

    /* 当前编辑模式 */
    let currentMode='rich';
    function switchEditMode(mode){
      currentMode=mode;
      const qe=document.getElementById('note-editor');
      const mw=document.getElementById('md-wrapper');
      const md=document.getElementById('md-editor');
      const pv=document.getElementById('md-preview');
      const previewBtn=document.getElementById('md-preview-toggle');
      if(mode==='rich'){
        qe.classList.remove('hidden');
        mw.classList.add('hidden');
        md.classList.add('hidden');
        pv.classList.add('hidden');
        previewBtn.classList.add('hidden');
      }else{
        qe.classList.add('hidden');
        mw.classList.remove('hidden');
        pv.classList.add('hidden');
        md.classList.remove('hidden');
        previewBtn.classList.remove('hidden');
        previewBtn.dataset.state='edit';
      }
    }

    function toggleMdPreview(){
      if(currentMode!=='md') return;
      const mw=document.getElementById('md-wrapper');
      const md=document.getElementById('md-editor');
      const pv=document.getElementById('md-preview');
      const btn=document.getElementById('md-preview-toggle');
      if(btn.dataset.state==='edit'){
        // 渲染
        pv.innerHTML = marked.parse(md.value||'');
        md.classList.add('hidden');
        pv.classList.remove('hidden');
        btn.dataset.state='preview';
        btn.innerHTML='<i class="fas fa-edit"></i>';
        btn.title='返回编辑';
      }else{
        pv.classList.add('hidden');
        md.classList.remove('hidden');
        btn.dataset.state='edit';
        btn.innerHTML='<i class="fas fa-eye"></i>';
        btn.title='浏览';
      }
    }

    // 确保工具栏扩展控件存在（模式选择 & 预览）
    function ensureToolbarExtras(){
      if(!quill) return;
      const toolbarEl=quill.getModule('toolbar').container;
      if(!toolbarEl) return;
      // 清理旧版控件
      const oldSel=document.getElementById('note-mode-select');
      if(oldSel) oldSel.parentElement?.remove();
      const oldGrp=document.querySelector('.mode-group');
      if(oldGrp) oldGrp.remove();

      if(document.getElementById('mode-toggle')) return; // 已创建
      const group=document.createElement('span');
      group.className='toolbar-extras';
      // 确保 toolbar 是 flex 布局
      const tbStyle=getComputedStyle(toolbarEl);
      if(tbStyle.display!=="flex"){
        toolbarEl.style.display='flex';
        toolbarEl.style.flexWrap='wrap';
        toolbarEl.style.alignItems='center';
      }
      // —— 单一切换按钮 ——
      const modeBtn=document.createElement('button');
      modeBtn.id='mode-toggle';
      modeBtn.className='mode-toggle active';
      modeBtn.innerHTML='<i class="fas fa-retweet mr-1"></i><span class="mode-label">Text</span>';
      modeBtn.title='切换为 Markdown 编辑';

      modeBtn.onclick=()=>{
        if(currentMode==='rich'){
          switchEditMode('md');
          modeBtn.innerHTML='<i class="fas fa-retweet mr-1"></i><span class="mode-label">MD</span>';
          modeBtn.title='切换为 普通文本编辑';
        }else{
          switchEditMode('rich');
          modeBtn.innerHTML='<i class="fas fa-retweet mr-1"></i><span class="mode-label">Text</span>';
          modeBtn.title='切换为 Markdown 编辑';
        }
      };

      // 预览按钮
      const pvBtn=document.createElement('button');
      pvBtn.id='md-preview-toggle';
      pvBtn.title='浏览';
      pvBtn.innerHTML='<i class="fas fa-eye"></i>';
      pvBtn.dataset.state='edit';
      pvBtn.addEventListener('mousedown',e=>e.preventDefault());
      // 组装 顺序：模式切换按钮 | 👁
      group.appendChild(modeBtn);
      group.appendChild(pvBtn);
      toolbarEl.appendChild(group);
      pvBtn.onclick=toggleMdPreview;
      // 初始状态
      switchEditMode(currentMode);
    }

    // 将文本中的纯图片 URL 转成 <img> 标签（支持 jpg/png/gif/webp/svg）
    function convertImageLinks(text){
      if(!text) return '';
      const urlRegex = /(https?:\/\/[^\s"'>]+\.(?:png|jpe?g|gif|webp|svg))(?![^<]*>)/gi;
      // 为图片添加 zoomable-img 类并设置光标指针，后续可通过该类实现点击放大
      return text.replace(urlRegex, (url)=>`<img src="${url}" alt="图片" class="zoomable-img" style="max-width:100%;display:block;margin:8px auto;cursor:zoom-in;">`);
    }

    // === 图片点击放大查看 (简易 Lightbox) ===
    // 放在 DOMContentLoaded 回调中，确保元素已渲染再挂载
    document.addEventListener('DOMContentLoaded', () => {
      // 创建遮罩层及内部图片元素
      const lightbox = document.createElement('div');
      lightbox.id = 'img-lightbox';
      lightbox.className = 'hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-80 z-50';
      lightbox.innerHTML = '<img id="img-lightbox-img" style="max-width:90%;max-height:90%;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,0.5);cursor:zoom-out;" />';
      document.body.appendChild(lightbox);

      // 点击遮罩或图片本身即可关闭
      lightbox.addEventListener('click', () => {
        lightbox.classList.add('hidden');
      });

      // 事件委托：捕获所有 .zoomable-img 点击事件
      document.body.addEventListener('click', (e) => {
        const target = e.target;
        if(target && target.classList && target.classList.contains('zoomable-img')){
          const img = document.getElementById('img-lightbox-img');
          img.src = target.currentSrc || target.src;
          lightbox.classList.remove('hidden');
        }
      });

      // === 滚轮缩放功能 ===
      const lbImg = document.getElementById('img-lightbox-img');
      let lbScale = 1;

      // 鼠标滚轮控制缩放，范围 0.5x - 5x
      lbImg.addEventListener('wheel', (e) => {
        e.preventDefault(); // 阻止页面滚动
        if (e.deltaY < 0) {
          lbScale = Math.min(lbScale * 1.2, 5);
        } else {
          lbScale = Math.max(lbScale / 1.2, 0.5);
        }
        lbImg.style.transform = `scale(${lbScale})`;
      }, { passive: false });

      // 关闭 lightbox 时重置缩放
      lightbox.addEventListener('click', () => {
        lbScale = 1;
        lbImg.style.transform = 'scale(1)';
      });

      // 打开 lightbox 时也重置缩放
      document.body.addEventListener('click', (e) => {
        const t = e.target;
        if (t && t.classList && t.classList.contains('zoomable-img')) {
          lbScale = 1;
          lbImg.style.transform = 'scale(1)';
        }
      });
    });

    // ========== 进度保存/恢复/清除 ========== //
    function savePracticeProgress(library, currentIdx, userAnswers, submitted, finished) {
      try {
        const key = 'tijing_progress';
        let progress = JSON.parse(localStorage.getItem(key) || '{}');
        const id = library.id || library.name;
        progress[id] = {
          currentIndex: currentIdx,
          userAnswers: JSON.parse(JSON.stringify(userAnswers)),
          submitted: JSON.parse(JSON.stringify(submitted)),
          finished: !!finished
        };
        localStorage.setItem(key, JSON.stringify(progress));
      } catch (e) {}
    }
    function loadPracticeProgress(library) {
      try {
        const key = 'tijing_progress';
        const id = library.id || library.name;
        const progress = JSON.parse(localStorage.getItem(key) || '{}');
        return progress[id] || null;
      } catch (e) { return null; }
    }
    function clearPracticeProgress(library) {
      try {
        const key = 'tijing_progress';
        const id = library.id || library.name;
        let progress = JSON.parse(localStorage.getItem(key) || '{}');
        delete progress[id];
        localStorage.setItem(key, JSON.stringify(progress));
      } catch (e) {}
    }

    // ========== 结束页按钮逻辑 ========== //
    document.addEventListener('click', function(e) {
      if (e.target && e.target.id === 'restart-practice') {
        clearPracticeProgress(practiceState.library);
        showToast('进度已清除');
        setTimeout(()=>{
          startPractice(practiceState.library);
        }, 600);
      }
      if (e.target && e.target.id === 'end-practice') {
        practiceState.finished = true;
        savePracticeProgress(practiceState.library, practiceState.current, practiceState.userAnswers, practiceState.submitted, true);
        showToast('已标记为完成');
        renderPractice();
        renderAnswerSheet();
      }
    });

    function showToast(message, duration = 2000) {
      let toast = document.getElementById('toast-message');
      if (!toast) {
        toast = document.createElement('div');
        toast.id = 'toast-message';
        toast.style.position = 'fixed';
        toast.style.bottom = '20px';
        toast.style.left = '50%';
        toast.style.transform = 'translateX(-50%)';
        toast.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
        toast.style.color = 'white';
        toast.style.padding = '10px 20px';
        toast.style.borderRadius = '4px';
        toast.style.zIndex = '1000';
        toast.style.transition = 'opacity 0.3s';
        document.body.appendChild(toast);
      }
      toast.textContent = message;
      toast.style.opacity = '1';
      clearTimeout(toast.timeoutId);
      toast.timeoutId = setTimeout(() => {
        toast.style.opacity = '0';
      }, duration);
    }
  </script>
</body>
</html> 
