<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>é¢˜å¢ƒ | æœ¬åœ°é¢˜åº“ç³»ç»Ÿ</title>
  <!-- Tailwind CSS -->
  <link href="https://cdn.staticfile.org/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link href="https://cdn.staticfile.org/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <!-- Noto Serif SC & Noto Sans SC -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;500;600;700&family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
  <!-- SheetJS for xlsx parsing -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- æœ¬åœ° SheetJS å¤‡ä»½ï¼Œé¿å…ç½‘ç»œé—®é¢˜ -->
  <script>
    // æ£€æŸ¥ XLSX æ˜¯å¦å·²åŠ è½½ï¼Œå¦‚æœæ²¡æœ‰åˆ™åŠ è½½æœ¬åœ°ç‰ˆæœ¬
    window.addEventListener('DOMContentLoaded', function() {
      if (typeof XLSX === 'undefined') {
        console.log('CDNåŠ è½½å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°XLSXåº“');
        const script = document.createElement('script');
        script.src = './xlsx.full.min.js'; // æœ¬åœ°å¤‡ä»½
        document.head.appendChild(script);
      } else {
        console.log('CDNåŠ è½½æˆåŠŸ');
      }
    });
  </script>
  <!-- Marked.js for Markdown rendering -->
  <!-- ä¼˜å…ˆCDNï¼Œå¤±è´¥è‡ªåŠ¨é™çº§ä¸ºæœ¬åœ° -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    if (typeof marked === 'undefined' || typeof marked.parse !== 'function') {
      var script = document.createElement('script');
      script.src = './src/marked.min.js';
      document.head.appendChild(script);
    }
  </script>
  <!-- Chart.js for statistics -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <!-- å…‰å½±ä¹¦æ¶è‰ºæœ¯çº§è§†è§‰å‡çº§CSSï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼Œ2024ï¼‰ -->
  <style>
    body {
      background: radial-gradient(ellipse at 60% 20%, #e0e7ff 0%, #f8fafc 60%, #f1f5f9 100%);
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
      font-family: 'Noto Serif SC', serif;
    }
    /* ä¸‰æ ç©ºé—´åˆ†éš”ä¸æŸ”å’Œå…‰å½± */
    aside, #main-section {
      box-shadow: 0 8px 32px 0 rgba(99,102,241,0.10), 0 1.5px 4px 0 rgba(0,0,0,0.04);
      border-radius: 1.5rem;
      background: rgba(255,255,255,0.85);
      backdrop-filter: blur(2.5px);
      margin: 1.5rem 0.5rem;
      border: 1.5px solid #e0e7ff;
      transition: box-shadow 0.3s, background 0.3s;
    }
    aside {
      background: linear-gradient(120deg, #f8fafc 80%, #e0e7ff 100%);
    }
    #main-section {
      background: linear-gradient(120deg, #f8fafc 60%, #e0e7ff 100%);
      box-shadow: 0 12px 48px 0 rgba(99,102,241,0.13), 0 2px 8px 0 rgba(0,0,0,0.04);
    }
    /* å¡ç‰‡å‡çº§ */
    .draggable-cat, .draggable-lib, .group.bg-white, .group.bg-gray-900 {
      box-shadow: 0 4px 16px 0 rgba(99,102,241,0.08), 0 1px 2px 0 rgba(0,0,0,0.03);
      border-radius: 1.1rem;
      border: 1.5px solid #e0e7ff;
      background: rgba(255,255,255,0.97);
      transition: box-shadow 0.2s, background 0.2s;
    }
    .draggable-cat:hover, .draggable-lib:hover {
      box-shadow: 0 8px 32px 0 rgba(99,102,241,0.13), 0 2px 8px 0 rgba(0,0,0,0.04);
      background: #f1f5fa;
    }
    /* è§£æåŒºè‰ºæœ¯åŒ– */
    .markdown-body, #explanation-md {
      background: linear-gradient(90deg, #f8f9ff 0%, #e8ecff 100%);
      border-left: 6px solid #6366f1;
      border-radius: 1.1rem;
      padding: 1.3em 1.6em;
      font-style: normal;
      line-height: 1.85;
      letter-spacing: 0.02em;
      box-shadow: 0 2px 8px 0 rgba(99,102,241,0.08);
      margin-top: 0.5em;
      position: relative;
      word-break: break-word;
      white-space: pre-line;
    }
    /* Xiaohongshu é£æ ¼åˆ—è¡¨ç¬¦å· */
    .markdown-body ul, #explanation-md ul {list-style:none; padding-left:0; margin-left:0;}
    .markdown-body ul li, #explanation-md ul li {position:relative; padding-left:1.4em; margin:0.4em 0;}
    .markdown-body ul li::before, #explanation-md ul li::before {
      content:'ğŸ“';
      position:absolute; left:0; top:0.1em;
    }
    /* æ®µè½é—´è· */
    .markdown-body p, #explanation-md p {margin:0.6em 0;}
    /* å¤œé—´è§£æåŒºæ–‡æœ¬æäº® */
    .dark .markdown-body, .dark #explanation-md {color:#e5e7eb;}
    /* è§£æåŒºå¼•å·è£…é¥° */
    .markdown-body:before, #explanation-md:before {
      content: '"';
      font-size: 2.5em;
      color: #fbbf24;
      position: absolute;
      left: 1.1em; top: 0.2em;
      opacity: 0.18;
      font-family: serif;
      pointer-events: none;
    }
    /* æŒ‰é’®ä¸è¿›åº¦æ¡å‡çº§ */
    button, .practice-btn, #fav-btn {
      box-shadow: 0 2px 8px 0 rgba(99,102,241,0.08);
      border-radius: 1.1rem;
      transition: box-shadow 0.2s, background 0.2s, transform 0.15s;
    }
    button:hover, .practice-btn:hover, #fav-btn:hover {
      box-shadow: 0 4px 16px 0 rgba(99,102,241,0.13);
      transform: translateY(-2px) scale(1.04);
    }
    .w-56 .grid button {
      border: 2px solid #e0e7ff;
      background: linear-gradient(120deg, #f8fafc 80%, #e0e7ff 100%);
    }
    /* è¿›åº¦æ¡å‡çº§ */
    .w-56.h-2.bg-gray-200 {
      background: linear-gradient(90deg, #e0e7ff 0%, #f8fafc 100%);
    }
    .h-2.bg-gradient-to-r {
      box-shadow: 0 1px 4px 0 rgba(99,102,241,0.13);
    }
    /* é”™é¢˜æœ¬/æ”¶è—å¤¹åŒºå—æè´¨æ„Ÿ */
    #tab-wrong, #tab-fav {
      background: linear-gradient(120deg, #fff7f7 80%, #ffeaea 100%);
      border-radius: 1.2rem;
      box-shadow: 0 4px 16px 0 rgba(239,68,68,0.07);
    }
    #tab-fav {
      background: linear-gradient(120deg, #fffbe6 80%, #fff3c4 100%);
      box-shadow: 0 4px 16px 0 rgba(251,191,36,0.07);
    }
    /* ä¸»é¢˜LOGOå‡çº§ä¸ºåŸåˆ›SVGå›¾æ ‡ */
    .logo-tijing {
      display:inline-block;
    }
    .logo-tijing svg {
      width:40px;
      height:40px;
      filter: drop-shadow(0 2px 8px #a5b4fc88);
      border-radius: 1.2rem;
      background: linear-gradient(120deg, #e0e7ff 60%, #f8fafc 100%);
    }
    /* ä¸»åŠŸèƒ½åŒºå›¾æ ‡å‡çº§ä¸ºåŸåˆ›SVG */
    .fa-folder-open:before, .fa-times-circle:before, .fa-star:before {
      content: '' !important;
      display: none !important;
    }
    .tab-btn[data-tab="library"] i::before {
      content: '';
      display: inline-block;
      width: 1.5em; height: 1.5em;
      background: url('data:image/svg+xml;utf8,<svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="4" y="8" width="24" height="16" rx="4" fill="%236366f1" fill-opacity="0.13"/><rect x="4" y="8" width="24" height="16" rx="4" stroke="%236366f1" stroke-width="2"/><path d="M8 12 Q16 20 24 12" stroke="%236366f1" stroke-width="2" fill="none"/><ellipse cx="16" cy="10.5" rx="2.5" ry="1.2" fill="%236366f1" fill-opacity="0.5"/></svg>') center/contain no-repeat;
      vertical-align: middle;
    }
    .tab-btn[data-tab="wrong"] i::before {
      content: '';
      display: inline-block;
      width: 1.5em; height: 1.5em;
      background: url('data:image/svg+xml;utf8,<svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="16" cy="16" r="13" fill="%23ef4444" fill-opacity="0.13"/><circle cx="16" cy="16" r="13" stroke="%23ef4444" stroke-width="2"/><path d="M12 12 L20 20 M20 12 L12 20" stroke="%23ef4444" stroke-width="2.5" stroke-linecap="round"/></svg>') center/contain no-repeat;
      vertical-align: middle;
    }
    .tab-btn[data-tab="fav"] i::before {
      content: '';
      display: inline-block;
      width: 1.5em; height: 1.5em;
      background: url('data:image/svg+xml;utf8,<svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg"><polygon points="16,6 19.09,13.26 27,14.27 21,19.14 22.18,27 16,23.27 9.82,27 11,19.14 5,14.27 12.91,13.26" fill="%23fbbf24" fill-opacity="0.13"/><polygon points="16,6 19.09,13.26 27,14.27 21,19.14 22.18,27 16,23.27 9.82,27 11,19.14 5,14.27 12.91,13.26" stroke="%23fbbf24" stroke-width="2"/><polygon points="16,8.5 18.18,13.26 23,13.97 19.5,17.14 20.36,22 16,19.27 11.64,22 12.5,17.14 9,13.97 13.82,13.26" fill="%23fbbf24"/></svg>') center/contain no-repeat;
      vertical-align: middle;
    }
    /* å“åº”å¼ä¼˜åŒ– */
    @media (max-width: 900px) {
      aside, #main-section {
        margin: 0.7rem 0.2rem;
        border-radius: 1.1rem;
      }
    }
    @media (max-width: 700px) {
      aside, #main-section {
        margin: 0.2rem 0;
        border-radius: 0.7rem;
        box-shadow: 0 2px 8px 0 rgba(99,102,241,0.08);
      }
      .logo-tijing svg {
        width: 28px; height: 28px;
      }
    }
    aside.w-56 button i, aside.w-56 button::before, aside.w-56 button::after {
      display: none !important;
    }
    /* å¤œé—´ä¸»é¢˜æ•´ä½“é…è‰²è¦†ç›– */
    .dark body {
      background: radial-gradient(ellipse at 60% 20%, #1e293b 0%, #0f172a 60%, #0a101b 100%);
    }
    /* éšè—åˆ†ç±»æ’­æ”¾æŒ‰é’®ï¼Œå‡å°‘è§†è§‰å¹²æ‰° */
    .practice-cat-btn{display:none!important;}
    /* é¡¶éƒ¨ Header åœ¨å¤œé—´é‡‡ç”¨åŒç³»æ·±è‰²æ¸å˜ï¼Œä¿æŒæ•´ä½“ä¸€è‡´ */
    .dark header {
      background: linear-gradient(120deg, #1f2937 0%, #111827 100%);
      border-bottom-color:#334155;
      box-shadow: 0 2px 6px rgba(0,0,0,0.6);
    }
    .dark .logo-tijing svg {
      background: linear-gradient(120deg, #334155 60%, #1e293b 100%);
    }
    .dark header span.text-base {
      color:#94a3b8; /* slate-400 */
    }
    .dark aside, .dark #main-section {
      background: linear-gradient(120deg, #1f2937 60%, #111827 100%);
      border-color: #334155;
      box-shadow: 0 10px 40px rgba(0,0,0,0.45), 0 2px 6px rgba(0,0,0,0.3);
    }
    .dark .draggable-cat, .dark .draggable-lib, .dark .group.bg-white, .dark .group.bg-gray-900 {
      background: rgba(31,41,55,0.9);
      border-color: #334155;
      box-shadow: 0 6px 24px rgba(0,0,0,0.4);
    }
    .dark button, .dark .practice-btn, .dark #fav-btn {
      box-shadow: 0 2px 6px rgba(0,0,0,0.4);
    }
    .dark .markdown-body, .dark #explanation-md {
      background: linear-gradient(90deg,#1e293b 0%, #334155 100%);
      border-left-color:#fbbf24;
    }
    .dark .w-56 .grid button {
      background: linear-gradient(120deg, #1e293b 80%, #334155 100%);
      border-color:#334155;
    }
    /* å¤œé—´æ»šåŠ¨æ¡ */
    .dark ::-webkit-scrollbar-thumb {background:#334155;}
    .dark ::-webkit-scrollbar-track {background:#111827;}
    /* å¤œé—´ä¸‹ç»ƒä¹ å¡ç‰‡å¼ºåˆ¶æ·±è‰² */
    .dark .practice-card {
      background:#1f2937 !important;
      border-color:#334155 !important;
      color:#e5e7eb;
    }
    .dark .practice-card .text-gray-900,
    .dark .practice-card .text-base,
    .dark .practice-card .text-xl {
      color:#e5e7eb !important;
    }
    .dark .practice-card .text-gray-500 {color:#9ca3af !important;}
    /* å¤œé—´ä¾§æ æ–‡å­—æäº® */
    .dark aside {
      color:#e5e7eb;
    }
    .dark aside .text-gray-600,
    .dark aside .text-gray-700,
    .dark aside .text-gray-800,
    .dark aside .text-gray-900 {
      color:#e5e7eb !important;
    }
    .dark aside .text-gray-500 {color:#9ca3af !important;}
    /* å¤œé—´é€‰é¡¹å¡ç‰‡ç»Ÿä¸€æ·±è‰² */
    .dark .practice-card label.custom-radio {
      background:#1e2638 !important;
      border-color:#3b475c !important;
      color:#e2e8f0 !important;
    }
    .dark .practice-card label.custom-radio:hover {
      background:#27324a !important;
      border-color:#56607a !important;
    }
    .dark .practice-card label.custom-radio.locked {
      background:#2b374d !important;
      border-color:#4b5563 !important;
    }
    /* è§£æåŒºï¼ˆå¡ç‰‡ï¼‰æ—¥é—´ä¸»è‰²è°ƒ */
    .explain-card {
      background:linear-gradient(90deg,#f0f4ff 0%, #e8ecff 100%);
      border-color:#c7d2fe;
    }
    /* å¤œé—´è§£æåŒºä¿æŒæ·±è‰² */
    .dark .explain-card {
      background:linear-gradient(90deg,#182235 0%, #25324a 100%) !important;
      border-color:#475569 !important;
      color:#e5e7eb !important;
    }
    /* å¤œé—´Headeræ–‡æ¡ˆæäº® */
    .dark header .font-extrabold {color:#e5e7eb !important;}
    .dark header span.text-base {color:#cbd5e1 !important;}

    /* éšè—ä¸€é”®å¤‡ä»½æŒ‰é’® */
    #dev-backup-btn {display:none !important;}

    /* å¤œé—´ä¸»é¢˜åˆ‡æ¢æŒ‰é’®æŸ”å’ŒåŒ– */
    .dark #theme-toggle {background:#334155 !important; box-shadow:0 1px 4px rgba(0,0,0,0.4);}
    .dark #theme-toggle:hover {background:#475569 !important;}
    .dark #theme-toggle i {color:#fbbf24 !important; opacity:0.8;}
    /* å¤œé—´ä¸»é¢˜æ¯æ—¥ä¸€è¨€å­—ä½“é¢œè‰²ä¿®æ­£ */
    .dark #daily-quote {
      color: #a5b4fc !important;
    }
    /* é¢˜åº“æ–‡ä»¶åè‡ªåŠ¨æ¢è¡Œ */
    .group.bg-white .font-semibold,
    .group.bg-gray-900 .font-semibold {
      word-break: break-all;
      white-space: normal;
      display: block;
    }
    .group.bg-white, .group.bg-gray-900 {
      min-height: 56px;
    }
    /* ç­”é¢˜å¡é¢˜å·æŒ‰é’®åœ†å½¢ç»Ÿä¸€é£æ ¼ */
    .answer-sheet-btn {
      width: 2.5rem;
      height: 2.5rem;
      min-width: 2.5rem;
      min-height: 2.5rem;
      max-width: 2.5rem;
      max-height: 2.5rem;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s;
      word-break: keep-all;
      padding: 0;
      overflow: hidden;
    }
    .answer-sheet-btn.long {
      font-size: 0.95rem;
    }
    .answer-sheet-btn.xlong {
      font-size: 0.8rem;
    }
    /* ç­”é¢˜å¡é«˜äº®å¤–åœˆç”¨box-shadowå®ç°ï¼Œé¿å…è¢«é®æŒ¡ */
    .answer-sheet-btn.ring-indigo-500 {
      box-shadow: 0 0 0 3px #6366f1;
      border-color: #6366f1 !important;
      z-index: 2;
    }
    .answer-sheet-btn.scale-110 {
      transform: scale(1.10);
    }
    /* å¤œé—´æ¨¡å¼ä¸‹ç¦ç”¨æŒ‰é’®æ ·å¼ä¼˜åŒ– */
    .dark #prev-answer-page[disabled],
    .dark #next-answer-page[disabled] {
      opacity: 0.5;
      background-color: #4b5563 !important; /* gray-600 */
      cursor: not-allowed;
    }
    /* é¢˜åº“å¡ç‰‡æ ·å¼ä¼˜åŒ– */
    .draggable-lib {
      display: flex;
      flex-direction: column;
      min-height: 96px;
      position: relative;
    }
    .draggable-lib .flex.items-center.mb-1 {
      flex: 1;
      margin-bottom: 8px;
    }
    .draggable-lib .flex.items-center.justify-between {
      margin-top: 8px;
      width: 100%;
      flex-shrink: 0; /* ä¸å…è®¸è¡Œè¢«å‹ç¼©åˆ°0é«˜åº¦ */
    }
    .draggable-lib .font-semibold {
      max-height: none;
      overflow: visible;
      display: block;
      line-clamp: unset;
      -webkit-line-clamp: unset;
      box-orient: unset;
      -webkit-box-orient: unset;
      line-height: 1.3;
      word-break: break-word;
    }
    /* æ¸…ç©ºæŒ‰é’®æ ·å¼ */
    .clear-btn {
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }

    /* ç™½å¤©æ¨¡å¼ */
    body:not(.dark-mode) .clear-btn {
      background: #f0f0f0;
      color: #666;
      border: 1px solid #ccc;
    }

    body:not(.dark-mode) .clear-btn:hover {
      background: #e0e0e0;
      color: #333;
    }

    /* å¤œæ™šæ¨¡å¼ */
    body.dark-mode .clear-btn {
      background: rgba(30, 41, 59, 0.5);
      color: #94a3b8;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    body.dark-mode .clear-btn:hover {
      background: rgba(30, 41, 59, 0.8);
      color: #e2e8f0;
    }

    /* ä¿®å¤åˆ—è¡¨å†…å®¹æº¢å‡ºåœ†è§’é—®é¢˜ */
    #wrongbook-list, #favbook-list {
      overflow: hidden;
      border-radius: inherit;
    }

    .question-item {
      margin-bottom: 8px;
      overflow: hidden;
    }

    /* é”™é¢˜æœ¬å’Œæ”¶è—å¤¹å®¹å™¨æ ·å¼ */
    .tab-container {
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
    }

    /* ç™½å¤©æ¨¡å¼ */
    body:not(.dark-mode) .tab-container {
      background: #fff;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    /* å¤œæ™šæ¨¡å¼ */
    body.dark-mode .tab-container {
      background: rgba(13, 18, 30, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    /* æ ‡é¢˜æ æ ·å¼ */
    .tab-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    /* é”™é¢˜æœ¬æ ‡é¢˜æ ·å¼ */
    .wrong-title {
      font-size: 18px;
      font-weight: bold;
      display: flex;
      align-items: center;
    }

    body:not(.dark-mode) .wrong-title {
      color: #ff4d4f;
    }

    body.dark-mode .wrong-title {
      color: #ff7875;
    }

    /* æ”¶è—å¤¹æ ‡é¢˜æ ·å¼ */
    .fav-title {
      font-size: 18px;
      font-weight: bold;
      display: flex;
      align-items: center;
    }

    body:not(.dark-mode) .fav-title {
      color: #faad14;
    }

    body.dark-mode .fav-title {
      color: #ffd666;
    }

    /* ç§»é™¤æŒ‰é’®æ ·å¼ */
    body.dark-mode .remove-btn {
      background: rgba(30, 41, 59, 0.5);
      color: #94a3b8;
      border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 2px 8px;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }

    body.dark-mode .remove-btn:hover {
      background: rgba(30, 41, 59, 0.8);
      color: #e2e8f0;
    }

    /* é”™é¢˜æœ¬å’Œæ”¶è—å¤¹å®¹å™¨åŸºç¡€æ ·å¼ */
    .tab-container {
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
    }

    /* ç™½å¤©æ¨¡å¼ */
    body:not(.dark-mode) #tab-wrong {
      background: #fff1f0;
    }

    body:not(.dark-mode) #tab-fav {
      background: #fffbe6;
    }

    /* å¤œæ™šæ¨¡å¼ */
    body.dark-mode #tab-wrong {
      background: rgba(71, 27, 27, 0.3);
    }

    body.dark-mode #tab-fav {
      background: rgba(82, 72, 21, 0.3);
    }

    /* åˆ—è¡¨å®¹å™¨æ ·å¼ */
    #wrongbook-list, #favbook-list {
      overflow: hidden;
      border-radius: 8px;
    }

    /* åˆ—è¡¨é¡¹æ ·å¼ */
    .question-item {
      padding: 12px;
      margin-bottom: 8px;
      border-radius: 8px;
    }

    /* ç™½å¤©æ¨¡å¼åˆ—è¡¨é¡¹ */
    body:not(.dark-mode) .question-item {
      background: rgba(255, 255, 255, 0.8);
      border: 1px solid rgba(0, 0, 0, 0.1);
    }

    /* å¤œæ™šæ¨¡å¼åˆ—è¡¨é¡¹ */
    body.dark-mode .question-item {
      background: rgba(30, 41, 59, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: #94a3b8;
    }

    /* æ¸…ç©ºæŒ‰é’®åŸºç¡€æ ·å¼ */
    .clear-btn {
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }

    /* ç™½å¤©æ¨¡å¼æŒ‰é’® */
    body:not(.dark-mode) .clear-btn {
      background: rgba(255, 255, 255, 0.8);
      border: 1px solid rgba(0, 0, 0, 0.1);
      color: #666;
    }

    body:not(.dark-mode) .clear-btn:hover {
      background: rgba(255, 255, 255, 0.9);
      color: #333;
    }

    /* å¤œæ™šæ¨¡å¼æŒ‰é’® */
    body.dark-mode .clear-btn {
      background: rgba(30, 41, 59, 0.4);
      color: #94a3b8;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    body.dark-mode .clear-btn:hover {
      background: rgba(30, 41, 59, 0.6);
      color: #e2e8f0;
    }

    /* ç§»é™¤æŒ‰é’®æ ·å¼ */
    .remove-btn {
      padding: 2px 8px;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }

    /* ç™½å¤©æ¨¡å¼ç§»é™¤æŒ‰é’® */
    body:not(.dark-mode) .remove-btn {
      background: rgba(255, 255, 255, 0.8);
      border: 1px solid rgba(0, 0, 0, 0.1);
      color: #666;
    }

    /* å¤œæ™šæ¨¡å¼ç§»é™¤æŒ‰é’® */
    body.dark-mode .remove-btn {
      background: rgba(30, 41, 59, 0.4);
      color: #94a3b8;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    body.dark-mode .remove-btn:hover {
      background: rgba(30, 41, 59, 0.6);
      color: #e2e8f0;
    }

    /* æ–°å¢è¦†ç›–æ ·å¼ï¼Œç¡®ä¿å¤œé—´æ¨¡å¼èƒŒæ™¯æ›´æ·±ä¸”ä¸æ•´ä½“åè°ƒ */
    body.dark-mode #tab-wrong {
      background: rgba(255, 77, 79, 0.08) !important; /* æ·±çº¢è½»é€æ˜ */
    }
    body.dark-mode #tab-fav {
      background: rgba(250, 173, 20, 0.08) !important; /* æ·±é»„è½»é€æ˜ */
    }
    body.dark-mode #tab-wrong .question-item,
    body.dark-mode #tab-fav .question-item {
      background: rgba(255, 255, 255, 0.05) !important; /* æ¯”å®¹å™¨æ›´æ·±ä¸€ç‚¹ */
      color: #cbd5e1 !important;
    }
    body.dark-mode .clear-btn,
    body.dark-mode .remove-btn {
      background: rgba(255, 255, 255, 0.05) !important;
      border-color: rgba(255, 255, 255, 0.15) !important;
      color: #cbd5e1 !important;
    }
    /* å¤œé—´æ¨¡å¼-æ·±è‰²èƒŒæ™¯æ›¿æ¢ */
    .dark #tab-wrong {
      background: linear-gradient(120deg, #2b2a30 0%, #1d1e24 100%) !important; /* æ·±ç°å¸¦å¾®çº¢æ»¤è‰² */
    }
    .dark #tab-fav {
      background: linear-gradient(120deg, #2b2a25 0%, #1d1c18 100%) !important; /* æ·±ç°å¸¦å¾®é»„æ»¤è‰² */
    }
    .dark #tab-wrong .question-item,
    .dark #tab-fav .question-item {
      background: rgba(255,255,255,0.04) !important;
      color:#d1d5db !important;
    }
    .dark #tab-wrong .clear-btn,
    .dark #tab-wrong .remove-btn,
    .dark #tab-fav .clear-btn,
    .dark #tab-fav .remove-btn {
      background: rgba(255,255,255,0.06) !important;
      color:#d1d5db !important;
      border-color: rgba(255,255,255,0.12) !important;
    }
    /* å¤œé—´ä¿®æ­£é”™é¢˜æœ¬/æ”¶è—å¤¹åˆ—è¡¨é¡¹è¿‡äº®é—®é¢˜ */
    .dark #tab-wrong .bg-red-50,
    .dark #tab-wrong .bg-red-100 {background: rgba(55, 27, 27, 0.35) !important;}
    .dark #tab-fav .bg-yellow-50,
    .dark #tab-fav .bg-yellow-100 {background: rgba(55, 48, 21, 0.35) !important;}
    .dark #tab-wrong .text-red-700 {color:#fca5a5 !important;}
    .dark #tab-fav .text-yellow-700 {color:#fde68a !important;}
    /* å¤œé—´ä¸‹ç§»é™¤æŒ‰é’®å¯¹æ¯”åº¦å¢å¼º */
    .dark #tab-wrong .remove-btn {
      background: rgba(220, 38, 38, 0.25) !important; /* æ·±çº¢åŠé€æ˜ */
      color: #fca5a5 !important;
      border-color: rgba(248, 113, 113, 0.4) !important;
    }
    .dark #tab-fav .remove-btn {
      background: rgba(202, 138, 4, 0.25) !important; /* æ·±é»„åŠé€æ˜ */
      color: #fde68a !important;
      border-color: rgba(253, 224, 71, 0.4) !important;
    }
    /* å¤œé—´ä¸‹ç§»é™¤æŒ‰é’®å¯¹æ¯”åº¦å†æå‡ */
    .dark #tab-wrong .remove-btn {
      background: rgba(239, 68, 68, 0.25) !important; /* æ›´äº®çš„çº¢èƒŒæ™¯ */
      color: #fda4af !important; /* æµ…çº¢æ–‡å­— */
      border-color: rgba(248, 113, 113, 0.7) !important;
      font-weight: 600 !important;
    }
    .dark #tab-wrong .remove-btn:hover {
      background: rgba(239, 68, 68, 0.4) !important;
    }
    .dark #tab-fav .remove-btn {
      background: rgba(253, 224, 71, 0.22) !important; /* æ›´äº®çš„é»„èƒŒæ™¯ */
      color: #fde68a !important; /* æµ…é»„æ–‡å­— */
      border-color: rgba(253, 224, 71, 0.7) !important;
      font-weight: 600 !important;
    }
    .dark #tab-fav .remove-btn:hover {
      background: rgba(253, 224, 71, 0.38) !important;
    }
    /* ç™½å¤©æ¨¡å¼ä¸‹å®¹å™¨èƒŒæ™¯ä¸æ•´ä½“ä¸€è‡´ */
    :not(.dark) #tab-wrong,
    :not(.dark) #tab-fav {
      background:#ffffff !important;
      box-shadow:0 1px 4px rgba(0,0,0,0.05) !important;
    }
    /* ç™½å¤©æ¨¡å¼ä¸‹åˆ—è¡¨é¡¹èƒŒæ™¯æ”¹ä¸ºçº¯ç™½ï¼Œæ·»åŠ å·¦ä¾§å½©è‰²æ ‡æ¡åŒºåˆ† */
    :not(.dark) #tab-wrong .bg-red-50,
    :not(.dark) #tab-wrong .bg-red-100 {
      background:#ffffff !important;
      border-left:4px solid #f87171 !important;
    }
    :not(.dark) #tab-fav .bg-yellow-50,
    :not(.dark) #tab-fav .bg-yellow-100 {
      background:#ffffff !important;
      border-left:4px solid #fbbf24 !important;
    }
    :not(.dark) #tab-wrong .text-red-700 {color:#ef4444 !important;}
    :not(.dark) #tab-fav .text-yellow-700 {color:#f59e0b !important;}

    /* ===== Light mode accurate selectors ===== */
    html:not(.dark) #tab-wrong,
    body:not(.dark) #tab-wrong,
    html:not(.dark) #tab-fav,
    body:not(.dark) #tab-fav {
      background:#ffffff !important;
      box-shadow:0 1px 4px rgba(0,0,0,0.05) !important;
    }
    html:not(.dark) #tab-wrong .question-item,
    body:not(.dark) #tab-wrong .question-item {
      background:#ffffff !important;
      border-left:4px solid #ef4444 !important;
      color:#ef4444 !important;
    }
    html:not(.dark) #tab-fav .question-item,
    body:not(.dark) #tab-fav .question-item {
      background:#ffffff !important;
      border-left:4px solid #fbbf24 !important;
      color:#f59e0b !important;
    }
    html:not(.dark) #tab-wrong .remove-btn,
    body:not(.dark) #tab-wrong .remove-btn {
      background:rgba(239,68,68,0.15) !important;
      color:#ef4444 !important;
      border-color:rgba(248,113,113,0.4) !important;
    }
    html:not(.dark) #tab-fav .remove-btn,
    body:not(.dark) #tab-fav .remove-btn {
      background:rgba(253,224,71,0.15) !important;
      color:#f59e0b !important;
      border-color:rgba(253,224,71,0.4) !important;
    }

    /* ==== Dark theme containers harmonize with overall bg ==== */
    .dark #tab-wrong,
    .dark #tab-fav {
      background: rgba(38, 45, 60, 0.8) !important; /* æ·±è“ç°åŠé€æ˜ï¼Œä¸ä¸»ä½“ä¸€è‡´ */
      border: 1px solid rgba(255,255,255,0.08) !important;
      box-shadow: 0 2px 8px rgba(0,0,0,0.4);
    }
    .dark #tab-wrong {border-left-color:#ef4444 !important;}
    .dark #tab-fav {border-left-color:#fbbf24 !important;}
    /* åˆ—è¡¨é¡¹ */
    .dark #tab-wrong .question-item,
    .dark #tab-fav .question-item {
      background: rgba(255, 255, 255, 0.03) !important;
      border: 1px solid rgba(255,255,255,0.05) !important;
      border-radius: 8px;
    }
    .dark #tab-wrong .question-item::before,
    .dark #tab-fav .question-item::before {
      content:'';
      display:block;
      position:absolute;
      left:0;top:0;bottom:0;width:3px;
      border-radius:3px 0 0 3px;
    }
    .dark #tab-wrong .question-item::before {background:#ef4444;}
    .dark #tab-fav .question-item::before {background:#fbbf24;}
    /* è°ƒæ•´æ–‡æœ¬é¢œè‰² */
    .dark #tab-wrong .question-item {color:#fca5a5 !important;}
    .dark #tab-fav .question-item {color:#fde68a !important;}
    /* ç§»é™¤æŒ‰é’®å¯è§æ€§ */
    .dark #tab-wrong .remove-btn {background:rgba(239,68,68,0.25) !important; color:#fda4af !important;}
    .dark #tab-fav .remove-btn {background:rgba(253,224,71,0.25) !important; color:#fde68a !important;}

    /* FINAL dark override */
    .dark #tab-wrong,
    .dark #tab-fav{
      background:rgba(31,41,55,0.9) !important; /* æ·±ç°è“ */
      backdrop-filter:blur(2px);
    }
    .dark #tab-wrong .question-item,
    .dark #tab-fav .question-item{background:rgba(255,255,255,0.04)!important;}

    /* Ultimate dark container rule */
    .dark #tab-wrong,
    .dark #tab-fav{
      background-color:#1e273b !important; /* ç»Ÿä¸€æ·±è‰² */
      background-image:none !important;    /* å–æ¶ˆæ¸å˜ */
      border:1px solid rgba(255,255,255,0.06) !important;
    }
    /* å¤œé—´æ¸…ç©ºæŒ‰é’®é¢œè‰²æ¢å¤ */
    .dark .clear-btn{
      background:rgba(255,255,255,0.08) !important;
      color:#cbd5e1 !important;
      border-color:rgba(255,255,255,0.15) !important;
    }

    /* å¼ºåˆ¶å¤œé—´å¡ç‰‡èƒŒæ™¯ä¸é¢˜åº“ç®¡ç†ä¸€è‡´ */
    .dark #tab-wrong.draggable-cat,
    .dark #tab-fav.draggable-cat {
      background: rgba(31,41,55,0.92) !important;
      border: 1.5px solid #334155 !important;
      box-shadow: 0 6px 24px rgba(0,0,0,0.4);
      background-image: none !important;
    }

    /* ä½œè€…ç½²åæ ·å¼ */
    .author-signature {
      position: absolute;
      left: 16px;
      top: 10px;
      font-family: 'Noto Sans SC', sans-serif;
      font-size: 14.5px;
      color: #666;
      opacity: 0.92;
      pointer-events: none;
      letter-spacing: 0.03em;
      font-weight: 400;
      transition: all 0.3s ease;
      padding: 4px 8px;
      border-radius: 4px;
      background: linear-gradient(120deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 100%);
      display: flex;
      align-items: center;
      gap: 2px;
    }
    .author-signature::before {
      content: 'Byï¼š';
      font-family: 'Noto Serif SC', serif;
      font-weight: 600;
      font-style: normal;
      letter-spacing: 0;
    }
    .author-signature span {
      font-family: 'Noto Serif SC', serif;
      font-weight: 500;
      background: linear-gradient(120deg, #666 0%, #888 100%);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      position: relative;
      top: 0.5px;
    }
    /* å¤œé—´æ¨¡å¼ç½²åæ ·å¼ */
    .dark .author-signature {
      color: #94a3b8;
      background: linear-gradient(120deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0) 100%);
    }
    .dark .author-signature span {
      background: linear-gradient(120deg, #94a3b8 0%, #cbd5e1 100%);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    /* æ·±è‰²æ¨¡å¼ä¸‹å­¦ä¹ ç»Ÿè®¡å ä½æ–‡å­—é¢œè‰² */
    .dark #stats-placeholder h3 {
      color: #ffffff !important;
    }
    .dark #stats-placeholder p {
      color: #cccccc !important;
    }
    /* å¯è§æ€§å¢å¼ºï¼šç­”é¢˜é€‰é¡¹åœ†ç‚¹ï¼ˆç™½å¤©/å¤œæ™š & é”å®šçŠ¶æ€ï¼‰ */
    .custom-radio { position: relative; }
    .custom-radio input[type="radio"],
    .custom-radio input[type="checkbox"] {
      position: absolute;
      inset: 0;
      margin: 0;
      opacity: 0;
      pointer-events: none;
    }
    .custom-radio .radio-dot {
      width: 1rem;
      height: 1rem;
      border-radius: 9999px;
      border: 2px solid #cbd5e1; /* slate-300 */
      flex-shrink: 0;
      transition: background-color .2s, border-color .2s, box-shadow .2s;
    }
    /* é€‰ä¸­æ—¶é¢œè‰² */
    .custom-radio input:checked + .radio-dot {
      background-color: #6366f1; /* indigo-500 */
      border-color: #6366f1;
    }
    /* é”å®šåä»ä¿æŒé«˜äº®ï¼Œå¢åŠ å¤–åœˆé˜´å½±ä»¥æå‡å¯è§æ€§ */
    .custom-radio.locked input:checked + .radio-dot {
      background-color: #6366f1;
      border-color: #6366f1;
      box-shadow: 0 0 0 2px #c7d2fe;
    }
    /* å¤œé—´ä¸»é¢˜é¢œè‰²è°ƒæ•´ */
    .dark .custom-radio .radio-dot {
      border-color: #475569; /* slate-600 */
    }
    .dark .custom-radio input:checked + .radio-dot {
      background-color: #a5b4fc; /* indigo-300 */
      border-color: #a5b4fc;
    }
    .dark .custom-radio.locked input:checked + .radio-dot {
      background-color: #a5b4fc;
      border-color: #a5b4fc;
      box-shadow: 0 0 0 2px #3730a3;
    }
    /* é¢˜å·æ›´é†’ç›® */
    .question-number {
      color: #4338ca !important; /* æ·±é›è“ï¼Œæ—¥é—´ */
      font-weight: bold;
      font-size: 1.1em;
      letter-spacing: 0.02em;
      text-shadow: 0 1px 2px #e0e7ff88;
      transition: color 0.2s;
    }
    .dark .question-number {
      color: #a5b4fc !important; /* å¤œé—´äº®ç´«è“ */
      text-shadow: 0 1px 4px #1e293b88;
    }
    /* === é”™é¢˜æœ¬ & æ”¶è—å¤¹ å¤œé—´é…è‰²ä¼˜åŒ– === */
    .dark .wrong-cat, .dark .wrong-lib {
      background: #1e293b !important; /* slate-800 */
      border-color: #b91c1c !important; /* red-700 accent */
    }
    .dark .wrong-lib {
      background: #27324a !important; /* slightly lighter for depth */
    }
    .dark .wrong-cat .text-red-400, .dark .wrong-lib .text-red-600,
    .dark .wrong-cat .text-red-600, .dark .wrong-lib .text-red-400 {
      color: #f87171 !important; /* red-400 */
    }
    .dark .fav-cat, .dark .fav-lib {
      background: #1e293b !important; /* slate-800 */
      border-color: #b45309 !important; /* amber-700 accent */
    }
    .dark .fav-lib {
      background: #27324a !important;
    }
    .dark .fav-cat .text-yellow-400, .dark .fav-lib .text-yellow-600,
    .dark .fav-cat .text-yellow-600, .dark .fav-lib .text-yellow-400 {
      color: #fbbf24 !important; /* amber-400 */
    }
    /* è°ƒæ•´åˆ é™¤/æ’­æ”¾ç­‰æŒ‰é’®hoveré¢œè‰²åœ¨å¤œé—´ä¸è¿‡äº® */
    .dark .wrong-cat button:hover, .dark .wrong-lib button:hover {
      background: #7f1d1d33 !important;
    }
    .dark .fav-cat button:hover, .dark .fav-lib button:hover {
      background: #b4530933 !important;
    }
    /* è¿›ä¸€æ­¥è¦†ç›–å¯èƒ½æ®‹ç•™çš„æµ…è‰²èƒŒæ™¯ç±» */
    .dark .wrong-cat .bg-red-50, .dark .wrong-cat .bg-red-50\/50,
    .dark .wrong-lib .bg-red-50, .dark .wrong-lib .bg-red-50\/50 {
      background: #27324a !important;
    }
    .dark .fav-cat .bg-yellow-50, .dark .fav-cat .bg-yellow-50\/50,
    .dark .fav-lib .bg-yellow-50, .dark .fav-lib .bg-yellow-50\/50 {
      background: #27324a !important;
    }
    /* å¼ºåˆ¶è¦†ç›–æ®‹ç•™æµ…è‰²èƒŒæ™¯ï¼ˆWrong/Fav å¡ç‰‡ï¼‰*/
    .dark .wrong-cat,
    .dark .wrong-cat *[class*='bg-'],
    .dark .wrong-lib,
    .dark .wrong-lib *[class*='bg-']{
      background-color:#1f2937 !important;
    }
    .dark .fav-cat,
    .dark .fav-cat *[class*='bg-'],
    .dark .fav-lib,
    .dark .fav-lib *[class*='bg-']{
      background-color:#1f2937 !important;
    }
    /* ç¬”è®°æŒ‰é’®æ ·å¼ */
    #note-btn {
      cursor:pointer;
    }
    .dark #note-btn svg {fill:#a5b4fc;}
    
    /* å¤œé—´æ¨¡å¼ç¬”è®°çª—å£æ ·å¼ */
    html.dark #note-modal .note-draggable {
      background: #1f2937 !important;
      border-color: #475569 !important;
    }
    html.dark #note-editor {
      background: #111827;
      color: #e5e7eb; /* é»˜è®¤æ–‡å­—è‰²ï¼Œå¯è¢«Quill inlineæ ·å¼è¦†ç›– */
      border-color: #475569;
    }
    html.dark #note-toolbar {
      background: #374151 !important;
    }
    html.dark .note-tool {
      background: #1f2937 !important;
      color: #a5b4fc !important;
      border-color: #475569 !important;
    }
    html.dark #note-preview-toggle {
      background: #4f46e5 !important;
    }
    html.dark #note-save {
      background: #4f46e5 !important;
    }
    html.dark #note-delete {
      background: #1f2937 !important;
      color: #f87171 !important;
      border-color: #7f1d1d !important;
    }

      /* å¼¹çª—èƒŒæ™¯æ ·å¼ */
  .modal-bg {
    background-color: rgba(0, 0, 0, 0.3);
    backdrop-filter: blur(2px);
  }
  .dark .modal-bg {
    background-color: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(3px);
  }
  
  /* åˆ†ç±»é€‰æ‹©å¼¹çª—å¢å¼ºæ ·å¼ */
  #category-modal .bg-white.dark\:bg-gray-800 {
    box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.1);
  }
  
  .dark #category-modal .bg-white.dark\:bg-gray-800 {
    background: #1b2838 !important; /* ç²¾å‡†åŒ¹é…æˆªå›¾ä¸­çš„æ·±è“è‰²èƒŒæ™¯ */
    box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5) !important;
    border: none !important;
    color: white !important;
  }
  
  /* ç¡®ä¿æ ‡é¢˜æ–‡å­—æ˜¾ç¤ºæ­£ç¡® */
  .dark #category-modal .text-black {
    color: white !important;
  }
  
  #category-modal .text-black {
    color: black;
  }
  
  .dark #category-modal .fas {
    font-size: 1.1rem;
  }
  
  /* å¤œé—´æ¨¡å¼ä¸‹çš„è¡¨å•æ§ä»¶å¢å¼º */
  .dark #category-select,
  .dark #category-input {
    background-color: #2a3b52 !important; /* ç¨å¾®äº®ä¸€ç‚¹çš„æ·±è“è‰² */
    border: none !important;
    color: #ffffff !important;
    box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.15) !important;
    font-size: 1rem !important;
  }
  
  .dark #category-select:focus,
  .dark #category-input:focus {
    border: none !important;
    box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.15), 0 0 0 2px rgba(99, 102, 241, 0.25) !important;
  }
  
  /* å¤œé—´æ¨¡å¼ä¸‹å ä½ç¬¦æ–‡æœ¬é¢œè‰² */
  .dark #category-input::placeholder {
    color: #a0aec0 !important;
  }
  
  /* å¤œé—´æ¨¡å¼ä¸‹çš„æŒ‰é’®æ ·å¼ç²¾ç¡®åŒ¹é… */
  .dark #category-cancel {
    background-color: #ffffff !important;
    color: #1e293b !important;
    font-weight: 500 !important;
    border: none !important;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1) !important;
  }
  
  .dark #category-confirm {
    background-color: #6366f1 !important;
    border: none !important;
    font-weight: 500 !important;
    box-shadow: 0 2px 5px rgba(99, 102, 241, 0.3) !important;
  }
  
  /* å¤œé—´æ¨¡å¼ä¸‹çš„æ ‡ç­¾æ–‡å­—é¢œè‰² */
  .dark #category-modal label {
    color: #94a3b8 !important;
  }

    /* å¯æ‹–åŠ¨å¼¹çª—æ ·å¼ */
    .note-draggable {
      position: absolute;
      transform: translate(-50%, -50%);
      left: 50%;
      top: 50%;
      transition: none;
    }

    .drag-handle {
      cursor: move;
      user-select: none;
      position: relative;
    }

    .drag-handle::before {
      content: '';
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 100%;
      height: 10px;
      background: linear-gradient(to right, #e0e7ff 5%, transparent 5%, transparent 95%, #e0e7ff 95%);
      background-size: 14px 2px;
      background-repeat: repeat-x;
      opacity: 0.5;
      pointer-events: none;
    }

    .dark .drag-handle::before {
      background: linear-gradient(to right, #4b5563 5%, transparent 5%, transparent 95%, #4b5563 95%);
      background-size: 14px 2px;
      background-repeat: repeat-x;
    }

    /* ç¬”è®°çª—å£çš„æ™®é€šæ¨¡å¼ */
    .note-panel {
      background-color: #ffffff; /* ç™½å¤©æ¨¡å¼èƒŒæ™¯ */
      color: #333333; /* ç™½å¤©æ¨¡å¼æ–‡å­—é¢œè‰² */
    }

    /* ç¬”è®°çª—å£çš„å¤œé—´æ¨¡å¼ */
    .dark .note-panel {
      background-color: rgba(30, 30, 30, 0.95); /* æ·±è‰²èƒŒæ™¯ */
      color: #e0e0e0; /* æ·±è‰²æ¨¡å¼æ–‡å­—é¢œè‰² */
    }

    /* å…¶ä»–å…ƒç´ çš„æ ·å¼ */
    .dark .note-panel button {
      background-color: #4a90e2; /* æ·±è‰²æ¨¡å¼æŒ‰é’®èƒŒæ™¯ */
      color: white; /* æ·±è‰²æ¨¡å¼æŒ‰é’®æ–‡å­—é¢œè‰² */
    }

    .dark .note-panel button:hover {
      background-color: #357abd; /* æ·±è‰²æ¨¡å¼æŒ‰é’®æ‚¬åœæ•ˆæœ */
    }

    /* æ·»åŠ å¤œé—´æ¨¡å¼æ ·å¼ */
    /* ç¬”è®°çª—å£å¤œé—´æ¨¡å¼æ ·å¼ */
    html.dark #note-modal .note-draggable {
      background: #1f2937 !important;
      border-color: #475569 !important;
    }
    
    html.dark #note-editor {
      background: #111827;
      color: #e5e7eb;
      border-color: #475569;
    }
    
    html.dark #note-toolbar {
      background: #374151 !important;
    }
    
    html.dark .note-tool {
      background: #1f2937 !important;
      color: #a5b4fc !important;
      border-color: #475569 !important;
    }
    
    html.dark #note-preview-toggle {
      background: #4f46e5 !important;
    }
    
    html.dark #note-save {
      background: #4f46e5 !important;
    }
    
    html.dark #note-delete {
      background: #1f2937 !important;
      color: #f87171 !important;
      border-color: #7f1d1d !important;
    }
    
    html.dark #note-close {
      color: #9ca3af;
    }
    
    html.dark #note-close:hover {
      background-color: #374151;
    }
    
    html.dark #note-toolbar {
      background-color: #1f2937;
    }
    
    html.dark .note-tool {
      background-color: #374151;
      border-color: #4b5563;
      color: #e5e7eb;
    }
    
    html.dark .note-tool:hover {
      background-color: #4b5563;
    }
    
    html.dark #note-preview-toggle {
      background-color: #4f46e5;
    }
    
    html.dark #note-preview-toggle:hover {
      background-color: #4338ca;
    }
    
    html.dark #note-editor {
      background-color: #1f2937;
      border-color: #4b5563;
      color: #e5e7eb;
    }
    
    html.dark #note-preview {
      background-color: #111827;
      border-color: #4b5563;
      color: #e5e7eb;
    }
    
    html.dark #note-save {
      background-color: #4f46e5;
    }
    
    html.dark #note-save:hover {
      background-color: #4338ca;
    }
    
    html.dark #note-delete {
      background-color: #1f2937;
      border-color: #7f1d1d;
      color: #ef4444;
    }
    
    html.dark #note-delete:hover {
      background-color: #7f1d1d;
      color: #fca5a5;
    }

    /* å¤œé—´æ¨¡å¼ä¸‹ç¬”è®°çª—å£å­—ä½“é¢œè‰²ä¼˜åŒ– - ç§»é™¤ !important ä»¥å…è®¸ Quill è¡Œå†…é¢œè‰²ç”Ÿæ•ˆ */
    html.dark #note-modal .note-draggable {
      color:#e5e7eb;
    }
    html.dark #note-modal .note-draggable .note-tool {
      color: #a5b4fc !important;
    }
    html.dark #note-modal .note-draggable .text-indigo-700 {
      color: #a5b4fc !important;
    }
    html.dark #note-modal .note-draggable .text-gray-500 {
      color: #cbd5e1 !important;
    }
    html.dark #note-modal .note-draggable .text-indigo-500 {
      color: #818cf8 !important;
    }
    html.dark #note-modal .note-draggable .text-indigo-600 {
      color: #818cf8 !important;
    }
    html.dark #note-modal .note-draggable .text-indigo-400 {
      color: #a5b4fc !important;
    }
    /* å¤œé—´æ¨¡å¼ä¸‹ç¬”è®°çª—å£é¡¶éƒ¨è™šçº¿åˆ†å‰²çº¿é¢œè‰²ä¼˜åŒ– */
    html.dark #note-modal .note-draggable .border-b {
      border-bottom-color: #334155 !important;
      border-bottom-style: dashed !important;
    }
    html.dark #note-modal .note-draggable .drag-handle::before {
      background: linear-gradient(to right, #334155 5%, transparent 5%, transparent 95%, #334155 95%) !important;
    }
    /* éšè—ç¬”è®°çª—å£é¡¶éƒ¨è™šçº¿åˆ†å‰²çº¿ */
    #note-modal .note-draggable .drag-handle::before {
      display: none !important;
    }

    /* ä¼˜åŒ–å¤œé—´æ¨¡å¼ä¸‹ç¬”è®°çª—å£å­—ä½“é¢œè‰²è¦†ç›–ï¼Œé¿å…å½±å“æŒ‰é’®å’Œç¼–è¾‘å™¨å†…å®¹ */
    html.dark #note-modal .note-draggable {
      color: #e5e7eb !important;
    }
    /* æ¢å¤æŒ‰é’®åŸæœ‰é¢œè‰² */
    html.dark #note-modal .note-draggable .note-tool {
      color: #a5b4fc !important;
      background-color: #1f2937 !important;
      border-color: #475569 !important;
    }
    html.dark #note-modal .note-draggable .note-tool:hover {
      background-color: #374151 !important;
    }
    /* æ¢å¤ç¼–è¾‘å™¨å†…å®¹çš„åˆ—è¡¨æ ·å¼å’Œé¢œè‰² */
    html.dark #note-editor ol,
    html.dark #note-editor ul {
      color: #e5e7eb !important;
      list-style-position: inside !important;
    }
    html.dark #note-editor li {
      color: #e5e7eb !important;
    }

    /* éšè—æ—§çš„è‡ªå®šä¹‰ç¬”è®°å·¥å…·æ ï¼ˆå·²è¢«Quillæ›¿ä»£ï¼‰ */
    #note-toolbar{display:none!important;}

    /* Quill ç¼–è¾‘å™¨è‡ªå®šä¹‰æ ·å¼ - äº®è‰²æ¨¡å¼ */
    body:not(.dark) .ql-toolbar.ql-snow{
      background:#f9fafb;
      border:1px solid #e5e7eb;
      border-radius:0.75rem;
      padding:4px 8px;
      margin-bottom:8px;
    }
    body:not(.dark) .ql-container.ql-snow{
      border:1px solid #e5e7eb;
      border-radius:0.75rem;
    }
    /* Quill ç¼–è¾‘å™¨è‡ªå®šä¹‰æ ·å¼ - æš—è‰²æ¨¡å¼ */
    html.dark .ql-toolbar.ql-snow{
      background:#374151;
      border:1px solid #475569;
      border-radius:0.75rem;
      padding:4px 8px;
      margin-bottom:8px;
    }
    html.dark .ql-container.ql-snow{
      border:1px solid #475569;
      border-radius:0.75rem;
    }
    html.dark .ql-toolbar .ql-stroke{stroke:#e5e7eb;}
    html.dark .ql-toolbar .ql-fill{fill:#e5e7eb;}
    html.dark .ql-toolbar .ql-picker{color:#e5e7eb;}
    /* è®¾ç½®ç¼–è¾‘åŒºåŸŸæœ€å°é«˜åº¦ */
    #note-editor .ql-editor{
      max-height:70vh !important;
      min-height:40vh !important;
    }
    #md-editor,#md-preview{max-height:50vh;overflow-y:auto;}
    #note-modal .note-draggable{max-height:90vh;display:flex;flex-direction:column;}
    #note-modal .note-draggable>div.flex-1{flex:1;overflow:hidden;}
    #md-wrapper{height:auto !important;min-height:45vh !important;}
    /* Quill å·¥å…·æ é¢å¤–æ§ä»¶ï¼ˆæ¨¡å¼é€‰æ‹© & é¢„è§ˆï¼‰æ ·å¼ */
    .ql-toolbar .toolbar-extras{
      margin-left:auto; /* æ¨åˆ°æœ€å³ */
      display:flex;
      align-items:center;
      gap:8px;
    }
    /* ç»Ÿä¸€æŒ‰é’®/é€‰æ‹©æ¡†æ ·å¼ - äº®è‰² */
    body:not(.dark) #note-mode-select,
    body:not(.dark) #md-preview-toggle{
      background:#f9fafb;
      border:1px solid #e5e7eb;
      color:#374151;
      border-radius:0.375rem;
      padding:4px 8px;
      height:32px;
      transition:background-color .2s, color .2s;
    }
    body:not(.dark) #note-mode-select:hover,
    body:not(.dark) #md-preview-toggle:hover{
      background:#f3f4f6;
    }
    /* ç»Ÿä¸€æŒ‰é’®/é€‰æ‹©æ¡†æ ·å¼ - æš—è‰² */
    html.dark #note-mode-select,
    html.dark #md-preview-toggle{
      background:#374151;
      border:1px solid #475569;
      color:#e5e7eb;
    }
    html.dark #note-mode-select:hover,
    html.dark #md-preview-toggle:hover{
      background:#4b5563;
    }
    /* ç§»é™¤ select é»˜è®¤ç®­å¤´ï¼Œä½¿ç”¨ç»Ÿä¸€æ ·å¼ */
    #note-mode-select{
      appearance:none;
      -moz-appearance:none;
      -webkit-appearance:none;
      padding-right:1.75rem; /* ç•™å‡ºç©ºé—´æ˜¾ç¤ºç®­å¤´ */
      position:relative;
    }
    /* è‡ªå®šä¹‰ä¸‹æ‹‰ç®­å¤´ */
    #note-mode-select::after{
      content:'\25BC';
      position:absolute;
      right:0.6rem;
      top:50%;
      transform:translateY(-50%);
      pointer-events:none;
      font-size:0.6rem;
    }
    /* ç¡®ä¿æŒ‰é’®å†…å›¾æ ‡å‚ç›´å±…ä¸­ */
    #md-preview-toggle i{pointer-events:none;}

    /* è°ƒæ•´çœ¼ç›æŒ‰é’®å°ºå¯¸å¹¶å¼ºåˆ¶å±…ä¸­ */
    #md-preview-toggle{
      width:32px;
      height:32px;
      padding:0;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    #md-preview-toggle i{font-size:16px;}

    /* è°ƒæ•´ä¸‹æ‹‰æ¡†å†…æ–‡å­—æ°´å¹³å‚ç›´å±…ä¸­ */
    #note-mode-select{
      padding:0 12px;
      height:32px;
      line-height:32px;
      text-align:center;
      border:none !important;
      outline:none !important;
      box-shadow:none !important;
      background:#374151 !important;
      color:#e5e7eb !important;
    }

    /* æ·±è‰²æ¨¡å¼ Markdown ç¼–è¾‘æ¡†èƒŒæ™¯ä¿æŒä¸€è‡´ */
    html.dark #md-editor:not(.hidden){
      background:#374151 !important;
      color:#e5e7eb !important;
    }
    html.dark #md-preview:not(.hidden){
      background:#374151 !important;
      color:#e5e7eb !important;
    }
    /* ç»Ÿä¸€ extras æŒ‰é’®åœ¨æš—è‰²ä¸‹çš„èƒŒæ™¯åŠæ— è¾¹æ¡† */
    html.dark #md-preview-toggle,
    html.dark #note-mode-select{
      background:#475569 !important;
      border:none !important;
    }
    body:not(.dark) #md-preview-toggle,
    body:not(.dark) #note-mode-select{
      background:#e5e7eb !important;
      border:none !important;
      color:#374151 !important;
    }
    /* é‡è®¾å·¥å…·æ é¢å¤–æ§ä»¶èƒŒæ™¯ - æ˜/æš—ä¸»é¢˜åŒ¹é… Quill */
    .ql-toolbar .toolbar-extras>*{margin-left:8px;}
    .ql-toolbar .toolbar-extras>*:first-child{margin-left:0;}

    body:not(.dark) #md-preview-toggle,
    body:not(.dark) #note-mode-select{
      background:#f9fafb !important;
      color:#374151 !important;
      border:none !important;
    }
    html.dark #md-preview-toggle,
    html.dark #note-mode-select{
      background:#374151 !important;
      color:#e5e7eb !important;
      border:none !important;
    }

    /* â€”â€” æ¨¡å¼åˆ‡æ¢æŒ‰é’® â€”â€” */
    .mode-btn{
      border:none;
      border-radius:0.375rem;
      height:32px;
      padding:0 14px;
      font-size:14px;
      line-height:32px;
      cursor:pointer;
      transition:background-color .2s,color .2s;
    }
    body:not(.dark) .mode-btn{background:#f9fafb;color:#374151;}
    body:not(.dark) .mode-btn:hover{background:#e5e7eb;}
    html.dark .mode-btn{background:#374151;color:#e5e7eb;}
    html.dark .mode-btn:hover{background:#4b5563;}
    .mode-btn.active{background:#6366f1!important;color:#ffffff!important;}

    /* åˆ†æ®µæ§ä»¶å¤–æ¡† */
    .mode-group{
      display:flex;
      border:1px solid rgba(255,255,255,0.08);
      border-radius:0.5rem;
      overflow:hidden;
    }
    body:not(.dark) .mode-group{border-color:#d1d5db;}
    html.dark .mode-group{border-color:#475569;}

    .mode-group .mode-btn{
      border-radius:0; /* ç”±å¤–æ¡†æ§åˆ¶åœ†è§’ */
      min-width:72px;
    }
    .mode-group .mode-btn:first-child{border-top-left-radius:0.5rem;border-bottom-left-radius:0.5rem;}
    .mode-group .mode-btn:last-child{border-top-right-radius:0.5rem;border-bottom-right-radius:0.5rem;}
    /* å–æ¶ˆå·¦å³é—´éš™ */
    .toolbar-extras>*{margin-left:12px;}
    .toolbar-extras .mode-group{margin-left:0;}

    /* å•ä¸€æ¨¡å¼åˆ‡æ¢æŒ‰é’® (Textâ‡„MD) */
    .mode-toggle{
      height:32px;min-width:72px;
      padding:0 16px;
      border-radius:0.5rem;
      border:none;
      cursor:pointer;
      font-size:15px;
      font-weight:500;
      transition:background-color .2s,color .2s;
    }
    body:not(.dark) .mode-toggle{background:#f9fafb;color:#374151;}
    body:not(.dark) .mode-toggle:hover{background:#e5e7eb;}
    html.dark .mode-toggle{background:#374151;color:#e5e7eb;}
    html.dark .mode-toggle:hover{background:#4b5563;}
    .mode-toggle.active{background:#6366f1!important;color:#ffffff!important;}

    /* ----- Typora-aligned Markdown é¢„è§ˆæ’ç‰ˆ ----- */
    #md-preview.markdown-body{
      background:#374151; /* æ·±è‰²èƒŒæ™¯ä¸ç¼–è¾‘ä¸€è‡´ */
      border:1px solid #475569;
      border-radius:.75rem;
      padding:.75rem;
      white-space:pre-line; /* ä¿ç•™åŸæ–‡ç¡¬/è½¯æ¢è¡Œ */
    }
    #md-preview.markdown-body:before{content:none!important;} /* å–æ¶ˆé»„è‰²è£…é¥°æ¡ */
    #md-preview.markdown-body p{margin:.7em 0;}
    #md-preview.markdown-body ul,#md-preview.markdown-body ol{margin:.5em 0 .5em 1.4em;}
    #md-preview.markdown-body li{margin:.3em 0;}
  </style>
  <!-- Typora-aligned override for Markdown preview -->
  <style id="md-preview-fix">
    #md-preview.markdown-body{
      background:#374151;
      border:1px solid #475569;
      border-radius:.75rem;
      padding:.75rem;
      white-space:pre-line;
    }
    #md-preview.markdown-body:before{content:none!important;}
    #md-preview.markdown-body p{margin:.7em 0;}
    #md-preview.markdown-body ul,
    #md-preview.markdown-body ol{margin:.5em 0 .5em 1.4em;}
    #md-preview.markdown-body li{margin:.3em 0;}
  </style>
  <style id="md-preview-li-fix">
    /* æ¢å¤åˆ—è¡¨é¡¹å†…éƒ¨æ®µè·ï¼Œç¡®ä¿ Markdown æ®µå†…ç©ºè¡Œå¯è§ */
    #md-preview.markdown-body li p { margin: .6em 0 !important; }
    /* è°ƒæ•´åˆ—è¡¨é¡¹è‡ªèº«çš„ä¸Šä¸‹é—´è· */
    #md-preview.markdown-body li     { margin: .4em 0 !important; }
  </style>
  <!-- è§£å†³ Markdown é¢„è§ˆé¢å¤–ç©ºè¡Œï¼šè¦†ç›– white-space è®¾ç½® -->
  <style id="md-preview-overrides">
    /* éµå¾ª Markdown é»˜è®¤æ®µè½å¤„ç†ï¼Œå–æ¶ˆ pre-line é€ æˆçš„è½¯å›è½¦æ¢è¡Œ */
    #md-preview.markdown-body {
      white-space: normal !important;
    }
  </style>
  
  <style id="scroll-list-styles">/* æ»šåŠ¨å®¹å™¨å®šåˆ¶çª„æ»šåŠ¨æ¡ï¼Œæ»šåŠ¨æ¡è¦†ç›–åœ¨å†…å®¹ä¹‹ä¸Šä¸”ä¸å‹ç¼©å†…å®¹ */ .scroll-list { position: relative; box-sizing: border-box; scrollbar-width: thin; /* ä½¿ç”¨overlayæ¨¡å¼è®©æ»šåŠ¨æ¡è¦†ç›–åœ¨å†…å®¹ä¸Šæ–¹ï¼Œä¸å ç”¨å†…å®¹ç©ºé—´ */ overflow-y: overlay; } .scroll-list::-webkit-scrollbar { width: 8px; } .scroll-list::-webkit-scrollbar-thumb { background: #c7d2fe; border-radius: 4px; } /* ç¡®ä¿å¡ç‰‡åœ¨æ»šåŠ¨åŒºåŸŸå†…ä¿æŒå®Œæ•´å®½åº¦ */ .scroll-list .draggable-lib { width: calc(100% - 8px); /* å‡å»æ»šåŠ¨æ¡å®½åº¦ */ min-width: 0; /* å…è®¸æ”¶ç¼©åˆ°çˆ¶å®¹å™¨å®½åº¦ */ } /* ç»™æ»šåŠ¨åŒºåŸŸå³ä¾§æ·»åŠ æ¸å˜é˜´å½±ï¼Œæç¤ºå¯æ»šåŠ¨ */ .scroll-list::after { content: ''; position: absolute; top: 0; right: 0; width: 8px; height: 100%; background: linear-gradient(to left, rgba(255,255,255,.7), rgba(255,255,255,0)); pointer-events: none; } .dark .scroll-list::after { background: linear-gradient(to left, rgba(30,41,59,.7), rgba(30,41,59,0)); }</style>
  <!-- ç¬”è®°ç¼–è¾‘åŒºå°ºå¯¸è¦†ç›–ï¼Œæé«˜å¯è§é«˜åº¦ -->
  <style id="note-size-override">
    #note-editor .ql-editor{
      max-height:70vh !important;
    }
    #md-editor,
    #md-preview,
    #md-wrapper{
      max-height:70vh !important;
    }
    /* è°ƒå¤§ Markdown åŒ…è£…åˆå§‹é«˜åº¦ */
    #md-wrapper{
      height:auto !important;
      min-height:45vh !important;
    }
    /* Quill å®¹å™¨ä¹Ÿéœ€è¦æœ€å°é«˜åº¦ */
    #note-editor{
      min-height:45vh !important;
    }
  </style>
  <!-- Note modal fixed size & internal scrolling -->
  <style id="note-modal-fixed-size">
    #note-modal .note-draggable{
      height:80vh !important; /* å›ºå®šæ•´ä½“é«˜åº¦ */
      max-height:80vh !important;
      display:flex;
      flex-direction:column;
    }
    /* å·¥å…·æ ã€æŒ‰é’®åŒºç»´æŒå›ºæœ‰é«˜åº¦ï¼›ç¼–è¾‘åŒºå æ»¡å‰©ä½™ç©ºé—´ */
    #note-editor,
    #md-wrapper{
      flex:1 1 0%;
      min-height:0 !important; /* å…è®¸æ”¶ç¼© */
      max-height:none !important;
      overflow:auto !important; /* è¶…å‡ºæ»šåŠ¨ */
    }
  </style>
  <!-- Quill å¯Œæ–‡æœ¬ç¼–è¾‘å™¨ -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

  <!-- ç»Ÿä¸€é¢œè‰² / é«˜äº®æŒ‰é’®å¤–è§‚ -->
  <style id="quill-pickers-unified">
    /* ç»Ÿä¸€å¤–è§‚ */
    #note-modal .ql-toolbar .ql-picker.ql-color > .ql-picker-label,
    #note-modal .ql-toolbar .ql-picker.ql-background > .ql-picker-label {
      width:32px;height:32px;border-radius:50%;
      display:flex;align-items:center;justify-content:center;
      margin-right:4px;background:#f3f4f6!important;border:none;cursor:pointer;position:relative;
    }
    html.dark #note-modal .ql-toolbar .ql-picker.ql-color > .ql-picker-label,
    html.dark #note-modal .ql-toolbar .ql-picker.ql-background > .ql-picker-label {
      background:#374151!important;
    }
    /* å»æ‰Quillæ³¨å…¥ SVG */
    #note-modal .ql-toolbar .ql-picker.ql-color svg,
    #note-modal .ql-toolbar .ql-picker.ql-background svg {display:none!important;}
    /* FontAwesome icon */
    #note-modal .ql-toolbar .ql-picker.ql-color   > .ql-picker-label::before {
      content:"\f031";
    }
    #note-modal .ql-toolbar .ql-picker.ql-background > .ql-picker-label::before {
      content:"\f591";
    }
    #note-modal .ql-toolbar .ql-picker.ql-color > .ql-picker-label::before,
    #note-modal .ql-toolbar .ql-picker.ql-background > .ql-picker-label::before {
      font-family:"Font Awesome 6 Free";font-weight:900;font-size:15px;
      color:#374151;position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
    }
    html.dark #note-modal .ql-toolbar .ql-picker.ql-color > .ql-picker-label::before,
    html.dark #note-modal .ql-toolbar .ql-picker.ql-background > .ql-picker-label::before {color:#e5e7eb;}
    /* hover */
    #note-modal .ql-toolbar .ql-picker.ql-color > .ql-picker-label:hover,
    #note-modal .ql-toolbar .ql-picker.ql-background > .ql-picker-label:hover {background:#e5e7eb!important;}
    html.dark #note-modal .ql-toolbar .ql-picker.ql-color > .ql-picker-label:hover,
    html.dark #note-modal .ql-toolbar .ql-picker.ql-background > .ql-picker-label:hover {background:#4b5563!important;}
    /* active */
    #note-modal .ql-toolbar .ql-picker.ql-color.ql-expanded   > .ql-picker-label,
    #note-modal .ql-toolbar .ql-picker.ql-background.ql-expanded > .ql-picker-label,
    #note-modal .ql-toolbar .ql-picker.ql-color .ql-picker-label.ql-active,
    #note-modal .ql-toolbar .ql-picker.ql-background .ql-picker-label.ql-active {background:#6366f1!important;}
    #note-modal .ql-toolbar .ql-picker.ql-color.ql-expanded   > .ql-picker-label::before,
    #note-modal .ql-toolbar .ql-picker.ql-background.ql-expanded > .ql-picker-label::before,
    #note-modal .ql-toolbar .ql-picker.ql-color .ql-picker-label.ql-active::before,
    #note-modal .ql-toolbar .ql-picker.ql-background .ql-picker-label.ql-active::before {color:#fff;}
    /* highlight left spacing */
    #note-modal .ql-toolbar .ql-picker.ql-background {margin-left:4px;}
    /* é«˜äº®æŒ‰é’®ä¸é¢œè‰²æŒ‰é’®é—´éš” 4px */
    #note-modal .ql-toolbar .ql-picker.ql-background{margin-left:4px;}

    /* === å¯¹é½ & è¾¹æ¡†ä¿®æ­£ === */
    #note-modal .ql-toolbar .ql-picker.ql-color,
    #note-modal .ql-toolbar .ql-picker.ql-background{
      display:inline-flex !important;      /* è®©æ•´ä½“åœ¨ flex å®¹å™¨ä¸­å‚ç›´å±…ä¸­ */
      align-items:center;                  /* label å±…ä¸­ */
      vertical-align:middle;               /* é¿å…åŸºçº¿åå·®å¯¼è‡´ä¸Šä¸‹ä¸é½ */
      box-sizing:border-box;
      border:1px solid #d1d5db;            /* æ—¥é—´è¾¹æ¡† */
    }
    html.dark #note-modal .ql-toolbar .ql-picker.ql-color,
    html.dark #note-modal .ql-toolbar .ql-picker.ql-background{
      border:1px solid #4b5563;            /* å¤œé—´è¾¹æ¡† */
    }
    /* â€”â€” wrapperå•åœ†å½¢åŒ–ï¼Œå»æ‰å¤šä½™æ–¹æ¡† â€”â€” */
    #note-modal .ql-toolbar .ql-picker.ql-color,
    #note-modal .ql-toolbar .ql-picker.ql-background{
      width:32px!important;height:32px!important;border-radius:50%!important;
      padding:0!important;background:transparent!important;border:none!important;
      display:inline-flex!important;align-items:center!important;justify-content:center!important;
    }
    /* === final uniform picker override === */
    /* å¤–å±‚æ¢å¤é»˜è®¤å°ºå¯¸ï¼Œä¿ç•™å·¦å³ 8px é—´éš” */
    #note-modal .ql-toolbar .ql-picker.ql-color,
    #note-modal .ql-toolbar .ql-picker.ql-background {
      padding:0 8px;               /* Quill é»˜è®¤ */
      width:auto!important;
      height:auto!important;
      background:transparent!important;
      border:none!important;
      display:inline-flex!important;
      align-items:center!important;
    }
    /* å†…å±‚ label 32px åœ†å½¢ï¼ˆå§‹ç»ˆå¯è§ï¼‰ */
    #note-modal .ql-toolbar .ql-picker.ql-color   > .ql-picker-label,
    #note-modal .ql-toolbar .ql-picker.ql-background > .ql-picker-label {
      width:32px;height:32px;border-radius:50%;
      display:flex;align-items:center;justify-content:center;
      background:#ffffff!important;border:1px solid #d1d5db!important;
    }
    html.dark #note-modal .ql-toolbar .ql-picker.ql-color   > .ql-picker-label,
    html.dark #note-modal .ql-toolbar .ql-picker.ql-background > .ql-picker-label {
      background:#374151!important;border:1px solid #4b5563!important;
    }
    /* hover / active */
    #note-modal .ql-toolbar .ql-picker.ql-color   > .ql-picker-label:hover,
    #note-modal .ql-toolbar .ql-picker.ql-background > .ql-picker-label:hover {
      background:#e5e7eb!important;
    }
    html.dark #note-modal .ql-toolbar .ql-picker.ql-color   > .ql-picker-label:hover,
    html.dark #note-modal .ql-toolbar .ql-picker.ql-background > .ql-picker-label:hover {
      background:#4b5563!important;
    }
    #note-modal .ql-toolbar .ql-picker.ql-color.ql-expanded   > .ql-picker-label,
    #note-modal .ql-toolbar .ql-picker.ql-background.ql-expanded > .ql-picker-label,
    #note-modal .ql-toolbar .ql-picker.ql-color   .ql-picker-label.ql-active,
    #note-modal .ql-toolbar .ql-picker.ql-background .ql-picker-label.ql-active {
      background:#6366f1!important;color:#fff!important;
    }
    /*  å›¾æ ‡é¢œè‰²åœ¨ active çŠ¶æ€ä¸‹å·²ç”± Quill è‡ªåŠ¨è®¾å®šä¸ºç™½è‰²ï¼Œè¿™é‡Œä¸å†é¢å¤–å¤„ç† */
  </style>
  <style id="quill-picker-shade">
  /* --- match default Quill button shading --- */
  /* äº®è‰²ï¼šç¨æ·±ç°åº• + subtle inner shadow */
  body:not(.dark) #note-modal .ql-toolbar .ql-picker.ql-color > .ql-picker-label,
  body:not(.dark) #note-modal .ql-toolbar .ql-picker.ql-background > .ql-picker-label{
    background:#e5e7eb!important;/* ä¸å…¶å®ƒæŒ‰é’®ä¸€è‡´ */
    box-shadow: inset 0 0 0 1px rgba(0,0,0,0.05);
    border:1px solid #d1d5db!important;
  }
  /* æš—è‰²ï¼šä¸å…¶å®ƒæŒ‰é’®ä¸€è‡´çš„ç¨äº®ç°åœ† & å†…é˜´å½± */
  html.dark #note-modal .ql-toolbar .ql-picker.ql-color   > .ql-picker-label,
  html.dark #note-modal .ql-toolbar .ql-picker.ql-background > .ql-picker-label{
    background:#4b5563!important; /* æ¯”å·¥å…·æ æ·±ä¸€é˜¶ */
    box-shadow: inset 0 0 0 1px rgba(255,255,255,0.05);
    border:1px solid #4b5563!important;
  }
  /* æ‚¬åœæ—¶ä»…è¾¹æ¡† & é˜´å½±æäº®ï¼Œä¿æŒä¸å…¶ä»–æŒ‰é’®ä¸€è‡´ */
  body:not(.dark) #note-modal .ql-toolbar .ql-picker.ql-color > .ql-picker-label:hover,
  body:not(.dark) #note-modal .ql-toolbar .ql-picker.ql-background > .ql-picker-label:hover{
    background:#d1d5db!important;
  }
  html.dark #note-modal .ql-toolbar .ql-picker.ql-color   > .ql-picker-label:hover,
  html.dark #note-modal .ql-toolbar .ql-picker.ql-background > .ql-picker-label:hover{
    background:#6b7280!important; /* slate-500 */
  }
  </style>
  <style id="quill-picker-final-override">
    /* Light-mode default background & hover (sync with other buttons) */
    body:not(.dark) #note-modal .ql-toolbar .ql-picker.ql-color > .ql-picker-label,
    body:not(.dark) #note-modal .ql-toolbar .ql-picker.ql-background > .ql-picker-label{
      background:#ffffff !important;
      border:1px solid #e5e7eb !important; /* subtle outline */
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.03);
    }
    body:not(.dark) #note-modal .ql-toolbar .ql-picker.ql-color > .ql-picker-label:hover,
    body:not(.dark) #note-modal .ql-toolbar .ql-picker.ql-background > .ql-picker-label:hover{
      background:#f3f4f6 !important;
    }
    /* Dark-mode default & hover */
    html.dark #note-modal .ql-toolbar .ql-picker.ql-color > .ql-picker-label,
    html.dark #note-modal .ql-toolbar .ql-picker.ql-background > .ql-picker-label{
      background:#374151 !important;
      border:1px solid #4b5563 !important;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.05);
    }
    html.dark #note-modal .ql-toolbar .ql-picker.ql-color > .ql-picker-label:hover,
    html.dark #note-modal .ql-toolbar .ql-picker.ql-background > .ql-picker-label:hover{
      background:#4b5563 !important;
    }
  </style>
  <style id="quill-picker-size-fix">
    /* shrink pickers to match other buttons */
    #note-modal .ql-toolbar .ql-picker.ql-color,
    #note-modal .ql-toolbar .ql-picker.ql-background{
      padding:0 !important;              /* remove extra horizontal paddings */
    }
    #note-modal .ql-toolbar .ql-picker.ql-color > .ql-picker-label,
    #note-modal .ql-toolbar .ql-picker.ql-background > .ql-picker-label{
      width:28px !important;
      height:28px !important;
    }
  </style>
  <!-- å–æ¶ˆç´§å‡‘æ¨¡å¼æ ·å¼ï¼Œå§‹ç»ˆä¿æŒç»Ÿä¸€å¡ç‰‡å°ºå¯¸ -->
  <style id="card-size-lock">
    /* é¢˜åº“å¡ç‰‡ä¿æŒç»Ÿä¸€å°ºå¯¸ä¸ä¸Šä¸‹ç•™ç™½ */
    .draggable-lib {
      min-height: 96px;
      padding: 16px 20px;
      display: flex;
      flex-direction: column;
      width: 100%;
      box-sizing: border-box;
      flex-shrink: 0;
    }
    
    /* é‡è¦ï¼šä¿®å¤æ»šåŠ¨åŒºåŸŸå¡ç‰‡è¢«å‹ç¼©çš„é—®é¢˜ */
    .scroll-list > .draggable-lib,
    .scroll-list > div {
      width: calc(100% - 12px) !important;
      margin-right: 4px;
    }
    
    /* ç¡®ä¿æ ‡é¢˜å†…å®¹ä¸è¢«å‹ç¼©ï¼Œæ ‡é¢˜å’Œæ“ä½œæ é—´è·å›ºå®š */
    .draggable-lib .flex.items-center.mb-1 {
      flex: 1;
    }
    
    /* æ“ä½œæ å›ºå®šé«˜åº¦ï¼Œä¸è¢«å‹ç¼© */
    .draggable-lib .flex.items-center.justify-between {
      margin-top: 12px;
      flex-shrink: 0;
      flex-wrap: nowrap;
    }
    
    /* æ»šåŠ¨å®¹å™¨è®¾ç½® */
    .scroll-list {
      position: relative;
      box-sizing: border-box;
      scrollbar-width: none; /* éšè—Firefoxæ»šåŠ¨æ¡ */
      -ms-overflow-style: none; /* éšè—IEæ»šåŠ¨æ¡ */
      /* ä½¿ç”¨autoè€Œä¸æ˜¯overlayï¼Œç¡®ä¿å…¼å®¹æ€§ */
      overflow-y: auto;
      padding-right: 4px; /* ç»™æ»šåŠ¨æ¡é¢„ç•™ç©ºé—´ */
      margin-right: -4px; /* æŠµæ¶ˆpadding-right */
    }
    
    /* éšè—æ»šåŠ¨æ¡ä½†ä¿ç•™åŠŸèƒ½ */
    .scroll-list::-webkit-scrollbar { 
      width: 8px;
      background: transparent;
    }
    
    .scroll-list::-webkit-scrollbar-thumb { 
      background: rgba(199, 210, 254, 0.5); /* åŠé€æ˜æ»šåŠ¨æ¡ */
      border-radius: 4px;
    }

    /* å½“å‰ç»ƒä¹ é¢˜åº“é«˜äº®æ ·å¼ */
    .active-practice-library {
      position: relative;
      border: 2px solid #6366f1 !important;
      box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2), 0 4px 12px rgba(99, 102, 241, 0.15) !important;
    }

    .active-practice-library::before {
      content: 'å½“å‰ç»ƒä¹ ';
      position: absolute;
      top: 4px;
      right: 8px;
      background: #6366f1;
      color: white;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 600;
      z-index: 10;
    }

    .dark .active-practice-library::before {
      background: #818cf8;
    }

    .active-practice-library .draggable-lib {
      border-color: #6366f1 !important;
      background: rgba(99, 102, 241, 0.05) !important;
    }

    .dark .active-practice-library .draggable-lib {
      background: rgba(99, 102, 241, 0.1) !important;
    }
  </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen transition-colors duration-300">
  <!-- é¡¶éƒ¨LOGO+ç³»ç»Ÿå -->
  <header class="flex items-center gap-3 px-6 py-4 border-b border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900 shadow-sm select-none sticky top-0 z-50" style="backdrop-filter: blur(6px);">
    <!-- åˆ é™¤ç½²åå…ƒç´  -->
    <!-- <div class="author-signature"><span>Leosu</span></div> -->
    <span class="logo-tijing">
      <svg viewBox="0 0 48 48" fill="none">
        <rect x="6" y="12" width="36" height="24" rx="6" fill="url(#bookGradient)"/>
        <path d="M12 18 Q24 30 36 18" stroke="#6366f1" stroke-width="2.5" fill="none"/>
        <ellipse cx="24" cy="16" rx="3.5" ry="2" fill="#6366f1" opacity=".7"/>
        <circle cx="24" cy="10" r="3" fill="#fbbf24" stroke="#6366f1" stroke-width="1.5"/>
        <path d="M24 13 v2" stroke="#fbbf24" stroke-width="1.5"/>
        <defs>
          <linearGradient id="bookGradient" x1="6" y1="12" x2="42" y2="36" gradientUnits="userSpaceOnUse">
            <stop stop-color="#a5b4fc"/>
            <stop offset="1" stop-color="#c4b5fd"/>
          </linearGradient>
        </defs>
      </svg>
    </span>
    <span class="text-2xl font-extrabold tracking-tight" style="font-family: 'Noto Serif SC', serif; letter-spacing: 0.05em;">é¢˜å¢ƒ</span>
    <span class="ml-4 text-base text-gray-500 dark:text-gray-400 font-medium">æœ¬åœ°é¢˜åº“ç³»ç»Ÿ</span>
    <!-- æ¯æ—¥ä¸€è¨€ï¼šä¿æŒ flex é¡ºåº (ml-auto å®ç°æ¨å³)ï¼Œè¶…é•¿å¥å­é€šè¿‡ transform å‘å·¦ä½ç§» -->
    <span id="daily-quote" class="ml-auto mr-4 text-base italic text-indigo-600 dark:text-indigo-300 whitespace-nowrap" style="max-width:none;" title="æ¯æ—¥ä¸€è¨€"></span>
    <!-- ä¸»é¢˜åˆ‡æ¢æŒ‰é’® -->
    <button id="theme-toggle" class="p-2 rounded-full bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 shadow transition-transform hover:scale-110" title="åˆ‡æ¢ä¸»é¢˜">
      <i id="theme-icon" class="fas fa-moon text-gray-700 dark:text-yellow-300"></i>
    </button>
  </header>

  <!-- ä¸‰æ ä¸»å¸ƒå±€ -->
  <main class="flex flex-row w-full max-w-[1600px] mx-auto min-h-[calc(100vh-64px)]">
    <!-- å·¦ä¾§ï¼šåˆ†ç±»ä¸é¢˜åº“ç®¡ç† -->
    <aside class="w-72 min-w-[240px] max-w-xs bg-white dark:bg-gray-900 border-r border-gray-200 dark:border-gray-800 p-4 flex flex-col gap-4 overflow-y-auto scrollbar-hide">
      <div class="flex items-center gap-2 mb-4">
        <button class="tab-btn flex-1 flex flex-col items-center gap-1 py-2 rounded-lg font-semibold text-indigo-600 dark:text-indigo-300 bg-indigo-50 dark:bg-indigo-900 hover:bg-indigo-100 dark:hover:bg-indigo-800 transition" data-tab="library"><i class="fas fa-folder-open text-lg"></i><span class="text-xs">é¢˜åº“</span></button>
        <button class="tab-btn flex-1 flex flex-col items-center gap-1 py-2 rounded-lg font-semibold text-red-500 dark:text-red-300 bg-red-50 dark:bg-red-900 hover:bg-red-100 dark:hover:bg-red-800 transition" data-tab="wrong"><i class="fas fa-times-circle text-lg"></i><span class="text-xs">é”™é¢˜æœ¬</span></button>
        <button class="tab-btn flex-1 flex flex-col items-center gap-1 py-2 rounded-lg font-semibold text-yellow-500 dark:text-yellow-300 bg-yellow-50 dark:bg-yellow-900 hover:bg-yellow-100 dark:hover:bg-yellow-800 transition" data-tab="fav"><i class="fas fa-star text-lg"></i><span class="text-xs">æ”¶è—å¤¹</span></button>
      </div>
      <!-- æ“ä½œæŒ‰é’®è¡Œ + æœç´¢æ  -->
      <div id="action-row" class="flex flex-col gap-2 mb-4">
        <!-- æŒ‰é’®è¡Œ -->
        <div class="flex gap-1 w-full flex-nowrap">
          <button id="download-template-btn" title="ä¸‹è½½æ¨¡æ¿"
                  class="px-2 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-semibold shadow text-xs inline-flex items-center justify-center gap-1 whitespace-nowrap flex-1">
            <i class="fas fa-download text-xs"></i><span>ä¸‹è½½æ¨¡æ¿</span>
          </button>
          <button id="upload-btn" title="ä¸Šä¼ é¢˜åº“"
                  class="px-2 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-semibold shadow text-xs inline-flex items-center justify-center gap-1 whitespace-nowrap flex-1">
            <i class="fas fa-upload text-xs"></i><span>ä¸Šä¼ é¢˜åº“</span>
          </button>
          <button id="stats-btn" title="å­¦ä¹ ç»Ÿè®¡"
                  class="px-2 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-semibold shadow text-xs inline-flex items-center justify-center gap-1 whitespace-nowrap flex-1">
            <i class="fas fa-chart-column text-xs"></i><span>å­¦ä¹ ç»Ÿè®¡</span>
          </button>
        </div>
        <!-- æœç´¢æ  -->
        <input id="lib-search" type="text" placeholder="æœç´¢é¢˜åº“â€¦"
               class="w-full h-8 px-3 text-sm rounded-lg border border-indigo-200 focus:ring-2 focus:ring-indigo-300 outline-none transition" />
      </div>
      <div id="tab-library">
        <div class="flex items-center justify-between mb-2">
          <span class="text-lg font-bold"><i class="fas fa-folder-open text-indigo-500 mr-2"></i>é¢˜åº“ç®¡ç†</span>
        </div>
        <div id="category-list" class="flex flex-col gap-2"></div>
      </div>
      <!-- é”™é¢˜æœ¬éƒ¨åˆ† -->
      <div id="tab-wrong" class="hidden tab-container draggable-cat">
        <div class="tab-header">
          <span class="wrong-title"><i class="fas fa-times-circle mr-2"></i>é”™é¢˜æœ¬</span>
          <button id="clear-wrongbook" class="clear-btn">æ¸…ç©º</button>
        </div>
        <div id="wrongbook-list" class="flex flex-col gap-2"></div>
        <button id='wrongbook-practice' class='mt-3 px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg font-semibold shadow hidden'>
          <i class='fas fa-play mr-1'></i>åˆ·é”™é¢˜
        </button>
      </div>
      <!-- æ”¶è—å¤¹éƒ¨åˆ† -->
      <div id="tab-fav" class="hidden tab-container draggable-cat">
        <div class="tab-header">
          <span class="fav-title"><i class="fas fa-star mr-2"></i>æ”¶è—å¤¹</span>
          <button id="clear-favbook" class="clear-btn">æ¸…ç©º</button>
        </div>
        <div id="favbook-list" class="flex flex-col gap-2"></div>
        <button id='favbook-practice' class='mt-3 px-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg font-semibold shadow hidden'>
          <i class='fas fa-play mr-1'></i>åˆ·æ”¶è—
        </button>
      </div>
    </aside>

    <!-- ä¸­é—´ï¼šç»ƒä¹ ä¸»åŒºåŸŸï¼ˆé¢„ç•™ï¼‰ -->
    <section id="main-section" class="flex-1 flex flex-col items-center justify-center w-full h-full p-0 m-0">
      <div class="text-gray-400 text-xl">è¯·é€‰æ‹©å·¦ä¾§é¢˜åº“å¼€å§‹ç»ƒä¹ </div>
    </section>

    <section id="search-result" class="flex-1 hidden overflow-y-auto p-6"></section>
    <!-- å­¦ä¹ ç»Ÿè®¡é¡µ -->
    <section id="stats-section" class="flex-1 hidden overflow-y-auto p-6 flex flex-col justify-between items-center">
      <!-- å¾…å¼€å‘å ä½ -->
      <div id="stats-placeholder" class="flex flex-col items-center justify-center w-full max-w-3xl h-96 bg-white/90 dark:bg-gray-700/60 backdrop-blur-md rounded-2xl shadow-2xl border border-gray-100 dark:border-gray-700/60">
        <i class="fas fa-tools text-4xl text-indigo-400 mb-4"></i>
        <h3 class="dark:text-white text-gray-700 text-xl font-semibold mb-2">å­¦ä¹ ç»Ÿè®¡åŠŸèƒ½å¼€å‘ä¸­â€¦</h3>
        <p class="dark:text-gray-300 text-gray-500">æ•¬è¯·æœŸå¾…åç»­æ›´æ–°</p>
      </div>
    </section>

    <!-- å³ä¾§ï¼šç­”é¢˜å¡ï¼ˆé¢„ç•™ï¼‰ -->
    <aside class="w-56 min-w-[180px] max-w-sm bg-white dark:bg-gray-900 border-l border-gray-200 dark:border-gray-800 p-4 flex flex-col gap-4 overflow-y-auto scrollbar-hide">
      <div class="text-lg font-bold text-gray-500 dark:text-gray-400"><i class="fas fa-list-ol mr-2"></i>ç­”é¢˜å¡</div>
      <div class="text-gray-400 text-sm">ç»ƒä¹ æ—¶æ˜¾ç¤ºé¢˜å·è·³è½¬</div>
    </aside>
  </main>

  <!-- ä¸Šä¼ é¢˜åº“æ–‡ä»¶inputï¼ˆéšè—ï¼‰ -->
  <input id="file-upload" type="file" accept=".xlsx,.xls" class="hidden" />

  <!-- åˆ†ç±»é€‰æ‹©/æ–°å»ºå¼¹çª— -->
  <div id="category-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-bg hidden">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl p-7 w-full max-w-md flex flex-col gap-4 border border-gray-100 dark:border-gray-700">
      <div class="text-xl font-bold mb-5 flex items-center">
        <div class="w-10 h-10 bg-indigo-100 dark:bg-white rounded-full flex items-center justify-center mr-3 shadow-sm">
          <i class="fas fa-layer-group text-indigo-600 dark:text-indigo-600"></i>
        </div>
        <span class="text-black dark:text-white">é€‰æ‹©æˆ–æ–°å»ºåˆ†ç±»</span>
      </div>
      <label class="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-100">å·²æœ‰åˆ†ç±»</label>
      <select id="category-select" class="w-full p-2.5 rounded-md border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-800 dark:text-white mb-4 focus:outline-none dark:focus:outline-none">
        <option value="">-- è¯·é€‰æ‹© --</option>
      </select>
      <label class="block text-sm font-medium mb-1 text-gray-700 dark:text-gray-100">æ–°å»ºåˆ†ç±»</label>
      <input id="category-input" type="text" class="w-full p-2.5 rounded-md border border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-800 dark:text-white dark:placeholder-gray-300 focus:outline-none dark:focus:outline-none" placeholder="è¾“å…¥æ–°åˆ†ç±»åç§°" />
      <div class="flex gap-3 mt-7 justify-end">
        <button id="category-cancel" class="px-5 py-2 bg-gray-200 hover:bg-gray-300 dark:bg-white dark:hover:bg-gray-200 text-gray-700 dark:text-gray-800 rounded-md font-medium transition">å–æ¶ˆ</button>
        <button id="category-confirm" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 dark:bg-indigo-500 dark:hover:bg-indigo-600 text-white rounded-md font-medium transition">ç¡®å®š</button>
      </div>
    </div>
  </div>

  <!-- å¼€å‘ä¸“ç”¨ï¼šä¸€é”®å¤‡ä»½æŒ‰é’®ï¼Œå‘å¸ƒæ—¶å¯åˆ é™¤ -->
  <div id="dev-backup-btn" style="position:fixed;top:16px;right:120px;z-index:1000;">
    <button id="backup-btn" class="px-3 py-1 bg-yellow-400 hover:bg-yellow-500 text-white rounded shadow font-bold text-sm" title="å¼€å‘ä¸“ç”¨ï¼šä¸€é”®å¤‡ä»½å½“å‰ä»£ç ">ä¸€é”®å¤‡ä»½</button>
  </div>

  <!-- ç¬”è®°å¼¹çª— -->
  <div id="note-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
    <div class="modal-bg absolute inset-0" id="note-modal-bg"></div>
    <div class="bg-white rounded-2xl shadow-xl p-6 w-10/12 max-w-3xl flex flex-col gap-4 border-2 border-indigo-100 bg-gradient-to-br from-white to-indigo-50 note-draggable z-10">
      <div class="text-lg font-bold mb-3 flex items-center justify-between pb-2 border-b border-indigo-100 cursor-move drag-handle" id="note-drag-handle">
        <div class="flex items-center gap-2">
          <div class="w-7 h-7 rounded-full bg-indigo-100 flex items-center justify-center">
            <i class="fas fa-sticky-note text-indigo-500"></i>
          </div>
          <span class="text-indigo-700">é¢˜ç›®ç¬”è®°</span>
        </div>
        <button id="note-close" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-200 text-gray-500" title="å…³é—­"><i class="fas fa-times"></i></button>
      </div>
      <!-- å·¥å…·æ  -->
      <div id="note-toolbar" class="flex flex-wrap gap-1.5 mb-2 p-1.5 bg-indigo-50 rounded-lg">
        <button class="note-tool px-2 py-0.5 text-xs bg-white hover:bg-indigo-100 rounded-md text-indigo-700 shadow-sm border border-indigo-100" data-cmd="bold" title="åŠ ç²—">
          <i class="fas fa-bold mr-1"></i>åŠ ç²—
        </button>
        <button class="note-tool px-2 py-0.5 text-xs bg-white hover:bg-indigo-100 rounded-md text-indigo-700 shadow-sm border border-indigo-100" data-cmd="italic" title="æ–œä½“">
          <i class="fas fa-italic mr-1"></i>æ–œä½“
        </button>
        <button class="note-tool px-2 py-0.5 text-xs bg-white hover:bg-indigo-100 rounded-md text-indigo-700 shadow-sm border border-indigo-100" data-cmd="ul" title="æ— åºåˆ—è¡¨">
          <i class="fas fa-list-ul mr-1"></i>æ— åº
        </button>
        <button class="note-tool px-2 py-0.5 text-xs bg-white hover:bg-indigo-100 rounded-md text-indigo-700 shadow-sm border border-indigo-100" data-cmd="ol" title="æœ‰åºåˆ—è¡¨">
          <i class="fas fa-list-ol mr-1"></i>æœ‰åº
        </button>
        <button id="note-preview-toggle" class="ml-auto text-xs px-2 py-0.5 rounded-md bg-indigo-500 hover:bg-indigo-600 text-white shadow-sm" title="åˆ‡æ¢é¢„è§ˆ">
          <i class="fas fa-eye mr-1"></i>é¢„è§ˆ
        </button>
      </div>
      <!-- å¯Œæ–‡æœ¬ç¼–è¾‘å™¨å®¹å™¨ï¼ˆQuill æ³¨å…¥ï¼‰ -->
      <div id="note-editor" class="quill-container w-full"></div>
      <!-- Markdown ç¼–è¾‘å™¨ -->
      <div id="md-wrapper" class="w-full hidden flex flex-col">
        <!-- Markdown ç¼–è¾‘å™¨ -->
        <textarea id="md-editor" class="flex-1 min-h-[260px] p-3 text-sm font-mono resize-none overflow-y-auto" placeholder="åœ¨æ­¤è¾“å…¥ Markdown..."></textarea>
        <!-- Markdown é¢„è§ˆåŒº -->
        <div id="md-preview" class="flex-1 min-h-[260px] p-3 markdown-body overflow-y-auto hidden"></div>
      </div>
      <div class="flex gap-2 mt-3 justify-end pt-2 border-t border-indigo-100">
        <button id="note-delete" class="px-3 py-1 bg-white hover:bg-red-50 text-red-500 rounded-lg font-medium mr-auto border border-red-200 hover:border-red-300 shadow-sm flex items-center text-sm">
          <i class="fas fa-trash mr-1"></i>åˆ é™¤
        </button>
        <button id="note-save" class="px-3 py-1 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-medium shadow-sm flex items-center text-sm">
          <i class="fas fa-save mr-1"></i>ä¿å­˜
        </button>
      </div>
    </div>
  </div>
  <!-- ç»“æŸç¬”è®°å¼¹çª— -->

  <div class="note-panel">
    <!-- ç¬”è®°çª—å£å†…å®¹ -->
  </div>

  <script>
    // è§£æé¢˜åº“æ–‡ä»¶å†…å®¹çš„å‡½æ•° - å…¨å±€å®šä¹‰ï¼Œç¡®ä¿åœ¨Electronå’ŒéElectronç¯å¢ƒéƒ½å¯è®¿é—®
      async function parseQuestionBankFromContent(fileContent, filePath) {
        try {
          // ç¡®ä¿XLSXå·²ç»åŠ è½½
          if (typeof XLSX === 'undefined') {
            throw new Error('XLSXåº“æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
          }
          
          console.log('å¼€å§‹è§£ææ–‡ä»¶...');
          
          // å°†æ–‡ä»¶å†…å®¹è½¬æ¢ä¸º ArrayBuffer
          const arrayBuffer = new Uint8Array(fileContent).buffer;
          
          // ä½¿ç”¨ SheetJS è§£æ Excel æ–‡ä»¶ï¼Œä½¿ç”¨raw:falseç¡®ä¿ä¿ç•™æ–‡æœ¬æ ¼å¼
          const workbook = XLSX.read(arrayBuffer, { 
            type: 'array', 
            raw: false, 
            cellText: true, 
            cellFormula: false,
            cellNF: false,  // ç¦ç”¨æ•°å­—æ ¼å¼åŒ–ï¼Œå¼ºåˆ¶æ–‡æœ¬ä¿ç•™
            dateNF: 'yyyy-mm-dd' // æ—¥æœŸæ ¼å¼ä¿æŒåŸå§‹æ–‡æœ¬
          });
          
          if (!workbook || !workbook.SheetNames || workbook.SheetNames.length === 0) {
            throw new Error('æ— æ³•è¯»å–Excelå·¥ä½œè¡¨');
          }
          
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          if (!sheet) {
            throw new Error('å·¥ä½œè¡¨ä¸ºç©º');
          }
          
          console.log('æˆåŠŸè¯»å–å·¥ä½œè¡¨');
          
          const rows = XLSX.utils.sheet_to_json(sheet, { 
            header: 1, 
            blankrows: false, 
            defval: '',
            raw: false,  // ç¡®ä¿æ–‡æœ¬æ ¼å¼ä¿ç•™
            cellText: true  // å¼ºåˆ¶ä½¿ç”¨æ–‡æœ¬æ ¼å¼
          });
          if (!rows || rows.length === 0) {
            throw new Error('å·¥ä½œè¡¨ä¸­æ²¡æœ‰æ•°æ®');
          }
          
          console.log(`è¯»å–åˆ°${rows.length}è¡Œæ•°æ®`);
          
          // è°ƒè¯•ï¼šéªŒè¯æ ‡ç‚¹ç¬¦å·æ˜¯å¦è¢«æ­£ç¡®ä¿ç•™
          console.log('=== æ ‡ç‚¹ç¬¦å·è°ƒè¯•ä¿¡æ¯ ===');
          rows.slice(0, 3).forEach((row, idx) => {
            if (row && row.length > 0) {
              const firstCell = String(row[0] || '');
              console.log(`ç¬¬${idx+1}è¡Œç¬¬ä¸€åˆ—å†…å®¹: "${firstCell}"`);
              console.log(`åŒ…å«é€—å·: ${firstCell.includes(',')}`);
              console.log(`é€—å·ä½ç½®: ${[...firstCell].map((c, i) => c === ',' ? i : -1).filter(i => i !== -1)}`);
            }
          });
          console.log('=== è°ƒè¯•ä¿¡æ¯ç»“æŸ ===');
          
        // ç›´æ¥ä½¿ç”¨æ‰€æœ‰è¡Œï¼Œä¸è·³è¿‡ç¬¬ä¸€è¡Œ
          const questions = rows.map((row, idx) => {
            // æ£€æŸ¥è¡Œæ•°æ®æ˜¯å¦æœ‰æ•ˆ
            if (!row || !Array.isArray(row) || row.length < 2) {
              console.warn(`ç¬¬${idx+1}è¡Œæ•°æ®æ— æ•ˆï¼Œå·²è·³è¿‡`);
              return null;
            }
            
            // ç¡®ä¿æ‰€æœ‰å€¼éƒ½è½¬æ¢ä¸ºå­—ç¬¦ä¸²ä»¥ä¿ç•™åŸå§‹æ ¼å¼ï¼ˆåŒ…æ‹¬æ•°å­—ä¸­çš„é€—å·ï¼‰
            const [stem, answer, optA, optB, optC, optD, optE, explanation] = row.map(cell => {
              const strValue = cell != null ? String(cell) : '';
              // è°ƒè¯•ï¼šæ£€æµ‹åŸå§‹å€¼ç±»å‹å’Œå†…å®¹
              console.log(`ç¬¬${idx+1}è¡Œå•å…ƒæ ¼å€¼:`, {
                original: cell,
                type: typeof cell,
                string: strValue,
                hasComma: strValue.includes(','),
                length: strValue.length
              });
              return strValue;
            });
            
            // è°ƒè¯•ï¼šæ‰“å°å®Œæ•´è¡Œæ•°æ®ä»¥éªŒè¯æ ‡ç‚¹ç¬¦å·
            console.log(`ç¬¬${idx+1}è¡Œå®Œæ•´æ•°æ®:`, {
              stem: stem,
              answer: answer,
              optA: optA,
              optB: optB,
              optC: optC,
              optD: optD,
              optE: optE,
              explanation: explanation,
              rowLength: row.length,
              rawRow: row
            });
            
            // æ£€æŸ¥é¢˜å¹²å’Œç­”æ¡ˆæ˜¯å¦å­˜åœ¨
            if (!stem || !answer) {
              console.warn(`ç¬¬${idx+1}è¡Œç¼ºå°‘é¢˜å¹²æˆ–ç­”æ¡ˆï¼Œå·²è·³è¿‡`);
              return null;
            }
            
            const options = [optA, optB, optC, optD, optE]
              .map((opt, i) => opt ? { label: String.fromCharCode(65 + i), text: opt } : null)
              .filter(Boolean);
            
            // æ£€æŸ¥é€‰é¡¹æ˜¯å¦å­˜åœ¨
            if (options.length === 0) {
              console.warn(`ç¬¬${idx+1}è¡Œæ²¡æœ‰æœ‰æ•ˆé€‰é¡¹ï¼Œå·²è·³è¿‡`);
              return null;
            }
            
            const type = (typeof answer === 'string' && answer.length > 1) ? 'å¤šé€‰' : 'å•é€‰';
            return {
              id: idx + 1,
              stem: stem || '',
              answer: answer || '',
              options,
              explanation: explanation || '',
              type
            };
          }).filter(Boolean); // è¿‡æ»¤æ‰nullå€¼
          
          if (!questions.length) {
            throw new Error('é¢˜åº“æ–‡ä»¶è§£æå¤±è´¥ï¼Œæœªæ‰¾åˆ°æœ‰æ•ˆé¢˜ç›®ï¼Œè¯·æ£€æŸ¥æ ¼å¼ï¼');
          }
          
          console.log(`æˆåŠŸè§£æ${questions.length}é“é¢˜ç›®`);
          
          // æ˜¾ç¤ºåˆ†ç±»é€‰æ‹©å¼¹çª—
          showCategoryModal(questions, filePath);
          
        } catch (error) {
          console.error('æ–‡ä»¶è§£æé”™è¯¯:', error);
          alert('æ–‡ä»¶è§£æå¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'));
          throw error;
        }
      }
      
    // æ˜¾ç¤ºå¯¼å…¥æˆåŠŸä¿¡æ¯ - å…¨å±€å®šä¹‰
      function showImportSuccess(filePath) {
        const fileName = filePath.split(/[\\/]/).pop(); // è·å–æ–‡ä»¶å
        console.log(`é¢˜åº“å¯¼å…¥æˆåŠŸ: ${fileName}`);
        // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æ›´å‹å¥½çš„æˆåŠŸæç¤º
      }
      
    // æ˜¾ç¤ºåˆ†ç±»é€‰æ‹©å¼¹çª— - å…¨å±€å®šä¹‰
      function showCategoryModal(questions, filePath) {
      const fileName = typeof filePath === 'string' ? filePath.split(/[\\/]/).pop().replace(/\.[^.]+$/, '') : 'æœªå‘½åé¢˜åº“';
        
        // å¡«å……å·²æœ‰åˆ†ç±»
        const categorySelect = document.getElementById('category-select');
        categorySelect.innerHTML = '<option value="">-- è¯·é€‰æ‹© --</option>' + categories.map(cat => `<option value="${cat.name}">${cat.name}</option>`).join('');
        
        // æ¸…ç©ºè¾“å…¥æ¡†
        document.getElementById('category-input').value = '';
        
        // æ˜¾ç¤ºå¼¹çª—
        document.getElementById('category-modal').classList.remove('hidden');
        
        // ä¿®æ”¹ç¡®è®¤æŒ‰é’®çš„å¤„ç†é€»è¾‘
        const categoryConfirm = document.getElementById('category-confirm');
        
      categoryConfirm.onclick = () => {
          let catName = categorySelect.value || document.getElementById('category-input').value.trim();
          if (!catName) {
            alert('è¯·é€‰æ‹©æˆ–è¾“å…¥åˆ†ç±»åç§°');
            return;
          }
          
          // é¢˜åº“åè‡ªåŠ¨ç”Ÿæˆ
          const name = fileName;
          
          // åˆ†ç±»å¤„ç†
          let catIdx = categories.findIndex(cat => cat.name === catName);
          if (catIdx === -1) {
            categories.unshift({ name: catName, libraries: [] });
            catIdx = 0;
          }
          
          // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨åŒåé¢˜åº“
          const existingLibIndex = categories[catIdx].libraries.findIndex(lib => lib.name === name);
          if (existingLibIndex !== -1) {
            // æç¤ºç”¨æˆ·æ˜¯å¦æ›¿æ¢
            if (confirm(`åˆ†ç±»"${catName}"ä¸­å·²å­˜åœ¨åä¸º"${name}"çš„é¢˜åº“ï¼Œæ˜¯å¦æ›¿æ¢ï¼Ÿ`)) {
              // æ›¿æ¢ç°æœ‰é¢˜åº“
              categories[catIdx].libraries[existingLibIndex] = {
                id: Date.now(),
                name,
                questions,
                created: new Date().toISOString(),
                lastUsed: new Date().toISOString()
              };
            } else {
              // ç”¨æˆ·å–æ¶ˆæ›¿æ¢ï¼Œå¯ä»¥æä¾›é‡å‘½åé€‰é¡¹
              const newName = prompt('è¯·è¾“å…¥æ–°çš„é¢˜åº“åç§°:', name + ' (å¤åˆ¶)');
              if (!newName || !newName.trim()) return; // ç”¨æˆ·å–æ¶ˆ
              
              // æ·»åŠ æ–°é¢˜åº“
              categories[catIdx].libraries.push({
                id: Date.now(),
                name: newName.trim(),
                questions,
                created: new Date().toISOString(),
                lastUsed: new Date().toISOString()
              });
            }
          } else {
            // æ–°é¢˜åº“åŠ åˆ°åˆ†ç±»æœ€å
            categories[catIdx].libraries.push({
              id: Date.now(),
              name,
              questions,
              created: new Date().toISOString(),
              lastUsed: new Date().toISOString()
            });
          }
          
          saveCategories();
          renderCategories(catIdx); // å±•å¼€å½“å‰åˆ†ç±»
          document.getElementById('category-modal').classList.add('hidden');
      };
    }
    
    // Electron ç¯å¢ƒæ£€æµ‹å’Œå¢å¼ºå¯¼å…¥åŠŸèƒ½
    if (typeof window.electronAPI !== 'undefined') {
      // å¢å¼ºçš„é¢˜åº“å¯¼å…¥åŠŸèƒ½
      async function enhancedImportQuestionBank() {
        try {
          console.log('å¼€å§‹å¯¼å…¥é¢˜åº“...');
          
          // æ£€æŸ¥XLSXåº“æ˜¯å¦å·²åŠ è½½
          if (typeof XLSX === 'undefined') {
            alert('XLSXåº“æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            return;
          }
          
          // ä½¿ç”¨ Electron API æ‰“å¼€æ–‡ä»¶å¯¹è¯æ¡†
          const filePath = await window.electronAPI.openFileDialog();
          
          if (!filePath) {
            console.log('ç”¨æˆ·å–æ¶ˆäº†æ–‡ä»¶é€‰æ‹©');
            return;
          }
          
          console.log('ç”¨æˆ·é€‰æ‹©äº†æ–‡ä»¶:', filePath);
          
          // ä½¿ç”¨ Electron API è¯»å–æ–‡ä»¶å†…å®¹
          const fileContent = await window.electronAPI.readFile(filePath);
          
          if (!fileContent || !fileContent.length) {
            throw new Error('æ–‡ä»¶å†…å®¹ä¸ºç©º');
          }
          
          console.log('æˆåŠŸè¯»å–æ–‡ä»¶å†…å®¹ï¼Œå¤§å°:', fileContent.length, 'å­—èŠ‚');
          
          // è§£ææ–‡ä»¶å†…å®¹
          await parseQuestionBankFromContent(fileContent, filePath);
          
          // æ˜¾ç¤ºå¯¼å…¥æˆåŠŸä¿¡æ¯
          showImportSuccess(filePath);
        } catch (error) {
          console.error('å¯¼å…¥å¤±è´¥:', error);
          alert('å¯¼å…¥å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'));
        }
      }
      
      // æ›¿æ¢åŸæœ‰çš„ä¸Šä¼ æŒ‰é’®äº‹ä»¶
      const uploadBtn = document.getElementById('upload-btn');
      uploadBtn.onclick = enhancedImportQuestionBank;
    }

    // ä¸»é¢˜åˆ‡æ¢æŒ‰é’®äº‹ä»¶
    document.getElementById('theme-toggle').onclick = function() {
      const isDark = document.documentElement.classList.toggle('dark');
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
      const themeIcon = document.getElementById('theme-icon');
      themeIcon.className = isDark ? 'fas fa-sun text-yellow-300' : 'fas fa-moon text-gray-700';
      
      // æ›´æ–°ç­”é¢˜å¡æŒ‰é’®æ ·å¼
      updateAnswerCardButtonStyles();
    };
    
    // åˆå§‹åŒ–ä¸»é¢˜è®¾ç½®
    if (localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
      document.documentElement.classList.add('dark');
      document.getElementById('theme-icon').className = 'fas fa-sun text-yellow-300';
    }
    
    // æ›´æ–°ç­”é¢˜å¡æŒ‰é’®æ ·å¼çš„å‡½æ•°
    function updateAnswerCardButtonStyles() {
      const prevBtn = document.getElementById('prev-answer-page');
      const nextBtn = document.getElementById('next-answer-page');
      const isDark = document.documentElement.classList.contains('dark');
      
      if (prevBtn && nextBtn) {
        if (isDark) {
          prevBtn.style.backgroundColor = '#4f46e5';
          prevBtn.style.color = 'white';
          nextBtn.style.backgroundColor = '#4f46e5';
          nextBtn.style.color = 'white';
          
          if (prevBtn.hasAttribute('disabled')) {
            prevBtn.style.backgroundColor = '#4b5563';
            prevBtn.style.opacity = '0.5';
          }
          if (nextBtn.hasAttribute('disabled')) {
            nextBtn.style.backgroundColor = '#4b5563';
            nextBtn.style.opacity = '0.5';
          }
        } else {
          // æ·»åŠ æ—¥é—´æ¨¡å¼æ ·å¼
          prevBtn.style.backgroundColor = '#6366f1';
          prevBtn.style.color = 'white';
          nextBtn.style.backgroundColor = '#6366f1';
          nextBtn.style.color = 'white';
          
          if (prevBtn.hasAttribute('disabled')) {
            prevBtn.style.backgroundColor = '#d1d5db';
            prevBtn.style.opacity = '0.5';
          }
          if (nextBtn.hasAttribute('disabled')) {
            nextBtn.style.backgroundColor = '#d1d5db';
            nextBtn.style.opacity = '0.5';
          }
        }
      }
    }

    /* ---- æ¯æ—¥ä¸€è¨€ ---- */
    // åœ¨çº¿éšæœºæ¯æ—¥ä¸€è¨€ï¼ˆHitokoto APIï¼‰+ ç¦»çº¿æœ¬åœ°åå¤‡
    (async function(){
      const useStore = !!window.electronAPI;
      let storeQuoteObj = null;
      if (useStore) {
        try {
          storeQuoteObj = await window.electronAPI.getDailyQuote();
        } catch(e){console.warn('è¯»å– dailyQuote store å¤±è´¥',e);}  
      }
      const fallbackQuotes = [
        'è¯»ä¸‡å·ä¹¦ï¼Œè¡Œä¸‡é‡Œè·¯ã€‚',
        'å­¦å¦‚é€†æ°´è¡ŒèˆŸï¼Œä¸è¿›åˆ™é€€ã€‚',
        'å®å‰‘é”‹ä»ç£¨ç ºå‡ºï¼Œæ¢…èŠ±é¦™è‡ªè‹¦å¯’æ¥ã€‚',
        'é»‘å‘ä¸çŸ¥å‹¤å­¦æ—©ï¼Œç™½é¦–æ–¹æ‚”è¯»ä¹¦è¿Ÿã€‚',
        'ä¹¦å±±æœ‰è·¯å‹¤ä¸ºå¾„ï¼Œå­¦æµ·æ— æ¶¯è‹¦ä½œèˆŸã€‚',
        'ä¸šç²¾äºå‹¤è’äºå¬‰ï¼Œè¡Œæˆäºæ€æ¯äºéšã€‚',
        'æ•è€Œå¥½å­¦ï¼Œä¸è€»ä¸‹é—®ã€‚',
        'å°‘å£®ä¸åŠªåŠ›ï¼Œè€å¤§å¾’ä¼¤æ‚²ã€‚',
        'å¥½å­¦è€Œä¸è´°ï¼Œè€»ä¸‹é—®è€…ä¹Ÿã€‚',
        'çŸ¥è¯†æ”¹å˜å‘½è¿ï¼Œå­¦ä¹ æˆå°±æœªæ¥ã€‚'
      ];

      const KEY   = 'tijing-daily-quote';
      const today = new Date().toISOString().slice(0,10);
      // å…ˆå°è¯• localStorageï¼Œå†å°è¯•æ–‡ä»¶å­˜å‚¨
      const cacheLocal = JSON.parse(localStorage.getItem(KEY) || '{}');
      const cache = storeQuoteObj || cacheLocal;

      // å¦‚æœä»Šå¤©å·²æœ‰ç¼“å­˜ï¼ˆæ— è®ºæ¥æºï¼‰ï¼Œç›´æ¥æ˜¾ç¤ºå¹¶ç»“æŸï¼Œä¸å†è¯·æ±‚ç½‘ç»œ
      if (cache.date === today && cache.quote) {
        setQuote(cache.quote);
        return;
      }

      // è‹¥æ— ç¼“å­˜ï¼Œå†å°è¯•åœ¨çº¿è·å–
      fetch('https://v1.hitokoto.cn?encode=text', { cache: 'no-store' })
        .then(res => res.ok ? res.text() : Promise.reject())
        .then(txt => {
          const quoteOnline = txt.trim();
          if(isPositive(quoteOnline)){
            saveAndShow(quoteOnline, true); // online ä¸”é€šè¿‡ç­›é€‰
          }else{
            throw new Error('not positive');
          }
        })
        .catch(() => {
          // è‹¥ä»Šæ—¥å°šæ— ç¼“å­˜ï¼Œåˆ™ä½¿ç”¨æœ¬åœ°åå¤‡
          if (!(cache.date === today && cache.quote)) {
            // ä»æœ¬åœ°æ­£èƒ½é‡æ± éšæœºå–
            const local = fallbackQuotes[Math.floor(Math.random()*fallbackQuotes.length)];
            saveAndShow(local, false);
          }
        });

      function saveAndShow(q, isOnline){
        const obj = { date: today, quote: q, online: !!isOnline };
        localStorage.setItem(KEY, JSON.stringify(obj));
        if (useStore) {
          window.electronAPI.setDailyQuote(obj);
        }
        setQuote(q);
      }

      function setQuote(q){
        const span = document.getElementById('daily-quote');
        if(span){
          const maxLen = 40; // æœ€å¤šæ˜¾ç¤º 40 ä¸ªå­—ç¬¦ï¼Œè¶…å‡ºåŠ çœç•¥å·
          span.textContent = q.length > maxLen ? q.slice(0, maxLen) + 'â€¦' : q;
          span.setAttribute('title', q); // hover æ—¶æ˜¾ç¤ºå®Œæ•´å¥å­
        }
      }
    })();

    // å…³é”®è¯ç­›é€‰ï¼šåŒ…å«ç§¯æå­¦ä¹ ç›¸å…³è¯ä¸”ä¸å«å±è”½è¯
    const positiveKeywords = ['å­¦', 'ä¹ ', 'è¯»', 'ä¹¦', 'å‹¤', 'æ€', 'é—®', 'çŸ¥', 'è¿›', 'æ‚Ÿ', 'æˆé•¿', 'å¥‹æ–—', 'æœªæ¥', 'æ¢¦æƒ³', 'åŠªåŠ›', 'åšæŒ'];
    const bannedKeywords   = ['èƒ¸', 'è´«ä¹³', 'è‰²è‰²', 'æš—é»‘', 'æš´åŠ›'];

    function isPositive(q){
      const hasPositive = positiveKeywords.some(k => q.includes(k));
      const hasBanned   = bannedKeywords.some(k => q.includes(k));
      return hasPositive && !hasBanned;
    }

    // åˆ†ç±»ä¸é¢˜åº“æœ¬åœ°å­˜å‚¨ç»“æ„
    let categories = [];
    
    // åˆå§‹åŒ–æ•°æ®å­˜å‚¨
    async function initializeStorage() {
      try {
        console.log('åˆå§‹åŒ–æ•°æ®å­˜å‚¨...');
        
        // ä¼˜å…ˆä»æ–‡ä»¶å­˜å‚¨åŠ è½½æ•°æ®
        if (window.electronAPI) {
          const result = await window.electronAPI.loadData('categories');
          if (result.success && result.data) {
            categories = result.data;
            console.log('ä»æ–‡ä»¶å­˜å‚¨åŠ è½½äº†', categories.length, 'ä¸ªåˆ†ç±»');
            renderCategories(); // ç«‹å³æ¸²æŸ“åˆ†ç±»åˆ—è¡¨
            return;
          }
        }
        
        // å¦‚æœæ–‡ä»¶å­˜å‚¨æ²¡æœ‰æ•°æ®ï¼Œå°è¯•ä»localStorageè¯»å–
        categories = JSON.parse(localStorage.getItem('tijing-categories') || '[]');
        console.log('ä»localStorageåŠ è½½äº†', categories.length, 'ä¸ªåˆ†ç±»');
        
        // å¦‚æœä»localStorageè¯»å–åˆ°æ•°æ®ï¼Œç«‹å³ä¿å­˜åˆ°æ–‡ä»¶å­˜å‚¨
        if (categories.length > 0 && window.electronAPI) {
          await window.electronAPI.saveData('categories', categories);
          console.log('å·²å°†localStorageæ•°æ®è¿ç§»åˆ°æ–‡ä»¶å­˜å‚¨');
        }
      } catch (error) {
        console.error('è¯»å–é¢˜åº“æ•°æ®å¤±è´¥:', error);
        categories = [];
      }
      
      // æ¸²æŸ“åˆ†ç±»
      renderCategories();
    }
    
    // é¡µé¢åŠ è½½å®Œæˆåè°ƒç”¨åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      initializeStorage();
    });
    
    async function saveCategories() {
      try {
        // åŒæ—¶ä¿å­˜åˆ°localStorageå’Œæ–‡ä»¶å­˜å‚¨
        localStorage.setItem('tijing-categories', JSON.stringify(categories));
        
        if (window.electronAPI) {
          await window.electronAPI.saveData('categories', categories);
          console.log('ä¿å­˜äº†', categories.length, 'ä¸ªåˆ†ç±»åˆ°æ–‡ä»¶å­˜å‚¨');
        } else {
          console.log('ä¿å­˜äº†', categories.length, 'ä¸ªåˆ†ç±»åˆ°localStorage');
        }
      } catch (error) {
        console.error('ä¿å­˜é¢˜åº“æ•°æ®å¤±è´¥:', error);
        alert('ä¿å­˜é¢˜åº“æ•°æ®å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'));
      }
    }

    // åˆ†ç±»æŠ˜å çŠ¶æ€è®°å¿† - ä½¿ç”¨åˆ†ç±»åç§°ä½œä¸ºç¨³å®šID
    let categoryFoldState = JSON.parse(localStorage.getItem('tijing-category-fold') || '{}');
    function saveCategoryFoldState() {
      localStorage.setItem('tijing-category-fold', JSON.stringify(categoryFoldState));
    }

    // ç­”é¢˜å¡åˆ†é¡µå˜é‡
    let answerSheetPage = 0;
    const ANSWER_SHEET_PAGE_SIZE = 100;

    // é¢˜åº“åŠŸèƒ½
    
    // ç¡®ä¿DOMå®Œå…¨æ¸²æŸ“åå†ç»‘å®šäº‹ä»¶
    function bindEvents() {
      // ç»‘å®šåˆ†ç±»åˆ é™¤äº‹ä»¶
      document.querySelectorAll('.delete-cat-btn').forEach(btn => {
        btn.onclick = (e) => {
          e.stopPropagation();
          const cidx = btn.getAttribute('data-cidx');
          if (confirm('ç¡®å®šè¦åˆ é™¤è¯¥åˆ†ç±»åŠå…¶ä¸‹æ‰€æœ‰é¢˜åº“å—ï¼Ÿ')) {
            const catName = categories[cidx].name;
            delete categoryFoldState[catName];
            saveCategoryFoldState();
            categories.splice(cidx, 1);
            saveCategories();
            renderCategories();
          }
        };
      });

      // ç»‘å®šåˆ†ç±»æ ‡é¢˜ç‚¹å‡»äº‹ä»¶
      document.querySelectorAll('.cat-header').forEach(header => {
        header.onclick = function(e) {
          const cidx = header.closest('.draggable-cat').getAttribute('data-cidx');
          const bodyElement = document.getElementById(`cat-body-${cidx}`);
          bodyElement.classList.toggle('hidden');
        };
      });

      // ç»‘å®šé¢˜åº“åˆ é™¤äº‹ä»¶
      document.querySelectorAll('.delete-lib-btn').forEach(btn => {
        btn.onclick = (e) => {
          e.stopPropagation();
          const cidx = btn.getAttribute('data-cidx');
          const lidx = btn.getAttribute('data-lidx');
          if (confirm('ç¡®å®šè¦åˆ é™¤è¯¥é¢˜åº“å—ï¼Ÿ')) {
            categories[cidx].libraries.splice(lidx, 1);
            saveCategories();
            renderCategories(cidx);
          }
        };
      });

      // ç»‘å®šé¢˜åº“ç»ƒä¹ äº‹ä»¶
      document.querySelectorAll('.practice-btn').forEach(btn => {
        btn.onclick = (e) => {
          e.stopPropagation();
          const cidx = btn.getAttribute('data-cidx');
          const lidx = btn.getAttribute('data-lidx');
          const cat = categories[cidx];
          const libOrig = cat.libraries[lidx];
          // å…‹éš†åº“å¯¹è±¡å¹¶é™„åŠ æ‰€å±åˆ†ç±»ä¿¡æ¯
          const lib = { ...libOrig, _categoryName: cat.name };
          startPractice(lib);
        };
      });

      // ç»‘å®šæ‹–æ‹½äº‹ä»¶
      initializeDragAndDrop();
    }

    function renderCategories(expandIdx = null) {
      const list = document.getElementById('category-list');
      list.innerHTML = '';
      if (!categories.length) {
        list.innerHTML = '<div class="text-gray-400 text-sm">æš‚æ— åˆ†ç±»ï¼Œè¯·ä¸Šä¼ é¢˜åº“</div>';
        return;
      }
      
      categories.forEach((cat, cidx) => {
        // åˆ¤æ–­æ˜¯å¦åº”è¯¥å±•å¼€æ­¤åˆ†ç±» - åªåœ¨æ˜ç¡®æŒ‡å®šexpandIdxæ—¶å±•å¼€
        const shouldExpand = expandIdx !== null ? cidx === expandIdx : false;
        
        list.innerHTML += `
          <div class="border rounded-xl mb-2 bg-gray-50 dark:bg-gray-800 draggable-cat" draggable="true" data-cidx="${cidx}">
            <div class="flex items-center justify-between px-3 py-2 cursor-pointer select-none cat-header" data-cat-name="${cat.name}">
              <div class="flex items-center gap-2">
                <i class="fas fa-folder text-indigo-500"></i>
                <span class="font-bold">${cat.name}</span>
              </div>
              <button class="delete-cat-btn text-red-400 hover:text-red-600" data-cidx="${cidx}"><i class="fas fa-trash"></i></button>
            </div>
            <div id="cat-body-${cidx}" class="px-2 pb-2 ${shouldExpand ? '' : 'hidden'}">
              <div class="flex flex-col gap-2 scroll-list" data-cidx="${cidx}" id="lib-list-${cidx}" style="max-height: 320px;">
                ${cat.libraries.map((lib, lidx) => `
                  <div class="group bg-white dark:bg-gray-900 rounded-lg px-4 py-3 shadow-sm border border-gray-100 dark:border-gray-800 cursor-move draggable-lib" draggable="true" data-lidx="${lidx}">
                    <div class="flex items-center mb-1">
                      <i class="fas fa-book text-indigo-400 mr-2"></i>
                      <span class="font-semibold text-base filename whitespace-normal overflow-auto">${lib.name}</span>
                    </div>
                    <div class="flex items-center justify-between mt-1">
                      <span class="px-2 py-0.5 text-xs rounded bg-indigo-100 dark:bg-indigo-700 text-indigo-600 dark:text-indigo-200">${lib.questions.length}é¢˜</span>
                      <div class="flex gap-1 flex-shrink-0">
                        <button class="practice-btn w-7 h-7 flex items-center justify-center rounded hover:bg-indigo-100 dark:hover:bg-indigo-700 text-indigo-600 dark:text-indigo-200" data-cidx="${cidx}" data-lidx="${lidx}" title="ç»ƒä¹ "><i class="fas fa-play"></i></button>
                        <button class="delete-lib-btn w-7 h-7 flex items-center justify-center rounded hover:bg-red-100 dark:hover:bg-red-700 text-red-600 dark:text-red-200" data-cidx="${cidx}" data-lidx="${lidx}" title="åˆ é™¤"><i class="fas fa-trash"></i></button>
                      </div>
                    </div>
                  </div>
                `).join('')}
              </div>
              ${cat.libraries.length ? '<div class="text-xs text-gray-400 mt-1">å¯æ‹–åŠ¨é¢˜åº“å¡ç‰‡è°ƒæ•´é¡ºåº</div>' : '<div class="text-gray-400 text-xs px-2 py-2">æš‚æ— é¢˜åº“</div>'}
            </div>
          </div>
        `;
      });

      // ç¡®ä¿DOMå®Œå…¨æ¸²æŸ“åå†ç»‘å®šäº‹ä»¶
      setTimeout(() => {
        bindEvents();
      }, 100);
    }

    // åˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½
    function initializeDragAndDrop() {
      // åˆ†ç±»æ‹–æ‹½
      document.querySelectorAll('.draggable-cat').forEach(catDiv => {
        catDiv.ondragstart = function(e) {
          e.dataTransfer.setData('cat-idx', catDiv.getAttribute('data-cidx'));
          catDiv.classList.add('opacity-50');
        };
        catDiv.ondragend = function() {
          catDiv.classList.remove('opacity-50');
        };
        catDiv.ondragover = function(e) {
          e.preventDefault();
          catDiv.classList.add('ring', 'ring-indigo-300');
        };
        catDiv.ondragleave = function() {
          catDiv.classList.remove('ring', 'ring-indigo-300');
        };
        catDiv.ondrop = function(e) {
          e.preventDefault();
          catDiv.classList.remove('ring', 'ring-indigo-300');
          const from = parseInt(e.dataTransfer.getData('cat-idx'));
          const to = parseInt(catDiv.getAttribute('data-cidx'));
          if (from !== to) {
            const moved = categories.splice(from, 1)[0];
            categories.splice(to, 0, moved);
            saveCategories();
            renderCategories();
          }
        };
      });

      // é¢˜åº“æ‹–æ‹½
      document.querySelectorAll('.draggable-lib').forEach(libDiv => {
        libDiv.ondragstart = function(e) {
          e.dataTransfer.setData('lib-lidx', libDiv.getAttribute('data-lidx'));
          e.dataTransfer.setData('lib-cidx', libDiv.parentElement.getAttribute('data-cidx'));
          libDiv.classList.add('opacity-50');
        };
        libDiv.ondragend = function() {
          libDiv.classList.remove('opacity-50');
        };
        libDiv.ondragover = function(e) {
          e.preventDefault();
          libDiv.classList.add('ring', 'ring-indigo-300');
        };
        libDiv.ondragleave = function() {
          libDiv.classList.remove('ring', 'ring-indigo-300');
        };
        libDiv.ondrop = function(e) {
          e.preventDefault();
          libDiv.classList.remove('ring', 'ring-indigo-300');
          const fromLidx = parseInt(e.dataTransfer.getData('lib-lidx'));
          const fromCidx = parseInt(e.dataTransfer.getData('lib-cidx'));
          const toLidx = parseInt(libDiv.getAttribute('data-lidx'));
          const cidx = parseInt(libDiv.parentElement.getAttribute('data-cidx'));
          if (fromCidx === cidx && fromLidx !== toLidx) {
            const moved = categories[cidx].libraries.splice(fromLidx, 1)[0];
            categories[cidx].libraries.splice(toLidx, 0, moved);
            saveCategories();
            renderCategories(cidx);
          }
        };
      });
    }

    // é”™é¢˜æœ¬æœ¬åœ°å­˜å‚¨
    function getWrongBook() {
      return JSON.parse(localStorage.getItem('tijing-wrongbook') || '[]');
    }
    function setWrongBook(arr) {
      localStorage.setItem('tijing-wrongbook', JSON.stringify(arr));
    }
    // ç»ƒä¹ åŒºç­”é”™é¢˜è‡ªåŠ¨å½’å…¥é”™é¢˜æœ¬
    function addToWrongBook(q) {
      const wrongBook = getWrongBook();
      if (!wrongBook.find(item => item.stem === q.stem && item.answer === q.answer)) {
        wrongBook.push(q);
        setWrongBook(wrongBook);
      }
    }
    // æ”¶è—å¤¹æœ¬åœ°å­˜å‚¨
    function getFavBook() {
      return JSON.parse(localStorage.getItem('tijing-favbook') || '[]');
    }
    function setFavBook(arr) {
      localStorage.setItem('tijing-favbook', JSON.stringify(arr));
    }
    function isFav(q) {
      return getFavBook().find(item => item.stem === q.stem && item.answer === q.answer);
    }
    function toggleFav(q) {
      let favBook = getFavBook();
      if (isFav(q)) {
        favBook = favBook.filter(item => !(item.stem === q.stem && item.answer === q.answer));
      } else {
        favBook.push({ ...q });
      }
      setFavBook(favBook);
    }
    // ä¸Šä¼ é¢˜åº“å¼¹çª—é€»è¾‘ï¼ˆé Electron ç¯å¢ƒä½¿ç”¨ï¼‰
    const fileInput = document.getElementById('file-upload');
    const categoryModal = document.getElementById('category-modal');
    const categorySelect = document.getElementById('category-select');
    const categoryInput = document.getElementById('category-input');
    const categoryCancel = document.getElementById('category-cancel');
    const categoryConfirm = document.getElementById('category-confirm');
    let pendingFile = null;

    // åªåœ¨é Electron ç¯å¢ƒä¸­è®¾ç½®åŸæœ‰çš„ä¸Šä¼ é€»è¾‘
    if (typeof window.electronAPI === 'undefined') {
      const uploadBtn = document.getElementById('upload-btn');
      uploadBtn.onclick = () => fileInput.click();
    }
    // åªåœ¨é Electron ç¯å¢ƒä¸­è®¾ç½®æ–‡ä»¶è¾“å…¥å¤„ç†
    if (typeof window.electronAPI === 'undefined') {
      fileInput.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const data = new Uint8Array(e.target.result);
            // ç¡®ä¿è°ƒç”¨å…¨å±€ä½œç”¨åŸŸä¸­çš„å‡½æ•°
            parseQuestionBankFromContent(data, file.name)
              .catch(err => {
                console.error('å¤„ç†æ–‡ä»¶å¤±è´¥:', err);
                alert('å¤„ç†æ–‡ä»¶å¤±è´¥: ' + (err.message || 'æœªçŸ¥é”™è¯¯'));
              });
          } catch (err) {
            console.error('å¤„ç†æ–‡ä»¶å¤±è´¥:', err);
            alert('å¤„ç†æ–‡ä»¶å¤±è´¥: ' + (err.message || 'æœªçŸ¥é”™è¯¯'));
          }
        };
        reader.readAsArrayBuffer(file);
      };
    }
    // å–æ¶ˆæŒ‰é’®å¤„ç†ï¼ˆé€‚ç”¨äºæ‰€æœ‰ç¯å¢ƒï¼‰
    categoryCancel.onclick = () => {
      categoryModal.classList.add('hidden');
      pendingFile = null;
      fileInput.value = '';
    };
    // åªåœ¨é Electron ç¯å¢ƒä¸­è®¾ç½®ç¡®è®¤æŒ‰é’®å¤„ç†
    if (typeof window.electronAPI === 'undefined') {
      categoryConfirm.onclick = async () => {
        let catName = categorySelect.value || categoryInput.value.trim();
        if (!catName) {
          alert('è¯·é€‰æ‹©æˆ–è¾“å…¥åˆ†ç±»åç§°');
          return;
        }
        // è§£ææ–‡ä»¶
        const data = await pendingFile.arrayBuffer();
        const workbook = XLSX.read(data, { 
          type: 'array', 
          raw: false, 
          cellText: true, 
          cellFormula: false,
          cellNF: false,  // ç¦ç”¨æ•°å­—æ ¼å¼åŒ–ï¼Œå¼ºåˆ¶æ–‡æœ¬ä¿ç•™
          dateNF: 'yyyy-mm-dd' // æ—¥æœŸæ ¼å¼ä¿æŒåŸå§‹æ–‡æœ¬
        });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet, { 
          header: 1, 
          blankrows: false, 
          defval: '',
          raw: false,  // ç¡®ä¿æ–‡æœ¬æ ¼å¼ä¿ç•™
          cellText: true  // å¼ºåˆ¶ä½¿ç”¨æ–‡æœ¬æ ¼å¼
        });
        // è°ƒè¯•ï¼šéªŒè¯æ ‡ç‚¹ç¬¦å·æ˜¯å¦è¢«æ­£ç¡®ä¿ç•™
        console.log('=== æ–‡ä»¶ä¸Šä¼ æ ‡ç‚¹ç¬¦å·è°ƒè¯•ä¿¡æ¯ ===');
        rows.slice(0, 3).forEach((row, idx) => {
          if (row && row.length > 0) {
            const firstCell = String(row[0] || '');
            console.log(`ç¬¬${idx+1}è¡Œç¬¬ä¸€åˆ—å†…å®¹: "${firstCell}"`);
            console.log(`åŒ…å«é€—å·: ${firstCell.includes(',')}`);
            console.log(`é€—å·ä½ç½®: ${[...firstCell].map((c, i) => c === ',' ? i : -1).filter(i => i !== -1)}`);
          }
        });
        console.log('=== è°ƒè¯•ä¿¡æ¯ç»“æŸ ===');
        
        const questions = rows.map((row, idx) => {
          // å¼ºåˆ¶è½¬æ¢ä¸ºå­—ç¬¦ä¸²å¹¶ä¿ç•™æ‰€æœ‰æ ‡ç‚¹ç¬¦å·
          const [stem, answer, optA, optB, optC, optD, optE, explanation] = row.map(cell => {
            if (cell == null) return '';
            const strValue = String(cell);
            // è°ƒè¯•ï¼šæ˜¾ç¤ºåŸå§‹å€¼å’Œè½¬æ¢åçš„å€¼
            if (idx < 3 && strValue.includes(',')) {
              console.log(`æ–‡ä»¶ä¸Šä¼  - ç¬¬${idx+1}è¡Œå•å…ƒæ ¼è°ƒè¯•: åŸå§‹å€¼="${cell}" -> å­—ç¬¦ä¸²="${strValue}"`);
            }
            return strValue;
          });
          const options = [optA, optB, optC, optD, optE].map((opt, i) => opt ? { label: String.fromCharCode(65 + i), text: opt } : null).filter(Boolean);
          const type = (typeof answer === 'string' && answer.length > 1) ? 'å¤šé€‰' : 'å•é€‰';
          return {
            id: idx + 1,
            stem: stem || '',
            answer: answer || '',
            options,
            explanation: explanation || '',
            type
          };
        }).filter(q => q.stem && q.answer && q.options.length > 0);
        if (!questions.length) {
          alert('é¢˜åº“æ–‡ä»¶è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ ¼å¼ï¼');
          return;
        }
        // é¢˜åº“åè‡ªåŠ¨ç”Ÿæˆ
        const name = pendingFile.name.replace(/\.[^.]+$/, '');
        // åˆ†ç±»å¤„ç†
        let catIdx = categories.findIndex(cat => cat.name === catName);
        if (catIdx === -1) {
          categories.unshift({ name: catName, libraries: [] });
          catIdx = 0;
        }
        // æ–°é¢˜åº“åŠ åˆ°åˆ†ç±»æœ€å
        categories[catIdx].libraries.push({
          id: Date.now(),
          name,
          questions,
          created: new Date().toISOString(),
          lastUsed: new Date().toISOString()
        });
        saveCategories();
        renderCategories(catIdx); // ä¿æŒå½“å‰åˆ†ç±»å±•å¼€
        categoryModal.classList.add('hidden');
        pendingFile = null;
        fileInput.value = '';
      };
    }

    // ç»ƒä¹ åŒºä¸»æµç¨‹
    let practiceState = null;
    const PRACTICE_MODES = [
      { key: 'practice', label: 'ç»ƒä¹ æ¨¡å¼' },
      { key: 'recite', label: 'èƒŒé¢˜æ¨¡å¼' }
    ];
    function startPractice(library, mode = 'practice') {
      // è‹¥æœç´¢ç»“æœé¡µæ˜¾ç¤ºï¼Œå…³é—­å®ƒ
      const resDiv=document.getElementById('search-result');
      if(resDiv) resDiv.classList.add('hidden');
      document.getElementById('main-section')?.classList.remove('hidden');
      // è‹¥ç»Ÿè®¡é¡µå¼€å¯ï¼Œåˆ™å…³é—­å®ƒ
      document.getElementById('stats-section')?.classList.add('hidden');
      let saved = loadPracticeProgress(library);
      if (saved && Array.isArray(saved.userAnswers) && Array.isArray(saved.submitted)) {
        practiceState = {
          library,
          questions: library.questions,
          current: typeof saved.currentIndex === 'number' ? saved.currentIndex : 0,
          userAnswers: JSON.parse(JSON.stringify(saved.userAnswers)),
          submitted: JSON.parse(JSON.stringify(saved.submitted)),
          mode,
          startTime: Date.now(),
          finished: !!saved.finished,
          score: 0,
          duration: 0,
          orderMode: 'ordered',
          originalQuestions: library.questions.slice()
        };
        if (saved.finished) {
          practiceState.finished = true;
          practiceState.current = practiceState.questions.length - 1;
        }
      } else {
        practiceState = {
          library,
          questions: library.questions,
          current: 0,
          userAnswers: Array(library.questions.length).fill(null),
          submitted: Array(library.questions.length).fill(false),
          mode,
          startTime: Date.now(),
          finished: false,
          score: 0,
          duration: 0,
          orderMode: 'ordered',
          originalQuestions: [] // å…ˆè®¾ç½®ä¸ºç©ºæ•°ç»„ï¼Œåé¢å†å¡«å……
        };
      }
      // å…ˆä¸ºæ‰€æœ‰é¢˜ç›®æ·»åŠ å…ƒæ•°æ®
      practiceState.questions.forEach(q => {
        if (!q._libraryName) q._libraryName = library.name;
        if (!q._categoryName) q._categoryName = library._categoryName || '';
      });
      // ä¿å­˜å¸¦æœ‰å…ƒæ•°æ®çš„é¢˜ç›®åˆ° originalQuestions
      practiceState.originalQuestions = practiceState.questions.slice();
      highlightActiveLibrary(library);
      renderPractice();
      renderAnswerSheet();
    }
    function renderPractice() {
      const main = document.getElementById('main-section');
      const { questions, current, userAnswers, submitted, mode, finished } = practiceState;
      const q = questions[current];
      const favActive = isFav(q);
      // æ¨¡å¼åˆ‡æ¢æŒ‰é’®
      const modeBtns = PRACTICE_MODES.map(m => `<button class="mode-btn px-2 py-1 rounded text-xs font-semibold border ${mode===m.key?'bg-indigo-500 text-white border-indigo-500':'bg-white dark:bg-gray-800 text-gray-500 dark:text-gray-300 border-gray-300 dark:border-gray-600'} mr-2" data-mode="${m.key}">${m.label}</button>`).join('');
      const orderBtn = `<button id=\"toggle-order-btn\" class=\"px-2 py-1 rounded text-xs font-semibold border ${practiceState.orderMode==='ordered'?'bg-purple-500 text-white border-purple-500':'bg-white dark:bg-gray-800 text-gray-500 dark:text-gray-300 border-gray-300 dark:border-gray-600'} hover:ring-2 hover:ring-purple-300 transition mr-2\">${practiceState.orderMode==='ordered'?'é¡ºåº':'ä¹±åº'}<i class=\"fas fa-exchange-alt ml-1 text-[10px]\"></i></button>`;
      // é¢˜ç›®åŒº
      const fixedStem = fixChinesePunctuationNoLineStart(q.stem);
      const stemHtml = convertImageLinks(fixedStem);
      main.innerHTML = `
        <div class="practice-card w-full h-full bg-white dark:bg-gray-900 rounded-2xl shadow-2xl border border-gray-100 dark:border-gray-700 p-6 sm:p-8 flex flex-col" style="min-height: 100%;">
          <div class="flex items-center justify-between mb-2 w-full">
            <div class="flex items-center gap-2 flex-wrap">
              <span class="px-2 py-0.5 text-xs rounded bg-indigo-500 text-white font-bold">${q.type}</span>
              <span class="text-gray-500 dark:text-gray-400 text-xs question-number">ç¬¬ ${current + 1} / ${questions.length} é¢˜</span>
              <span class="ml-4">${modeBtns}${orderBtn}</span>
            </div>
            <div class="flex items-center gap-3">
              <div class="w-32 h-2 bg-gray-200 dark:bg-gray-700 rounded relative flex items-center">
                <div class="h-2 bg-gradient-to-r from-indigo-500 to-purple-500 rounded" style="width:${((current+1)/questions.length)*100}%"></div>
          </div>
              <button id="fav-btn" class="p-0 m-0 bg-transparent border-none focus:outline-none transform hover:scale-110 transition-transform" title="æ”¶è—/å–æ¶ˆæ”¶è—" style="cursor:pointer;">
                ${favActive
                  ? '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="32" height="32" fill="#fbbf24" stroke="#f59e0b" stroke-width="1.2" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.2 21.02 12 17.77 5.8 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>'
                  : '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="32" height="32" fill="none" stroke="#94a3b8" stroke-width="1.8" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.2 21.02 12 17.77 5.8 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>'
                }
              </button>
              <button id="note-btn" class="p-0 m-0 bg-transparent border-none focus:outline-none transform hover:scale-110 transition-transform" title="é¢˜ç›®ç¬”è®°" style="cursor:pointer;">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="32" height="32" fill="#6366f1" class="dark:fill-current"><path d="M4 3h14a1 1 0 011 1v12l-4-4H5a1 1 0 01-1-1V4a1 1 0 011-1z"/><path d="M3 7v11a1 1 0 001 1h11" stroke="#6366f1" stroke-width="2" fill="none"/></svg>
              </button>
            </div>
          </div>
          <div class="font-semibold text-xl mb-4 w-full">${stemHtml}</div>
          ${mode==='recite' ? renderReciteMode(q) : ''}
          ${mode!=='recite' ? `<form id="answer-form" class="flex flex-col gap-0 mb-4 w-full">
            ${q.options.map(opt => {
              const isChecked = userAnswers[current] && (Array.isArray(userAnswers[current]) ? userAnswers[current].includes(opt.label) : userAnswers[current] === opt.label);
              const isLocked = submitted[current] && isChecked;
              return `
                <label class="custom-radio flex items-center gap-2 cursor-pointer rounded px-3 py-3 transition border-2 mb-2 ${isChecked ? (submitted[current] ? 'bg-gray-100 dark:bg-gray-800 border-gray-400 dark:border-gray-600 locked' : 'bg-indigo-50 dark:bg-indigo-800 border-indigo-600 dark:border-indigo-400 ring-2 ring-indigo-400') : 'bg-gray-50 dark:bg-gray-800 border-gray-200 dark:border-gray-700 hover:border-indigo-300 dark:hover:border-indigo-600'}">
                  <input type="${q.type==='å¤šé€‰'?'checkbox':'radio'}" name="option" value="${opt.label}" ${submitted[current] ? 'disabled' : ''} ${isChecked ? 'checked' : ''} />
                  <span class="radio-dot"></span>
                  <span class="w-7 h-7 flex items-center justify-center rounded bg-indigo-100 dark:bg-gray-700 text-indigo-600 dark:text-indigo-200 font-bold text-lg">${opt.label}</span>
                  <span class="text-base">${opt.text}</span>
                </label>
              `;
            }).join('')}
          </form>
          <div class="flex gap-4 mt-2 w-full">
            <button id="prev-question" class="px-5 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg font-semibold shadow transition" ${current === 0 ? 'disabled' : ''}>ä¸Šä¸€é¢˜</button>
            ${!submitted[current] && mode!=='recite' ? `<button id="submit-answer" class="px-7 py-2 bg-gradient-to-r from-indigo-500 to-purple-500 text-white font-semibold rounded-lg shadow hover:scale-105 transition-transform">æäº¤</button>` : ''}
            <button id="next-question" class="px-5 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-semibold shadow transition" ${current === questions.length-1 ? 'disabled' : ''}>ä¸‹ä¸€é¢˜</button>
          </div>
          ` : ''}
          <!-- ç§»é™¤é‡å¤çš„ç­”æ¡ˆæ³¨é‡Š -->
          <div class="w-full">
          ${submitted[current] ? renderPracticeResult(q, userAnswers[current]) : ''}
            </div>
          ${finished ? renderFinalScore() : ''}
        </div>
      `;
      // æ¨¡å¼åˆ‡æ¢äº¤äº’
      document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.onclick = () => {
          if(practiceState.mode!==btn.dataset.mode){
            practiceState.mode=btn.dataset.mode;
            renderPractice();
            renderAnswerSheet();
          }
        };
      });
      // é¡ºåº/ä¹±åºæŒ‰é’®
      const toggleBtn=document.getElementById('toggle-order-btn');
      if(toggleBtn){
        toggleBtn.onclick=()=>{
          practiceState.orderMode = practiceState.orderMode==='ordered'?'shuffle':'ordered';
          practiceState.questions = practiceState.orderMode==='shuffle' ? shuffleArray(practiceState.originalQuestions.slice()) : practiceState.originalQuestions.slice();
          practiceState.current=0;
          practiceState.userAnswers = Array(practiceState.questions.length).fill(null);
          practiceState.submitted = Array(practiceState.questions.length).fill(false);
          renderPractice();
          renderAnswerSheet();
        };
      }
      setTimeout(() => {
        const favBtn = document.getElementById('fav-btn');
        if(favBtn) favBtn.onclick = () => {
          toggleFav(q);
          renderPractice();
          renderAnswerSheet();
        };
        const noteBtn = document.getElementById('note-btn');
        if(noteBtn){
          // æ£€æŸ¥å½“å‰é¢˜ç›®æ˜¯å¦å·²æœ‰ç¬”è®°ï¼Œå¼‚æ­¥è·å–åé«˜äº®
          getNotes().then(ns=>{
            if(ns[getQuestionKey(q)]){
              noteBtn.querySelector('svg').style.fill='#fbbf24'; // æœ‰ç¬”è®°æ—¶é«˜äº®
            }
          });
          noteBtn.onclick=()=>{
            openNoteModal(q);
          };
        }
      }, 0);
      // é€‰é¡¹äº¤äº’
      if(mode!=='recite'){
      const form = document.getElementById('answer-form');
      if (form) {
        form.onchange = () => {
            let selected;
            const opts = form.elements['option'];
            if(q.type==='å¤šé€‰'){
              // å¤šé€‰é¢˜ï¼Œopts ä¸€å®šæ˜¯ NodeList
              selected = (Array.isArray(opts) || opts instanceof NodeList)
                ? Array.from(opts).filter(input => input.checked).map(input => input.value).sort()
                : (opts && opts.checked ? [opts.value] : []);
            }else{
              // å•é€‰é¢˜ï¼Œopts å¯èƒ½æ˜¯ NodeList æˆ–å•ä¸ªå…ƒç´ 
              if (Array.isArray(opts) || opts instanceof NodeList) {
                const checked = Array.from(opts).find(input => input.checked);
                selected = checked ? checked.value : null;
              } else {
                selected = opts && opts.checked ? opts.value : null;
              }
            }
            practiceState.userAnswers[current] = selected;
          renderPractice();
          renderAnswerSheet();
        };
        }
      }
      // æŒ‰é’®äº¤äº’
      document.getElementById('prev-question').onclick = (e) => {
        e.preventDefault();
        if (practiceState.current > 0) {
          practiceState.current--;
          savePracticeProgress(practiceState.library, practiceState.current, practiceState.userAnswers, practiceState.submitted, practiceState.finished);
          renderPractice();
          renderAnswerSheet();
        }
      };
      document.getElementById('next-question').onclick = (e) => {
        e.preventDefault();
        if (practiceState.current < practiceState.questions.length-1) {
          practiceState.current++;
          savePracticeProgress(practiceState.library, practiceState.current, practiceState.userAnswers, practiceState.submitted, practiceState.finished);
          renderPractice();
          renderAnswerSheet();
        }
      };
      const submitBtn = document.getElementById('submit-answer');
      if (submitBtn) {
        submitBtn.onclick = (e) => {
          e.preventDefault();
          let hasAnswer = false;
          const q = practiceState.questions[practiceState.current];
          if(q.type==='å¤šé€‰'){
            hasAnswer = Array.isArray(practiceState.userAnswers[practiceState.current]) && practiceState.userAnswers[practiceState.current].length>0;
          }else{
            hasAnswer = !!practiceState.userAnswers[practiceState.current];
          }
          if (!hasAnswer) {
            alert('è¯·é€‰æ‹©ç­”æ¡ˆ');
            return;
          }
          practiceState.submitted[practiceState.current] = true;
          if(practiceState.current===practiceState.questions.length-1){
            practiceState.finished=true;
            practiceState.duration = Math.floor((Date.now()-practiceState.startTime)/1000);
            practiceState.score = calcTotalScore(practiceState);
          }
          savePracticeProgress(practiceState.library, practiceState.current, practiceState.userAnswers, practiceState.submitted, practiceState.finished);
          renderPractice();
          renderAnswerSheet();
        };
      }
      // Markdownæ¸²æŸ“
      if (submitted[current]) {
        try {
          const mdDiv = document.getElementById('explanation-md');
          if (mdDiv) {
            mdDiv.innerHTML = q.explanation ? marked.parse(convertImageLinks(q.explanation)) : '<span class="text-gray-400">æ— è§£æå†…å®¹</span>';
          }
        } catch (e) {
          const mdDiv = document.getElementById('explanation-md');
          if (mdDiv) mdDiv.innerHTML = '<span class="text-red-400">è§£æå†…å®¹æ¸²æŸ“å‡ºé”™</span>';
        }
      }
    }
    function renderReciteMode(q){
      // èƒŒé¢˜æ¨¡å¼ï¼šåªæ˜¾ç¤ºé€‰é¡¹ã€ç­”æ¡ˆã€è§£æï¼ˆä¸é‡å¤é¢˜å¹²ï¼‰
      return `<div class="my-0 w-full">
        <ul class="mb-4">
          ${q.options.map(opt=>`<li class="flex items-center gap-2 mb-2"><span class="w-7 h-7 flex items-center justify-center rounded bg-indigo-100 dark:bg-gray-700 text-indigo-600 dark:text-indigo-200 font-bold text-lg">${opt.label}</span><span class="text-base">${opt.text}</span></li>`).join('')}
        </ul>
        <div class="mb-4 text-base text-green-600 dark:text-green-300 font-semibold">ç­”æ¡ˆï¼š${q.answer}</div>
        <div class="text-base text-gray-700 dark:text-gray-200 markdown-body">${q.explanation ? marked.parse(convertImageLinks(q.explanation)) : '<span class="text-gray-400">æ— è§£æå†…å®¹</span>'}</div>
        <div class="flex gap-4 mt-4 w-full">
          <button id="prev-question" class="px-5 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 rounded-lg font-semibold shadow transition" ${practiceState.current === 0 ? 'disabled' : ''}>ä¸Šä¸€é¢˜</button>
          <button id="next-question" class="px-5 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-semibold shadow transition" ${practiceState.current === practiceState.questions.length-1 ? 'disabled' : ''}>ä¸‹ä¸€é¢˜</button>
        </div>
      </div>`;
    }
    function renderFinalScore(){
      const {score, questions, duration, library} = practiceState;
      const min = Math.floor(duration/60), sec = duration%60;
      return `<div class="mt-8 p-6 rounded-2xl bg-gradient-to-r from-indigo-50 to-pink-50 dark:from-gray-800 dark:to-gray-700 border border-indigo-200 dark:border-pink-600 shadow flex flex-col gap-2 items-center">
        <div class="text-2xl font-bold text-indigo-600 dark:text-pink-300">æ€»æˆç»©ï¼š${score} åˆ† / ${questions.length+questions.filter(q=>q.type==='å¤šé€‰').length} åˆ†</div>
        <div class="text-lg text-gray-500 dark:text-gray-300">ç”¨æ—¶ï¼š${min}åˆ†${sec}ç§’</div>
        <div class="flex gap-4 mt-4">
          <button id="restart-practice" class="px-6 py-2 bg-indigo-500 hover:bg-indigo-600 text-white rounded-lg font-semibold shadow">é‡æ–°ç»ƒä¹ </button>
          <button id="end-practice" class="px-6 py-2 bg-gray-400 hover:bg-gray-500 text-white rounded-lg font-semibold shadow">ç»“æŸ</button>
        </div>
      </div>`;
    }
    function calcTotalScore(state){
      let total = 0;
      state.questions.forEach((q,idx)=>{
        const user = state.userAnswers[idx];
        const ansArr = typeof q.answer==='string' ? q.answer.split('').sort() : [];
        if(q.type==='å•é€‰'){
          if(user && user===ansArr[0]) total+=1;
        }else if(q.type==='å¤šé€‰'){
          if(Array.isArray(user)){
            const userSet = new Set(user);
            const ansSet = new Set(ansArr);
            const wrong = user.find(x=>!ansSet.has(x));
            if(wrong){
              // é”™é€‰ï¼Œä¸å¾—åˆ†
            }else if(user.length<ansArr.length){
              // å°‘é€‰ï¼Œ0.5åˆ†/é¡¹
              let rightCount = user.filter(x=>ansSet.has(x)).length;
              total += 0.5*rightCount;
            }else if(user.length===ansArr.length && user.every(x=>ansSet.has(x))){
              total += 2;
            }
          }
        }
      });
      return Math.round(total*100)/100;
    }
    // ç­”é¢˜å¡åŠŸèƒ½
    function renderAnswerSheet() {
      const aside = document.querySelector('aside.w-56');
      if (!practiceState) {
        aside.innerHTML = `<div class="text-lg font-bold text-gray-500 dark:text-gray-400"><i class="fas fa-list-ol mr-2"></i>ç­”é¢˜å¡</div><div class="text-gray-400 text-sm">ç»ƒä¹ æ—¶æ˜¾ç¤ºé¢˜å·è·³è½¬</div>`;
        return;
      }
      const { questions, current, userAnswers, submitted } = practiceState;
      const totalPages = Math.ceil(questions.length / ANSWER_SHEET_PAGE_SIZE);
      if (answerSheetPage >= totalPages) answerSheetPage = totalPages - 1;
      if (answerSheetPage < 0) answerSheetPage = 0;
      const startIdx = answerSheetPage * ANSWER_SHEET_PAGE_SIZE;
      const endIdx = Math.min(startIdx + ANSWER_SHEET_PAGE_SIZE, questions.length);
      aside.innerHTML = `
        <div class="flex justify-between items-center mb-2">
          <div class="text-lg font-bold text-gray-500 dark:text-gray-400"><i class="fas fa-list-ol mr-2"></i>ç­”é¢˜å¡</div>
          <div class="flex items-center gap-1">
            <button id="prev-answer-page" class="px-1 py-0.5 text-xs rounded bg-gray-200 hover:bg-gray-300" ${answerSheetPage === 0 ? 'disabled' : ''}>â†</button>
            <span class="text-xs">${answerSheetPage+1}/${totalPages}</span>
            <button id="next-answer-page" class="px-1 py-0.5 text-xs rounded bg-gray-200 hover:bg-gray-300" ${answerSheetPage === totalPages-1 ? 'disabled' : ''}>â†’</button>
          </div>
        </div>
        <div class="grid grid-cols-5 gap-2 mb-4">
          ${questions.slice(startIdx, endIdx).map((q, idx) => {
            let btnClass = '';
            let colorStyle = '';
            let bgStyle = '';
            let user = Array.isArray(userAnswers[startIdx+idx]) ? userAnswers[startIdx+idx].sort().join('') : (userAnswers[startIdx+idx] || '');
            let correct = q.answer.split('').sort().join('');
            if (submitted[startIdx+idx]) {
              if (user === correct) {
                btnClass = 'bg-green-500 border-green-500';
                colorStyle = 'color:#fff;';
                bgStyle = 'background:#10B981;';
              } else {
                btnClass = 'bg-red-500 border-red-500';
                colorStyle = 'color:#fff;';
                bgStyle = 'background:#EF4444;';
              }
            } else if (userAnswers[startIdx+idx]) {
              btnClass = 'bg-indigo-100 border-indigo-200';
              colorStyle = 'color:#3730a3;';
              bgStyle = 'background:#E0E7FF;';
            } else {
              btnClass = 'bg-gray-200 border-gray-200';
              colorStyle = 'color:#334155;';
              bgStyle = 'background:#E5E7EB;';
            }
            // æ•°å­—é•¿åº¦åˆ¤æ–­
            const numStr = (startIdx+idx+1).toString();
            let extraClass = '';
            if (numStr.length === 3) extraClass = 'long';
            if (numStr.length >= 4) extraClass = 'xlong';
            // é«˜äº®å¤–åœˆç”¨box-shadowå®ç°
            if (current === startIdx+idx) btnClass += ' ring-indigo-500 scale-110';
            return `<button class="answer-sheet-btn font-bold flex items-center justify-center border transition ${btnClass} ${extraClass}" data-idx="${startIdx+idx}" title="ç¬¬${startIdx+idx+1}é¢˜" style="line-height:1;${colorStyle}${bgStyle}">${numStr}</button>`;
          }).join('')}
        </div>
      `;
      aside.querySelectorAll('button[data-idx]').forEach(btn => {
        btn.onclick = () => {
          practiceState.current = parseInt(btn.getAttribute('data-idx'));
          savePracticeProgress(practiceState.library, practiceState.current, practiceState.userAnswers, practiceState.submitted, practiceState.finished);
          renderPractice();
          renderAnswerSheet();
        };
      });
      // åˆ†é¡µæŒ‰é’®äº‹ä»¶
      const prevBtn = document.getElementById('prev-answer-page');
      const nextBtn = document.getElementById('next-answer-page');
      if (prevBtn) prevBtn.onclick = () => { answerSheetPage--; renderAnswerSheet(); };
      if (nextBtn) nextBtn.onclick = () => { answerSheetPage++; renderAnswerSheet(); };
      
      // æ›´æ–°æŒ‰é’®æ ·å¼
      updateAnswerCardButtonStyles();
    }
    function renderPracticeResult(q, selected) {
      const correct = q.answer.split('').sort().join('');
      const user = Array.isArray(selected) ? selected.sort().join('') : (selected || '');
      const isCorrect = user === correct;
      if (!isCorrect) addToWrongBook(q);
      let explanationHtml = '';
      try {
        // æ—¥å¿—ä¸å¥å£®æ€§å¤„ç†
        const explanationStr = typeof q.explanation === 'string' ? q.explanation : (q.explanation ? JSON.stringify(q.explanation) : '');
        const converted = typeof convertImageLinks === 'function' ? convertImageLinks(explanationStr) : explanationStr;
        console.log('explanationåŸå§‹ï¼š', q.explanation);
        console.log('explanationå­—ç¬¦ä¸²ï¼š', explanationStr);
        console.log('convertImageLinksç»“æœï¼š', converted);
        if (typeof marked !== 'undefined' && typeof marked.parse === 'function') {
          explanationHtml = explanationStr ? marked.parse(converted) : '<span class="text-gray-400">æ— è§£æå†…å®¹</span>';
        } else {
          console.error('marked.js æœªæ­£ç¡®åŠ è½½');
          explanationHtml = '<span class="text-red-400">è§£æå†…å®¹æ¸²æŸ“å‡ºé”™(markedæœªåŠ è½½)</span>';
        }
      } catch (e) {
        console.error('è§£æå†…å®¹æ¸²æŸ“å‡ºé”™', e, q.explanation);
        explanationHtml = '<span class="text-red-400">è§£æå†…å®¹æ¸²æŸ“å‡ºé”™</span>';
      }
      return `
        <div class="explain-card mt-6 p-5 rounded-2xl bg-gradient-to-r from-pink-50 to-indigo-50 dark:from-gray-800 dark:to-gray-700 border border-pink-200 dark:border-pink-600 shadow flex flex-col gap-2">
          <div class="flex items-center gap-2 mb-1">
            <i class="fas ${isCorrect ? 'fa-check-circle text-green-500' : 'fa-times-circle text-red-500'} text-xl"></i>
            <span class="font-bold text-lg">${isCorrect ? 'å›ç­”æ­£ç¡®ï¼' : 'å›ç­”é”™è¯¯'}</span>
            <span class="ml-2 text-base text-gray-500">æ­£ç¡®ç­”æ¡ˆï¼š<span class="font-bold text-green-600 dark:text-green-400">${q.answer}</span></span>
          </div>
          <div class="flex items-center gap-2 mt-2 mb-1">
            <i class="fas fa-book-open text-pink-400"></i>
            <span class="font-bold text-pink-600 dark:text-pink-300 text-base">è§£æ</span>
            <div class="flex-1 border-t border-dashed border-pink-200 dark:border-pink-500 ml-2"></div>
          </div>
          <div class="text-base text-gray-700 dark:text-gray-200 markdown-body" id="explanation-md">${explanationHtml}</div>
        </div>
      `;
    }

    // Tabåˆ‡æ¢äº‹ä»¶
    function setupTabSwitch() {
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.onclick = () => {
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('ring-2', 'ring-indigo-400', 'bg-white', 'dark:bg-gray-800'));
          btn.classList.add('ring-2', 'ring-indigo-400', 'bg-white', 'dark:bg-gray-800');
          const tab = btn.getAttribute('data-tab');
          document.getElementById('tab-library').classList.toggle('hidden', tab !== 'library');
          document.getElementById('tab-wrong').classList.toggle('hidden', tab !== 'wrong');
          document.getElementById('tab-fav').classList.toggle('hidden', tab !== 'fav');
          if (tab === 'wrong') renderWrongBookList();
          if (tab === 'fav') renderFavBookList();
        };
      });
    }
    // é”™é¢˜æœ¬/æ”¶è—å¤¹åˆ—è¡¨æ¸²æŸ“
    function renderWrongBookList() {
      const container = document.getElementById('wrongbook-list');
      const wrongBook = getWrongBook();
      const practiceBtn = document.getElementById('wrongbook-practice');

      if (!wrongBook.length) {
        container.innerHTML = '<div class="text-red-400 text-sm">æš‚æ— é”™é¢˜</div>';
        practiceBtn.classList.add('hidden');
        return;
      }

      const grouped = groupByCatLib(wrongBook);
      let html = '';
      Object.keys(grouped).forEach(cat => {
        const libMap = grouped[cat];
        const total = Object.values(libMap).reduce((sum, l) => sum + l.length, 0);
        html += `<div class='wrong-cat border border-red-600 rounded-xl mb-2 bg-gray-50 dark:bg-gray-800'>
          <div class='flex items-center px-3 py-2 cursor-pointer cat-header'>
            <div class='flex items-center gap-2 flex-1'>
              <i class='fas fa-folder text-red-400'></i>
              <span class='font-bold'>${cat}</span>
              <span class='text-xs ml-1 text-red-400'>(${total})</span>
            </div>
            <button class='remove-cat-btn w-7 h-7 flex items-center justify-center rounded hover:bg-red-100 text-red-600 mr-2' data-cat='${cat}' title='åˆ é™¤æœ¬åˆ†ç±»å…¨éƒ¨é”™é¢˜'>
              <i class='fas fa-trash'></i>
            </button>
          </div>
          <div class='cat-body px-2 pb-2 hidden'>
            ${Object.keys(libMap).map(lib => {
              const list = libMap[lib];
              return `
              <div class='wrong-lib bg-white dark:bg-gray-900 rounded-lg ml-2 mb-3 overflow-hidden'>
                <div class='pl-2 pr-1 py-1 cursor-pointer lib-header flex items-center gap-2'>
                  <i class='fas fa-book text-red-300'></i>
                  <span class='font-medium'>${lib}</span>
                </div>
                <div class='flex items-center justify-between pl-4 pr-2 py-1 lib-controls'>
                  <span class='text-xs bg-red-100 dark:bg-red-700 text-red-600 dark:text-red-200 px-2 py-0.5 rounded'>${list.length}é¢˜</span>
                  <div class='flex items-center gap-2'>
                    <button class='practice-lib-btn w-7 h-7 flex items-center justify-center rounded hover:bg-red-100 dark:hover:bg-red-700 text-red-600 dark:text-red-200 mr-1' data-cat='${cat}' data-lib='${lib}' title='åˆ·æœ¬åº“'>
                      <i class='fas fa-play'></i>
                    </button>
                    <button class='remove-lib-btn w-7 h-7 flex items-center justify-center rounded hover:bg-red-100 dark:hover:bg-red-700 text-red-600 dark:text-red-200' data-cat='${cat}' data-lib='${lib}' title='åˆ é™¤æœ¬åº“é”™é¢˜'>
                      <i class='fas fa-trash'></i>
                    </button>
                  </div>
                </div>
                <div class='lib-body pl-4 hidden'>
                  ${list.map(({ q, idx }) => `
                    <div class='flex items-center gap-2 p-1 rounded wrong-item' data-idx='${idx}'>
                      <span class='flex-1 truncate text-sm'>${q.stem}</span>
                      <button class='px-2 py-0.5 text-xs rounded bg-red-100 hover:bg-red-200 text-red-600 remove-wrong-btn' data-idx='${idx}'>ç§»é™¤</button>
                    </div>
                  `).join('')}
                </div>
              </div>`;
            }).join('')}
          </div>
        </div>`;
      });
      container.innerHTML = html;

      // æŠ˜å äº¤äº’ï¼šåˆ†ç±»
      container.querySelectorAll('.cat-header').forEach(h => {
        h.onclick = e => {
          // å¦‚æœç‚¹å‡»çš„æ˜¯æŒ‰é’®åˆ™äº¤ç”±æŒ‰é’®å¤„ç†
          if (e.target.closest('button')) return;
          const body = h.nextElementSibling;
          body.classList.toggle('hidden');
          // å·²ç§»é™¤ç®­å¤´å›¾æ ‡ï¼Œæ— éœ€åˆ‡æ¢ç±»
        };
      });

      // æŠ˜å äº¤äº’ï¼šé¢˜åº“
      container.querySelectorAll('.lib-header').forEach(lh => {
        lh.onclick = e => {
          if (e.target.closest('button')) return;
          const body = lh.nextElementSibling;
          body.classList.toggle('hidden');
          // å·²ç§»é™¤ç®­å¤´å›¾æ ‡ï¼Œæ— éœ€åˆ‡æ¢ç±»
        };
      });

      // åˆ†ç±»åˆ é™¤æŒ‰é’®
      container.querySelectorAll('.remove-cat-btn').forEach(btn => {
        btn.onclick = () => {
          const cat = btn.getAttribute('data-cat');
          if(!confirm(`ç¡®è®¤åˆ é™¤åˆ†ç±» "${cat}" çš„æ‰€æœ‰é”™é¢˜ï¼Ÿ`)) return;
          const wb = getWrongBook().filter(q => (q._categoryName || 'æœªåˆ†ç±»') !== cat);
          setWrongBook(wb);
          renderWrongBookList();
        };
      });

      container.querySelectorAll('.practice-lib-btn').forEach(btn => {
        btn.onclick = () => {
          const cat = btn.getAttribute('data-cat');
          const lib = btn.getAttribute('data-lib');
          const subset = wrongBook.filter(q => (q._categoryName || 'æœªåˆ†ç±»') === cat && (q._libraryName || 'æœªçŸ¥é¢˜åº“') === lib);
          if (subset.length) startPractice({ name: `${cat}/${lib} - é”™é¢˜æœ¬`, questions: subset });
        };
      });

      // é¢˜åº“åˆ é™¤æŒ‰é’®
      container.querySelectorAll('.remove-lib-btn').forEach(btn => {
        btn.onclick = () => {
          const cat = btn.getAttribute('data-cat');
          const lib = btn.getAttribute('data-lib');
          if(!confirm(`ç¡®è®¤åˆ é™¤ ${cat}/${lib} çš„é”™é¢˜ï¼Ÿ`)) return;
          const wb = getWrongBook().filter(q => !((q._categoryName || 'æœªåˆ†ç±»')===cat && (q._libraryName || 'æœªçŸ¥é¢˜åº“')===lib));
          setWrongBook(wb);
          renderWrongBookList();
        };
      });

      practiceBtn.classList.remove('hidden');
      practiceBtn.onclick = () => { if (wrongBook.length) startPractice({ name: 'é”™é¢˜æœ¬', questions: wrongBook }); };
      document.getElementById('clear-wrongbook').onclick = () => { if (confirm('ç¡®å®šè¦æ¸…ç©ºé”™é¢˜æœ¬å—ï¼Ÿ')) { setWrongBook([]); renderWrongBookList(); } };
    }
    function renderFavBookList() {
      const container = document.getElementById('favbook-list');
      const favBook = getFavBook();
      const practiceBtn = document.getElementById('favbook-practice');

      if (!favBook.length) {
        container.innerHTML = '<div class="text-yellow-400 text-sm">æš‚æ— æ”¶è—</div>';
        practiceBtn.classList.add('hidden');
        return;
      }

      const grouped = groupByCatLib(favBook);
      let html = '';
      Object.keys(grouped).forEach(cat => {
        const libMap = grouped[cat];
        const total = Object.values(libMap).reduce((sum, l) => sum + l.length, 0);
        html += `<div class='fav-cat border border-amber-600 rounded-xl mb-2 bg-gray-50 dark:bg-gray-800'>
          <div class='flex items-center px-3 py-2 cursor-pointer cat-header'>
            <div class='flex items-center gap-2 flex-1'>
              <i class='fas fa-folder text-yellow-500'></i>
              <span class='font-bold'>${cat}</span>
              <span class='text-xs ml-1 text-yellow-500'>(${total})</span>
            </div>
            <button class='remove-fav-cat-btn w-7 h-7 flex items-center justify-center rounded hover:bg-yellow-100 text-yellow-600 mr-2' data-cat='${cat}' title='åˆ é™¤æœ¬åˆ†ç±»'>
              <i class='fas fa-trash'></i>
            </button>
          </div>
          <div class='cat-body px-2 pb-2 hidden'>
            ${Object.keys(libMap).map(lib => {
              const list = libMap[lib];
              return `
              <div class='fav-lib bg-white dark:bg-gray-900 rounded-lg ml-2 mb-3 overflow-hidden'>
                <div class='pl-2 pr-1 py-1 cursor-pointer lib-header flex items-center gap-2'>
                  <i class='fas fa-book text-yellow-400'></i>
                  <span class='font-medium'>${lib}</span>
                </div>
                <div class='flex items-center justify-between pl-4 pr-2 py-1 lib-controls'>
                  <span class='text-xs bg-yellow-100 dark:bg-yellow-700 text-yellow-600 dark:text-yellow-200 px-2 py-0.5 rounded'>${list.length}é¢˜</span>
                  <div class='flex items-center gap-2'>
                    <button class='practice-fav-lib-btn w-7 h-7 flex items-center justify-center rounded hover:bg-yellow-100 dark:hover:bg-yellow-700 text-yellow-600 dark:text-yellow-200 mr-1' data-cat='${cat}' data-lib='${lib}' title='ç»ƒä¹ '>
                      <i class='fas fa-play'></i>
                    </button>
                    <button class='remove-fav-lib-btn w-7 h-7 flex items-center justify-center rounded hover:bg-yellow-100 dark:hover:bg-yellow-700 text-yellow-600 dark:text-yellow-200' data-cat='${cat}' data-lib='${lib}' title='åˆ é™¤'>
                      <i class='fas fa-trash'></i>
                    </button>
                  </div>
                </div>
              </div>`;
            }).join('')}
          </div>
        </div>`;
      });
      container.innerHTML = html;

      container.querySelectorAll('.cat-header').forEach(h => {
        h.onclick = e => {
          if (e.target.closest('button')) return;
          const body = h.nextElementSibling;
          body.classList.toggle('hidden');
          // å·²ç§»é™¤ç®­å¤´å›¾æ ‡ï¼Œæ— éœ€åˆ‡æ¢ç±»
        };
      });

      container.querySelectorAll('.lib-header').forEach(lh => {
        lh.onclick = e => {
          const body = lh.nextElementSibling;
          body.classList.toggle('hidden');
          // å·²ç§»é™¤ç®­å¤´å›¾æ ‡ï¼Œæ— éœ€åˆ‡æ¢ç±»
        };
      });

      // åˆ†ç±»åˆ é™¤
      container.querySelectorAll('.remove-fav-cat-btn').forEach(btn=>{
        btn.onclick=()=>{
          const cat=btn.getAttribute('data-cat');
          if(!confirm(`ç¡®è®¤åˆ é™¤æ”¶è—åˆ†ç±» ${cat} ?`))return;
          const fb=getFavBook().filter(q=>(q._categoryName||'æœªåˆ†ç±»')!==cat);
          setFavBook(fb);renderFavBookList();
        }
      });

      // é¢˜åº“ç»ƒä¹ 
      container.querySelectorAll('.practice-fav-lib-btn').forEach(btn=>{
        btn.onclick=()=>{
          const cat=btn.getAttribute('data-cat');
          const lib=btn.getAttribute('data-lib');
          const subset=getFavBook().filter(q=> (q._categoryName||'æœªåˆ†ç±»')===cat && (q._libraryName||'æœªçŸ¥é¢˜åº“')===lib);
          if(subset.length) startPractice({name:`${cat}/${lib} - æ”¶è—`,questions:subset});
        }
      });

      // é¢˜åº“åˆ é™¤
      container.querySelectorAll('.remove-fav-lib-btn').forEach(btn=>{
        btn.onclick=()=>{
          const cat=btn.getAttribute('data-cat');
          const lib=btn.getAttribute('data-lib');
          if(!confirm(`ç¡®è®¤åˆ é™¤ ${cat}/${lib} æ”¶è—?`))return;
          const fb=getFavBook().filter(q=> !((q._categoryName||'æœªåˆ†ç±»')===cat && (q._libraryName||'æœªçŸ¥é¢˜åº“')===lib));
          setFavBook(fb);renderFavBookList();
        }
      });

      practiceBtn.classList.remove('hidden');
      practiceBtn.onclick = () => { if (favBook.length) startPractice({ name: 'æ”¶è—å¤¹', questions: favBook }); };
      document.getElementById('clear-favbook').onclick = () => { if (confirm('ç¡®å®šè¦æ¸…ç©ºæ”¶è—å¤¹å—ï¼Ÿ')) { setFavBook([]); renderFavBookList(); } };
    }
    // é¡µé¢åˆæ¬¡åŠ è½½æ—¶åªæ¿€æ´»ä¸€æ¬¡"é¢˜åº“"Tab
    setTimeout(() => {
      setupTabSwitch();
      document.querySelector('.tab-btn[data-tab="library"]').click();
    }, 0);

    // å¼€å‘ä¸“ç”¨ï¼šä¸€é”®å¤‡ä»½æŒ‰é’®é€»è¾‘ï¼Œå‘å¸ƒæ—¶å¯åˆ é™¤
    document.getElementById('backup-btn').onclick = function() {
      const text = '<!DOCTYPE html>\n' + document.documentElement.outerHTML;
      const blob = new Blob([text], {type: 'text/html'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      const ts = new Date().toISOString().replace(/[-:T.]/g, '').slice(0, 14);
      a.download = `index_backup_${ts}.html`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    };

    // é¢˜å¹²æ ‡ç‚¹æ¢è¡Œç¾åŒ–ï¼Œé˜²æ­¢æ‹¬å·ç­‰æ ‡ç‚¹å•ç‹¬å‡ºç°åœ¨æ¯è¡Œå¼€å¤´ï¼ˆé™¤é¦–è¡Œå¤–ï¼‰
    function fixChinesePunctuationNoLineStart(text) {
      // åœ¨æ ‡ç‚¹å‰æ’å…¥ word joiner (\u2060)ï¼Œé˜²æ­¢æ¢è¡Œåˆ°è¡Œé¦–
      // å¸¸è§ä¸­æ–‡æ ‡ç‚¹ï¼šï¼Œã€‚ã€ï¼ï¼Ÿï¼›ï¼šï¼‰ã€‘ã€ã€ã€‹ï¼‰
      return text.replace(/([\u4e00-\u9fa5A-Za-z0-9])([ï¼Œã€‚ã€ï¼ï¼Ÿï¼›ï¼šï¼‰\]\}ã€‘ã€ã€ã€‹ã€‰])/g, '$1\u2060$2');
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      initCategoryFoldState();
    });

    // ä¸‹è½½æ¨¡æ¿æŒ‰é’®äº‹ä»¶
    document.getElementById('download-template-btn').onclick = function() {
      // æ£€æŸ¥æ˜¯å¦åœ¨Electronç¯å¢ƒä¸­
      if (window.electronAPI) {
        // ä½¿ç”¨Electron APIä¸‹è½½æ¨¡æ¿
        window.electronAPI.downloadTemplate().then(result => {
          if (result && result.success) {
            console.log('æ¨¡æ¿ä¸‹è½½æˆåŠŸ:', result.path);
          } else if (result && result.message === 'ç”¨æˆ·å–æ¶ˆä¸‹è½½') {
            console.log('ç”¨æˆ·å–æ¶ˆä¸‹è½½æ¨¡æ¿');
            // ä¸æç¤ºé”™è¯¯ï¼Œé™é»˜è¿”å›
          } else {
            console.error('æ¨¡æ¿ä¸‹è½½å¤±è´¥:', result ? result.message : 'æœªçŸ¥é”™è¯¯');
            alert('æ¨¡æ¿ä¸‹è½½å¤±è´¥ï¼Œè¯·é‡è¯•');
          }
        }).catch(err => {
          console.error('æ¨¡æ¿ä¸‹è½½å‡ºé”™:', err);
          alert('ä¸‹è½½å‡ºé”™ï¼Œè¯·é‡è¯•');
        });
      } else {
        // æ™®é€šç½‘é¡µç¯å¢ƒï¼Œç›´æ¥ä»templatesæ–‡ä»¶å¤¹ä¸‹è½½
        try {
          const a = document.createElement('a');
          a.href = '../templates/é¢˜å¢ƒ-é¢˜åº“æ¨¡æ¿.xlsx';  // æŒ‡å‘templatesæ–‡ä»¶å¤¹
          a.download = 'é¢˜å¢ƒ-é¢˜åº“æ¨¡æ¿.xlsx';
          a.target = '_blank';  // åœ¨æ–°çª—å£ä¸­æ‰“å¼€ï¼Œé¿å…å½“å‰é¡µé¢è¢«æ›¿æ¢
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          
          console.log('æ¨¡æ¿ä¸‹è½½æˆåŠŸ');
        } catch (error) {
          console.error('ä¸‹è½½æ¨¡æ¿å‡ºé”™:', error);
          alert('ä¸‹è½½å‡ºé”™ï¼Œè¯·é‡è¯•');
        }
      }
    };

    // æ·»åŠ æš—é»‘æ¨¡å¼åˆ‡æ¢å¤„ç†
    function updateDarkModeStyles() {
      const isDarkMode = document.body.classList.contains('dark-mode');
      const wrongTab = document.getElementById('tab-wrong');
      const favTab = document.getElementById('tab-fav');
      
      if (isDarkMode) {
        wrongTab.style.backgroundColor = 'rgba(71, 27, 27, 0.3)';
        favTab.style.backgroundColor = 'rgba(82, 72, 21, 0.3)';
        
        // è®¾ç½®åˆ—è¡¨é¡¹æ ·å¼
        document.querySelectorAll('.question-item').forEach(item => {
          item.style.backgroundColor = 'rgba(30, 41, 59, 0.4)';
          item.style.borderColor = 'rgba(255, 255, 255, 0.1)';
          item.style.color = '#94a3b8';
        });
        
        // è®¾ç½®æŒ‰é’®æ ·å¼
        document.querySelectorAll('.clear-btn, .remove-btn').forEach(btn => {
          btn.style.backgroundColor = 'rgba(30, 41, 59, 0.4)';
          btn.style.borderColor = 'rgba(255, 255, 255, 0.1)';
          btn.style.color = '#94a3b8';
        });
      } else {
        wrongTab.style.backgroundColor = '#fff1f0';
        favTab.style.backgroundColor = '#fffbe6';
        
        // é‡ç½®åˆ—è¡¨é¡¹æ ·å¼
        document.querySelectorAll('.question-item').forEach(item => {
          item.style.backgroundColor = 'rgba(255, 255, 255, 0.8)';
          item.style.borderColor = 'rgba(0, 0, 0, 0.1)';
          item.style.color = '';
        });
        
        // é‡ç½®æŒ‰é’®æ ·å¼
        document.querySelectorAll('.clear-btn, .remove-btn').forEach(btn => {
          btn.style.backgroundColor = 'rgba(255, 255, 255, 0.8)';
          btn.style.borderColor = 'rgba(0, 0, 0, 0.1)';
          btn.style.color = '#666';
        });
      }
    }

    // ç›‘å¬æš—é»‘æ¨¡å¼å˜åŒ–
    const darkModeObserver = new MutationObserver(mutations => {
      mutations.forEach(mutation => {
        if (mutation.attributeName === 'class') {
          updateDarkModeStyles();
        }
      });
    });

    // é¡µé¢åŠ è½½ååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      updateDarkModeStyles();
      darkModeObserver.observe(document.body, { attributes: true });
    });

    // åœ¨æ–‡æ¡£åŠ è½½å®Œæˆåæ‰§è¡Œ
    document.addEventListener('DOMContentLoaded', function() {
      // è·å–ä¸»é¢˜æ¨¡å¼
      const isDarkMode = document.body.classList.contains('dark-mode');
      
      // è·å–é”™é¢˜æœ¬å’Œæ”¶è—å¤¹å…ƒç´ 
      const wrongTab = document.getElementById('tab-wrong');
      const favTab = document.getElementById('tab-fav');
      
      // è®¾ç½®åˆå§‹æ ·å¼
      updateThemeStyles(isDarkMode);
      
      // ç›‘å¬ä¸»é¢˜åˆ‡æ¢
      const themeToggle = document.querySelector('.theme-toggle'); // å‡è®¾æœ‰è¿™æ ·ä¸€ä¸ªåˆ‡æ¢æŒ‰é’®
      if (themeToggle) {
        themeToggle.addEventListener('click', function() {
          const newDarkMode = document.body.classList.toggle('dark-mode');
          updateThemeStyles(newDarkMode);
        });
      }
      
      // æ›´æ–°ä¸»é¢˜æ ·å¼
      function updateThemeStyles(isDark) {
        if (isDark) {
          // å¤œæ™šæ¨¡å¼
          wrongTab.style.background = 'rgba(71, 27, 27, 0.3)';
          favTab.style.background = 'rgba(82, 72, 21, 0.3)';
          
          // ä¸ºåˆ—è¡¨é¡¹æ·»åŠ æ·±è‰²æ ·å¼
          document.querySelectorAll('.question-item').forEach(item => {
            item.style.background = 'rgba(30, 41, 59, 0.4)';
            item.style.border = '1px solid rgba(255, 255, 255, 0.1)';
            item.style.color = '#94a3b8';
          });
          
          // ä¸ºæŒ‰é’®æ·»åŠ æ·±è‰²æ ·å¼
          document.querySelectorAll('.clear-btn, .remove-btn').forEach(btn => {
            btn.style.background = 'rgba(30, 41, 59, 0.4)';
            btn.style.color = '#94a3b8';
            btn.style.border = '1px solid rgba(255, 255, 255, 0.1)';
          });
        } else {
          // ç™½å¤©æ¨¡å¼
          wrongTab.style.background = '#fff1f0';
          favTab.style.background = '#fffbe6';
          
          // æ¢å¤åˆ—è¡¨é¡¹é»˜è®¤æ ·å¼
          document.querySelectorAll('.question-item').forEach(item => {
            item.style.background = 'rgba(255, 255, 255, 0.8)';
            item.style.border = '1px solid rgba(0, 0, 0, 0.1)';
            item.style.color = '';
          });
          
          // æ¢å¤æŒ‰é’®é»˜è®¤æ ·å¼
          document.querySelectorAll('.clear-btn, .remove-btn').forEach(btn => {
            btn.style.background = 'rgba(255, 255, 255, 0.8)';
            btn.style.color = '#666';
            btn.style.border = '1px solid rgba(0, 0, 0, 0.1)';
          });
        }
      }
      
      // åˆ›å»ºåˆ—è¡¨é¡¹æ—¶åº”ç”¨æ ·å¼
      function createQuestionItem(question, type) {
        const item = document.createElement('div');
        item.className = 'question-item';
        
        // æ ¹æ®å½“å‰ä¸»é¢˜è®¾ç½®æ ·å¼
        if (document.body.classList.contains('dark-mode')) {
          item.style.background = 'rgba(30, 41, 59, 0.4)';
          item.style.border = '1px solid rgba(255, 255, 255, 0.1)';
          item.style.color = '#94a3b8';
        } else {
          item.style.background = 'rgba(255, 255, 255, 0.8)';
          item.style.border = '1px solid rgba(0, 0, 0, 0.1)';
        }
        
        // å…¶ä»–è®¾ç½®...
        return item;
      }
    });

    // åˆå§‹åŒ–é¢˜åº“ç•Œé¢
    if (window.electronAPI) {
      // Electronç¯å¢ƒ
      document.addEventListener('DOMContentLoaded', () => {
        // è®¾ç½®ä¸Šä¼ æŒ‰é’®äº‹ä»¶
        const uploadBtn = document.getElementById('upload-btn');
        uploadBtn.onclick = enhancedImportQuestionBank;
        
        // ç›‘å¬æ¥è‡ªä¸»è¿›ç¨‹çš„å¯¼å…¥è¯·æ±‚
        window.electronAPI.onImportQuestion = () => {
          enhancedImportQuestionBank();
        };
      });
    } else {
      // éElectronç¯å¢ƒ
      // ä¸Šä¼ é¢˜åº“å¼¹çª—é€»è¾‘ï¼ˆé Electron ç¯å¢ƒä½¿ç”¨ï¼‰
      const fileInput = document.getElementById('file-upload');
      fileInput.onchange = function(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            try {
            const data = new Uint8Array(e.target.result);
              // ç°åœ¨è¿™ä¸ªå‡½æ•°åº”è¯¥èƒ½æ‰¾åˆ°äº†ï¼Œå› ä¸ºæˆ‘ä»¬æŠŠå®ƒå®šä¹‰åœ¨äº†å…¨å±€ä½œç”¨åŸŸ
            parseQuestionBankFromContent(data, file.name);
            } catch (err) {
              console.error('å¤„ç†æ–‡ä»¶å¤±è´¥:', err);
              alert('å¤„ç†æ–‡ä»¶å¤±è´¥: ' + (err.message || 'æœªçŸ¥é”™è¯¯'));
            }
          };
          reader.readAsArrayBuffer(file);
        }
      };
      const uploadBtn = document.getElementById('upload-btn');
      uploadBtn.onclick = () => fileInput.click();
      
      // åˆå§‹åŒ–æ¸²æŸ“
      renderCategories();
    }

    /* ========= æœç´¢æ é€»è¾‘ ========= */
    const searchInput = document.getElementById('lib-search');
    if (searchInput) {
      // æ ¹æ®å…³é”®å­—å’Œå½“å‰æ ‡ç­¾ç­›é€‰å¯¹åº”åˆ—è¡¨
      const performFilter = () => {
        const kw = searchInput.value.trim().toLowerCase();
        const activeTab = document.querySelector('.tab-btn.ring-2')?.dataset.tab || 'library';

        // å¦‚æœæœç´¢æ¡†å·²æ¸…ç©ºï¼Œç›´æ¥è¿˜åŸæ‰€æœ‰æ˜¾ç¤ºå¹¶æ¢å¤æ­¤å‰è‡ªåŠ¨å±•å¼€çš„åˆ†ç±»
        if (kw === '') {
          if (activeTab === 'library') {
            document.querySelectorAll('#category-list .draggable-cat').forEach(catDiv => {
              catDiv.style.display = '';
              const catBody = catDiv.querySelector('[id^="cat-body-"]');
              // ä¸€å¾‹æŠ˜å åˆ†ç±»ä½“ï¼Œæ— è®ºæ˜¯å¦ç”±æœç´¢å±•å¼€
              if (catBody) {
                catBody.classList.add('hidden');
                delete catBody.dataset.openedBySearch;
              }
              // æ¢å¤å†…éƒ¨é¢˜åº“å¯è§
              catDiv.querySelectorAll('.draggable-lib').forEach(libDiv => libDiv.style.display='');
            });
          } else {
            // é”™é¢˜æœ¬/æ”¶è—å¤¹ï¼šæ¢å¤å…¨éƒ¨å¯è§å¹¶æŠ˜å åˆ†ç±»
            const isWrongTab = activeTab === 'wrong';
            const catSelector = isWrongTab ? '#wrongbook-list .wrong-cat' : '#favbook-list .fav-cat';
            document.querySelectorAll(catSelector).forEach(catDiv => {
              catDiv.style.display='';
              const body = catDiv.querySelector('.cat-body');
              body?.classList.add('hidden');
            });
          }
          return;
        }

        // ---- å›¾ä¹¦/åˆ†ç±»æœç´¢ ----
        if (activeTab === 'library') {
          // éå†åˆ†ç±»
          document.querySelectorAll('#category-list .draggable-cat').forEach(catDiv => {
            const cidx = parseInt(catDiv.getAttribute('data-cidx'));
            const catBody = catDiv.querySelector(`#cat-body-${cidx}`);
            let catMatch = kw !== '' && catDiv.querySelector('.cat-header').innerText.toLowerCase().includes(kw);

            // éå†é¢˜åº“
            let visibleLibCount = 0;
            catDiv.querySelectorAll('.draggable-lib').forEach(libDiv => {
              const lidx = parseInt(libDiv.getAttribute('data-lidx'));
              const lib = (window.categories || [])[cidx]?.libraries[lidx];
              let libMatch = false;
              if (kw === '') {
                libMatch = true;
              } else {
                // åç§°åŒ¹é…
                libMatch = libDiv.innerText.toLowerCase().includes(kw);
                // é¢˜å¹²åŒ¹é…
                if (!libMatch && lib && Array.isArray(lib.questions)) {
                  libMatch = lib.questions.some(q => (q.stem || '').toLowerCase().includes(kw));
                }
              }
              libDiv.style.display = libMatch ? '' : 'none';
              if (libMatch) visibleLibCount++;
            });

            // åˆ†ç±»å¯è§æ€§ä¸å±•å¼€
            const catVisible = catMatch || visibleLibCount > 0;
            catDiv.style.display = catVisible ? '' : 'none';
            if (catVisible) {
              // å±•å¼€æ˜¾ç¤ºåŒ¹é…ç»“æœ
              catBody.classList.remove('hidden');
            }
          });
          return;
        }

        // ---- é”™é¢˜æœ¬ / æ”¶è—å¤¹åˆ—è¡¨æœç´¢ ----
        const isWrong = activeTab === 'wrong';
        const catSelector = isWrong ? '#wrongbook-list .wrong-cat' : '#favbook-list .fav-cat';
        const libSelector = isWrong ? '.wrong-lib' : '.fav-lib';

        document.querySelectorAll(catSelector).forEach(catDiv => {
          const catHeaderText = catDiv.querySelector('.cat-header')?.innerText.toLowerCase() || '';
          let catMatch = kw!=='' && catHeaderText.includes(kw);

          let visibleLibCount = 0;
          catDiv.querySelectorAll(libSelector).forEach(libDiv => {
            const libText = libDiv.querySelector('.lib-header')?.innerText.toLowerCase() || '';
            const match = kw==='' || libText.includes(kw) || libDiv.innerText.toLowerCase().includes(kw);
            libDiv.style.display = match ? '' : 'none';
            if (match) visibleLibCount++;
          });

          const catVisible = kw==='' ? true : (catMatch || visibleLibCount>0);
          catDiv.style.display = catVisible ? '' : 'none';

          const catBody = catDiv.querySelector('.cat-body');
          if (catVisible && kw!=='') {
            catBody?.classList.remove('hidden'); // å±•å¼€åŒ¹é…åˆ†ç±»
          } else if (kw==='') {
            // æ¸…ç©ºæœç´¢åæŠ˜å å…¨éƒ¨
            catBody?.classList.add('hidden');
          }
        });
      };

      searchInput.addEventListener('input', performFilter);

      // åˆ‡æ¢æ ‡ç­¾æ—¶é‡ç½®è¾“å…¥åŠå ä½ç¬¦
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const tab = btn.dataset.tab;
          searchInput.placeholder = tab === 'library' ? 'æœç´¢é¢˜åº“â€¦' : (tab === 'wrong' ? 'æœç´¢é”™é¢˜â€¦' : 'æœç´¢æ”¶è—â€¦');
          searchInput.value = '';
          performFilter();
        });
      });
    }

    // æ³¨æ„ï¼šä¸‹è½½æ¨¡æ¿åŠŸèƒ½å·²åœ¨ä¸Šæ–¹å®ç°ï¼Œæ— éœ€é‡å¤æ·»åŠ äº‹ä»¶ç›‘å¬å™¨

    /* ---------- é€šç”¨ï¼šæŒ‰ åˆ†ç±» > é¢˜åº“ åˆ†ç»„ ---------- */
    function groupByCatLib(arr) {
      const map = {};
      arr.forEach((q, idx) => {
        const cat = q._categoryName || 'æœªåˆ†ç±»';
        const lib = q._libraryName || 'æœªçŸ¥é¢˜åº“';
        if (!map[cat]) map[cat] = {};
        if (!map[cat][lib]) map[cat][lib] = [];
        map[cat][lib].push({ q, idx });
      });
      return map;
    }

    // Fisher-Yates shuffle
    function shuffleArray(arr){
      for(let i=arr.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]]=[arr[j],arr[i]];
      }
      return arr;
    }

    /* ========= å­¦ä¹ ç»Ÿè®¡åŠŸèƒ½ ========= */
    const STATS_KEY = 'tj_stats';

    function loadStats(){
      try{
        const raw = localStorage.getItem(STATS_KEY);
        return raw ? JSON.parse(raw) : { totalCorrect:0, totalIncorrect:0, categories:{} };
      }catch(e){
        console.warn('Stats parse failed',e);
        return { totalCorrect:0, totalIncorrect:0, categories:{} };
      }
    }

    function saveStats(stats){
      localStorage.setItem(STATS_KEY, JSON.stringify(stats));
    }

    // è°ƒç”¨æ­¤å‡½æ•°ä»¥æ›´æ–°ç»Ÿè®¡ï¼Œåç»­åšç­”é¢˜åŠŸèƒ½æ—¶å¯å¤ç”¨
    function updateStats(category, isCorrect){
      const stats = loadStats();
      if(isCorrect) stats.totalCorrect++; else stats.totalIncorrect++;
      if(!stats.categories[category]) stats.categories[category] = { correct:0, incorrect:0 };
      if(isCorrect) stats.categories[category].correct++; else stats.categories[category].incorrect++;
      saveStats(stats);
    }

    let overallChart;

    function renderStats(){
      const stats = loadStats();

      // æ€»ä½“å›¾è¡¨
      const overallCtx = document.getElementById('overall-chart').getContext('2d');
      if(overallChart) overallChart.destroy();
      const total = stats.totalCorrect + stats.totalIncorrect;
      let doughnutData;
      if(total===0){
        doughnutData=[1];
      }else{
        doughnutData=[stats.totalCorrect,stats.totalIncorrect];
      }
      overallChart = new Chart(overallCtx, {
        type:'doughnut',
        data:{
          labels: total===0?['æš‚æ— æ•°æ®']:['æ­£ç¡®','é”™è¯¯'],
          datasets:[{
            data:doughnutData,
            backgroundColor: total===0? ['#e5e7eb']:['#4ade80','#f87171'],
            borderWidth:0,
            cutout:'70%'
          }]
        },
        options:{responsive:true, plugins:{ legend:{ display:false }}}
      });

      /* é¢˜å‹æ¡å½¢å›¾ */
      const typeCtx=document.getElementById('type-chart').getContext('2d');
      const types=['å•é€‰','å¤šé€‰'];
      const typeData=types.map(t=>stats.byType?.[t]?.correct||0);
      const totalType=typeData.reduce((a,b)=>a+b,0);
      if(window.typeChart) window.typeChart.destroy();
      window.typeChart=new Chart(typeCtx,{
        type:'bar',
        data:{
          labels:types,
          datasets:[{
            data: totalType===0? [0,0]:typeData,
            backgroundColor: totalType===0? '#e5e7eb':['#6366f1','#a78bfa']
          }]
        },
        options:{
          responsive:true,
          plugins:{legend:{display:false}},
          scales:{y:{beginAtZero:true}}
        }
      });

      // æ›´æ–°æ•°å­—æ‘˜è¦
      document.getElementById('total-count').textContent = total;
      document.getElementById('correct-count').textContent = stats.totalCorrect;
      document.getElementById('incorrect-count').textContent = stats.totalIncorrect;

      // ç”Ÿæˆåˆ†ç±»è¡¨ç° TOP3
      const categoryContainer = document.getElementById('top-categories');
      categoryContainer.innerHTML = '';
      const sortedCats = Object.entries(stats.categories).sort((a,b)=>{
        const ta=a[1].correct+a[1].incorrect, tb=b[1].correct+b[1].incorrect; return tb-ta;});
      sortedCats.slice(0,3).forEach(([name,data])=>{
        const total=data.correct+data.incorrect;
        const percent=total?Math.round(data.correct/total*100):0;
        const bar=`<div class='flex items-center gap-2'>
          <span class='w-20 truncate'>${name}</span>
          <div class='flex-1 h-2 bg-gray-200 rounded overflow-hidden'>
            <div class='h-2 bg-green-400' style='width:${percent}%'></div>
          </div>
          <span class='w-12 text-right'>${percent}%</span>
        </div>`;
        categoryContainer.insertAdjacentHTML('beforeend',bar);
      });

      /* centerText æ’ä»¶ï¼šåœ¨åœ†ç¯å›¾ä¸­å¿ƒç»˜åˆ¶ç™¾åˆ†æ¯” */
      if(!Chart.registry.plugins.get('centerText')){
        Chart.register({
          id:'centerText',
          afterDraw(chart){
            if(chart.config.type!=='doughnut') return;
            const {ctx,width,height} = chart;
            const data = chart.data.datasets[0].data;
            const totalVal = data.reduce((a,b)=>a+b,0);
            const percent = totalVal?Math.round(data[0]/totalVal*100):0;
            ctx.save();
            ctx.font = 'bold 32px "Noto Sans SC", sans-serif';
            ctx.fillStyle = '#4ade80';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(percent + '%', width/2, height/2);
            ctx.restore();
          }
        });
      }
    }

    // æŒ‰é’®ç›‘å¬ä¸é¡µé¢åˆ‡æ¢
    document.getElementById('stats-btn')?.addEventListener('click', ()=>{
      document.getElementById('main-section')?.classList.add('hidden');
      document.getElementById('search-result')?.classList.add('hidden');
      document.getElementById('stats-section')?.classList.remove('hidden');
      renderStats();
    });

    // === ç¬”è®°åŠŸèƒ½ ===
    let quill = null; // Quillå®ä¾‹
    async function getNotes(){
      if(typeof window.electronAPI!=='undefined' && window.electronAPI.loadNotes){
        const res=await window.electronAPI.loadNotes();
        if(res.success && res.data) return res.data;
      }
      return JSON.parse(localStorage.getItem('tijing-notes')||'{}');
    }
    async function setNotes(obj){
      if(typeof window.electronAPI!=='undefined' && window.electronAPI.saveNotes){
        await window.electronAPI.saveNotes(obj);
      }
      localStorage.setItem('tijing-notes',JSON.stringify(obj));
    }
    // æ ¹æ®é¢˜åº“åã€åˆ†ç±»åã€é¢˜å¹²ç”Ÿæˆç¨³å®šä¸”å”¯ä¸€çš„ keyï¼›é¿å…é¢˜å¹²æ–‡æœ¬å°æ”¹å¯¼è‡´æ— æ³•åŒ¹é…ã€‚
    function getQuestionKey(q){
      // è‹¥ç¼ºå°‘å…ƒæ•°æ®åˆ™å›é€€ä¸ºç©ºä¸²ï¼Œä¿æŒæ ¼å¼ä¸€è‡´
      const lib = (q._libraryName || '').trim();
      const cat = (q._categoryName || '').trim();
      const stem = (q.stem || '').replace(/\s+/g,' ').trim();
      // ç»„åˆååšç®€å•é•¿åº¦é™åˆ¶ï¼Œè¶³å¤Ÿå”¯ä¸€
      return `${lib}::${cat}::${stem}`.slice(0,150);
    }

    // æ‰“å¼€ç¬”è®°å¼¹çª—å‡½æ•°ï¼ˆé›†æˆQuillï¼‰
    async function openNoteModal(q) {
      const modal = document.getElementById('note-modal');
      const modalBg = document.getElementById('note-modal-bg');
      const saveBtn = document.getElementById('note-save');
      const closeBtn = document.getElementById('note-close');
      const deleteBtn = document.getElementById('note-delete');
      const previewBtn = document.getElementById('note-preview-toggle');
      const dragElement = document.querySelector('.note-draggable');
      const dragHandle = document.getElementById('note-drag-handle');
      // ä¸ºç¬”è®°ç”Ÿæˆå”¯ä¸€çš„é”®
      const key = getQuestionKey(q);
      const notes = await getNotes();
      const rawNote = notes[key] || '';
      const existing = (typeof rawNote==='object' && rawNote!==null) ? rawNote : {mode:'rich',content:String(rawNote)};
      // åˆå§‹åŒ–Quillï¼ˆåªåˆå§‹åŒ–ä¸€æ¬¡ï¼‰
      if (!quill) {
        const COLORS = [false, '#000000', '#e60000', '#ff9900', '#ffff00', '#008a00', '#0066cc', '#9933ff'];
        quill = new Quill('#note-editor', {
          theme: 'snow',
          modules: {
            toolbar: [
              ['bold', 'italic'],
              [{ 'color': COLORS }, { 'background': COLORS }],
              [{ 'list': 'ordered'}, { 'list': 'bullet' }],
              ['code-block', 'image']
            ]
          }
        });
      }
      // è®¾ç½®å†…å®¹
      quill.root.innerHTML = existing.mode==='md' ? '' : (existing.content||'');
      // æ˜¾ç¤ºæ¨¡æ€æ¡†
      modal.classList.remove('hidden');
      // é‡ç½®å¼¹çª—ä½ç½®
      dragElement.style.transform = 'translate(-50%, -50%)';
      // é˜»æ­¢ç‚¹å‡»äº‹ä»¶å†’æ³¡åˆ°èƒŒæ™¯
      dragElement.addEventListener('click', (e) => {
        e.stopPropagation();
      });
      // èƒŒæ™¯ç‚¹å‡»å…³é—­
      modalBg.onclick = () => {
        modal.classList.add('hidden');
      };
      // å…³é—­æŒ‰é’®
      closeBtn.onclick = (e) => {
        e.stopPropagation();
        modal.classList.add('hidden');
      };
      // ä¿å­˜æŒ‰é’®
      saveBtn.onclick = async (e) => {
        e.stopPropagation();
        const content = quill.root.innerHTML;
        notes[key] = {mode:currentMode, content};
        await setNotes(notes);
        modal.classList.add('hidden');
      };
      // åˆ é™¤ç¬”è®°æŒ‰é’®
      deleteBtn.onclick = async (e) => {
        e.stopPropagation();
        if (confirm('ç¡®å®šè¦åˆ é™¤æ­¤ç¬”è®°å—ï¼Ÿ')) {
          delete notes[key];
          await setNotes(notes);
          modal.classList.add('hidden');
        }
      };
      // é¢„è§ˆæŒ‰é’®éšè—ï¼ˆQuillå·²è‡ªå¸¦æ‰€è§å³æ‰€å¾—ï¼‰
      if (previewBtn) previewBtn.style.display = 'none';
      // åˆå§‹åŒ–æ‹–åŠ¨åŠŸèƒ½
      initDraggable(dragElement, dragHandle);
      // ä¸ºå·¥å…·æ æŒ‰é’®å’Œé¢œè‰²é€‰é¡¹æ·»åŠ æç¤º
      addQuillTooltips();
      // ç¡®ä¿å·¥å…·æ æ‰©å±•æ§ä»¶å­˜åœ¨ï¼ˆæ¨¡å¼åˆ‡æ¢+é¢„è§ˆï¼‰
      ensureToolbarExtras();
    }

    // åˆå§‹åŒ–æ‹–åŠ¨åŠŸèƒ½
    function initDraggable(element, handle) {
      if (!element || !handle) return;
      
      let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
      
      handle.onmousedown = dragMouseDown;
      
      function dragMouseDown(e) {
        e = e || window.event;
        e.preventDefault();
        e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°èƒŒæ™¯
        
        // è·å–é¼ æ ‡åˆå§‹ä½ç½®
        pos3 = e.clientX;
        pos4 = e.clientY;
        document.onmouseup = closeDragElement;
        // é¼ æ ‡ç§»åŠ¨æ—¶è°ƒç”¨elementDrag
        document.onmousemove = elementDrag;
      }
      
      function elementDrag(e) {
        e = e || window.event;
        e.preventDefault();
        e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°èƒŒæ™¯
        
        // è®¡ç®—æ–°ä½ç½®
        pos1 = pos3 - e.clientX;
        pos2 = pos4 - e.clientY;
        pos3 = e.clientX;
        pos4 = e.clientY;
        
        // æ›´æ–°å…ƒç´ ä½ç½®
        const currentTransform = window.getComputedStyle(element).getPropertyValue('transform');
        const matrix = new DOMMatrix(currentTransform);
        const currentX = matrix.m41;
        const currentY = matrix.m42;
        
        element.style.transform = `translate(${currentX - pos1}px, ${currentY - pos2}px)`;
      }
      
      function closeDragElement() {
        document.onmouseup = null;
        document.onmousemove = null;
      }
    }

    // é«˜äº®å½“å‰ç»ƒä¹ çš„é¢˜åº“
    function highlightActiveLibrary(library) {
      // é¦–å…ˆæ¸…é™¤æ‰€æœ‰ä¹‹å‰çš„é«˜äº®
      document.querySelectorAll('.active-practice-library').forEach(el => {
        el.classList.remove('active-practice-library');
      });
      
      // æŸ¥æ‰¾å¯¹åº”çš„é¢˜åº“å…ƒç´ å¹¶æ·»åŠ é«˜äº®
      const libraryElements = document.querySelectorAll('.draggable-lib');
      libraryElements.forEach(libElement => {
        const libName = libElement.querySelector('.filename')?.textContent?.trim();
        if (libName === library.name) {
          // æ·»åŠ é«˜äº®ç±»åˆ°é¢˜åº“å…ƒç´ 
          libElement.classList.add('active-practice-library');
          
          // ç¡®ä¿åŒ…å«è¯¥é¢˜åº“çš„åˆ†ç±»æ˜¯å±•å¼€çš„
          const categoryElement = libElement.closest('.draggable-cat');
          if (categoryElement) {
            const cidx = categoryElement.getAttribute('data-cidx');
            const catBody = document.getElementById(`cat-body-${cidx}`);
            if (catBody && catBody.classList.contains('hidden')) {
              catBody.classList.remove('hidden');
            }
          }
          
          // æ»šåŠ¨åˆ°é«˜äº®çš„é¢˜åº“å…ƒç´ 
          libElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
      });
    }

  
    // ç¬”è®°ç¼–è¾‘å·¥å…·æ åŠŸèƒ½
    document.addEventListener('DOMContentLoaded', () => {
      // æ·»åŠ ç¬”è®°å·¥å…·æ æŒ‰é’®äº‹ä»¶
      document.querySelectorAll('.note-tool').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          const command = btn.getAttribute('data-cmd');
          
          if (command === 'bold') {
            toggleBold();
          } else if (command === 'italic') {
            toggleItalic();
          } else if (command === 'ul') {
            toggleList('ul');
          } else if (command === 'ol') {
            toggleList('ol');
          }
          
          // ç¡®ä¿ç¼–è¾‘å™¨è·å¾—ç„¦ç‚¹
          document.getElementById('note-editor').focus();
        });
      });
    });

    // åˆå§‹åŒ–åˆ†ç±»æŠ˜å çŠ¶æ€
    function initCategoryFoldState() {
      categoryFoldState = JSON.parse(localStorage.getItem('tijing-category-fold') || '{}');
      console.log('åˆ†ç±»æŠ˜å çŠ¶æ€åˆå§‹åŒ–å®Œæˆ');
    }

    // ====== æ–°å¢ï¼šåŸç”ŸJSå®ç°å¯Œæ–‡æœ¬åŠŸèƒ½ ======
    // åŠ ç²—åŠŸèƒ½
    function toggleBold() {
      const editor = document.getElementById('note-editor');
      const selection = window.getSelection();
      if (!selection.rangeCount) return;
      const range = selection.getRangeAt(0);
      // æ£€æŸ¥æ˜¯å¦åœ¨<b>æˆ–<strong>æ ‡ç­¾å†…
      let node = selection.anchorNode;
      while (node && node !== editor) {
        if (node.nodeName === 'B' || node.nodeName === 'STRONG') {
          // ç§»é™¤åŠ ç²—ï¼šç”¨çˆ¶èŠ‚ç‚¹æ›¿æ¢å½“å‰èŠ‚ç‚¹
          const parent = node.parentNode;
          while (node.firstChild) parent.insertBefore(node.firstChild, node);
          parent.removeChild(node);
          return;
        }
        node = node.parentNode;
      }
      // å¦åˆ™åŠ ç²—é€‰åŒº
      const bold = document.createElement('b');
      bold.appendChild(range.extractContents());
      range.insertNode(bold);
      // é‡æ–°èšç„¦
      editor.focus();
    }
    // æ–œä½“åŠŸèƒ½
    function toggleItalic() {
      const editor = document.getElementById('note-editor');
      const selection = window.getSelection();
      if (!selection.rangeCount) return;
      const range = selection.getRangeAt(0);
      // æ£€æŸ¥æ˜¯å¦åœ¨<i>æˆ–<em>æ ‡ç­¾å†…
      let node = selection.anchorNode;
      while (node && node !== editor) {
        if (node.nodeName === 'I' || node.nodeName === 'EM') {
          const parent = node.parentNode;
          while (node.firstChild) parent.insertBefore(node.firstChild, node);
          parent.removeChild(node);
          return;
        }
        node = node.parentNode;
      }
      // å¦åˆ™æ–œä½“é€‰åŒº
      const italic = document.createElement('i');
      italic.appendChild(range.extractContents());
      range.insertNode(italic);
      editor.focus();
    }
    // æœ‰åº/æ— åºåˆ—è¡¨åŠŸèƒ½
    function toggleList(type) {
      const editor = document.getElementById('note-editor');
      const selection = window.getSelection();
      if (!selection.rangeCount) return;
      const range = selection.getRangeAt(0);
      // æ£€æŸ¥æ˜¯å¦å·²åœ¨åˆ—è¡¨ä¸­
      let node = selection.anchorNode;
      while (node && node !== editor) {
        if (node.nodeName === 'UL' || node.nodeName === 'OL') {
          // å·²åœ¨åˆ—è¡¨ä¸­ï¼Œç§»é™¤åˆ—è¡¨
          const parent = node.parentNode;
          while (node.firstChild) parent.insertBefore(node.firstChild, node);
          parent.removeChild(node);
          return;
        }
        node = node.parentNode;
      }
      // å¦åˆ™æ’å…¥æ–°åˆ—è¡¨
      const list = document.createElement(type);
      const li = document.createElement('li');
      li.textContent = selection.toString() || 'æ–°åˆ—è¡¨é¡¹';
      list.appendChild(li);
      // æ›¿æ¢é€‰åŒºå†…å®¹ä¸ºåˆ—è¡¨
      range.deleteContents();
      range.insertNode(list);
      // ç§»åŠ¨å…‰æ ‡åˆ°æ–°åˆ—è¡¨é¡¹
      selection.removeAllRanges();
      const newRange = document.createRange();
      newRange.selectNodeContents(li);
      newRange.collapse(false);
      selection.addRange(newRange);
      editor.focus();
    }

    /* ä¸º Quill å·¥å…·æ æŒ‰é’®å’Œé¢œè‰²é€‰é¡¹æ·»åŠ  title æç¤º */
    function addQuillTooltips(){
      const toolbar = document.querySelector('.ql-toolbar');
      if(!toolbar) return;
      // åŸºæœ¬æŒ‰é’®
      const btnMap = {
        '.ql-bold':'åŠ ç²—',
        '.ql-italic':'æ–œä½“',
        'button.ql-list[value="ordered"]':'æœ‰åºåˆ—è¡¨',
        'button.ql-list[value="bullet"]':'æ— åºåˆ—è¡¨',
        '.ql-code-block':'ä»£ç å—',
        '.ql-image':'æ’å…¥å›¾ç‰‡'
      };
      Object.entries(btnMap).forEach(([sel,text])=>{
        const el=toolbar.querySelector(sel);
        if(el){
          el.setAttribute('title',text);
          // é˜»æ­¢æŒ‰é’®è·å–ç„¦ç‚¹å¯¼è‡´é€‰åŒºä¸¢å¤±
          el.addEventListener('mousedown',e=>e.preventDefault());
        }
      });
      // é¢œè‰²åç§°æ˜ å°„
      const colorName={
        '':'é»˜è®¤',
        '#000000':'é»‘è‰²','#e60000':'çº¢è‰²','#ff9900':'æ©™è‰²',
        '#ffff00':'é»„è‰²','#008a00':'ç»¿è‰²','#0066cc':'è“è‰²','#9933ff':'ç´«è‰²'
      };
      toolbar.querySelectorAll('.ql-color .ql-picker-item').forEach(item=>{
        const val=item.getAttribute('data-value')||'';
        const name=colorName[val]||'é»˜è®¤';
        item.setAttribute('title',name);
        item.addEventListener('mousedown',e=>e.preventDefault());
      });
      toolbar.querySelectorAll('.ql-background .ql-picker-item').forEach(item=>{
        const val=item.getAttribute('data-value')||'';
        const name=colorName[val]||'é»˜è®¤';
        item.setAttribute('title',`é«˜äº®-${name}`);
        item.addEventListener('mousedown',e=>e.preventDefault());
      });
    }

    /* å½“å‰ç¼–è¾‘æ¨¡å¼ */
    let currentMode='rich';
    function switchEditMode(mode){
      currentMode=mode;
      const qe=document.getElementById('note-editor');
      const mw=document.getElementById('md-wrapper');
      const md=document.getElementById('md-editor');
      const pv=document.getElementById('md-preview');
      const previewBtn=document.getElementById('md-preview-toggle');
      if(mode==='rich'){
        qe.classList.remove('hidden');
        mw.classList.add('hidden');
        md.classList.add('hidden');
        pv.classList.add('hidden');
        previewBtn.classList.add('hidden');
      }else{
        qe.classList.add('hidden');
        mw.classList.remove('hidden');
        pv.classList.add('hidden');
        md.classList.remove('hidden');
        previewBtn.classList.remove('hidden');
        previewBtn.dataset.state='edit';
      }
    }

    function toggleMdPreview(){
      if(currentMode!=='md') return;
      const mw=document.getElementById('md-wrapper');
      const md=document.getElementById('md-editor');
      const pv=document.getElementById('md-preview');
      const btn=document.getElementById('md-preview-toggle');
      if(btn.dataset.state==='edit'){
        // æ¸²æŸ“
        pv.innerHTML = marked.parse(md.value||'');
        md.classList.add('hidden');
        pv.classList.remove('hidden');
        btn.dataset.state='preview';
        btn.innerHTML='<i class="fas fa-edit"></i>';
        btn.title='è¿”å›ç¼–è¾‘';
      }else{
        pv.classList.add('hidden');
        md.classList.remove('hidden');
        btn.dataset.state='edit';
        btn.innerHTML='<i class="fas fa-eye"></i>';
        btn.title='æµè§ˆ';
      }
    }

    // ç¡®ä¿å·¥å…·æ æ‰©å±•æ§ä»¶å­˜åœ¨ï¼ˆæ¨¡å¼é€‰æ‹© & é¢„è§ˆï¼‰
    function ensureToolbarExtras(){
      if(!quill) return;
      const toolbarEl=quill.getModule('toolbar').container;
      if(!toolbarEl) return;
      // æ¸…ç†æ—§ç‰ˆæ§ä»¶
      const oldSel=document.getElementById('note-mode-select');
      if(oldSel) oldSel.parentElement?.remove();
      const oldGrp=document.querySelector('.mode-group');
      if(oldGrp) oldGrp.remove();

      if(document.getElementById('mode-toggle')) return; // å·²åˆ›å»º
      const group=document.createElement('span');
      group.className='toolbar-extras';
      // ç¡®ä¿ toolbar æ˜¯ flex å¸ƒå±€
      const tbStyle=getComputedStyle(toolbarEl);
      if(tbStyle.display!=="flex"){
        toolbarEl.style.display='flex';
        toolbarEl.style.flexWrap='wrap';
        toolbarEl.style.alignItems='center';
      }
      // â€”â€” å•ä¸€åˆ‡æ¢æŒ‰é’® â€”â€”
      const modeBtn=document.createElement('button');
      modeBtn.id='mode-toggle';
      modeBtn.className='mode-toggle active';
      modeBtn.innerHTML='<i class="fas fa-retweet mr-1"></i><span class="mode-label">Text</span>';
      modeBtn.title='åˆ‡æ¢ä¸º Markdown ç¼–è¾‘';

      modeBtn.onclick=()=>{
        if(currentMode==='rich'){
          switchEditMode('md');
          modeBtn.innerHTML='<i class="fas fa-retweet mr-1"></i><span class="mode-label">MD</span>';
          modeBtn.title='åˆ‡æ¢ä¸º æ™®é€šæ–‡æœ¬ç¼–è¾‘';
        }else{
          switchEditMode('rich');
          modeBtn.innerHTML='<i class="fas fa-retweet mr-1"></i><span class="mode-label">Text</span>';
          modeBtn.title='åˆ‡æ¢ä¸º Markdown ç¼–è¾‘';
        }
      };

      // é¢„è§ˆæŒ‰é’®
      const pvBtn=document.createElement('button');
      pvBtn.id='md-preview-toggle';
      pvBtn.title='æµè§ˆ';
      pvBtn.innerHTML='<i class="fas fa-eye"></i>';
      pvBtn.dataset.state='edit';
      pvBtn.addEventListener('mousedown',e=>e.preventDefault());
      // ç»„è£… é¡ºåºï¼šæ¨¡å¼åˆ‡æ¢æŒ‰é’® | ğŸ‘
      group.appendChild(modeBtn);
      group.appendChild(pvBtn);
      toolbarEl.appendChild(group);
      pvBtn.onclick=toggleMdPreview;
      // åˆå§‹çŠ¶æ€
      switchEditMode(currentMode);
    }

    // å°†æ–‡æœ¬ä¸­çš„çº¯å›¾ç‰‡ URL è½¬æˆ <img> æ ‡ç­¾ï¼ˆæ”¯æŒ jpg/png/gif/webp/svgï¼‰
    function convertImageLinks(text){
      if(!text) return '';
      const urlRegex = /(https?:\/\/[^\s"'>]+\.(?:png|jpe?g|gif|webp|svg))(?![^<]*>)/gi;
      // ä¸ºå›¾ç‰‡æ·»åŠ  zoomable-img ç±»å¹¶è®¾ç½®å…‰æ ‡æŒ‡é’ˆï¼Œåç»­å¯é€šè¿‡è¯¥ç±»å®ç°ç‚¹å‡»æ”¾å¤§
      return text.replace(urlRegex, (url)=>`<img src="${url}" alt="å›¾ç‰‡" class="zoomable-img" style="max-width:100%;display:block;margin:8px auto;cursor:zoom-in;">`);
    }

    // === å›¾ç‰‡ç‚¹å‡»æ”¾å¤§æŸ¥çœ‹ (ç®€æ˜“ Lightbox) ===
    // æ”¾åœ¨ DOMContentLoaded å›è°ƒä¸­ï¼Œç¡®ä¿å…ƒç´ å·²æ¸²æŸ“å†æŒ‚è½½
    document.addEventListener('DOMContentLoaded', () => {
      // åˆ›å»ºé®ç½©å±‚åŠå†…éƒ¨å›¾ç‰‡å…ƒç´ 
      const lightbox = document.createElement('div');
      lightbox.id = 'img-lightbox';
      lightbox.className = 'hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-80 z-50';
      lightbox.innerHTML = '<img id="img-lightbox-img" style="max-width:90%;max-height:90%;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,0.5);cursor:zoom-out;" />';
      document.body.appendChild(lightbox);

      // ç‚¹å‡»é®ç½©æˆ–å›¾ç‰‡æœ¬èº«å³å¯å…³é—­
      lightbox.addEventListener('click', () => {
        lightbox.classList.add('hidden');
      });

      // äº‹ä»¶å§”æ‰˜ï¼šæ•è·æ‰€æœ‰ .zoomable-img ç‚¹å‡»äº‹ä»¶
      document.body.addEventListener('click', (e) => {
        const target = e.target;
        if(target && target.classList && target.classList.contains('zoomable-img')){
          const img = document.getElementById('img-lightbox-img');
          img.src = target.currentSrc || target.src;
          lightbox.classList.remove('hidden');
        }
      });

      // === æ»šè½®ç¼©æ”¾åŠŸèƒ½ ===
      const lbImg = document.getElementById('img-lightbox-img');
      let lbScale = 1;

      // é¼ æ ‡æ»šè½®æ§åˆ¶ç¼©æ”¾ï¼ŒèŒƒå›´ 0.5x - 5x
      lbImg.addEventListener('wheel', (e) => {
        e.preventDefault(); // é˜»æ­¢é¡µé¢æ»šåŠ¨
        if (e.deltaY < 0) {
          lbScale = Math.min(lbScale * 1.2, 5);
        } else {
          lbScale = Math.max(lbScale / 1.2, 0.5);
        }
        lbImg.style.transform = `scale(${lbScale})`;
      }, { passive: false });

      // å…³é—­ lightbox æ—¶é‡ç½®ç¼©æ”¾
      lightbox.addEventListener('click', () => {
        lbScale = 1;
        lbImg.style.transform = 'scale(1)';
      });

      // æ‰“å¼€ lightbox æ—¶ä¹Ÿé‡ç½®ç¼©æ”¾
      document.body.addEventListener('click', (e) => {
        const t = e.target;
        if (t && t.classList && t.classList.contains('zoomable-img')) {
          lbScale = 1;
          lbImg.style.transform = 'scale(1)';
        }
      });
    });

    // ========== è¿›åº¦ä¿å­˜/æ¢å¤/æ¸…é™¤ ========== //
    function savePracticeProgress(library, currentIdx, userAnswers, submitted, finished) {
      try {
        const key = 'tijing_progress';
        let progress = JSON.parse(localStorage.getItem(key) || '{}');
        const id = library.id || library.name;
        progress[id] = {
          currentIndex: currentIdx,
          userAnswers: JSON.parse(JSON.stringify(userAnswers)),
          submitted: JSON.parse(JSON.stringify(submitted)),
          finished: !!finished
        };
        localStorage.setItem(key, JSON.stringify(progress));
      } catch (e) {}
    }
    function loadPracticeProgress(library) {
      try {
        const key = 'tijing_progress';
        const id = library.id || library.name;
        const progress = JSON.parse(localStorage.getItem(key) || '{}');
        return progress[id] || null;
      } catch (e) { return null; }
    }
    function clearPracticeProgress(library) {
      try {
        const key = 'tijing_progress';
        const id = library.id || library.name;
        let progress = JSON.parse(localStorage.getItem(key) || '{}');
        delete progress[id];
        localStorage.setItem(key, JSON.stringify(progress));
      } catch (e) {}
    }

    // ========== ç»“æŸé¡µæŒ‰é’®é€»è¾‘ ========== //
    document.addEventListener('click', function(e) {
      if (e.target && e.target.id === 'restart-practice') {
        clearPracticeProgress(practiceState.library);
        showToast('è¿›åº¦å·²æ¸…é™¤');
        setTimeout(()=>{
          startPractice(practiceState.library);
        }, 600);
      }
      if (e.target && e.target.id === 'end-practice') {
        practiceState.finished = true;
        savePracticeProgress(practiceState.library, practiceState.current, practiceState.userAnswers, practiceState.submitted, true);
        showToast('å·²æ ‡è®°ä¸ºå®Œæˆ');
        renderPractice();
        renderAnswerSheet();
      }
    });

    function showToast(message, duration = 2000) {
      let toast = document.getElementById('toast-message');
      if (!toast) {
        toast = document.createElement('div');
        toast.id = 'toast-message';
        toast.style.position = 'fixed';
        toast.style.bottom = '20px';
        toast.style.left = '50%';
        toast.style.transform = 'translateX(-50%)';
        toast.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
        toast.style.color = 'white';
        toast.style.padding = '10px 20px';
        toast.style.borderRadius = '4px';
        toast.style.zIndex = '1000';
        toast.style.transition = 'opacity 0.3s';
        document.body.appendChild(toast);
      }
      toast.textContent = message;
      toast.style.opacity = '1';
      clearTimeout(toast.timeoutId);
      toast.timeoutId = setTimeout(() => {
        toast.style.opacity = '0';
      }, duration);
    }
  </script>
</body>
</html> 
